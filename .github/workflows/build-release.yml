name: Build Release Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.8.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos
          - os: ubuntu-latest
            platform: linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies with uv (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .

      - name: Install dependencies with uv (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          uv venv
          & .venv\Scripts\Activate.ps1
          uv pip install -e .

      - name: Create database (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          python manage.py migrate --noinput

      - name: Create database (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & .venv\Scripts\Activate.ps1
          python manage.py migrate --noinput

      - name: Build with PyInstaller (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          pyinstaller main.spec --clean

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & .venv\Scripts\Activate.ps1
          pyinstaller main.spec --clean

      - name: Create archive (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          cd dist/main
          Compress-Archive -Path * -DestinationPath ../../CPOS-Hub-${{ inputs.version }}-windows.zip

      - name: Create archive (macOS)
        if: matrix.platform == 'macos'
        run: |
          cd dist
          zip -r ../CPOS-Hub-${{ inputs.version }}-macos.zip "CPOS Hub.app"

      - name: Create archive (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd dist/main
          tar -czf ../../CPOS-Hub-${{ inputs.version }}-linux.tar.gz *

      - name: Import GPG key
        if: inputs.create_release
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "[OK] GPG key imported"

      - name: Sign release artifacts
        if: inputs.create_release
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Firmar archivo Windows
          if [ -f "CPOS-Hub-${{ inputs.version }}-windows.zip" ]; then
            echo "[INFO] Signing Windows archive..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "CPOS-Hub-${{ inputs.version }}-windows.zip"
          fi

          # Firmar archivo macOS
          if [ -f "CPOS-Hub-${{ inputs.version }}-macos.zip" ]; then
            echo "[INFO] Signing macOS archive..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "CPOS-Hub-${{ inputs.version }}-macos.zip"
          fi

          # Firmar archivo Linux
          if [ -f "CPOS-Hub-${{ inputs.version }}-linux.tar.gz" ]; then
            echo "[INFO] Signing Linux archive..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "CPOS-Hub-${{ inputs.version }}-linux.tar.gz"
          fi

          echo "[OK] All artifacts signed"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CPOS-Hub-${{ inputs.version }}-${{ matrix.platform }}
          path: |
            CPOS-Hub-*.zip
            CPOS-Hub-*.zip.asc
            CPOS-Hub-*.tar.gz
            CPOS-Hub-*.tar.gz.asc
          retention-days: 30

      - name: Upload to Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: Release v${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            CPOS-Hub-*.zip
            CPOS-Hub-*.zip.asc
            CPOS-Hub-*.tar.gz
            CPOS-Hub-*.tar.gz.asc
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
