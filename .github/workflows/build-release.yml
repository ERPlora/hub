name: Build Release Executables

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.8.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub Release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: windows
            hub_env: desktop_windows
          - os: macos-latest
            platform: macos
            hub_env: desktop_macos
          - os: ubuntu-latest
            platform: linux
            hub_env: desktop_linux

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies with uv (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .

      - name: Install dependencies with uv (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          uv venv
          & .venv\Scripts\Activate.ps1
          uv pip install -e .

      - name: Create database (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          HUB_ENV: ${{ matrix.hub_env }}
        run: |
          source .venv/bin/activate
          python manage.py migrate --noinput
          echo "✅ Database created (HUB_ENV=$HUB_ENV)"

      - name: Create database (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          HUB_ENV: ${{ matrix.hub_env }}
        run: |
          & .venv\Scripts\Activate.ps1
          python manage.py migrate --noinput
          Write-Host "✅ Database created (HUB_ENV=$env:HUB_ENV)"

      - name: Build with PyInstaller (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          HUB_ENV: ${{ matrix.hub_env }}
        run: |
          source .venv/bin/activate
          pyinstaller main.spec --clean

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          HUB_ENV: ${{ matrix.hub_env }}
        run: |
          & .venv\Scripts\Activate.ps1
          pyinstaller main.spec --clean

      - name: Install Inno Setup (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Create Windows Installer
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          # Actualizar versión en setup.iss
          $Content = Get-Content installers/windows/setup.iss -Raw
          $Content = $Content -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ inputs.version }}`""
          $Content | Set-Content installers/windows/setup.iss -NoNewline

          # Compilar instalador
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" installers/windows/setup.iss

          # Mover instalador a raíz
          Move-Item dist/CPOS-Hub-${{ inputs.version }}-Setup.exe ./CPOS-Hub-${{ inputs.version }}-windows-installer.exe

      - name: Create macOS DMG
        if: matrix.platform == 'macos'
        run: |
          cd installers/macos
          chmod +x sign-and-package.sh
          ./sign-and-package.sh ${{ inputs.version }}
          mv CPOS-Hub-${{ inputs.version }}-macos.dmg ../../

      - name: Install AppImage dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Create AppImage (Linux)
        if: matrix.platform == 'linux'
        run: |
          cd installers/linux
          chmod +x create-appimage.sh
          ./create-appimage.sh ${{ inputs.version }}
          mv CPOS-Hub-${{ inputs.version }}-$(uname -m).AppImage ../../

      - name: Import GPG key
        if: inputs.create_release
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "[OK] GPG key imported"

      - name: Sign release artifacts
        if: inputs.create_release
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          # Firmar instalador Windows
          if [ -f "CPOS-Hub-${{ inputs.version }}-windows-installer.exe" ]; then
            echo "[INFO] Signing Windows installer..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "CPOS-Hub-${{ inputs.version }}-windows-installer.exe"
          fi

          # Firmar DMG macOS
          if [ -f "CPOS-Hub-${{ inputs.version }}-macos.dmg" ]; then
            echo "[INFO] Signing macOS DMG..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "CPOS-Hub-${{ inputs.version }}-macos.dmg"
          fi

          # Firmar AppImage Linux
          if [ -f "CPOS-Hub-${{ inputs.version }}-"*".AppImage" ]; then
            for appimage in CPOS-Hub-${{ inputs.version }}-*.AppImage; do
              echo "[INFO] Signing Linux AppImage: $appimage"
              gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "$appimage"
            done
          fi

          echo "[OK] All artifacts signed"
        shell: bash

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CPOS-Hub-${{ inputs.version }}-${{ matrix.platform }}
          path: |
            CPOS-Hub-*.exe
            CPOS-Hub-*.exe.asc
            CPOS-Hub-*.dmg
            CPOS-Hub-*.dmg.asc
            CPOS-Hub-*.AppImage
            CPOS-Hub-*.AppImage.asc
          retention-days: 30

      - name: Upload to Release
        if: inputs.create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: Release v${{ inputs.version }}
          draft: false
          prerelease: false
          files: |
            CPOS-Hub-*.exe
            CPOS-Hub-*.exe.asc
            CPOS-Hub-*.dmg
            CPOS-Hub-*.dmg.asc
            CPOS-Hub-*.AppImage
            CPOS-Hub-*.AppImage.asc
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
