name: Build Executables

on:
  push:
    branches: [develop]  # Solo develop (staging y main usan release.yml)
    tags:
      - 'v*'
  pull_request:
    branches: [main, staging]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: CPOS-Hub-Linux
            asset_name: CPOS-Hub-Linux-x64.AppImage
          - os: windows-latest
            artifact_name: CPOS-Hub-Windows
            asset_name: CPOS-Hub-Windows-x64-Setup.exe
          - os: macos-latest
            artifact_name: CPOS-Hub-macOS
            asset_name: CPOS-Hub-macOS-arm64.dmg

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Python 3.11 es más compatible que 3.14

      - name: Install uv (fast package manager)
        run: pip install uv

      - name: Install dependencies with uv (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .

      - name: Install dependencies with uv (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          uv venv
          & .venv\Scripts\Activate.ps1
          uv pip install -e .

      - name: Create database (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          python manage.py migrate --noinput
          echo "✅ Base de datos SQLite creada"

      - name: Create database (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & .venv\Scripts\Activate.ps1
          python manage.py migrate --noinput
          Write-Host "✅ Base de datos SQLite creada"

      - name: Build executable (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          source .venv/bin/activate
          pyinstaller main.spec --clean

      - name: Build executable (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & .venv\Scripts\Activate.ps1
          pyinstaller main.spec --clean

      # ========================================
      # INSTALADORES NATIVOS (en lugar de archivos simples)
      # ========================================

      - name: Install Inno Setup (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Create Windows Installer
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          # Obtener versión desde pyproject.toml
          $Version = (Get-Content pyproject.toml | Select-String -Pattern 'version = "(.*)"').Matches[0].Groups[1].Value

          # Actualizar versión en setup.iss
          $Content = Get-Content installers/windows/setup.iss -Raw
          $Content = $Content -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$Version`""
          $Content | Set-Content installers/windows/setup.iss -NoNewline

          # Compilar instalador
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" installers/windows/setup.iss

          # Mover instalador a raíz
          Move-Item "dist/CPOS-Hub-$Version-Setup.exe" "./${{ matrix.asset_name }}"

      - name: Install AppImage dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

      - name: Create AppImage (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # Obtener versión desde pyproject.toml
          VERSION=$(grep -oP 'version = "\K[^"]+' pyproject.toml)

          cd installers/linux
          chmod +x create-appimage.sh
          ./create-appimage.sh "$VERSION"
          mv "CPOS-Hub-$VERSION-$(uname -m).AppImage" "../../${{ matrix.asset_name }}"

      - name: Create macOS DMG
        if: matrix.os == 'macos-latest'
        run: |
          # Obtener versión desde pyproject.toml
          VERSION=$(grep -oE 'version = "[^"]+"' pyproject.toml | cut -d'"' -f2)

          cd installers/macos
          chmod +x sign-and-package.sh
          ./sign-and-package.sh "$VERSION"
          mv "CPOS-Hub-$VERSION-macos.dmg" "../../${{ matrix.asset_name }}"

      # ========================================
      # FIRMA GPG DE INSTALADORES
      # ========================================

      - name: Import GPG key
        if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          echo "[OK] GPG key imported"
        shell: bash

      - name: Sign installer with GPG
        if: github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/')
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
        run: |
          if [ -f "${{ matrix.asset_name }}" ]; then
            echo "[INFO] Signing ${{ matrix.asset_name }}..."
            gpg --batch --yes --detach-sign --armor --local-user "$GPG_KEY_ID" "${{ matrix.asset_name }}"
            echo "[OK] Signature created: ${{ matrix.asset_name }}.asc"
          else
            echo "[WARNING] File not found: ${{ matrix.asset_name }}"
            exit 1
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.asset_name }}
            ${{ matrix.asset_name }}.asc

      # Nota: Este workflow solo se usa para develop y tags manuales
      # Los releases de main/staging son manejados por release.yml (semantic-release)
