{% extends "base.html" %}
{% load static i18n djicons %}

{% block content %}
<div class="app" x-data="app()" x-init="init()">
    <div class="page">
        <!-- Drawer Backdrop (mobile) -->
        <label class="drawer-backdrop"
               :class="{ 'drawer-backdrop-open': drawerOpen }"
               @click="drawerOpen = false"></label>

        <!-- Drawer (left navigation) -->
        <aside class="drawer drawer-start glass"
               :class="{ 'drawer-open': drawerOpen, 'drawer-collapsed': drawerCollapsed }">
            <!-- Drawer Header: User Card -->
            <div class="header flex justify-center">
                {% if request.user.pk %}
                <div class="employee-card border-0">
                    <div class="employee-card-avatar employee-card-avatar-primary">
                        {{ request.user.first_name|first|default:"U" }}{{ request.user.last_name|first }}
                    </div>
                    <div class="employee-card-info">
                        <h3 class="employee-card-name">{{ request.user.get_full_name|default:request.user.username }}</h3>
                        <span class="employee-card-title">{{ request.user.role_name|default:"" }}</span>
                    </div>
                    <div class="employee-card-actions">
                        <a class="employee-card-action"
                           href="{% url 'main:employee_edit' employee_id=request.user.pk %}"
                           hx-get="{% url 'main:employee_edit' employee_id=request.user.pk %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            {% icon "create-outline" %}
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Drawer Content: Navigation -->
            <div class="content scroll-area-viewport p-2">
                <nav class="sidebar-menu">
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.currentPath === '/' }"
                           href="/"
                           hx-get="/"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "home-outline" %}</span>
                            <span class="sidebar-label">{% trans "Home" %}</span>
                        </a>
                    </div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/files') }"
                           href="{% url 'main:files' %}"
                           hx-get="{% url 'main:files' %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "briefcase-outline" %}</span>
                            <span class="sidebar-label">{% trans "Files" %}</span>
                        </a>
                    </div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/employees') }"
                           href="{% url 'main:employees' %}"
                           hx-get="{% url 'main:employees' %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "people-outline" %}</span>
                            <span class="sidebar-label">{% trans "Employees" %}</span>
                        </a>
                    </div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/roles') }"
                           href="{% url 'main:roles:list' %}"
                           hx-get="{% url 'main:roles:list' %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "shield-outline" %}</span>
                            <span class="sidebar-label">{% trans "Roles" %}</span>
                        </a>
                    </div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/settings') }"
                           href="{% url 'main:settings' %}"
                           hx-get="{% url 'main:settings' %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "settings-outline" %}</span>
                            <span class="sidebar-label">{% trans "Settings" %}</span>
                        </a>
                    </div>

                    <div class="sidebar-separator"></div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/modules') }"
                           href="{% url 'mymodules:index' %}"
                           hx-get="{% url 'mymodules:index' %}"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "cube-outline" %}</span>
                            <span class="sidebar-label">{% trans "My Modules" %}</span>
                        </a>
                    </div>
                    <div class="sidebar-menu-item">
                        <a class="sidebar-menu-button"
                           :class="{ 'is-active': $store.nav.isActive('/marketplace') }"
                           href="/marketplace/"
                           hx-get="/marketplace/"
                           hx-target="#main-content-area"
                           hx-push-url="true">
                            <span class="sidebar-menu-icon">{% icon "storefront-outline" %}</span>
                            <span class="sidebar-label">{% trans "Marketplace" %}</span>
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Drawer Footer: Install + Logout -->
            <div class="footer">
                <div class="sidebar-menu"
                     x-data="{ canInstall: canInstallPWA() }"
                     @pwa-installable.document="canInstall = true"
                     @pwa-installed.document="canInstall = false">
                    <div class="sidebar-menu-item" x-show="canInstall" x-cloak>
                        <button @click="installPWA().then(() => canInstall = canInstallPWA())" class="sidebar-menu-button">
                            <span class="sidebar-menu-icon">{% icon "download-outline" %}</span>
                            <span class="sidebar-label">{% trans "Install App" %}</span>
                        </button>
                    </div>
                    <div class="sidebar-menu-item">
                        <a href="{% url 'auth:logout' %}" class="sidebar-menu-button">
                            <span class="sidebar-menu-icon">{% icon "log-out-outline" %}</span>
                            <span class="sidebar-label">{% trans "Log Out" %}</span>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main content area (direct child of .page â†’ grid column 2, row 2) -->
        {% block main %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function app() {
        return {
            drawerOpen: false,
            drawerCollapsed: false,
            isDark: (window.ERPlora && window.ERPlora.isDark) || false,

            init() {
                // Listen to OS changes only in system mode
                if (window.ERPlora && window.ERPlora.theme === 'system') {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        this.isDark = e.matches;
                        if (this.isDark) {
                            document.documentElement.setAttribute('data-theme', 'dark');
                        } else {
                            document.documentElement.removeAttribute('data-theme');
                        }
                    });
                }

                document.body.addEventListener('htmx:afterSettle', () => {
                    if (window.innerWidth < 992) {
                        this.drawerOpen = false;
                    }
                    this.updateBackButton();
                });

                document.body.addEventListener('pageTitle', (e) => {
                    const el = document.getElementById('page-title');
                    if (el) el.textContent = e.detail.value || e.detail;
                });

                this.updateBackButton();
            },

            updateBackButton() {
                const btn = document.getElementById('back-button');
                if (!btn) return;
                const meta = document.querySelector('#main-content-area [data-back-url]');
                if (meta) {
                    const url = meta.getAttribute('data-back-url');
                    btn.setAttribute('href', url);
                    btn.setAttribute('hx-get', url);
                    htmx.process(btn);
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            },

            toggleDrawer() {
                if (window.innerWidth >= 992) {
                    this.drawerCollapsed = !this.drawerCollapsed;
                } else {
                    this.drawerOpen = !this.drawerOpen;
                }
            },

            applyTheme(theme) {
                var isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                this.isDark = isDark;
                if (isDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
            }
        }
    }
</script>
{% block app_scripts %}{% endblock %}
{% endblock %}
