{% extends "base.html" %} {% load static i18n djicons %} {% block title%}ERPlora Hub - {% trans "Setup" %}{%endblock %} {% block content %}
<div class="min-h-screen flex items-start justify-center p-4 pt-12">
  <div class="w-full max-w-3xl">
    <!-- Logo -->
    <div class="flex items-center gap-4 mb-6">
      <div class="shrink-0">
        <img
          class="w-10 h-10"
          src="{% static 'img/logo.png' %}"
          alt="ERPlora"/>
      </div>
      <h1 class="text-2xl font-bold">ERPlora</h1>
    </div>

    <!-- Stepper Wizard -->
    <div class="card overflow-visible">
      <div class="card-header">
        <h2 class="card-title">
          {% trans "Configure your store to get started" %}
        </h2>
      </div>
      <div class="card-body overflow-visible">
        <div class="stepper">
          <div id="wizard-step-content">{% include step_template %}</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  /* Timezone search data (from Django zoneinfo) */
  const TIMEZONES = {{ timezones_json|safe }};

  /* Country data for phone input (from phonenumbers + pytz) */
  const COUNTRIES = {{ countries_json|safe }};

  /* Browser locale auto-detection map (from phonenumbers + pytz) */
  const LOCALE_MAP = {{ locale_map_json|safe }};

  function detectLocale() {
      const browserLang = navigator.language || navigator.languages?.[0] || 'en';
      return LOCALE_MAP[browserLang] || LOCALE_MAP[browserLang.split('-')[0]] || { lang: 'en', country: 'US', tz: 'UTC' };
  }

  const DETECTED_LOCALE = detectLocale();

  /* Auto-set language select on page load (only if not already configured) */
  {% if not hub_config.language %}
  document.addEventListener('DOMContentLoaded', () => {
      const langSelect = document.getElementById('language');
      if (langSelect) {
          const opt = langSelect.querySelector(`option[value="${DETECTED_LOCALE.lang}"]`);
          if (opt) langSelect.value = DETECTED_LOCALE.lang;
      }
  });
  {% endif %}

  /* Timezone search Alpine component */
  function tzSearch() {
      const saved = '{{ hub_config.timezone|default:"" }}';
      const initial = saved || DETECTED_LOCALE.tz;
      return {
          query: initial,
          selected: initial,
          open: false,
          highlighted: 0,

          get filtered() {
              if (!this.query) return TIMEZONES.slice(0, 30);
              const q = this.query.toLowerCase();
              return TIMEZONES.filter(tz => tz.toLowerCase().includes(q)).slice(0, 30);
          },

          select(tz) {
              this.query = tz;
              this.selected = tz;
              this.open = false;
          }
      };
  }

  /* Phone input Alpine component */
  function phoneInput() {
      const existingPhone = '{{ store_config.phone|default:"" }}';
      let initialCountry = COUNTRIES.find(c => c.code === DETECTED_LOCALE.country) || COUNTRIES[0];
      let initialNumber = '';

      if (existingPhone) {
          initialNumber = existingPhone;
          if (existingPhone.startsWith('+')) {
              const sorted = [...COUNTRIES].sort((a, b) => b.dial.length - a.dial.length);
              for (const c of sorted) {
                  if (existingPhone.startsWith(c.dial)) {
                      initialCountry = c;
                      initialNumber = existingPhone.slice(c.dial.length).trim();
                      break;
                  }
              }
          }
      }

      return {
          open: false,
          search: '',
          highlighted: 0,
          selectedCountry: initialCountry,
          number: initialNumber,

          get fullNumber() {
              if (!this.number.trim()) return '';
              return this.selectedCountry.dial + ' ' + this.number.trim();
          },

          get filteredCountries() {
              if (!this.search) return COUNTRIES;
              const q = this.search.toLowerCase();
              return COUNTRIES.filter(c =>
                  c.name.toLowerCase().includes(q) ||
                  c.dial.includes(q) ||
                  c.code.toLowerCase().includes(q)
              );
          },

          selectCountry(c) {
              this.selectedCountry = c;
              this.open = false;
              this.search = '';
          },

          toggle() {
              this.open = !this.open;
              if (this.open) {
                  this.$nextTick(() => this.$refs.searchInput?.focus());
              }
          }
      };
  }
</script>
{% endblock %}
