{% load i18n djicons %}

{% include "setup/partials/stepper.html" %}

{% if errors %}
<div class="callout callout-warning mb-4">
    {% for error in errors %}
    <p>{% icon "alert-circle-outline" %} {{ error }}</p>
    {% endfor %}
</div>
{% endif %}

<div class="stepper-content">
    <h2 class="text-xl font-semibold mb-1" data-i18n-en="Regional Settings" data-i18n-es="Configuración Regional">{% trans "Regional Settings" %}</h2>
    <p class="text-sm opacity-60 mb-6" data-i18n-en="Set your language, country, and timezone" data-i18n-es="Configura tu idioma, país y zona horaria">{% trans "Set your language, country, and timezone" %}</p>

    <form hx-post="{% url 'setup:step' step=1 %}"
          hx-target="#wizard-step-content"
          hx-swap="innerHTML">
        {% csrf_token %}

        <div class="flex flex-col gap-4">
            <div class="form-group">
                <label class="form-group-label" for="language" data-i18n-en="System Language" data-i18n-es="Idioma del sistema">{% trans "System Language" %}</label>
                <select class="select" name="language" id="language"
                        @change="
                            const lang = $el.value;
                            // Update stepper labels
                            const labels = {
                                en: ['Region', 'Modules', 'Business', 'Tax'],
                                es: ['Región', 'Módulos', 'Negocio', 'Impuestos']
                            };
                            const stepLabels = labels[lang] || labels['en'];
                            document.querySelectorAll('.stepper-label').forEach((el, i) => {
                                if (stepLabels[i]) el.textContent = stepLabels[i];
                            });
                            // Update all i18n elements on this page
                            document.querySelectorAll('[data-i18n-' + lang + ']').forEach(el => {
                                el.textContent = el.getAttribute('data-i18n-' + lang);
                            });
                        ">
                    {% for code, name in languages %}
                    <option value="{{ code }}" {% if hub_config.language == code or code == 'en' and not hub_config.language %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label class="form-group-label" for="country-search">{% trans "Country" %}</label>
                <div class="dropdown w-full"
                     x-data="countrySearch()"
                     @click.outside="open = false"
                     @keydown.escape="open = false"
                     :data-state="open ? 'open' : 'closed'">
                    <input type="search"
                           class="input w-full"
                           id="country-search"
                           x-model="query"
                           @focus="open = true; query = ''"
                           @input="open = true; highlighted = 0"
                           @keydown.arrow-down.prevent="highlighted = Math.min(highlighted + 1, filtered.length - 1)"
                           @keydown.arrow-up.prevent="highlighted = Math.max(highlighted - 1, 0)"
                           @keydown.enter.prevent="if (filtered.length) { selectCountry(filtered[highlighted]); }"
                           placeholder="{% trans 'Search country...' %}"
                           autocomplete="off">
                    <input type="hidden" name="country" :value="selected">
                    <div class="dropdown-menu dropdown-menu-full"
                         x-show="open && filtered.length > 0"
                         x-cloak
                         style="max-height: 240px; overflow-y: auto;">
                        <template x-for="(c, i) in filtered" :key="c.code">
                            <div class="dropdown-item"
                                 :class="{ 'dropdown-item-active': i === highlighted }"
                                 @click="selectCountry(c)"
                                 x-text="c.flag + ' ' + c.name"></div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-group-label" for="tz-search">{% trans "Timezone" %}</label>
                <div class="dropdown w-full"
                     x-data="tzSearch()"
                     @click.outside="open = false"
                     @keydown.escape="open = false"
                     :data-state="open ? 'open' : 'closed'">
                    <input type="search"
                           class="input w-full"
                           id="tz-search"
                           x-model="query"
                           @focus="open = true"
                           @input="open = true; highlighted = 0"
                           @keydown.arrow-down.prevent="highlighted = Math.min(highlighted + 1, filtered.length - 1)"
                           @keydown.arrow-up.prevent="highlighted = Math.max(highlighted - 1, 0)"
                           @keydown.enter.prevent="if (filtered.length) { select(filtered[highlighted]); }"
                           placeholder="{% trans 'Search timezone...' %}"
                           autocomplete="off">
                    <input type="hidden" name="timezone" :value="selected">
                    <div class="dropdown-menu dropdown-menu-full"
                         x-show="open && filtered.length > 0"
                         x-cloak
                         style="max-height: 240px; overflow-y: auto;">
                        <template x-for="(tz, i) in filtered" :key="tz">
                            <div class="dropdown-item"
                                 :class="{ 'dropdown-item-active': i === highlighted }"
                                 @click="select(tz)"
                                 x-text="tz"></div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div class="stepper-actions">
            <div class="stepper-actions-start"></div>
            <div class="stepper-actions-end">
                <button type="submit" class="btn color-primary">
                    {% trans "Continue" %}
                    {% icon "arrow-forward-outline" %}
                </button>
            </div>
        </div>
    </form>
</div>
