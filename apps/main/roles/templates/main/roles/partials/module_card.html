{% load i18n djicons %}
{# Module permission card with toggle and expandable permissions #}
{# Used both in detail.html and as HTMX swap target #}

<div class="accordion-item" :data-state="isOpen({{ forloop.counter0|default:0 }}) ? 'open' : 'closed'">
    <button class="accordion-header" @click="toggle({{ forloop.counter0|default:0 }})">
        <!-- Module toggle checkbox -->
        {% if role.name != 'admin' %}
        <label class="checkbox mr-2" @click.stop>
            <input type="checkbox"
                   class="checkbox-input"
                   {% if module.has_wildcard or module.is_full %}checked{% endif %}
                   {% if module.is_partial %}data-indeterminate="true"{% endif %}
                   hx-post="{% url 'main:roles:api_toggle_module' role_id=role.id module_id=module.id %}"
                   hx-target="#module-{{ module.id }}"
                   hx-swap="innerHTML">
            <span class="checkbox-box">
                <span class="checkbox-mark">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </span>
            </span>
        </label>
        {% else %}
        <label class="checkbox mr-2">
            <input type="checkbox" class="checkbox-input" checked disabled>
            <span class="checkbox-box">
                <span class="checkbox-mark">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </span>
            </span>
        </label>
        {% endif %}

        <!-- Module icon -->
        <span class="mr-3 shrink-0 opacity-60">
            {% icon module.icon %}
        </span>

        <!-- Module info -->
        <div class="flex-1 min-w-0 flex flex-col">
            <span class="accordion-title">{{ module.name }}</span>
            <span class="text-xs opacity-60">
                {% if module.has_wildcard %}
                <span class="badge color-primary badge-sm">{{ module.wildcard }}</span>
                {% else %}
                {{ module.active_count }}/{{ module.total_count }} {% trans "permissions" %}
                {% endif %}
            </span>
        </div>

        <!-- Chevron -->
        <span class="accordion-chevron">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
        </span>
    </button>

    <!-- Accordion Content: Permissions List -->
    <div class="accordion-body">
        <div>
            <div>
                {% if module.permissions %}
                <div class="list">
                    {% for perm in module.permissions %}
                    <div class="list-item">
                        {% if role.name != 'admin' %}
                        <label class="checkbox flex items-center gap-3 w-full cursor-pointer p-2">
                            <input type="checkbox"
                                   class="checkbox-input"
                                   {% if perm.codename in expanded_permissions %}checked{% endif %}
                                   hx-post="{% url 'main:roles:api_toggle_permission' role_id=role.id codename=perm.codename %}"
                                   hx-swap="none">
                            <span class="checkbox-box">
                                <span class="checkbox-mark">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </span>
                            </span>
                            <div class="flex-1 min-w-0 flex flex-col">
                                <span class="checkbox-label text-sm">{{ perm.name }}</span>
                                <span class="text-xs opacity-60">{{ perm.codename }}</span>
                                {% if perm.description %}
                                <span class="text-xs opacity-60">{{ perm.description }}</span>
                                {% endif %}
                            </div>
                        </label>
                        {% else %}
                        <label class="checkbox flex items-center gap-3 w-full cursor-pointer p-2">
                            <input type="checkbox" class="checkbox-input" checked disabled>
                            <span class="checkbox-box">
                                <span class="checkbox-mark">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </span>
                            </span>
                            <div class="flex-1 min-w-0 flex flex-col">
                                <span class="checkbox-label text-sm">{{ perm.name }}</span>
                                <span class="text-xs opacity-60">{{ perm.codename }}</span>
                                {% if perm.description %}
                                <span class="text-xs opacity-60">{{ perm.description }}</span>
                                {% endif %}
                            </div>
                        </label>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-base-content/60 text-sm p-4">{% trans "No permissions defined for this module." %}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
