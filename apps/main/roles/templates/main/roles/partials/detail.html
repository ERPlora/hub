{% load i18n ui component_tags %}

{% component "page" title=role.display_name back_hx_get="/roles/" back_hx_target="#main-content-area" back_hx_push_url="true" %}
    {% fill "content" %}
        <!-- Role info card -->
        {% ui_card %}
            <div class="d-flex justify-between align-start mb-md">
                <div>
                    <p class="fs-sm text-medium m-0">{{ role.description|default:_("No description") }}</p>
                    <div class="d-flex gap-xs mt-sm">
                        {% if role.is_system %}
                        {% ui_chip label=_("System") color="medium" %}
                        {% endif %}
                        {% if role.is_active %}
                        {% ui_chip label=_("Active") color="success" %}
                        {% else %}
                        {% ui_chip label=_("Inactive") color="warning" %}
                        {% endif %}
                        {% if '*' in wildcards %}
                        {% ui_chip label=_("Full Access") color="primary" %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-sm flex-wrap">
                {% if not role.is_system or role.name != 'admin' %}
                <a href="{% url 'main:roles:toggle_active' role_id=role.id %}"
                   hx-post="{% url 'main:roles:toggle_active' role_id=role.id %}"
                   hx-target="#main-content-area">
                    {% if role.is_active %}
                    {% ui_button label=_("Deactivate") icon="pause-outline" fill="outline" size="small" color="warning" %}
                    {% else %}
                    {% ui_button label=_("Activate") icon="play-outline" fill="outline" size="small" color="success" %}
                    {% endif %}
                </a>
                {% endif %}
                {% if not role.is_system %}
                <a href="{% url 'main:roles:edit' role_id=role.id %}"
                   hx-get="{% url 'main:roles:edit' role_id=role.id %}"
                   hx-target="#main-content-area"
                   hx-push-url="true">
                    {% ui_button label=_("Edit") icon="create-outline" fill="outline" size="small" %}
                </a>
                <a href="{% url 'main:roles:delete' role_id=role.id %}"
                   hx-get="{% url 'main:roles:delete' role_id=role.id %}"
                   hx-target="#main-content-area"
                   hx-push-url="true">
                    {% ui_button label=_("Delete") icon="trash-outline" fill="outline" size="small" color="danger" %}
                </a>
                {% endif %}
            </div>
        {% endui_card %}

        <!-- Module Permissions Section -->
        <h3 class="fw-semibold mt-lg mb-md">{% trans "Module Permissions" %}</h3>

        {% if role.name == 'admin' %}
        <div class="p-md bg-light border-radius-md mb-md">
            <div class="d-flex align-center gap-sm">
                <ion-icon name="shield-checkmark" class="fs-xl text-primary"></ion-icon>
                <div>
                    <p class="fw-semibold m-0">{% trans "Administrator Role" %}</p>
                    <p class="fs-sm text-medium m-0">{% trans "This role has full access to all permissions. Permissions cannot be modified." %}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% for module in modules %}
        <div id="module-{{ module.id }}" class="mb-md">
            {% include "main/roles/partials/module_card.html" with role=role module=module expanded_permissions=expanded_permissions %}
        </div>
        {% empty %}
        {% ui_empty_state title=_("No modules found") description=_("Sync permissions from modules first.") icon="cube-outline" action_label=_("Sync Permissions") action_url="/roles/sync-permissions/" %}
        {% endfor %}

        <!-- Manual Wildcards Section (for power users) -->
        {% if role.name != 'admin' %}
        {% ui_card title=_("Advanced: Custom Wildcards") css_class="mt-lg" %}
            <p class="fs-sm text-medium mb-md">{% trans "Add custom wildcard patterns for advanced permission rules (e.g., inventory.view_*, *.delete_*)." %}</p>

            <div class="d-flex flex-wrap gap-sm mb-md">
                {% for wildcard in wildcards %}
                {% if '.*' not in wildcard or wildcard == '*' %}
                <ion-chip color="tertiary">
                    <ion-label>{{ wildcard }}</ion-label>
                    {% if wildcard != '*' %}
                    <ion-icon name="close-circle"
                        hx-post="{% url 'main:roles:api_remove_wildcard' role_id=role.id wildcard=wildcard %}"
                        hx-target="#main-content-area"
                        hx-swap="innerHTML"
                        onclick="event.stopPropagation();"
                        style="cursor: pointer;"></ion-icon>
                    {% endif %}
                </ion-chip>
                {% endif %}
                {% empty %}
                <p class="text-medium fs-sm">{% trans "No custom wildcards." %}</p>
                {% endfor %}
            </div>

            <div class="d-flex gap-sm align-center"
                 x-data="{ wildcard: '' }">
                <ion-item class="flex-1">
                    <ion-input
                        type="text"
                        placeholder="{% trans 'e.g., inventory.view_*, *.export_*' %}"
                        x-model="wildcard"></ion-input>
                </ion-item>
                <ion-button size="small"
                    @click="
                        if (wildcard.includes('*')) {
                            fetch('{% url 'main:roles:api_add_wildcard' role_id=role.id %}', {
                                method: 'POST',
                                body: JSON.stringify({ wildcard: wildcard }),
                                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                            }).then(() => htmx.ajax('GET', window.location.href, {target: '#main-content-area'}));
                        }
                    ">
                    <ion-icon slot="start" name="add-outline"></ion-icon>
                    {% trans "Add" %}
                </ion-button>
            </div>
        {% endui_card %}
        {% endif %}
    {% endfill %}
{% endcomponent %}
