{% extends "layouts/module_page.html" %}
{% load i18n %}

{% block page_content %}
<ion-content>
    <div class="ion-padding">
        <!-- Role header -->
        <div class="card-info mb-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-xl font-semibold">{{ role.display_name }}</h1>
                    <p class="text-secondary mt-xs">{{ role.description|default:"-" }}</p>
                </div>
                <div class="flex gap-sm">
                    {% if not role.is_system or role.name != 'admin' %}
                    <ion-button href="{% url 'main:roles:toggle_active' role_id=role.id %}" fill="outline" size="small">
                        {% if role.is_active %}
                        <ion-icon slot="start" name="pause-outline"></ion-icon>
                        {% trans "Deactivate" %}
                        {% else %}
                        <ion-icon slot="start" name="play-outline"></ion-icon>
                        {% trans "Activate" %}
                        {% endif %}
                    </ion-button>
                    {% endif %}
                    {% if not role.is_system %}
                    <ion-button href="{% url 'main:roles:edit' role_id=role.id %}" fill="outline" size="small">
                        <ion-icon slot="start" name="create-outline"></ion-icon>
                        {% trans "Edit" %}
                    </ion-button>
                    <ion-button href="{% url 'main:roles:delete' role_id=role.id %}" color="danger" fill="outline" size="small">
                        <ion-icon slot="start" name="trash-outline"></ion-icon>
                        {% trans "Delete" %}
                    </ion-button>
                    {% endif %}
                </div>
            </div>
            <div class="flex gap-md mt-md">
                {% if role.is_system %}
                <ion-badge color="medium">{% trans "System Role" %}</ion-badge>
                {% endif %}
                {% if role.is_active %}
                <ion-badge color="success">{% trans "Active" %}</ion-badge>
                {% else %}
                <ion-badge color="warning">{% trans "Inactive" %}</ion-badge>
                {% endif %}
            </div>
        </div>

        <!-- Wildcards section -->
        <div class="card-form mb-lg">
            <h3 class="form-section-title">{% trans "Wildcard Permissions" %}</h3>
            <p class="text-secondary text-sm mb-md">{% trans "Wildcards grant multiple permissions at once. Use * for all, module.* for all module permissions." %}</p>

            <div class="flex flex-wrap gap-sm mb-md">
                {% for wildcard in wildcards %}
                <ion-chip color="primary">
                    <ion-label>{{ wildcard }}</ion-label>
                    {% if role.name != 'admin' or wildcard != '*' %}
                    <ion-icon name="close-circle"
                        hx-post="{% url 'main:roles:api_remove_wildcard' role_id=role.id wildcard=wildcard %}"
                        hx-swap="none"
                        hx-confirm="{% trans 'Remove this wildcard?' %}"></ion-icon>
                    {% endif %}
                </ion-chip>
                {% empty %}
                <p class="text-muted">{% trans "No wildcards configured." %}</p>
                {% endfor %}
            </div>

            {% if role.name != 'admin' %}
            <div class="flex gap-sm items-center" x-data="{ wildcard: '' }">
                <ion-input
                    type="text"
                    placeholder="{% trans 'e.g., inventory.*, sales.view_*' %}"
                    x-model="wildcard"
                    class="flex-1"></ion-input>
                <ion-button
                    size="small"
                    @click="
                        if (wildcard.includes('*')) {
                            htmx.ajax('POST', '{% url 'main:roles:api_add_wildcard' role_id=role.id %}', {
                                body: JSON.stringify({ wildcard: wildcard }),
                                headers: { 'Content-Type': 'application/json' }
                            }).then(() => location.reload());
                        }
                    ">
                    <ion-icon slot="start" name="add-outline"></ion-icon>
                    {% trans "Add" %}
                </ion-button>
            </div>
            {% endif %}
        </div>

        <!-- Permissions by module -->
        <h3 class="form-section-title">{% trans "Individual Permissions" %}</h3>

        {% for module_id, perms in permissions_by_module.items %}
        <ion-accordion-group class="mb-md">
            <ion-accordion value="{{ module_id }}">
                <ion-item slot="header">
                    <ion-label>
                        <strong>{{ module_id|title }}</strong>
                        <p class="text-sm text-secondary">{{ perms|length }} {% trans "permissions" %}</p>
                    </ion-label>
                </ion-item>
                <div slot="content" class="ion-padding">
                    <ion-list class="list-clean">
                        {% for perm in perms %}
                        <ion-item>
                            <ion-checkbox
                                slot="start"
                                {% if perm.codename in role_permissions %}checked{% endif %}
                                {% if role.name == 'admin' %}disabled{% endif %}
                                @ionChange="
                                    htmx.ajax('POST', '{% url 'main:roles:api_permissions' role_id=role.id %}', {
                                        body: JSON.stringify({
                                            [this.checked ? 'add' : 'remove']: ['{{ perm.codename }}']
                                        }),
                                        headers: { 'Content-Type': 'application/json' }
                                    });
                                "></ion-checkbox>
                            <ion-label>
                                <h3>{{ perm.name }}</h3>
                                <p class="text-sm text-secondary">{{ perm.codename }}</p>
                                {% if perm.description %}
                                <p class="text-xs text-muted">{{ perm.description }}</p>
                                {% endif %}
                            </ion-label>
                        </ion-item>
                        {% endfor %}
                    </ion-list>
                </div>
            </ion-accordion>
        </ion-accordion-group>
        {% empty %}
        <div class="empty-state--compact">
            <ion-icon name="key-outline"></ion-icon>
            <p>{% trans "No permissions found. Sync permissions from modules first." %}</p>
            <ion-button href="{% url 'main:roles:sync_permissions' %}" size="small">
                <ion-icon slot="start" name="sync-outline"></ion-icon>
                {% trans "Sync Permissions" %}
            </ion-button>
        </div>
        {% endfor %}
    </div>
</ion-content>
{% endblock %}
