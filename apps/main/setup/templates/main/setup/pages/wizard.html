{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ERPlora Hub - {% trans "Setup" %}{% endblock %}

{% block extra_css %}
<style>
    .setup-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .setup-card {
        width: 100%;
        max-width: 600px;
        margin: 0;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--ion-color-medium);
        transition: all 0.3s;
    }

    .step-dot.active {
        background: var(--ion-color-primary);
        transform: scale(1.2);
    }

    .step-dot.completed {
        background: var(--ion-color-success);
    }

    .step-content {
        min-height: 300px;
    }

    .fade-enter {
        opacity: 0;
        transform: translateX(20px);
    }

    .fade-enter-active {
        opacity: 1;
        transform: translateX(0);
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="setup-container" x-data="setupWizard()">
    <ion-card class="setup-card">
        <!-- Header -->
        <ion-card-header class="text-center">
            <img src="{% static 'img/logo.png' %}" alt="ERPlora" style="width: 48px; height: 48px; margin: 0 auto 0.5rem;">
            <ion-card-title class="text-2xl">{% trans "Welcome to ERPlora" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Let's configure your store" %}</ion-card-subtitle>
        </ion-card-header>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <template x-for="i in 3" :key="i">
                <div
                    class="step-dot"
                    :class="{
                        'active': currentStep === i,
                        'completed': currentStep > i
                    }"
                ></div>
            </template>
        </div>

        <ion-card-content>
            <!-- Step 1: Business Info -->
            <div x-show="currentStep === 1" x-transition:enter="fade-enter" x-transition:enter-start="fade-enter" x-transition:enter-end="fade-enter-active" class="step-content">
                <h2 class="text-xl font-semibold mb-4 text-center">
                    <ion-icon name="business-outline" class="mr-2"></ion-icon>
                    {% trans "Business Information" %}
                </h2>
                <p class="text-medium text-center mb-6">{% trans "Enter your business details for invoices and receipts" %}</p>

                <ion-list>
                    <ion-item>
                        <ion-input
                            type="text"
                            label="{% trans 'Business Name' %} *"
                            label-placement="floating"
                            x-model="business.name"
                            placeholder="{% trans 'Your business name' %}"
                            required
                        ></ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-textarea
                            label="{% trans 'Address' %} *"
                            label-placement="floating"
                            x-model="business.address"
                            rows="2"
                            placeholder="{% trans 'Street, City, Postal Code' %}"
                            required
                        ></ion-textarea>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            type="text"
                            label="{% trans 'VAT/Tax ID' %} *"
                            label-placement="floating"
                            x-model="business.vat"
                            placeholder="{% trans 'e.g., ES12345678A' %}"
                            required
                        ></ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            type="tel"
                            label="{% trans 'Phone' %}"
                            label-placement="floating"
                            x-model="business.phone"
                            placeholder="+34 600 000 000"
                        ></ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-input
                            type="email"
                            label="{% trans 'Email' %}"
                            label-placement="floating"
                            x-model="business.email"
                            placeholder="info@business.com"
                        ></ion-input>
                    </ion-item>
                </ion-list>

                <p class="text-sm text-medium mt-4 text-center">* {% trans "Required fields" %}</p>
            </div>

            <!-- Step 2: Tax Configuration -->
            <div x-show="currentStep === 2" x-transition:enter="fade-enter" x-transition:enter-start="fade-enter" x-transition:enter-end="fade-enter-active" class="step-content">
                <h2 class="text-xl font-semibold mb-4 text-center">
                    <ion-icon name="calculator-outline" class="mr-2"></ion-icon>
                    {% trans "Tax Configuration" %}
                </h2>
                <p class="text-medium text-center mb-6">{% trans "Configure how taxes are handled in your store" %}</p>

                <ion-list>
                    <ion-item>
                        <ion-input
                            type="number"
                            label="{% trans 'Tax Rate (%)' %}"
                            label-placement="floating"
                            x-model="tax.rate"
                            placeholder="21"
                            min="0"
                            max="100"
                            step="0.01"
                        ></ion-input>
                    </ion-item>

                    <ion-item>
                        <ion-toggle
                            x-model="tax.included"
                            :checked="tax.included"
                            @ionChange="tax.included = $event.detail.checked"
                        >
                            {% trans "Tax included in prices" %}
                        </ion-toggle>
                    </ion-item>
                </ion-list>

                <div class="ion-padding text-center">
                    <ion-chip :color="tax.included ? 'success' : 'warning'">
                        <ion-icon :name="tax.included ? 'checkmark-circle' : 'add-circle'" slot="start"></ion-icon>
                        <ion-label x-text="tax.included ? '{% trans 'Prices include tax' %}' : '{% trans 'Tax will be added at checkout' %}'"></ion-label>
                    </ion-chip>
                </div>
            </div>

            <!-- Step 3: Receipt Configuration -->
            <div x-show="currentStep === 3" x-transition:enter="fade-enter" x-transition:enter-start="fade-enter" x-transition:enter-end="fade-enter-active" class="step-content">
                <h2 class="text-xl font-semibold mb-4 text-center">
                    <ion-icon name="receipt-outline" class="mr-2"></ion-icon>
                    {% trans "Receipt Configuration" %}
                </h2>
                <p class="text-medium text-center mb-6">{% trans "Customize your receipt appearance" %}</p>

                <ion-list>
                    <ion-item>
                        <ion-textarea
                            label="{% trans 'Receipt Header' %}"
                            label-placement="floating"
                            x-model="receipt.header"
                            rows="2"
                            placeholder="{% trans 'Welcome message or promotional text' %}"
                        ></ion-textarea>
                    </ion-item>

                    <ion-item>
                        <ion-textarea
                            label="{% trans 'Receipt Footer' %}"
                            label-placement="floating"
                            x-model="receipt.footer"
                            rows="2"
                            placeholder="{% trans 'Thank you message or return policy' %}"
                        ></ion-textarea>
                    </ion-item>
                </ion-list>

                <div class="ion-padding">
                    <ion-card class="m-0" style="background: var(--ion-color-light);">
                        <ion-card-content class="text-center text-sm" style="font-family: monospace;">
                            <div x-show="receipt.header" x-text="receipt.header" class="mb-2"></div>
                            <div class="text-medium">--- {% trans "Receipt Preview" %} ---</div>
                            <div x-show="receipt.footer" x-text="receipt.footer" class="mt-2"></div>
                        </ion-card-content>
                    </ion-card>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="flex justify-between items-center mt-6 gap-4">
                <ion-button
                    fill="outline"
                    x-show="currentStep > 1"
                    @click="prevStep()"
                    :disabled="loading"
                >
                    <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
                    {% trans "Back" %}
                </ion-button>

                <div x-show="currentStep === 1" class="flex-1"></div>

                <div class="flex gap-2">
                    <ion-button
                        fill="clear"
                        x-show="currentStep > 1 && canFinish"
                        @click="skipToFinish()"
                        :disabled="loading"
                    >
                        {% trans "Skip & Finish" %}
                    </ion-button>

                    <ion-button
                        x-show="currentStep < 3"
                        @click="nextStep()"
                        :disabled="loading || (currentStep === 1 && !isStep1Valid)"
                    >
                        <span x-show="!loading">{% trans "Next" %}</span>
                        <ion-spinner x-show="loading" name="crescent"></ion-spinner>
                        <ion-icon name="arrow-forward-outline" slot="end" x-show="!loading"></ion-icon>
                    </ion-button>

                    <ion-button
                        color="success"
                        x-show="currentStep === 3"
                        @click="finish()"
                        :disabled="loading"
                    >
                        <span x-show="!loading">{% trans "Finish Setup" %}</span>
                        <ion-spinner x-show="loading" name="crescent"></ion-spinner>
                        <ion-icon name="checkmark-circle-outline" slot="end" x-show="!loading"></ion-icon>
                    </ion-button>
                </div>
            </div>
        </ion-card-content>
    </ion-card>
</div>
{% endblock %}

{% block scripts %}
<script>
    function setupWizard() {
        return {
            currentStep: 1,
            loading: false,
            canFinish: false,

            // Step 1: Business Info
            business: {
                name: '{{ store_config.business_name|escapejs }}',
                address: '{{ store_config.business_address|escapejs }}',
                vat: '{{ store_config.vat_number|escapejs }}',
                phone: '{{ store_config.phone|escapejs }}',
                email: '{{ store_config.email|escapejs }}',
                website: '{{ store_config.website|escapejs }}'
            },

            // Step 2: Tax Config
            tax: {
                rate: '{{ store_config.tax_rate|default:"21" }}',
                included: {{ store_config.tax_included|yesno:"true,false" }}
            },

            // Step 3: Receipt Config
            receipt: {
                header: '{{ store_config.receipt_header|escapejs }}',
                footer: '{{ store_config.receipt_footer|escapejs }}'
            },

            get isStep1Valid() {
                return this.business.name.trim() &&
                       this.business.address.trim() &&
                       this.business.vat.trim();
            },

            async nextStep() {
                if (this.loading) return;

                this.loading = true;

                try {
                    let action, body;

                    if (this.currentStep === 1) {
                        action = 'save_business';
                        body = new URLSearchParams({
                            action: action,
                            business_name: this.business.name,
                            business_address: this.business.address,
                            vat_number: this.business.vat,
                            phone: this.business.phone,
                            email: this.business.email,
                            website: this.business.website
                        });
                    } else if (this.currentStep === 2) {
                        action = 'save_tax';
                        body = new URLSearchParams({
                            action: action,
                            tax_rate: this.tax.rate,
                            tax_included: this.tax.included
                        });
                    }

                    const response = await fetch('{% url "setup:wizard" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: body
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.currentStep = data.next_step;
                        if (data.can_finish !== undefined) {
                            this.canFinish = data.can_finish;
                        }
                    } else {
                        await this.showToast(data.error || 'Error saving', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await this.showToast('{% trans "Connection error" %}', 'danger');
                } finally {
                    this.loading = false;
                }
            },

            prevStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                }
            },

            async finish() {
                if (this.loading) return;

                this.loading = true;

                try {
                    // Save step 3 first
                    await fetch('{% url "setup:wizard" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: new URLSearchParams({
                            action: 'save_receipt',
                            receipt_header: this.receipt.header,
                            receipt_footer: this.receipt.footer
                        })
                    });

                    // Then finish
                    const response = await fetch('{% url "setup:wizard" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: new URLSearchParams({ action: 'finish' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        await this.showToast('{% trans "Setup complete!" %}', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 500);
                    } else {
                        await this.showToast(data.error || 'Error', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await this.showToast('{% trans "Connection error" %}', 'danger');
                } finally {
                    this.loading = false;
                }
            },

            async skipToFinish() {
                if (this.loading || !this.canFinish) return;

                this.loading = true;

                try {
                    const response = await fetch('{% url "setup:wizard" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: new URLSearchParams({ action: 'skip' })
                    });

                    const data = await response.json();

                    if (data.success) {
                        await this.showToast('{% trans "Setup complete!" %}', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 500);
                    } else {
                        await this.showToast(data.error || 'Error', 'danger');
                    }
                } catch (error) {
                    console.error('Error:', error);
                } finally {
                    this.loading = false;
                }
            },

            async showToast(message, color = 'primary') {
                const toast = document.createElement('ion-toast');
                toast.message = message;
                toast.duration = 2000;
                toast.color = color;
                document.body.appendChild(toast);
                await toast.present();
            }
        }
    }
</script>
{% endblock %}
