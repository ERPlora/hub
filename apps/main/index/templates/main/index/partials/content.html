{% load i18n %}
{% load ui %}

{% if request.htmx %}
<!-- Clear tab bar for home - home doesn't have module tabs -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML"></div>
{% endif %}

<div class="ion-padding" x-data="moduleGrid()">
    {% ui_page_header title=_("Home") subtitle=_("Welcome to ERPlora Hub") %}

    <!-- Search Bar -->
    <div class="module-searchbar">
        <ion-searchbar
            placeholder="{% trans 'Search modules...' %}"
            @ionInput="filterModules($event)"
            debounce="300">
        </ion-searchbar>
    </div>

    <!-- Favorites Section (only if there are favorites) -->
    <template x-if="favoritesData.length > 0">
        <div class="module-section">
            <div class="module-section__header">
                <ion-icon name="star" class="module-section__icon"></ion-icon>
                <h3 class="module-section__title">{% trans "Favorites" %}</h3>
            </div>
            <div class="module-grid">
                <template x-for="mod in favoritesData" :key="'fav-' + mod.id">
                    <div class="module-app-icon"
                         :hx-get="mod.url"
                         hx-target="#main-content-area"
                         hx-push-url="true"
                         @click="trackRecent(mod.id)">
                        <div class="module-app-icon__image"
                             :class="'module-app-icon__image--' + mod.color">
                            <ion-icon :name="mod.icon"></ion-icon>
                        </div>
                        <span class="module-app-icon__label" x-text="mod.label"></span>
                        <ion-icon name="star" class="module-app-icon__favorite"></ion-icon>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <!-- Recent Section (only if there are recent modules) -->
    <template x-if="recentData.length > 0">
        <div class="module-section">
            <div class="module-section__header">
                <ion-icon name="time-outline" class="module-section__icon"></ion-icon>
                <h3 class="module-section__title">{% trans "Recent" %}</h3>
            </div>
            <div class="module-grid">
                <template x-for="mod in recentData" :key="'recent-' + mod.id">
                    <div class="module-app-icon"
                         :hx-get="mod.url"
                         hx-target="#main-content-area"
                         hx-push-url="true"
                         @click="trackRecent(mod.id)">
                        <div class="module-app-icon__image"
                             :class="'module-app-icon__image--' + mod.color">
                            <ion-icon :name="mod.icon"></ion-icon>
                        </div>
                        <span class="module-app-icon__label" x-text="mod.label"></span>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <!-- All Modules Section -->
    <div class="module-section">
        <div class="module-section__header">
            <ion-icon name="apps-outline" class="module-section__icon"></ion-icon>
            <h3 class="module-section__title">{% trans "All Modules" %}</h3>
        </div>
        <div class="module-grid">
            <!-- Dynamic modules from Alpine.js -->
            <template x-for="mod in filteredModules" :key="mod.id">
                <div class="module-app-icon"
                     :hx-get="mod.url"
                     hx-target="#main-content-area"
                     hx-push-url="true"
                     :data-module-id="mod.id"
                     @click="trackRecent(mod.id)"
                     @contextmenu.prevent="toggleFavorite(mod.id)">
                    <div class="module-app-icon__image"
                         :class="'module-app-icon__image--' + mod.color">
                        <ion-icon :name="mod.icon"></ion-icon>
                    </div>
                    <span class="module-app-icon__label" x-text="mod.label"></span>
                    <template x-if="isFavorite(mod.id)">
                        <ion-icon name="star" class="module-app-icon__favorite"></ion-icon>
                    </template>
                </div>
            </template>

            <!-- Add More Modules button -->
            <div class="module-app-icon module-app-icon--add"
                 hx-get="/store/modules/marketplace/"
                 hx-target="#main-content-area"
                 hx-push-url="true">
                <div class="module-app-icon__image">
                    <ion-icon name="add"></ion-icon>
                </div>
                <span class="module-app-icon__label">{% trans "Get More" %}</span>
            </div>
        </div>
    </div>

    <!-- Empty state when no modules and no search -->
    <template x-if="modules.length === 0">
        <div class="ui-empty-state">
            <ion-icon name="extension-puzzle-outline" class="ui-empty-state-icon"></ion-icon>
            <h3 class="ui-empty-state-title">{% trans "No modules installed" %}</h3>
            <p class="ui-empty-state-description">{% trans "Visit the Module Store to add functionality to your Hub." %}</p>
            <ion-button
                hx-get="/store/modules/marketplace/"
                hx-target="#main-content-area"
                hx-push-url="true">
                <ion-icon slot="start" name="storefront-outline"></ion-icon>
                {% trans "Browse Module Store" %}
            </ion-button>
        </div>
    </template>
</div>

<!-- Alpine.js Module Grid Logic -->
<script>
(function() {
    const modulesData = {{ modules_json|safe }};

    // Define moduleGrid function globally FIRST
    window.moduleGrid = function() {
        return {
            modules: modulesData,
            favorites: JSON.parse(localStorage.getItem('erplora_favorite_modules') || '[]'),
            recent: JSON.parse(localStorage.getItem('erplora_recent_modules') || '[]'),
            searchQuery: '',

            get filteredModules() {
                if (!this.searchQuery) {
                    return this.modules;
                }
                const query = this.searchQuery.toLowerCase();
                return this.modules.filter(mod =>
                    mod.label.toLowerCase().includes(query)
                );
            },

            get favoritesData() {
                return this.modules.filter(mod => this.favorites.includes(mod.id));
            },

            get recentData() {
                // Get last 4 recent modules that exist and are not in favorites
                return this.recent
                    .filter(id => !this.favorites.includes(id))
                    .map(id => this.modules.find(mod => mod.id === id))
                    .filter(mod => mod !== undefined)
                    .slice(0, 4);
            },

            filterModules(event) {
                this.searchQuery = event.target.value || '';
            },

            isFavorite(moduleId) {
                return this.favorites.includes(moduleId);
            },

            toggleFavorite(moduleId) {
                const index = this.favorites.indexOf(moduleId);
                if (index === -1) {
                    this.favorites.push(moduleId);
                } else {
                    this.favorites.splice(index, 1);
                }
                localStorage.setItem('erplora_favorite_modules', JSON.stringify(this.favorites));
            },

            trackRecent(moduleId) {
                // Remove if already in recent
                const index = this.recent.indexOf(moduleId);
                if (index !== -1) {
                    this.recent.splice(index, 1);
                }
                // Add to beginning
                this.recent.unshift(moduleId);
                // Keep only last 8
                this.recent = this.recent.slice(0, 8);
                localStorage.setItem('erplora_recent_modules', JSON.stringify(this.recent));
            }
        };
    };

    // Initialize Alpine on the element after script loads (for HTMX partial loads)
    requestAnimationFrame(() => {
        const el = document.querySelector('[x-data="moduleGrid()"]');
        if (el && typeof Alpine !== 'undefined' && !el._x_dataStack) {
            Alpine.initTree(el);
        }
    });
})();
</script>
