{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "dashboard/partials/tabbar_main.html" %}
</div>
{% endif %}

<div class="ion-padding" x-data="settingsApp()">
    <h1 class="text-2xl font-bold mb-6">{% trans "Settings" %}</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Store Information (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    {% trans "Store Information" %}
                    {% if not store_config.is_configured %}
                    <ion-chip color="warning" class="ml-2">{% trans "Required" %}</ion-chip>
                    {% endif %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Business details for invoices and receipts" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveStoreSettings()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Basic Info -->
                        <div>
                            <ion-list>
                                <!-- Business Name -->
                                <ion-item>
                                    <ion-input
                                        type="text"
                                        label="{% trans 'Business Name' %} *"
                                        label-placement="floating"
                                        :value="store.business_name"
                                        @ionInput="store.business_name = $event.target.value"
                                        placeholder="{% trans 'Your business name' %}"
                                    ></ion-input>
                                </ion-item>

                                <!-- Business Address -->
                                <ion-item>
                                    <ion-textarea
                                        label="{% trans 'Address' %} *"
                                        label-placement="floating"
                                        :value="store.business_address"
                                        @ionInput="store.business_address = $event.target.value"
                                        rows="2"
                                        placeholder="{% trans 'Street, City, Postal Code' %}"
                                    ></ion-textarea>
                                </ion-item>

                                <!-- VAT Number -->
                                <ion-item>
                                    <ion-input
                                        type="text"
                                        label="{% trans 'VAT/Tax ID' %} *"
                                        label-placement="floating"
                                        :value="store.vat_number"
                                        @ionInput="store.vat_number = $event.target.value"
                                        placeholder="{% trans 'e.g., ES12345678A' %}"
                                    ></ion-input>
                                </ion-item>

                                <!-- Phone -->
                                <ion-item>
                                    <ion-input
                                        type="tel"
                                        label="{% trans 'Phone' %}"
                                        label-placement="floating"
                                        :value="store.phone"
                                        @ionInput="store.phone = $event.target.value"
                                        placeholder="+34 600 000 000"
                                    ></ion-input>
                                </ion-item>

                                <!-- Email -->
                                <ion-item>
                                    <ion-input
                                        type="email"
                                        label="{% trans 'Email' %}"
                                        label-placement="floating"
                                        :value="store.email"
                                        @ionInput="store.email = $event.target.value"
                                        placeholder="info@business.com"
                                    ></ion-input>
                                </ion-item>

                                <!-- Website -->
                                <ion-item>
                                    <ion-input
                                        type="url"
                                        label="{% trans 'Website' %}"
                                        label-placement="floating"
                                        :value="store.website"
                                        @ionInput="store.website = $event.target.value"
                                        placeholder="https://www.business.com"
                                    ></ion-input>
                                </ion-item>
                            </ion-list>
                        </div>

                        <!-- Right Column: Tax & Receipt -->
                        <div>
                            <ion-list>
                                <!-- Logo -->
                                <ion-item>
                                    <ion-label>{% trans "Logo" %}</ion-label>
                                    <div class="flex items-center gap-4 py-2 w-full">
                                        <div class="w-16 h-16 border rounded flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                                            {% if store_config.logo %}
                                            <img src="{{ store_config.logo.url }}" alt="Logo" class="max-w-full max-h-full object-contain" id="logo-preview">
                                            {% else %}
                                            <ion-icon name="image-outline" class="text-3xl text-gray-400" id="logo-preview"></ion-icon>
                                            {% endif %}
                                        </div>
                                        <input type="file" id="logo-input" accept="image/*" class="hidden" @change="handleLogoChange">
                                        <ion-button fill="outline" size="small" @click="document.getElementById('logo-input').click()">
                                            {% trans "Upload" %}
                                        </ion-button>
                                    </div>
                                </ion-item>

                                <!-- Tax Rate -->
                                <ion-item>
                                    <ion-input
                                        type="number"
                                        label="{% trans 'Tax Rate (%)' %}"
                                        label-placement="floating"
                                        x-model="store.tax_rate"
                                        step="0.01"
                                        min="0"
                                        max="100"
                                        placeholder="21.00"
                                    ></ion-input>
                                </ion-item>

                                <!-- Tax Included -->
                                <ion-item>
                                    <ion-label>{% trans "Tax included in prices" %}</ion-label>
                                    <ion-toggle slot="end" :checked="store.tax_included" :color="store.tax_included ? 'success' : 'warning'" @ionChange="store.tax_included = $event.detail.checked"></ion-toggle>
                                </ion-item>
                            </ion-list>
                        </div>
                    </div>

                    <ion-button type="submit" expand="block" class="mt-4" :disabled="saving">
                        <ion-spinner x-show="saving" name="crescent" class="mr-2"></ion-spinner>
                        {% trans "Save Store Settings" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Tax Classes (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="receipt-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Tax Classes" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Configure tax rates according to your country's legislation" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <!-- Tax Classes List -->
                <div class="mb-4">
                    <template x-if="taxClasses.length === 0">
                        <div class="text-center py-8" style="color: var(--ion-color-medium);">
                            <ion-icon name="alert-circle-outline" class="text-4xl mb-2"></ion-icon>
                            <p class="mb-2">{% trans "No tax classes configured" %}</p>
                            <p class="text-sm">{% trans "Create tax types according to your country (e.g., Standard 21%, Reduced 10%, Exempt 0%)" %}</p>
                        </div>
                    </template>

                    <ion-list x-show="taxClasses.length > 0">
                        <template x-for="tc in taxClasses" :key="tc.id">
                            <ion-item>
                                <ion-label>
                                    <h2 x-text="tc.name"></h2>
                                    <p>
                                        <span x-text="tc.rate + '%'"></span>
                                        <template x-if="tc.description">
                                            <span x-text="' - ' + tc.description"></span>
                                        </template>
                                    </p>
                                </ion-label>
                                <ion-chip slot="end" color="success" x-show="tc.is_default">
                                    {% trans "Default" %}
                                </ion-chip>
                                <ion-button slot="end" fill="clear" @click="editTaxClass(tc)">
                                    <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                                </ion-button>
                                <ion-button slot="end" fill="clear" color="danger" @click="deleteTaxClass(tc)">
                                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                </ion-button>
                            </ion-item>
                        </template>
                    </ion-list>
                </div>

                <!-- Add Tax Class Form -->
                <div class="border-t pt-4" style="border-color: var(--ion-color-light);">
                    <h3 class="font-medium mb-3" x-text="editingTaxClass ? '{% trans "Edit Tax Class" %}' : '{% trans "Add Tax Class" %}'"></h3>
                    <form @submit.prevent="saveTaxClass()">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <ion-item>
                                <ion-input
                                    type="text"
                                    label="{% trans 'Name' %} *"
                                    label-placement="floating"
                                    x-model="taxForm.name"
                                    placeholder="{% trans 'e.g., Standard 21%' %}"
                                    required
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-input
                                    type="number"
                                    label="{% trans 'Rate (%)' %} *"
                                    label-placement="floating"
                                    x-model="taxForm.rate"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    placeholder="21.00"
                                    required
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-input
                                    type="text"
                                    label="{% trans 'Description' %}"
                                    label-placement="floating"
                                    x-model="taxForm.description"
                                    placeholder="{% trans 'Optional notes' %}"
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-label>{% trans "Set as default" %}</ion-label>
                                <ion-toggle slot="end" x-model="taxForm.is_default"></ion-toggle>
                            </ion-item>
                        </div>

                        <div class="flex gap-2 mt-4">
                            <ion-button type="submit" :disabled="savingTax || !taxForm.name">
                                <ion-spinner x-show="savingTax" name="crescent" class="mr-2"></ion-spinner>
                                <span x-text="editingTaxClass ? '{% trans "Update" %}' : '{% trans "Add Tax Class" %}'"></span>
                            </ion-button>
                            <ion-button fill="outline" x-show="editingTaxClass" @click="cancelEditTaxClass()">
                                {% trans "Cancel" %}
                            </ion-button>
                        </div>
                    </form>
                </div>

                <!-- Examples -->
                <div class="mt-4 p-3 rounded-lg text-sm" style="background: var(--ion-color-light);">
                    <p class="font-medium mb-1">{% trans "Examples by country:" %}</p>
                    <ul class="list-disc list-inside" style="color: var(--ion-color-medium);">
                        <li>Spain: General 21%, Reduced 10%, Super-reduced 4%, Exempt 0%</li>
                        <li>Germany: Standard 19%, Reduced 7%</li>
                        <li>France: Normal 20%, Intermediate 10%, Reduced 5.5%</li>
                        <li>UK: Standard 20%, Reduced 5%, Zero 0%</li>
                    </ul>
                </div>
            </ion-card-content>
        </ion-card>

        <!-- User Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "User Preferences" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveUserSettings()">
                    <ion-list>
                        <!-- Language -->
                        <ion-item>
                            <ion-select
                                label="{% trans 'Language' %}"
                                label-placement="floating"
                                x-model="language"
                                interface="popover"
                            >
                                {% for code, name in language_choices %}
                                <ion-select-option value="{{ code }}" {% if user.language == code %}selected{% endif %}>{{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <!-- Avatar -->
                        <ion-item>
                            <ion-label>{% trans "Avatar" %}</ion-label>
                            <div class="flex items-center gap-4 py-2">
                                <ion-avatar>
                                    {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" alt="{{ user.name }}">
                                    {% else %}
                                    <div class="w-full h-full bg-primary flex items-center justify-center text-white font-bold">
                                        {{ user.get_initials }}
                                    </div>
                                    {% endif %}
                                </ion-avatar>
                                <input type="file" id="avatar-input" accept="image/*" class="hidden" @change="handleAvatarChange">
                                <ion-button fill="outline" size="small" @click="document.getElementById('avatar-input').click()">
                                    {% trans "Change" %}
                                </ion-button>
                            </div>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4" :disabled="saving">
                        <ion-spinner x-show="saving" name="crescent" class="mr-2"></ion-spinner>
                        {% trans "Save Preferences" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Settings" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveHubSettings()">
                    <ion-list>
                        <!-- Currency -->
                        <ion-item>
                            <ion-select
                                label="{% trans 'Currency' %}"
                                label-placement="floating"
                                x-model="currency"
                                interface="action-sheet"
                                placeholder="{% trans 'Select currency' %}"
                            >
                                {% for code, name in currency_choices %}
                                <ion-select-option value="{{ code }}" {% if hub_config.currency == code %}selected{% endif %}>{{ code }} - {{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <!-- Dark Mode -->
                        <ion-item>
                            <ion-label>{% trans "Dark Mode" %}</ion-label>
                            <ion-toggle slot="end" :checked="isDark" :color="isDark ? 'success' : 'warning'" @ionChange="toggleTheme($event)"></ion-toggle>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4" :disabled="saving">
                        <ion-spinner x-show="saving" name="crescent" class="mr-2"></ion-spinner>
                        {% trans "Save Hub Settings" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Information -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Information" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Hub ID" %}</h3>
                            <p class="font-mono text-xs">{{ hub_config.hub_id|default:"Not configured" }}</p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Status" %}</h3>
                            <p>
                                {% if hub_config.is_configured %}
                                <ion-chip color="success">{% trans "Connected" %}</ion-chip>
                                {% else %}
                                <ion-chip color="warning">{% trans "Not configured" %}</ion-chip>
                                {% endif %}
                            </p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Version" %}</h3>
                            <p>1.0.0</p>
                        </ion-label>
                    </ion-item>
                </ion-list>
            </ion-card-content>
        </ion-card>

        <!-- Cloud Connection -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Cloud Connection" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Cloud URL" %}</h3>
                            <p class="font-mono text-xs">{{ CLOUD_URL }}</p>
                        </ion-label>
                    </ion-item>
                </ion-list>

                <ion-button expand="block" fill="outline" class="mt-4" href="{{ CLOUD_URL }}" target="_blank">
                    <ion-icon slot="start" name="open-outline"></ion-icon>
                    {% trans "Open Cloud Portal" %}
                </ion-button>
            </ion-card-content>
        </ion-card>

        <!-- Database Maintenance (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="build-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Database Maintenance" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Clean up orphaned data from deleted modules" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <p class="text-sm text-medium mb-4">
                    {% trans "Scan for and remove orphaned database tables, migration records, and media files left behind by deleted modules." %}
                </p>

                <ion-button
                    fill="outline"
                    hx-get="{% url 'configuration:scan_orphaned_data' %}"
                    hx-target="#scan-results"
                    hx-indicator="#scan-spinner">
                    <ion-icon slot="start" name="search-outline"></ion-icon>
                    {% trans "Scan for Orphaned Data" %}
                    <ion-spinner id="scan-spinner" name="crescent" class="htmx-indicator ml-2" style="display: none;"></ion-spinner>
                </ion-button>

                <div id="scan-results" class="mt-4"></div>
            </ion-card-content>
        </ion-card>

        <!-- Automatic Backups (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="cloud-upload-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Automatic Backups" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Schedule automatic database backups" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveBackupSettings()">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Schedule Settings -->
                        <div>
                            <ion-list>
                                <!-- Enable Backups -->
                                <ion-item>
                                    <ion-label>{% trans "Enable automatic backups" %}</ion-label>
                                    <ion-toggle
                                        slot="end"
                                        :checked="backup.enabled"
                                        :color="backup.enabled ? 'success' : 'warning'"
                                        @ionChange="backup.enabled = $event.detail.checked"
                                    ></ion-toggle>
                                </ion-item>

                                <!-- Frequency -->
                                <ion-item>
                                    <ion-select
                                        label="{% trans 'Frequency' %}"
                                        label-placement="floating"
                                        x-model="backup.frequency"
                                        interface="popover"
                                        :disabled="!backup.enabled"
                                    >
                                        {% for value, label in backup_frequency_choices %}
                                        <ion-select-option value="{{ value }}">{{ label }}</ion-select-option>
                                        {% endfor %}
                                    </ion-select>
                                </ion-item>

                                <!-- Time (Hour) -->
                                <ion-item>
                                    <ion-select
                                        label="{% trans 'Backup Time' %}"
                                        label-placement="floating"
                                        x-model="backup.time_hour"
                                        interface="popover"
                                        :disabled="!backup.enabled"
                                    >
                                        {% for hour in "0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23"|make_list %}
                                        <option value="{{ hour }}">{{ hour }}:00</option>
                                        {% endfor %}
                                        <ion-select-option value="0">00:00</ion-select-option>
                                        <ion-select-option value="1">01:00</ion-select-option>
                                        <ion-select-option value="2">02:00</ion-select-option>
                                        <ion-select-option value="3">03:00</ion-select-option>
                                        <ion-select-option value="4">04:00</ion-select-option>
                                        <ion-select-option value="5">05:00</ion-select-option>
                                        <ion-select-option value="6">06:00</ion-select-option>
                                        <ion-select-option value="12">12:00</ion-select-option>
                                        <ion-select-option value="18">18:00</ion-select-option>
                                        <ion-select-option value="22">22:00</ion-select-option>
                                        <ion-select-option value="23">23:00</ion-select-option>
                                    </ion-select>
                                </ion-item>
                            </ion-list>
                        </div>

                        <!-- Right Column: Retention & Status -->
                        <div>
                            <ion-list>
                                <!-- Retention Days -->
                                <ion-item>
                                    <ion-input
                                        type="number"
                                        label="{% trans 'Keep backups for (days)' %}"
                                        label-placement="floating"
                                        x-model="backup.retention_days"
                                        min="0"
                                        max="365"
                                        :disabled="!backup.enabled"
                                    ></ion-input>
                                </ion-item>

                                <!-- Max Backups -->
                                <ion-item>
                                    <ion-input
                                        type="number"
                                        label="{% trans 'Maximum backups to keep' %}"
                                        label-placement="floating"
                                        x-model="backup.max_backups"
                                        min="0"
                                        max="100"
                                        :disabled="!backup.enabled"
                                    ></ion-input>
                                </ion-item>

                                <!-- Last Backup Info -->
                                <ion-item>
                                    <ion-label>
                                        <h3>{% trans "Last Backup" %}</h3>
                                        <p>
                                            {% if backup_config.last_backup_at %}
                                            {{ backup_config.last_backup_at|date:"M d, Y H:i" }}
                                            ({{ backup_config.last_backup_size|filesizeformat }})
                                            {% else %}
                                            <span class="text-medium">{% trans "No backups yet" %}</span>
                                            {% endif %}
                                        </p>
                                        {% if backup_config.last_error %}
                                        <p class="text-danger text-xs">{{ backup_config.last_error|truncatechars:50 }}</p>
                                        {% endif %}
                                    </ion-label>
                                </ion-item>
                            </ion-list>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <ion-button type="submit" :disabled="savingBackup">
                            <ion-spinner x-show="savingBackup" name="crescent" class="mr-2"></ion-spinner>
                            {% trans "Save Backup Settings" %}
                        </ion-button>

                        <ion-button fill="outline" @click="runBackupNow()" :disabled="runningBackup">
                            <ion-spinner x-show="runningBackup" name="crescent" class="mr-2"></ion-spinner>
                            <ion-icon slot="start" name="cloud-upload-outline" x-show="!runningBackup"></ion-icon>
                            {% trans "Backup Now" %}
                        </ion-button>
                    </div>
                </form>
            </ion-card-content>
        </ion-card>
    </div>
</div>

<script>
    function settingsApp() {
        return {
            language: '{{ user.language }}',
            currency: '{{ hub_config.currency }}',
            isDark: {{ hub_config.dark_mode|yesno:"true,false" }},
            saving: false,
            savingBackup: false,
            runningBackup: false,
            avatarFile: null,
            logoFile: null,

            // Backup configuration
            backup: {
                enabled: {{ backup_config.enabled|yesno:"true,false" }},
                frequency: '{{ backup_config.frequency }}',
                time_hour: '{{ backup_config.time_hour }}',
                retention_days: {{ backup_config.retention_days }},
                max_backups: {{ backup_config.max_backups }},
            },

            // Store configuration
            store: {
                business_name: '{{ store_config.business_name|escapejs }}',
                business_address: '{{ store_config.business_address|escapejs }}',
                vat_number: '{{ store_config.vat_number|escapejs }}',
                phone: '{{ store_config.phone|escapejs }}',
                email: '{{ store_config.email|escapejs }}',
                website: '{{ store_config.website|escapejs }}',
                tax_rate: '{{ store_config.tax_rate }}',
                tax_included: {{ store_config.tax_included|yesno:"true,false" }},
            },

            // Tax Classes
            taxClasses: [
                {% for tc in tax_classes %}
                {
                    id: {{ tc.id }},
                    name: '{{ tc.name|escapejs }}',
                    rate: '{{ tc.rate }}',
                    description: '{{ tc.description|escapejs }}',
                    is_default: {{ tc.is_default|yesno:"true,false" }},
                },
                {% endfor %}
            ],
            taxForm: {
                name: '',
                rate: '',
                description: '',
                is_default: false,
            },
            editingTaxClass: null,
            savingTax: false,

            init() {
                // Listen to theme changes from parent
                document.addEventListener('theme-changed', (e) => {
                    this.isDark = e.detail.isDark;
                });
            },

            handleAvatarChange(event) {
                this.avatarFile = event.target.files[0];
            },

            handleLogoChange(event) {
                this.logoFile = event.target.files[0];
                // Preview the logo
                if (this.logoFile) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const preview = document.getElementById('logo-preview');
                        if (preview.tagName === 'IMG') {
                            preview.src = e.target.result;
                        } else {
                            // Replace icon with image
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Logo';
                            img.className = 'max-w-full max-h-full object-contain';
                            img.id = 'logo-preview';
                            preview.parentNode.replaceChild(img, preview);
                        }
                    };
                    reader.readAsDataURL(this.logoFile);
                }
            },

            async saveStoreSettings() {
                this.saving = true;
                try {
                    const formData = new FormData();
                    formData.append('action', 'update_store');
                    formData.append('business_name', this.store.business_name);
                    formData.append('business_address', this.store.business_address);
                    formData.append('vat_number', this.store.vat_number);
                    formData.append('phone', this.store.phone);
                    formData.append('email', this.store.email);
                    formData.append('website', this.store.website);
                    formData.append('tax_rate', this.store.tax_rate);
                    formData.append('tax_included', this.store.tax_included);

                    if (this.logoFile) {
                        formData.append('logo', this.logoFile);
                    }

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Store settings saved" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error saving store settings" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving store settings" %}', 'danger');
                } finally {
                    this.saving = false;
                }
            },

            async saveUserSettings() {
                this.saving = true;
                try {
                    const formData = new FormData();
                    formData.append('language', this.language);
                    if (this.avatarFile) {
                        formData.append('avatar', this.avatarFile);
                    }

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Preferences saved" %}', 'success');
                        // Reload if language changed
                        if (this.language !== '{{ user.language }}') {
                            window.location.reload();
                        }
                    } else {
                        await this.showToast(data.error || '{% trans "Error saving preferences" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving preferences" %}', 'danger');
                } finally {
                    this.saving = false;
                }
            },

            async saveHubSettings() {
                this.saving = true;
                try {
                    const formData = new FormData();
                    formData.append('currency', this.currency);

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Hub settings saved" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error saving settings" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving settings" %}', 'danger');
                } finally {
                    this.saving = false;
                }
            },

            async toggleTheme(event) {
                this.isDark = event.detail.checked;

                // Notify parent app
                const parentApp = Alpine.$data(document.getElementById('dashboard-app'));
                if (parentApp) {
                    parentApp.isDark = this.isDark;
                    document.body.classList.toggle('dark', this.isDark);
                }

                // Save to database
                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Theme updated" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error updating theme" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error updating theme" %}', 'danger');
                }
            },

            // Backup settings
            async saveBackupSettings() {
                this.savingBackup = true;
                try {
                    const formData = new FormData();
                    formData.append('action', 'update_backup');
                    formData.append('backup_enabled', this.backup.enabled);
                    formData.append('backup_frequency', this.backup.frequency);
                    formData.append('backup_hour', this.backup.time_hour);
                    formData.append('retention_days', this.backup.retention_days);
                    formData.append('max_backups', this.backup.max_backups);

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Backup settings saved" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error saving backup settings" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving backup settings" %}', 'danger');
                } finally {
                    this.savingBackup = false;
                }
            },

            async runBackupNow() {
                this.runningBackup = true;
                try {
                    const formData = new FormData();
                    formData.append('action', 'run_backup');

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        const sizeKB = Math.round(data.size / 1024);
                        await this.showToast(`{% trans "Backup completed" %} (${sizeKB} KB)`, 'success');
                        // Reload page to show updated last backup info
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        await this.showToast(data.error || '{% trans "Backup failed" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Backup failed" %}', 'danger');
                } finally {
                    this.runningBackup = false;
                }
            },

            // Tax Class Methods
            editTaxClass(tc) {
                this.editingTaxClass = tc;
                this.taxForm = {
                    name: tc.name,
                    rate: tc.rate,
                    description: tc.description,
                    is_default: tc.is_default,
                };
            },

            cancelEditTaxClass() {
                this.editingTaxClass = null;
                this.taxForm = { name: '', rate: '', description: '', is_default: false };
            },

            async saveTaxClass() {
                this.savingTax = true;
                try {
                    const formData = new FormData();
                    formData.append('action', this.editingTaxClass ? 'update_tax_class' : 'create_tax_class');
                    formData.append('name', this.taxForm.name);
                    formData.append('rate', this.taxForm.rate);
                    formData.append('description', this.taxForm.description);
                    formData.append('is_default', this.taxForm.is_default);

                    if (this.editingTaxClass) {
                        formData.append('tax_class_id', this.editingTaxClass.id);
                    }

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        if (this.editingTaxClass) {
                            // Update in array
                            const idx = this.taxClasses.findIndex(tc => tc.id === this.editingTaxClass.id);
                            if (idx >= 0) {
                                this.taxClasses[idx] = data.tax_class;
                            }
                            // If this one is default, unset others
                            if (data.tax_class.is_default) {
                                this.taxClasses.forEach(tc => {
                                    if (tc.id !== data.tax_class.id) tc.is_default = false;
                                });
                            }
                        } else {
                            // Add to array
                            this.taxClasses.push(data.tax_class);
                            // If this one is default, unset others
                            if (data.tax_class.is_default) {
                                this.taxClasses.forEach(tc => {
                                    if (tc.id !== data.tax_class.id) tc.is_default = false;
                                });
                            }
                        }
                        this.cancelEditTaxClass();
                        await this.showToast('{% trans "Tax class saved" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error saving tax class" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving tax class" %}', 'danger');
                } finally {
                    this.savingTax = false;
                }
            },

            async deleteTaxClass(tc) {
                const confirmed = await this.showAlert(
                    '{% trans "Delete Tax Class" %}',
                    `{% trans "Are you sure you want to delete" %} "${tc.name}"?`
                );

                if (!confirmed) return;

                try {
                    const formData = new FormData();
                    formData.append('action', 'delete_tax_class');
                    formData.append('tax_class_id', tc.id);

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        this.taxClasses = this.taxClasses.filter(t => t.id !== tc.id);
                        await this.showToast('{% trans "Tax class deleted" %}', 'success');
                    } else {
                        await this.showToast(data.error || '{% trans "Error deleting tax class" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error deleting tax class" %}', 'danger');
                }
            },

            async showAlert(header, message) {
                return new Promise((resolve) => {
                    const alert = document.createElement('ion-alert');
                    alert.header = header;
                    alert.message = message;
                    alert.buttons = [
                        {
                            text: '{% trans "Cancel" %}',
                            role: 'cancel',
                            handler: () => resolve(false)
                        },
                        {
                            text: '{% trans "Delete" %}',
                            role: 'destructive',
                            handler: () => resolve(true)
                        }
                    ];
                    document.body.appendChild(alert);
                    alert.present();
                });
            },

            // Use global Toast helper from toast-helper.js
            async showToast(message, color = 'primary') {
                await showToast(message, color);
            }
        }
    }
</script>
