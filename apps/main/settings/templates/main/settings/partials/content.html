{% load i18n %}

<!-- Tab bar update via OOB swap -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "dashboard/partials/tabbar_main.html" %}
</div>

<div class="ion-padding" x-data="settingsApp()">
    <h1 class="text-2xl font-bold mb-6">{% trans "Settings" %}</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- User Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "User Preferences" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveUserSettings()">
                    <ion-list>
                        <!-- Language -->
                        <ion-item>
                            <ion-label position="stacked">{% trans "Language" %}</ion-label>
                            <ion-select x-model="language" interface="popover">
                                {% for code, name in language_choices %}
                                <ion-select-option value="{{ code }}" {% if user.language == code %}selected{% endif %}>{{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <!-- Avatar -->
                        <ion-item>
                            <ion-label position="stacked">{% trans "Avatar" %}</ion-label>
                            <div class="flex items-center gap-4 py-2">
                                <ion-avatar>
                                    {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" alt="{{ user.name }}">
                                    {% else %}
                                    <div class="w-full h-full bg-primary flex items-center justify-center text-white font-bold">
                                        {{ user.get_initials }}
                                    </div>
                                    {% endif %}
                                </ion-avatar>
                                <input type="file" id="avatar-input" accept="image/*" class="hidden" @change="handleAvatarChange">
                                <ion-button fill="outline" size="small" @click="document.getElementById('avatar-input').click()">
                                    {% trans "Change" %}
                                </ion-button>
                            </div>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4" :disabled="saving">
                        <ion-spinner x-show="saving" name="crescent" class="mr-2"></ion-spinner>
                        {% trans "Save Preferences" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Settings" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form @submit.prevent="saveHubSettings()">
                    <ion-list>
                        <!-- Currency -->
                        <ion-item>
                            <ion-label position="stacked">{% trans "Currency" %}</ion-label>
                            <ion-select x-model="currency" interface="action-sheet" placeholder="{% trans 'Select currency' %}">
                                {% for code, name in currency_choices %}
                                <ion-select-option value="{{ code }}" {% if hub_config.currency == code %}selected{% endif %}>{{ code }} - {{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <!-- Dark Mode -->
                        <ion-item>
                            <ion-label>{% trans "Dark Mode" %}</ion-label>
                            <ion-toggle slot="end" :checked="isDark" @ionChange="toggleTheme($event)"></ion-toggle>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4" :disabled="saving">
                        <ion-spinner x-show="saving" name="crescent" class="mr-2"></ion-spinner>
                        {% trans "Save Hub Settings" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Information -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Information" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Hub ID" %}</h3>
                            <p class="font-mono text-xs">{{ hub_config.hub_id|default:"Not configured" }}</p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Status" %}</h3>
                            <p>
                                {% if hub_config.is_configured %}
                                <ion-chip color="success">{% trans "Connected" %}</ion-chip>
                                {% else %}
                                <ion-chip color="warning">{% trans "Not configured" %}</ion-chip>
                                {% endif %}
                            </p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Version" %}</h3>
                            <p>1.0.0</p>
                        </ion-label>
                    </ion-item>
                </ion-list>
            </ion-card-content>
        </ion-card>

        <!-- Cloud Connection -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Cloud Connection" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Cloud URL" %}</h3>
                            <p class="font-mono text-xs">{{ CLOUD_URL }}</p>
                        </ion-label>
                    </ion-item>
                </ion-list>

                <ion-button expand="block" fill="outline" class="mt-4" href="{{ CLOUD_URL }}" target="_blank">
                    <ion-icon slot="start" name="open-outline"></ion-icon>
                    {% trans "Open Cloud Portal" %}
                </ion-button>
            </ion-card-content>
        </ion-card>
    </div>
</div>

<script>
    function settingsApp() {
        return {
            language: '{{ user.language }}',
            currency: '{{ hub_config.currency }}',
            isDark: {{ hub_config.dark_mode|yesno:"true,false" }},
            saving: false,
            avatarFile: null,

            init() {
                // Listen to theme changes from parent
                document.addEventListener('theme-changed', (e) => {
                    this.isDark = e.detail.isDark;
                });
            },

            handleAvatarChange(event) {
                this.avatarFile = event.target.files[0];
            },

            async saveUserSettings() {
                this.saving = true;
                try {
                    const formData = new FormData();
                    formData.append('language', this.language);
                    if (this.avatarFile) {
                        formData.append('avatar', this.avatarFile);
                    }

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Preferences saved" %}', 'success');
                        // Reload if language changed
                        if (this.language !== '{{ user.language }}') {
                            window.location.reload();
                        }
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving preferences" %}', 'danger');
                } finally {
                    this.saving = false;
                }
            },

            async saveHubSettings() {
                this.saving = true;
                try {
                    const formData = new FormData();
                    formData.append('currency', this.currency);

                    const response = await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        await this.showToast('{% trans "Hub settings saved" %}', 'success');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Error saving settings" %}', 'danger');
                } finally {
                    this.saving = false;
                }
            },

            async toggleTheme(event) {
                this.isDark = event.detail.checked;

                // Notify parent app
                const parentApp = Alpine.$data(document.getElementById('dashboard-app'));
                if (parentApp) {
                    parentApp.isDark = this.isDark;
                    document.body.classList.toggle('dark', this.isDark);
                }

                // Save to database
                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);

                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Error saving theme:', error);
                }
            },

            async showToast(message, color = 'primary') {
                const toast = document.createElement('ion-toast');
                toast.message = message;
                toast.duration = 2000;
                toast.color = color;
                document.body.appendChild(toast);
                await toast.present();
            }
        }
    }
</script>
