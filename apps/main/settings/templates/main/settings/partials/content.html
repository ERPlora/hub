{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "dashboard/partials/tabbar_main.html" %}
</div>
{% endif %}

<div class="ion-padding">
    <h1 class="text-2xl font-bold mb-6">{% trans "Settings" %}</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Store Information (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    {% trans "Store Information" %}
                    {% if not store_config.is_configured %}
                    <ion-chip color="warning" class="ml-2">{% trans "Required" %}</ion-chip>
                    {% endif %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Business details for invoices and receipts" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <form hx-post="{% url 'main:settings' %}"
                      hx-target="#store-message"
                      hx-swap="innerHTML"
                      hx-indicator="#store-spinner"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_store">

                    <div id="store-message" class="mb-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Basic Info -->
                        <div>
                            <ion-list>
                                <ion-item>
                                    <ion-input
                                        type="text"
                                        name="business_name"
                                        label="{% trans 'Business Name' %} *"
                                        label-placement="floating"
                                        value="{{ store_config.business_name }}"
                                        placeholder="{% trans 'Your business name' %}"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-textarea
                                        name="business_address"
                                        label="{% trans 'Address' %} *"
                                        label-placement="floating"
                                        value="{{ store_config.business_address }}"
                                        rows="2"
                                        placeholder="{% trans 'Street, City, Postal Code' %}"
                                    ></ion-textarea>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="text"
                                        name="vat_number"
                                        label="{% trans 'VAT/Tax ID' %} *"
                                        label-placement="floating"
                                        value="{{ store_config.vat_number }}"
                                        placeholder="{% trans 'e.g., ES12345678A' %}"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="tel"
                                        name="phone"
                                        label="{% trans 'Phone' %}"
                                        label-placement="floating"
                                        value="{{ store_config.phone }}"
                                        placeholder="+34 600 000 000"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="email"
                                        name="email"
                                        label="{% trans 'Email' %}"
                                        label-placement="floating"
                                        value="{{ store_config.email }}"
                                        placeholder="info@business.com"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="url"
                                        name="website"
                                        label="{% trans 'Website' %}"
                                        label-placement="floating"
                                        value="{{ store_config.website }}"
                                        placeholder="https://www.business.com"
                                    ></ion-input>
                                </ion-item>
                            </ion-list>
                        </div>

                        <!-- Right Column: Tax & Logo -->
                        <div>
                            <ion-list>
                                <ion-item>
                                    <ion-label>{% trans "Logo" %}</ion-label>
                                    <div class="flex items-center gap-4 py-2 w-full">
                                        <div class="w-16 h-16 border rounded flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                                            {% if store_config.logo %}
                                            <img src="{{ store_config.logo.url }}" alt="Logo" class="max-w-full max-h-full object-contain">
                                            {% else %}
                                            <ion-icon name="image-outline" class="text-3xl text-gray-400"></ion-icon>
                                            {% endif %}
                                        </div>
                                        <input type="file" name="logo" accept="image/*" class="text-sm">
                                    </div>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="number"
                                        name="tax_rate"
                                        label="{% trans 'Tax Rate (%)' %}"
                                        label-placement="floating"
                                        value="{{ store_config.tax_rate }}"
                                        step="0.01"
                                        min="0"
                                        max="100"
                                        placeholder="21.00"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-label>{% trans "Tax included in prices" %}</ion-label>
                                    <ion-checkbox
                                        slot="end"
                                        name="tax_included"
                                        value="true"
                                        {% if store_config.tax_included %}checked{% endif %}
                                    ></ion-checkbox>
                                </ion-item>
                            </ion-list>
                        </div>
                    </div>

                    <ion-button type="submit" expand="block" class="mt-4">
                        <ion-spinner id="store-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                        {% trans "Save Store Settings" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Tax Classes (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="receipt-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Tax Classes" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Configure tax rates according to your country's legislation" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <!-- Tax Classes List -->
                <div id="tax-classes-list" class="mb-4">
                    {% include "main/settings/partials/tax_classes_list.html" %}
                </div>

                <!-- Add Tax Class Form -->
                <div class="border-t pt-4" style="border-color: var(--ion-color-light);">
                    <h3 class="font-medium mb-3">{% trans "Add Tax Class" %}</h3>
                    <form hx-post="{% url 'main:settings' %}"
                          hx-target="#tax-classes-list"
                          hx-swap="innerHTML"
                          hx-indicator="#tax-spinner">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="create_tax_class">

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <ion-item>
                                <ion-input
                                    type="text"
                                    name="name"
                                    label="{% trans 'Name' %} *"
                                    label-placement="floating"
                                    placeholder="{% trans 'e.g., Standard 21%' %}"
                                    required
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-input
                                    type="number"
                                    name="rate"
                                    label="{% trans 'Rate (%)' %} *"
                                    label-placement="floating"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    placeholder="21.00"
                                    required
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-input
                                    type="text"
                                    name="description"
                                    label="{% trans 'Description' %}"
                                    label-placement="floating"
                                    placeholder="{% trans 'Optional notes' %}"
                                ></ion-input>
                            </ion-item>

                            <ion-item>
                                <ion-label>{% trans "Set as default" %}</ion-label>
                                <ion-checkbox slot="end" name="is_default" value="true"></ion-checkbox>
                            </ion-item>
                        </div>

                        <div class="flex gap-2 mt-4">
                            <ion-button type="submit">
                                <ion-spinner id="tax-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                                {% trans "Add Tax Class" %}
                            </ion-button>
                        </div>
                    </form>
                </div>

                <!-- Examples -->
                <div class="mt-4 p-3 rounded-lg text-sm" style="background: var(--ion-color-light);">
                    <p class="font-medium mb-1">{% trans "Examples by country:" %}</p>
                    <ul class="list-disc list-inside" style="color: var(--ion-color-medium);">
                        <li>Spain: General 21%, Reduced 10%, Super-reduced 4%, Exempt 0%</li>
                        <li>Germany: Standard 19%, Reduced 7%</li>
                        <li>France: Normal 20%, Intermediate 10%, Reduced 5.5%</li>
                        <li>UK: Standard 20%, Reduced 5%, Zero 0%</li>
                    </ul>
                </div>
            </ion-card-content>
        </ion-card>

        <!-- User Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "User Preferences" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form hx-post="{% url 'main:settings' %}"
                      hx-target="#user-message"
                      hx-swap="innerHTML"
                      hx-indicator="#user-spinner"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_user">

                    <div id="user-message" class="mb-4"></div>

                    <ion-list>
                        <ion-item>
                            <ion-select
                                name="language"
                                label="{% trans 'Language' %}"
                                label-placement="floating"
                                value="{{ user.language }}"
                                interface="popover"
                            >
                                {% for code, name in language_choices %}
                                <ion-select-option value="{{ code }}" {% if user.language == code %}selected{% endif %}>{{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <ion-item>
                            <ion-label>{% trans "Avatar" %}</ion-label>
                            <div class="flex items-center gap-4 py-2">
                                <ion-avatar>
                                    {% if user.avatar %}
                                    <img src="{{ user.avatar.url }}" alt="{{ user.name }}">
                                    {% else %}
                                    <div class="w-full h-full bg-primary flex items-center justify-center text-white font-bold">
                                        {{ user.get_initials }}
                                    </div>
                                    {% endif %}
                                </ion-avatar>
                                <input type="file" name="avatar" accept="image/*" class="text-sm">
                            </div>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4">
                        <ion-spinner id="user-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                        {% trans "Save Preferences" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Settings" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <form hx-post="{% url 'main:settings' %}"
                      hx-target="#hub-message"
                      hx-swap="innerHTML"
                      hx-indicator="#hub-spinner">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_hub">

                    <div id="hub-message" class="mb-4"></div>

                    <ion-list>
                        <ion-item>
                            <ion-select
                                name="currency"
                                label="{% trans 'Currency' %}"
                                label-placement="floating"
                                value="{{ hub_config.currency }}"
                                interface="action-sheet"
                                placeholder="{% trans 'Select currency' %}"
                            >
                                {% for code, name in currency_choices %}
                                <ion-select-option value="{{ code }}" {% if hub_config.currency == code %}selected{% endif %}>{{ code }} - {{ name }}</ion-select-option>
                                {% endfor %}
                            </ion-select>
                        </ion-item>

                        <ion-item>
                            <ion-label>{% trans "Dark Mode" %}</ion-label>
                            <ion-checkbox
                                slot="end"
                                name="dark_mode"
                                value="true"
                                {% if hub_config.dark_mode %}checked{% endif %}
                            ></ion-checkbox>
                        </ion-item>
                    </ion-list>

                    <ion-button type="submit" expand="block" class="mt-4">
                        <ion-spinner id="hub-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                        {% trans "Save Hub Settings" %}
                    </ion-button>
                </form>
            </ion-card-content>
        </ion-card>

        <!-- Hub Information -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Hub Information" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Hub ID" %}</h3>
                            <p class="font-mono text-xs">{{ hub_config.hub_id|default:"Not configured" }}</p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Status" %}</h3>
                            <p>
                                {% if hub_config.is_configured %}
                                <ion-chip color="success">{% trans "Connected" %}</ion-chip>
                                {% else %}
                                <ion-chip color="warning">{% trans "Not configured" %}</ion-chip>
                                {% endif %}
                            </p>
                        </ion-label>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Version" %}</h3>
                            <p>1.0.0</p>
                        </ion-label>
                    </ion-item>
                </ion-list>
            </ion-card-content>
        </ion-card>

        <!-- Cloud Connection -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>{% trans "Cloud Connection" %}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h3>{% trans "Cloud URL" %}</h3>
                            <p class="font-mono text-xs">{{ CLOUD_URL }}</p>
                        </ion-label>
                    </ion-item>
                </ion-list>

                <ion-button expand="block" fill="outline" class="mt-4" href="{{ CLOUD_URL }}" target="_blank">
                    <ion-icon slot="start" name="open-outline"></ion-icon>
                    {% trans "Open Cloud Portal" %}
                </ion-button>
            </ion-card-content>
        </ion-card>

        <!-- Database Maintenance (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="build-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Database Maintenance" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Clean up orphaned data from deleted modules" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <p class="text-sm text-medium mb-4">
                    {% trans "Scan for and remove orphaned database tables, migration records, and media files left behind by deleted modules." %}
                </p>

                <ion-button
                    fill="outline"
                    hx-get="{% url 'configuration:scan_orphaned_data' %}"
                    hx-target="#scan-results"
                    hx-indicator="#scan-spinner">
                    <ion-icon slot="start" name="search-outline"></ion-icon>
                    {% trans "Scan for Orphaned Data" %}
                    <ion-spinner id="scan-spinner" name="crescent" class="htmx-indicator ml-2"></ion-spinner>
                </ion-button>

                <div id="scan-results" class="mt-4"></div>
            </ion-card-content>
        </ion-card>

        <!-- Automatic Backups (Full Width) -->
        <ion-card class="lg:col-span-2">
            <ion-card-header>
                <ion-card-title>
                    <ion-icon name="cloud-upload-outline" class="align-middle mr-2"></ion-icon>
                    {% trans "Automatic Backups" %}
                </ion-card-title>
                <ion-card-subtitle>{% trans "Schedule automatic database backups" %}</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
                <form hx-post="{% url 'main:settings' %}"
                      hx-target="#backup-message"
                      hx-swap="innerHTML"
                      hx-indicator="#backup-spinner">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_backup">

                    <div id="backup-message" class="mb-4"></div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column: Schedule Settings -->
                        <div>
                            <ion-list>
                                <ion-item>
                                    <ion-label>{% trans "Enable automatic backups" %}</ion-label>
                                    <ion-checkbox
                                        slot="end"
                                        name="backup_enabled"
                                        value="true"
                                        {% if backup_config.enabled %}checked{% endif %}
                                    ></ion-checkbox>
                                </ion-item>

                                <ion-item>
                                    <ion-select
                                        name="backup_frequency"
                                        label="{% trans 'Frequency' %}"
                                        label-placement="floating"
                                        value="{{ backup_config.frequency }}"
                                        interface="popover"
                                    >
                                        {% for value, label in backup_frequency_choices %}
                                        <ion-select-option value="{{ value }}" {% if backup_config.frequency == value %}selected{% endif %}>{{ label }}</ion-select-option>
                                        {% endfor %}
                                    </ion-select>
                                </ion-item>

                                <ion-item>
                                    <ion-select
                                        name="backup_hour"
                                        label="{% trans 'Backup Time' %}"
                                        label-placement="floating"
                                        value="{{ backup_config.time_hour }}"
                                        interface="popover"
                                    >
                                        <ion-select-option value="0" {% if backup_config.time_hour == 0 %}selected{% endif %}>00:00</ion-select-option>
                                        <ion-select-option value="1" {% if backup_config.time_hour == 1 %}selected{% endif %}>01:00</ion-select-option>
                                        <ion-select-option value="2" {% if backup_config.time_hour == 2 %}selected{% endif %}>02:00</ion-select-option>
                                        <ion-select-option value="3" {% if backup_config.time_hour == 3 %}selected{% endif %}>03:00</ion-select-option>
                                        <ion-select-option value="4" {% if backup_config.time_hour == 4 %}selected{% endif %}>04:00</ion-select-option>
                                        <ion-select-option value="5" {% if backup_config.time_hour == 5 %}selected{% endif %}>05:00</ion-select-option>
                                        <ion-select-option value="6" {% if backup_config.time_hour == 6 %}selected{% endif %}>06:00</ion-select-option>
                                        <ion-select-option value="12" {% if backup_config.time_hour == 12 %}selected{% endif %}>12:00</ion-select-option>
                                        <ion-select-option value="18" {% if backup_config.time_hour == 18 %}selected{% endif %}>18:00</ion-select-option>
                                        <ion-select-option value="22" {% if backup_config.time_hour == 22 %}selected{% endif %}>22:00</ion-select-option>
                                        <ion-select-option value="23" {% if backup_config.time_hour == 23 %}selected{% endif %}>23:00</ion-select-option>
                                    </ion-select>
                                </ion-item>
                            </ion-list>
                        </div>

                        <!-- Right Column: Retention & Status -->
                        <div>
                            <ion-list>
                                <ion-item>
                                    <ion-input
                                        type="number"
                                        name="retention_days"
                                        label="{% trans 'Keep backups for (days)' %}"
                                        label-placement="floating"
                                        value="{{ backup_config.retention_days }}"
                                        min="0"
                                        max="365"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-input
                                        type="number"
                                        name="max_backups"
                                        label="{% trans 'Maximum backups to keep' %}"
                                        label-placement="floating"
                                        value="{{ backup_config.max_backups }}"
                                        min="0"
                                        max="100"
                                    ></ion-input>
                                </ion-item>

                                <ion-item>
                                    <ion-label>
                                        <h3>{% trans "Last Backup" %}</h3>
                                        <p>
                                            {% if backup_config.last_backup_at %}
                                            {{ backup_config.last_backup_at|date:"M d, Y H:i" }}
                                            ({{ backup_config.last_backup_size|filesizeformat }})
                                            {% else %}
                                            <span class="text-medium">{% trans "No backups yet" %}</span>
                                            {% endif %}
                                        </p>
                                        {% if backup_config.last_error %}
                                        <p class="text-danger text-xs">{{ backup_config.last_error|truncatechars:50 }}</p>
                                        {% endif %}
                                    </ion-label>
                                </ion-item>
                            </ion-list>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-4">
                        <ion-button type="submit">
                            <ion-spinner id="backup-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                            {% trans "Save Backup Settings" %}
                        </ion-button>

                        <ion-button
                            fill="outline"
                            hx-post="{% url 'main:settings' %}"
                            hx-vals='{"action": "run_backup"}'
                            hx-target="#backup-message"
                            hx-swap="innerHTML"
                            hx-indicator="#backup-now-spinner">
                            <ion-spinner id="backup-now-spinner" name="crescent" class="htmx-indicator mr-2"></ion-spinner>
                            <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
                            {% trans "Backup Now" %}
                        </ion-button>
                    </div>
                </form>
            </ion-card-content>
        </ion-card>
    </div>
</div>
