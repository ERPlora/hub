{% load i18n ui djicons %}

{% if products %}
<div class="ux-product-grid">
    {% for product in products %}
    <article class="ux-product-card"
             hx-get="{% url 'marketplace:module_detail' product.slug %}"
             hx-target="#main-content-area"
             hx-push-url="true">
        {# Image/Icon Area #}
        <div class="ux-product-card__image-wrapper">
            {# Badges #}
            <div class="ux-product-card__badges">
                {% if product.is_featured %}
                <span class="ux-product-card__badge ux-product-card__badge--new">
                    {% trans "Featured" %}
                </span>
                {% endif %}
                {% if product.is_free or product.module_type == 'free' or product.price == 0 %}
                <span class="ux-product-card__badge" style="background-color: var(--ux-success);">
                    {% trans "Free" %}
                </span>
                {% endif %}
            </div>

            {# Module Icon as placeholder #}
            <div class="ux-product-card__placeholder">
                {% icon product.icon|default:"cube-outline" %}
            </div>

            {# Quick action button #}
            {% if not product.is_installed %}
            <button type="button"
                    class="ux-product-card__quick-add"
                    onclick="event.stopPropagation(); handleQuickAction(this, '{{ product.id }}', '{{ product.slug }}', '{{ product.download_url|default:'' }}', '{{ product.module_type }}', {{ product.is_owned|yesno:'true,false' }}, {{ product.is_free|yesno:'true,false' }})"
                    title="{% if product.is_owned %}{% trans 'Install' %}{% elif product.is_free or product.module_type == 'free' or product.price == 0 %}{% trans 'Get Free' %}{% else %}{% trans 'Purchase' %}{% endif %}">
                {% if product.is_owned %}
                    {% icon "download-outline" %}
                {% elif product.is_free or product.module_type == 'free' or product.price == 0 %}
                    {% icon "add" %}
                {% else %}
                    {% icon "cart-outline" %}
                {% endif %}
            </button>
            {% endif %}
        </div>

        {# Content #}
        <div class="ux-product-card__content">
            {# Category #}
            {% if product.category_name %}
            <span class="ux-product-card__category">{{ product.category_name }}</span>
            {% endif %}

            {# Name #}
            <h3 class="ux-product-card__name">{{ product.name }}</h3>

            {# Author & Version #}
            <p class="fs-xs text-tertiary m-0">
                {% if product.author %}{{ product.author }} &bull; {% endif %}v{{ product.version|default:"1.0" }}
            </p>

            {# Stats Row #}
            <div class="d-flex align-center gap-sm fs-xs text-secondary mt-auto pt-xs">
                {% if product.rating %}
                <span class="d-inline-flex align-center gap-xxs">
                    {% icon "star" css_class="text-warning" size="14" %}
                    {{ product.rating|floatformat:1 }}
                </span>
                {% endif %}
                {% if product.downloads %}
                <span class="d-inline-flex align-center gap-xxs">
                    {% icon "download-outline" size="14" %}
                    {{ product.downloads }}
                </span>
                {% endif %}
            </div>

            {# Price #}
            <div class="ux-product-card__price-wrapper mt-xs">
                {% if product.is_free or product.module_type == 'free' or product.price == 0 %}
                <span class="ux-product-card__price" style="color: var(--ux-success);">{% trans "Free" %}</span>
                {% elif product.module_type == 'subscription' %}
                <span class="ux-product-card__price">&euro;{{ product.price }}/{% trans "mo" %}</span>
                {% else %}
                <span class="ux-product-card__price">&euro;{{ product.price }}</span>
                {% endif %}
            </div>

            {# Status Chips #}
            {% if product.is_installed or product.is_owned %}
            <div class="mt-xs">
                {% if product.is_installed %}
                <span class="ux-chip ux-chip--sm ux-color-success--soft">
                    <span class="ux-chip__icon">{% icon "checkmark-circle-outline" %}</span>
                    {% trans "Installed" %}
                </span>
                {% elif product.is_owned %}
                <span class="ux-chip ux-chip--sm ux-color-tertiary--soft">
                    <span class="ux-chip__icon">{% icon "bag-check-outline" %}</span>
                    {% trans "Owned" %}
                </span>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</div>

{% if has_more %}
<!-- Infinite Scroll Trigger -->
<div id="infinite-scroll-trigger"
     hx-get="{% url 'marketplace:products_list' store_type %}?cursor={{ next_cursor }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if industry_filter %}&industry={{ industry_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
     hx-trigger="intersect once threshold:0.1"
     hx-swap="outerHTML"
     hx-indicator="#load-more-spinner"
     class="d-flex justify-center py-lg">
    <div id="load-more-spinner" class="ux-spinner htmx-indicator"></div>
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="ux-empty-state py-2xl">
    <div class="ux-empty-state__icon">
        {% icon "search-outline" %}
    </div>
    <h3 class="ux-empty-state__title">{% trans "No products found" %}</h3>
    <p class="ux-empty-state__description">{% trans "Try adjusting your search or filters" %}</p>
</div>
{% endif %}

<!-- Module action handlers -->
<script>
// Handle quick action button click
function handleQuickAction(button, moduleId, moduleSlug, downloadUrl, moduleType, isOwned, isFree) {
    if (isOwned) {
        downloadAndInstall(moduleSlug, downloadUrl, button);
    } else if (isFree || moduleType === 'free') {
        installFreeModule(moduleId, moduleSlug, downloadUrl, button);
    } else {
        purchaseModule(moduleId, button);
    }
}

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.innerHTML = '<div class="ux-spinner ux-spinner--sm"></div>';
    }
}
</script>
