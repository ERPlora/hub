{% load i18n djicons %}

{% if products %}
<div class="module-grid module-grid-3">
    {% for product in products %}
    {% include "system/modules/partials/module_card.html" with module=product card_context='marketplace' %}
    {% endfor %}
</div>

{% if has_more %}
<!-- Infinite Scroll Trigger -->
<div id="infinite-scroll-trigger"
     hx-get="{% url 'marketplace:products_list' store_type %}?cursor={{ next_cursor }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if industry_filter %}&industry={{ industry_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
     hx-trigger="intersect once threshold:0.1"
     hx-swap="outerHTML"
     class="flex justify-center py-8">
    <div class="loading"></div>
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="flex flex-col items-center text-center py-12">
    <div class="text-4xl mb-4 opacity-40">
        {% icon "search-outline" %}
    </div>
    <h3 class="text-lg font-semibold mb-2">{% trans "No products found" %}</h3>
    <p class="text-sm opacity-60">{% trans "Try adjusting your search or filters" %}</p>
</div>
{% endif %}

<!-- Module action handlers -->
<script>
if (!window._marketplaceGridInit) {
window._marketplaceGridInit = true;
// Handle action button clicks
document.addEventListener('click', function(e) {
    var button = e.target.closest('button[data-action]');
    if (!button) return;

    var action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed! Reloading..." %}');
            setTimeout(() => window.location.reload(), 5000);
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.dataset.originalContent = button.innerHTML;
        button.innerHTML = '<div class="loading loading-sm"></div>';
    } else if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
    }
}

// Review modal
var _reviewApiUrl = '{% url "mymodules:api_rate" %}';
var _reviewCsrf = '{{ csrf_token }}';
var _starSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="28" height="28"><path d="M394 480a16 16 0 01-9.39-3L256 383.76 127.39 477a16 16 0 01-24.55-18.08L153 310.35 23 221.2a16 16 0 019-29.2h160.38l48.4-148.95a16 16 0 0130.44 0l48.4 149H480a16 16 0 019.05 29.2L359 310.35l50.13 148.53A16 16 0 01394 480z"/></svg>';

window.openReviewModal = function(trigger) {
    var moduleId = trigger.dataset.moduleId;
    var moduleName = trigger.dataset.moduleName;

    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.setAttribute('data-state', 'open');

    var starsHtml = '';
    for (var i = 1; i <= 5; i++) {
        starsHtml += '<span class="review-star" data-value="' + i + '" style="cursor:pointer;color:var(--color-base-300);transition:color .15s;padding:2px;">' + _starSvg + '</span>';
    }

    backdrop.innerHTML =
        '<div class="modal modal-sm">' +
            '<div class="modal-header">' +
                '<h3 class="modal-title">{% trans "Rate" %} ' + moduleName + '</h3>' +
            '</div>' +
            '<div class="modal-body">' +
                '<div class="flex justify-center gap-xs mb-md" id="review-stars">' + starsHtml + '</div>' +
                '<textarea class="textarea w-full" id="review-comment" rows="3" placeholder="{% trans "Write a comment (optional)..." %}"></textarea>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>' +
                '<button class="btn color-primary" data-role="submit" disabled>{% trans "Submit" %}</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(backdrop);

    var selectedRating = 0;
    var stars = backdrop.querySelectorAll('.review-star');
    var submitBtn = backdrop.querySelector('[data-role="submit"]');

    function highlightStars(count) {
        stars.forEach(function(s, idx) {
            s.style.color = idx < count ? 'var(--color-warning)' : 'var(--color-base-300)';
        });
    }

    stars.forEach(function(star) {
        star.addEventListener('mouseenter', function() { highlightStars(parseInt(this.dataset.value)); });
        star.addEventListener('mouseleave', function() { highlightStars(selectedRating); });
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.value);
            highlightStars(selectedRating);
            submitBtn.disabled = false;
        });
    });

    function close() {
        backdrop.setAttribute('data-state', 'closed');
        setTimeout(function() { backdrop.remove(); }, 300);
    }

    backdrop.querySelector('[data-role="cancel"]').addEventListener('click', close);
    backdrop.addEventListener('click', function(e) { if (e.target === backdrop) close(); });

    submitBtn.addEventListener('click', async function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading loading-sm"></div>';
        try {
            var res = await fetch(_reviewApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': _reviewCsrf },
                body: JSON.stringify({
                    module_id: moduleId,
                    rating: selectedRating,
                    comment: backdrop.querySelector('#review-comment').value
                })
            });
            var data = await res.json();
            if (data.success) {
                Toast.success('{% trans "Review submitted!" %}');
                // Update card stars
                var cardStars = trigger.querySelectorAll('.module-card-star');
                if (cardStars.length) {
                    var newRating = data.rating || selectedRating;
                    cardStars.forEach(function(s, idx) {
                        if (idx < Math.round(newRating)) s.classList.add('module-card-star-filled');
                        else s.classList.remove('module-card-star-filled');
                    });
                    var ratingVal = trigger.querySelector('.module-card-rating-value');
                    if (ratingVal) ratingVal.textContent = parseFloat(newRating).toFixed(1);
                    else if (newRating > 0) {
                        var span = document.createElement('span');
                        span.className = 'module-card-rating-value';
                        span.textContent = parseFloat(newRating).toFixed(1);
                        trigger.appendChild(span);
                    }
                    var countEl = trigger.querySelector('.module-card-rating-count');
                    if (countEl && data.review_count) countEl.textContent = '(' + data.review_count + ')';
                }
                close();
            } else {
                Toast.error(data.error || '{% trans "Error submitting review" %}');
                submitBtn.disabled = false;
                submitBtn.textContent = '{% trans "Submit" %}';
            }
        } catch (err) {
            Toast.error('{% trans "Error submitting review" %}');
            submitBtn.disabled = false;
            submitBtn.textContent = '{% trans "Submit" %}';
        }
    });
};
} // end guard
</script>
