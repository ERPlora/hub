{% load i18n djicons %}

{% if products %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for product in products %}
    {% include "system/modules/partials/module_card.html" with module=product card_context='marketplace' %}
    {% endfor %}
</div>

{% if has_more %}
<!-- Infinite Scroll Trigger -->
<div id="infinite-scroll-trigger"
     hx-get="{% url 'marketplace:products_list' store_type %}?cursor={{ next_cursor }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if industry_filter %}&industry={{ industry_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
     hx-trigger="intersect once threshold:0.1"
     hx-swap="outerHTML"
     class="flex justify-center py-8">
    <div class="loading"></div>
</div>
{% endif %}

{% else %}
<!-- No Results -->
<div class="flex flex-col items-center text-center py-12">
    <div class="text-4xl mb-4 opacity-40">
        {% icon "search-outline" %}
    </div>
    <h3 class="text-lg font-semibold mb-2">{% trans "No products found" %}</h3>
    <p class="text-sm opacity-60">{% trans "Try adjusting your search or filters" %}</p>
</div>
{% endif %}

<!-- Module action handlers -->
<script>
// Handle action button clicks
document.addEventListener('click', function(e) {
    var button = e.target.closest('button[data-action]');
    if (!button) return;

    var action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.dataset.originalContent = button.innerHTML;
        button.innerHTML = '<div class="loading loading-sm"></div>';
    } else if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
    }
}
</script>
