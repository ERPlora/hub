{% load i18n djicons %}

{% if products %}

{% if current_view == 'table' %}
<!-- Table View -->
<div class="datatable-body">
    <table class="datatable-table">
        <thead class="datatable-thead">
            <tr>
                <th class="datatable-th datatable-th-sortable{% if sort_field == 'name' %} datatable-th-sorted{% if sort_dir == 'desc' %} datatable-th-sorted-desc{% endif %}{% endif %}"
                    hx-get="{% url 'marketplace:products_list' %}?sort=name&dir={% if sort_field == 'name' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#datatable-body"
                    hx-include="#marketplace-datatable"
                    style="cursor: pointer;">
                    {% trans "Module" %}
                    <span class="datatable-sort-icon">{% icon "chevron-up-outline" %}</span>
                </th>
                <th class="datatable-th" data-col="author">{% trans "Author" %}</th>
                <th class="datatable-th datatable-th-sortable{% if sort_field == 'price' %} datatable-th-sorted{% if sort_dir == 'desc' %} datatable-th-sorted-desc{% endif %}{% endif %}"
                    data-col="price"
                    hx-get="{% url 'marketplace:products_list' %}?sort=price&dir={% if sort_field == 'price' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#datatable-body"
                    hx-include="#marketplace-datatable"
                    style="cursor: pointer;">
                    {% trans "Price" %}
                    <span class="datatable-sort-icon">{% icon "chevron-up-outline" %}</span>
                </th>
                <th class="datatable-th datatable-th-sortable datatable-th-center{% if sort_field == 'rating' %} datatable-th-sorted{% if sort_dir == 'desc' %} datatable-th-sorted-desc{% endif %}{% endif %}"
                    data-col="rating"
                    hx-get="{% url 'marketplace:products_list' %}?sort=rating&dir={% if sort_field == 'rating' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}"
                    hx-target="#datatable-body"
                    hx-include="#marketplace-datatable"
                    style="cursor: pointer;">
                    {% trans "Rating" %}
                    <span class="datatable-sort-icon">{% icon "chevron-up-outline" %}</span>
                </th>
                <th class="datatable-th datatable-th-center" data-col="status">{% trans "Status" %}</th>
                <th class="datatable-th datatable-th-actions">{% trans "Actions" %}</th>
            </tr>
        </thead>
        <tbody class="datatable-tbody">
            {% for product in products %}
            <tr class="datatable-tr">
                <td class="datatable-td" data-label="{% trans 'Module' %}">
                    <div class="flex items-center gap-3">
                        {% if product.icon %}
                        <div class="flex items-center justify-center size-9 rounded-lg bg-base-200 shrink-0">
                            <img src="{{ product.icon }}" alt="{{ product.name }}" class="size-6">
                        </div>
                        {% else %}
                        <div class="flex items-center justify-center size-9 rounded-lg bg-base-200 shrink-0">
                            {% icon product.display_icon|default:"cube-outline" %}
                        </div>
                        {% endif %}
                        <div class="min-w-0">
                            <a href="{{ product.detail_url }}"
                               hx-get="{{ product.detail_url }}"
                               hx-target="#main-content-area"
                               hx-push-url="true"
                               class="font-medium block hover:text-primary transition-colors">
                                {{ product.name }}
                            </a>
                            {% if product.description %}
                            <span class="text-xs text-base-content/50 block truncate max-w-xs">{{ product.description }}</span>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td class="datatable-td" data-col="author" data-label="{% trans 'Author' %}">
                    <span class="text-base-content/60">{{ product.author|default:"-" }}</span>
                </td>
                <td class="datatable-td" data-col="price" data-label="{% trans 'Price' %}">
                    {% if product.is_free or product.module_type == 'free' or product.price == 0 %}
                    <span class="badge badge-sm color-success">{% trans "Free" %}</span>
                    {% elif product.module_type == 'subscription' %}
                    <span class="text-sm font-medium">&euro;{{ product.price }}<span class="text-xs text-base-content/50">/{% trans "mo" %}</span></span>
                    {% elif product.price %}
                    <span class="text-sm font-medium">&euro;{{ product.price }}</span>
                    {% else %}
                    <span class="text-base-content/40">-</span>
                    {% endif %}
                </td>
                <td class="datatable-td datatable-td-center" data-col="rating" data-label="{% trans 'Rating' %}">
                    {% if product.rating %}
                    <div class="flex items-center justify-center gap-1">
                        {% icon "star" css_class="text-warning" %}
                        <span class="text-sm">{{ product.rating|floatformat:1 }}</span>
                        {% if product.review_count %}
                        <span class="text-xs text-base-content/40">({{ product.review_count }})</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <span class="text-base-content/40">-</span>
                    {% endif %}
                </td>
                <td class="datatable-td datatable-td-center" data-col="status" data-label="{% trans 'Status' %}">
                    {% if product.is_installed %}
                    <span class="badge badge-sm color-success">{% trans "Installed" %}</span>
                    {% elif product.is_owned %}
                    <span class="badge badge-sm color-info">{% trans "Owned" %}</span>
                    {% else %}
                    <span class="badge badge-sm badge-ghost">{% trans "Available" %}</span>
                    {% endif %}
                </td>
                <td class="datatable-td datatable-td-actions">
                    <div class="datatable-row-actions">
                        {% if product.is_installed %}
                        <button class="btn btn-sm btn-ghost" disabled title="{% trans 'Installed' %}">
                            {% icon "checkmark-circle-outline" %}
                        </button>
                        {% elif product.is_owned %}
                        <button class="btn btn-sm btn-ghost color-success"
                                data-action="download"
                                data-module-slug="{{ product.slug }}"
                                data-module-dir="{{ product.module_id }}"
                                data-download-url="{{ product.download_url }}"
                                title="{% trans 'Install' %}">
                            {% icon "download-outline" %}
                        </button>
                        {% elif product.is_free or product.module_type == 'free' or product.price == 0 %}
                        <button class="btn btn-sm btn-ghost color-primary"
                                data-action="install-free"
                                data-module-id="{{ product.id }}"
                                data-module-slug="{{ product.slug }}"
                                data-module-dir="{{ product.module_id }}"
                                data-download-url="{{ product.download_url|default:'' }}"
                                title="{% trans 'Get Free' %}">
                            {% icon "download-outline" %}
                        </button>
                        {% else %}
                        <button class="btn btn-sm btn-ghost color-primary"
                                data-action="add-to-cart"
                                data-module-id="{{ product.id }}"
                                data-module-name="{{ product.name }}"
                                data-module-slug="{{ product.slug }}"
                                data-module-price="{{ product.price }}"
                                data-module-icon="{{ product.display_icon|default:'cube-outline' }}"
                                data-module-type="{{ product.module_type }}"
                                title="{% trans 'Add to Cart' %}">
                            {% icon "cart-outline" %}
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<!-- Card View (default) -->
<div class="datatable-body">
    <div class="module-grid module-grid-3 p-4">
        {% for product in products %}
        {% include "system/modules/partials/module_card.html" with module=product card_context='marketplace' %}
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Footer / Pagination -->
<div class="datatable-footer">
    <div class="datatable-per-page">
        {% trans "Show" %}
        <select name="per_page"
                hx-get="{% url 'marketplace:products_list' %}"
                hx-target="#datatable-body"
                hx-include="#marketplace-datatable"
                hx-trigger="change">
            <option value="12" {% if per_page == 12 %}selected{% endif %}>12</option>
            <option value="24" {% if per_page == 24 %}selected{% endif %}>24</option>
            <option value="48" {% if per_page == 48 %}selected{% endif %}>48</option>
            <option value="96" {% if per_page == 96 %}selected{% endif %}>96</option>
        </select>
        {% trans "per page" %}
    </div>
    <span class="datatable-info">
        {% if page_obj.paginator.count > 0 %}
        {% blocktrans with start=page_obj.start_index end=page_obj.end_index total=page_obj.paginator.count %}Showing {{ start }}-{{ end }} of {{ total }} modules{% endblocktrans %}
        {% endif %}
    </span>
    {% if page_obj.paginator.num_pages > 1 %}
    <nav class="pagination pagination-sm">
        <button class="pagination-btn pagination-prev"
                {% if page_obj.has_previous %}
                hx-get="{% url 'marketplace:products_list' %}?page={{ page_obj.previous_page_number }}"
                hx-target="#datatable-body"
                hx-include="#marketplace-datatable"
                {% else %}disabled{% endif %}>
            {% icon "chevron-back-outline" %}
        </button>
        {% for num in page_obj.paginator.page_range %}
        <button class="pagination-btn{% if num == page_obj.number %} pagination-active{% endif %}"
                hx-get="{% url 'marketplace:products_list' %}?page={{ num }}"
                hx-target="#datatable-body"
                hx-include="#marketplace-datatable">
            {{ num }}
        </button>
        {% endfor %}
        <button class="pagination-btn pagination-next"
                {% if page_obj.has_next %}
                hx-get="{% url 'marketplace:products_list' %}?page={{ page_obj.next_page_number }}"
                hx-target="#datatable-body"
                hx-include="#marketplace-datatable"
                {% else %}disabled{% endif %}>
            {% icon "chevron-forward-outline" %}
        </button>
    </nav>
    {% endif %}
</div>

{% else %}
<!-- Empty State -->
<div class="datatable-empty">
    <div class="datatable-empty-icon">
        {% icon "search-outline" %}
    </div>
    <div class="datatable-empty-title">
        {% trans "No modules found" %}
    </div>
    <div class="datatable-empty-text">
        {% trans "Try adjusting your search or filters" %}
    </div>
</div>
{% endif %}

<!-- Module action handlers -->
<script>
if (!window._marketplaceGridInit) {
window._marketplaceGridInit = true;
document.addEventListener('click', function(e) {
    var button = e.target.closest('button[data-action]');
    if (!button) return;

    var action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button, button.dataset.moduleDir);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button, button.dataset.moduleDir);
    } else if (action === 'add-to-cart') {
        addToCart(button);
    }
});

async function installFreeModule(moduleId, moduleSlug, downloadUrl, button, moduleDir) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl, null, moduleDir);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

async function addToCart(button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "marketplace:cart_add" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({
                item_id: button.dataset.moduleSlug,
                module_id: button.dataset.moduleId,
                item_name: button.dataset.moduleName,
                item_price: parseFloat(button.dataset.modulePrice) || 0,
                item_icon: button.dataset.moduleIcon || 'cube-outline',
                item_type: button.dataset.moduleType || 'one_time',
                quantity: 1
            })
        });
        const data = await response.json();
        if (data.success) {
            Toast.success(button.dataset.moduleName + ' {% trans "added to cart" %}');
            // Update cart badge
            var badge = document.getElementById('cart-badge');
            if (badge) {
                badge.textContent = data.cart_count;
                badge.style.display = '';
            }
            // Open cart side-sheet
            document.dispatchEvent(new CustomEvent('cart:open'));
            // Refresh cart content
            htmx.trigger(document.body, 'cart:refresh');
        } else {
            Toast.error(data.error || '{% trans "Error adding to cart" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error adding to cart" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

async function downloadAndInstall(moduleSlug, downloadUrl, button, moduleDir) {
    if (button) setButtonLoading(button, true);
    try {
        const payload = { module_slug: moduleSlug, download_url: downloadUrl };
        if (moduleDir) payload.module_id = moduleDir;
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed! Reloading..." %}');
            setTimeout(() => window.location.reload(), 5000);
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.dataset.originalContent = button.innerHTML;
        button.innerHTML = '<div class="loading loading-sm"></div>';
    } else if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
    }
}

var _reviewApiUrl = '{% url "mymodules:api_rate" %}';
var _reviewCsrf = '{{ csrf_token }}';
var _starSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor" width="28" height="28"><path d="M394 480a16 16 0 01-9.39-3L256 383.76 127.39 477a16 16 0 01-24.55-18.08L153 310.35 23 221.2a16 16 0 019-29.2h160.38l48.4-148.95a16 16 0 0130.44 0l48.4 149H480a16 16 0 019.05 29.2L359 310.35l50.13 148.53A16 16 0 01394 480z"/></svg>';

window.openReviewModal = function(trigger) {
    var moduleId = trigger.dataset.moduleId;
    var moduleName = trigger.dataset.moduleName;

    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.setAttribute('data-state', 'open');

    var starsHtml = '';
    for (var i = 1; i <= 5; i++) {
        starsHtml += '<span class="review-star" data-value="' + i + '" style="cursor:pointer;color:var(--color-base-300);transition:color .15s;padding:2px;">' + _starSvg + '</span>';
    }

    backdrop.innerHTML =
        '<div class="modal modal-sm">' +
            '<div class="modal-header">' +
                '<h3 class="modal-title">{% trans "Rate" %} ' + moduleName + '</h3>' +
            '</div>' +
            '<div class="modal-body">' +
                '<div class="flex justify-center gap-1 mb-4" id="review-stars">' + starsHtml + '</div>' +
                '<textarea class="textarea w-full" id="review-comment" rows="3" placeholder="{% trans "Write a comment (optional)..." %}"></textarea>' +
            '</div>' +
            '<div class="modal-footer">' +
                '<button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>' +
                '<button class="btn color-primary" data-role="submit" disabled>{% trans "Submit" %}</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(backdrop);

    var selectedRating = 0;
    var stars = backdrop.querySelectorAll('.review-star');
    var submitBtn = backdrop.querySelector('[data-role="submit"]');

    function highlightStars(count) {
        stars.forEach(function(s, idx) {
            s.style.color = idx < count ? 'var(--color-warning)' : 'var(--color-base-300)';
        });
    }

    stars.forEach(function(star) {
        star.addEventListener('mouseenter', function() { highlightStars(parseInt(this.dataset.value)); });
        star.addEventListener('mouseleave', function() { highlightStars(selectedRating); });
        star.addEventListener('click', function() {
            selectedRating = parseInt(this.dataset.value);
            highlightStars(selectedRating);
            submitBtn.disabled = false;
        });
    });

    function close() {
        backdrop.setAttribute('data-state', 'closed');
        setTimeout(function() { backdrop.remove(); }, 300);
    }

    backdrop.querySelector('[data-role="cancel"]').addEventListener('click', close);
    backdrop.addEventListener('click', function(e) { if (e.target === backdrop) close(); });

    submitBtn.addEventListener('click', async function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading loading-sm"></div>';
        try {
            var res = await fetch(_reviewApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': _reviewCsrf },
                body: JSON.stringify({
                    module_id: moduleId,
                    rating: selectedRating,
                    comment: backdrop.querySelector('#review-comment').value
                })
            });
            var data = await res.json();
            if (data.success) {
                Toast.success('{% trans "Review submitted!" %}');
                close();
            } else {
                Toast.error(data.error || '{% trans "Error submitting review" %}');
                submitBtn.disabled = false;
                submitBtn.textContent = '{% trans "Submit" %}';
            }
        } catch (err) {
            Toast.error('{% trans "Error submitting review" %}');
            submitBtn.disabled = false;
            submitBtn.textContent = '{% trans "Submit" %}';
        }
    });
};
} // end guard
</script>
