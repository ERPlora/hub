{% load i18n static ui component_tags djicons %}

{% component "page" title=page_title action_icon="cart-outline" action_badge=cart_count action_hx_get="/marketplace/cart/" action_hx_target="#main-content-area" action_hx_push_url="true" %}
    {% fill "content" %}
        {# Marketplace tabbar - manual since it's not a module #}
        <script>
        (function() {
            if (typeof window.updateGlobalTabBar === 'function') {
                window.updateGlobalTabBar([
                    {
                        url: '{% url "marketplace:index" %}',
                        icon: 'cube-outline',
                        label: '{% trans "Modules" %}',
                        active: {% if store_type == 'modules' %}true{% else %}false{% endif %}
                    },
                    {
                        url: '{% url "marketplace:store_hubs" %}',
                        icon: 'server-outline',
                        label: '{% trans "Hubs" %}',
                        active: {% if store_type == 'hubs' %}true{% else %}false{% endif %}
                    },
                    {
                        url: '{% url "marketplace:cart_page" %}',
                        icon: 'cart-outline',
                        label: '{% trans "Cart" %}',
                        active: {% if current_view == 'cart' %}true{% else %}false{% endif %}
                    }
                ]);
            }
        })();
        </script>
        <form id="marketplace-filters-form"
            hx-get="{% if store_type == 'hubs' %}{% url 'marketplace:hubs_products_list' %}{% else %}{% url 'marketplace:products_list' %}{% endif %}"
            hx-target="#products-grid" hx-swap="innerHTML"
            hx-trigger="submit, change from:input[type=hidden], input from:.searchbar-input delay:300ms"
            hx-indicator="#loading-spinner">

            {# Search Bar with Filter Button #}
            <div class="d-flex gap-2 mb-4 align-center">
                <div class="searchbar flex-1" x-data="{ focused: false, hasValue: '{{ request.GET.q|default:'' }}' !== '' }"
                     :class="{ 'searchbar--focused': focused, 'searchbar--has-value': hasValue }">
                    <div class="searchbar-container">
                        <span class="searchbar-icon">
                            {% icon "search-outline" %}
                        </span>
                        <input type="search"
                               class="searchbar-input"
                               id="search-input"
                               name="q"
                               placeholder="{% trans 'Search modules...' %}"
                               value="{{ request.GET.q|default:'' }}"
                               @focus="focused = true"
                               @blur="focused = false"
                               @input="hasValue = $el.value.length > 0">
                        <button type="button"
                                class="searchbar-clear"
                                @click="$refs.searchInput ? $refs.searchInput.value = '' : document.getElementById('search-input').value = ''; hasValue = false; document.getElementById('search-input').dispatchEvent(new Event('input', { bubbles: true }));"
                                x-show="hasValue">
                            {% icon "close" %}
                        </button>
                    </div>
                </div>
                <button type="button"
                        id="filter-toggle-btn"
                        class="btn btn-outline btn-icon-only"
                        onclick="openFiltersModal()"
                        style="position: relative;">
                    {% icon "options-outline" %}
                    {% if active_filters_count %}
                    <span class="badge badge-sm color-error" style="position: absolute; top: -4px; right: -4px;">
                        {{ active_filters_count }}
                    </span>
                    {% endif %}
                </button>
            </div>

            <!-- Hidden inputs for filters -->
            <input type="hidden" name="category" id="filter-category" value="{{ request.GET.category|default:'' }}">
            <input type="hidden" name="industry" id="filter-industry" value="{{ request.GET.industry|default:'' }}">
            <input type="hidden" name="type" id="filter-type" value="{{ request.GET.type|default:'' }}">
            <input type="hidden" name="region" id="filter-region" value="{{ request.GET.region|default:'' }}">
            <input type="hidden" name="plan" id="filter-plan" value="{{ request.GET.plan|default:'' }}">

            <!-- Active Filters Display -->
            <div id="active-filters" class="flex flex-wrap gap-2 mb-4" style="display: none;">
                <span class="fs-sm text-medium mr-sm">{% trans "Active:" %}</span>
                <div id="active-filters-chips" class="flex flex-wrap gap-2"></div>
            </div>
        </form>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="htmx-indicator d-flex justify-center py-8">
            <div class="loading"></div>
        </div>

        <!-- Products Grid Container with scroll -->
        <div id="products-scroll-container" style="height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            <div id="products-grid"
                hx-get="{% if store_type == 'hubs' %}{% url 'marketplace:hubs_products_list' %}{% else %}{% url 'marketplace:products_list' %}{% endif %}"
                hx-trigger="load" hx-swap="innerHTML" hx-indicator="#loading-spinner">
                <div class="d-flex justify-center py-8">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    {% endfill %}
{% endcomponent %}

<!-- Filters Modal -->
<div class="modal-backdrop" id="filters-modal-backdrop" data-state="closed"
     x-data="{ open: false }"
     :data-state="open ? 'open' : 'closed'"
     @click.self="open = false; closeFiltersModal()">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">{% trans "Filters" %}</h2>
            <button class="modal-close" onclick="closeFiltersModal()">
                {% icon "close" %}
            </button>
        </div>
        <div class="modal-body">
            {% if store_type == 'modules' %}
            <!-- Category Filter -->
            <div class="mb-lg">
                <h3 class="fs-sm fw-semibold text-medium mb-sm">{% trans "Category" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="chip filter-chip {% if not request.GET.category %}chip-active{% endif %}"
                            data-filter="category"
                            data-value=""
                            onclick="setFilter('category', '')">
                        {% trans "All" %}
                    </button>
                    {% for category in filters.categories %}
                    <button type="button"
                            class="chip filter-chip {% if request.GET.category == category.id %}chip-active{% endif %}"
                            data-filter="category"
                            data-value="{{ category.id }}"
                            onclick="setFilter('category', '{{ category.id }}')">
                        {{ category.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Industry Filter -->
            <div class="mb-lg">
                <h3 class="fs-sm fw-semibold text-medium mb-sm">{% trans "Industry" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="chip filter-chip {% if not request.GET.industry %}chip-active{% endif %}"
                            data-filter="industry"
                            data-value=""
                            onclick="setFilter('industry', '')">
                        {% trans "All" %}
                    </button>
                    {% for industry in filters.industries %}
                    <button type="button"
                            class="chip filter-chip {% if request.GET.industry == industry.id %}chip-active{% endif %}"
                            data-filter="industry"
                            data-value="{{ industry.id }}"
                            onclick="setFilter('industry', '{{ industry.id }}')">
                        {{ industry.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Pricing Type Filter -->
            <div class="mb-lg">
                <h3 class="fs-sm fw-semibold text-medium mb-sm">{% trans "Pricing" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="chip filter-chip {% if not request.GET.type %}chip-active{% endif %}"
                            data-filter="type"
                            data-value=""
                            onclick="setFilter('type', '')">
                        {% trans "All" %}
                    </button>
                    {% for type in filters.types %}
                    <button type="button"
                            class="chip filter-chip {% if request.GET.type == type.id %}chip-active{% endif %}"
                            data-filter="type"
                            data-value="{{ type.id }}"
                            onclick="setFilter('type', '{{ type.id }}')">
                        {% if type.icon %}{% icon type.icon %}{% endif %}
                        {{ type.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            {% elif store_type == 'hubs' %}
            <!-- Region Filter -->
            <div class="mb-lg">
                <h3 class="fs-sm fw-semibold text-medium mb-sm">{% trans "Region" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="chip filter-chip {% if not request.GET.region %}chip-active{% endif %}"
                            data-filter="region"
                            data-value=""
                            onclick="setFilter('region', '')">
                        {% trans "All" %}
                    </button>
                    {% for region in filters.regions %}
                    <button type="button"
                            class="chip filter-chip {% if request.GET.region == region.id %}chip-active{% endif %}"
                            data-filter="region"
                            data-value="{{ region.id }}"
                            onclick="setFilter('region', '{{ region.id }}')">
                        {{ region.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Plan Filter -->
            <div class="mb-lg">
                <h3 class="fs-sm fw-semibold text-medium mb-sm">{% trans "Plan" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="chip filter-chip {% if not request.GET.plan %}chip-active{% endif %}"
                            data-filter="plan"
                            data-value=""
                            onclick="setFilter('plan', '')">
                        {% trans "All" %}
                    </button>
                    {% for plan in filters.plans %}
                    <button type="button"
                            class="chip filter-chip {% if request.GET.plan == plan.id %}chip-active{% endif %}"
                            data-filter="plan"
                            data-value="{{ plan.id }}"
                            onclick="setFilter('plan', '{{ plan.id }}')">
                        {{ plan.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline color-error" onclick="clearAllFilters()">
                {% icon "trash-outline" %}
                <span>{% trans "Clear" %}</span>
            </button>
            <button type="button" class="btn color-primary" onclick="applyFilters()">
                {% trans "Apply" %}
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    // Modal functions
    window.openFiltersModal = function () {
        const backdrop = document.getElementById('filters-modal-backdrop');
        if (backdrop) {
            backdrop.setAttribute('data-state', 'open');
        }
    };

    window.closeFiltersModal = function () {
        const backdrop = document.getElementById('filters-modal-backdrop');
        if (backdrop) {
            backdrop.setAttribute('data-state', 'closed');
        }
    };

    window.applyFilters = function () {
        // Trigger HTMX request
        document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
        updateActiveFilters();
        closeFiltersModal();
    };

    // Set a filter value
    window.setFilter = function (filterName, value) {
        const input = document.getElementById('filter-' + filterName);
        if (input) {
            input.value = value;
            updateChipSelection(filterName, value);
        }
    };

    // Update chip selection for a filter
    function updateChipSelection(filterName, activeValue) {
        document.querySelectorAll('.filter-chip[data-filter="' + filterName + '"]').forEach(function (chip) {
            var chipValue = chip.dataset.value;
            if (chipValue === activeValue) {
                chip.classList.add('chip-active');
            } else {
                chip.classList.remove('chip-active');
            }
        });
    }

    // Clear all filters
    window.clearAllFilters = function () {
        ['category', 'industry', 'type', 'region', 'plan'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input) {
                input.value = '';
                updateChipSelection(filter, '');
            }
        });
        // Clear search
        var searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        // Trigger HTMX
        document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
        updateActiveFilters();
        closeFiltersModal();
    };

    // Update active filters display
    window.updateActiveFilters = function () {
        var container = document.getElementById('active-filters');
        var chipsContainer = document.getElementById('active-filters-chips');
        var filterToggleBtn = document.getElementById('filter-toggle-btn');

        var count = 0;

        // Clear previous chips
        chipsContainer.innerHTML = '';

        // Check search
        var searchInput = document.getElementById('search-input');
        var searchValue = searchInput ? searchInput.value : '';
        if (searchValue) {
            var searchChip = document.createElement('button');
            searchChip.type = 'button';
            searchChip.className = 'chip color-warning';
            searchChip.innerHTML = (document.querySelector('[data-icon="search-outline"]')?.outerHTML || '<svg></svg>') + ' ' + searchValue + '<button type="button" onclick="clearSearch(); event.stopPropagation();"><svg viewBox="0 0 512 512"><path d="M289.94 256l95-95A24 24 0 00351 127l-95 95-95-95a24 24 0 00-34 34l95 95-95 95a24 24 0 1034 34l95-95 95 95a24 24 0 0034-34z"/></svg></button>';
            searchChip.addEventListener('click', function() { clearSearch(); });
            chipsContainer.appendChild(searchChip);
            count++;
        }

        // Check filters
        ['category', 'industry', 'type', 'region', 'plan'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input && input.value) {
                var chip = document.createElement('button');
                chip.type = 'button';
                chip.className = 'chip color-warning';
                chip.innerHTML = input.value + '<button type="button"><svg viewBox="0 0 512 512"><path d="M289.94 256l95-95A24 24 0 00351 127l-95 95-95-95a24 24 0 00-34 34l95 95-95 95a24 24 0 1034 34l95-95 95 95a24 24 0 0034-34z"/></svg></button>';
                chip.addEventListener('click', function() { removeFilter(filter); });
                chipsContainer.appendChild(chip);
                count++;
            }
        });

        // Update UI
        if (count > 0) {
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }

        // Update badge on filter button
        if (filterToggleBtn) {
            var badge = filterToggleBtn.querySelector('.badge');
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge badge-sm color-error';
                    badge.style.cssText = 'position: absolute; top: -4px; right: -4px;';
                    filterToggleBtn.appendChild(badge);
                }
                badge.textContent = count;
            } else if (badge) {
                badge.remove();
            }
        }
    };

    // Remove a single filter
    window.removeFilter = function (filterName) {
        var input = document.getElementById('filter-' + filterName);
        if (input) {
            input.value = '';
            updateChipSelection(filterName, '');
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }
        updateActiveFilters();
    };

    // Clear search only
    window.clearSearch = function () {
        var searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.value = '';
            document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
            updateActiveFilters();
        }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updateActiveFilters);
    // Also run immediately for HTMX loads
    updateActiveFilters();
})();
</script>
