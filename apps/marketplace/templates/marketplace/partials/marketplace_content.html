{% load i18n static djicons %}

<div x-data="{
    view: 'cards',
    columnsModal: false,
    cols: { author: true, price: true, rating: true, status: true },
    toggleCol(col) {
        this.cols[col] = !this.cols[col];
        document.querySelectorAll('[data-col=' + col + ']').forEach(el => el.classList.toggle('hidden', !this.cols[col]));
    }
}">

    <div class="datatable glass mt-5" id="marketplace-datatable">

        <!-- Toolbar -->
        <div class="datatable-toolbar">
            <div class="datatable-toolbar-start">
                <label class="input input-sm datatable-search">
                    {% icon "search-outline" %}
                    <input type="search"
                           name="q"
                           id="search-input"
                           placeholder="{% trans 'Search modules...' %}"
                           value=""
                           autocomplete="off"
                           hx-get="{% url 'marketplace:products_list' %}"
                           hx-target="#datatable-body"
                           hx-include="#marketplace-datatable"
                           hx-trigger="input changed delay:300ms, search">
                </label>

                <!-- Filters button -->
                <button type="button"
                        class="datatable-export-btn"
                        id="filter-toggle-btn"
                        onclick="openFiltersModal()"
                        title="{% trans 'Filters' %}"
                        style="position: relative;">
                    {% icon "funnel-outline" %}
                </button>
            </div>
            <div class="datatable-toolbar-end">
                <!-- Column Visibility -->
                <button class="datatable-column-btn" @click="columnsModal = true" title="{% trans 'Columns' %}">
                    {% icon "options-outline" %}
                </button>

                <!-- View Toggle -->
                <div class="datatable-view-toggle">
                    <button type="button"
                            class="datatable-view-btn"
                            :class="{ 'datatable-view-btn-active': view === 'table' }"
                            @click="view = 'table'"
                            hx-get="{% url 'marketplace:products_list' %}"
                            hx-target="#datatable-body"
                            hx-include="#marketplace-datatable"
                            hx-vals='{"view": "table"}'
                            title="{% trans 'Table view' %}">
                        {% icon "list-outline" %}
                    </button>
                    <button type="button"
                            class="datatable-view-btn datatable-view-btn-active"
                            :class="{ 'datatable-view-btn-active': view === 'cards' }"
                            @click="view = 'cards'"
                            hx-get="{% url 'marketplace:products_list' %}"
                            hx-target="#datatable-body"
                            hx-include="#marketplace-datatable"
                            hx-vals='{"view": "cards"}'
                            title="{% trans 'Card view' %}">
                        {% icon "grid-outline" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Active Filters Display -->
        <div id="active-filters" class="datatable-active-filters" style="display: none;">
            <span class="text-xs font-semibold opacity-60 mr-1">{% trans "Active:" %}</span>
            <div id="active-filters-chips" class="flex flex-wrap gap-1"></div>
            <button class="datatable-clear-filters" onclick="clearAllFilters()">
                {% icon "close-outline" %}
                {% trans "Clear" %}
            </button>
        </div>

        <!-- Hidden state inputs -->
        <input type="hidden" name="sort" value="name">
        <input type="hidden" name="dir" value="asc">
        <input type="hidden" name="view" :value="view">
        <input type="hidden" name="per_page" value="12">
        <input type="hidden" name="category" id="filter-category" value="">
        <input type="hidden" name="industry" id="filter-industry" value="">
        <input type="hidden" name="type" id="filter-type" value="">

        <!-- Datatable Body (HTMX swap target) -->
        <div id="datatable-body"
             hx-get="{% url 'marketplace:products_list' %}"
             hx-trigger="load"
             hx-include="#marketplace-datatable"
             hx-swap="innerHTML">
            <div class="flex justify-center py-8">
                <div class="loading"></div>
            </div>
        </div>
    </div>

    <!-- Columns Modal -->
    <div class="modal-backdrop" :data-state="columnsModal ? 'open' : 'closed'" @click.self="columnsModal = false">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Show / Hide Columns" %}</h3>
                <button class="modal-close" @click="columnsModal = false">
                    {% icon "close-outline" %}
                </button>
            </div>
            <div class="modal-body">
                <label class="flex items-center gap-3 py-2 cursor-not-allowed opacity-50">
                    <input type="checkbox" class="checkbox checkbox-sm" checked disabled>
                    <span class="text-sm">{% trans "Module" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('author')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.author" readonly>
                    <span class="text-sm">{% trans "Author" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('price')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.price" readonly>
                    <span class="text-sm">{% trans "Price" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('rating')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.rating" readonly>
                    <span class="text-sm">{% trans "Rating" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('status')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.status" readonly>
                    <span class="text-sm">{% trans "Status" %}</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm color-primary" @click="columnsModal = false">
                    {% trans "Done" %}
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Filters Modal -->
<div class="modal-backdrop" id="filters-modal-backdrop" data-state="closed"
     onclick="if (event.target === this) closeFiltersModal()">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h2 class="modal-title">{% trans "Filters" %}</h2>
            <button class="modal-close" onclick="closeFiltersModal()">
                {% icon "close-outline" %}
            </button>
        </div>
        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            {% if store_type == 'modules' %}
            <!-- Function Filter (multi-select, grouped) -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold m-0">{% trans "Function" %}</h3>
                    <button type="button" class="text-xs opacity-50 hover:opacity-100" onclick="clearMultiFilter('category')">{% trans "Clear" %}</button>
                </div>
                {% for group in filters.categories_grouped %}
                <div class="mb-3">
                    <span class="text-xs font-semibold opacity-50 uppercase tracking-wide">{{ group.name }}</span>
                    <div class="flex flex-wrap gap-2 mt-1">
                        {% for cat in group.categories %}
                        <button type="button"
                                class="filter-chip"
                                data-filter="category"
                                data-value="{{ cat.id }}"
                                onclick="toggleMultiFilter('category', '{{ cat.id }}')">
                            {{ cat.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Industry Filter (multi-select, grouped) -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-sm font-semibold m-0">{% trans "Industry" %}</h3>
                    <button type="button" class="text-xs opacity-50 hover:opacity-100" onclick="clearMultiFilter('industry')">{% trans "Clear" %}</button>
                </div>
                {% for group in filters.industries_grouped %}
                <div class="mb-3">
                    <span class="text-xs font-semibold opacity-50 uppercase tracking-wide">{{ group.name }}</span>
                    <div class="flex flex-wrap gap-2 mt-1">
                        {% for ind in group.industries %}
                        <button type="button"
                                class="filter-chip"
                                data-filter="industry"
                                data-value="{{ ind.id }}"
                                onclick="toggleMultiFilter('industry', '{{ ind.id }}')">
                            {{ ind.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pricing Type Filter (single-select) -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold mb-2">{% trans "Pricing" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="filter-chip filter-chip-active"
                            data-filter="type"
                            data-value=""
                            onclick="setFilter('type', '')">
                        {% trans "All" %}
                    </button>
                    {% for type in filters.types %}
                    <button type="button"
                            class="filter-chip"
                            data-filter="type"
                            data-value="{{ type.id }}"
                            onclick="setFilter('type', '{{ type.id }}')">
                        {% if type.icon %}{% icon type.icon %}{% endif %}
                        {{ type.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            {% elif store_type == 'hubs' %}
            <!-- Region Filter -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold mb-2">{% trans "Region" %}</h3>
                <div class="flex flex-wrap gap-2">
                    <button type="button"
                            class="filter-chip filter-chip-active"
                            data-filter="region"
                            data-value=""
                            onclick="setFilter('region', '')">
                        {% trans "All" %}
                    </button>
                    {% for region in filters.regions %}
                    <button type="button"
                            class="filter-chip"
                            data-filter="region"
                            data-value="{{ region.id }}"
                            onclick="setFilter('region', '{{ region.id }}')">
                        {{ region.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline color-error" onclick="clearAllFilters()">
                {% icon "trash-outline" %}
                <span>{% trans "Clear" %}</span>
            </button>
            <button type="button" class="btn color-primary" onclick="applyFilters()">
                {% trans "Apply" %}
            </button>
        </div>
    </div>
</div>

<script>
(function () {
    // Multi-select filters store comma-separated values in hidden inputs
    // category and industry support multi-select; type is single-select

    function gatherDatatableParams() {
        var dt = document.getElementById('marketplace-datatable');
        if (!dt) return '';
        var params = [];
        dt.querySelectorAll('input[name], select[name]').forEach(function (el) {
            if (el.name && (el.type !== 'search' || el.value)) {
                params.push(encodeURIComponent(el.name) + '=' + encodeURIComponent(el.value));
            }
        });
        return params.join('&');
    }

    function fireFilterRequest() {
        var qs = gatherDatatableParams();
        var url = '{% url "marketplace:products_list" %}' + (qs ? '?' + qs : '');
        htmx.ajax('GET', url, { target: '#datatable-body', swap: 'innerHTML' });
    }

    // Get current values for a multi-select filter as an array
    function getMultiValues(filterName) {
        var input = document.getElementById('filter-' + filterName);
        if (!input || !input.value) return [];
        return input.value.split(',').filter(function(v) { return v; });
    }

    // Set multi-select filter values (array â†’ comma-separated string)
    function setMultiValues(filterName, values) {
        var input = document.getElementById('filter-' + filterName);
        if (input) input.value = values.join(',');
        updateMultiChipSelection(filterName, values);
    }

    // Toggle a value in a multi-select filter
    window.toggleMultiFilter = function (filterName, value) {
        var values = getMultiValues(filterName);
        var idx = values.indexOf(value);
        if (idx >= 0) {
            values.splice(idx, 1);
        } else {
            values.push(value);
        }
        setMultiValues(filterName, values);
    };

    // Clear all values for a multi-select filter
    window.clearMultiFilter = function (filterName) {
        setMultiValues(filterName, []);
    };

    // Update chip active states for multi-select
    function updateMultiChipSelection(filterName, activeValues) {
        document.querySelectorAll('.filter-chip[data-filter="' + filterName + '"]').forEach(function (chip) {
            if (activeValues.indexOf(chip.dataset.value) >= 0) {
                chip.classList.add('filter-chip-active');
            } else {
                chip.classList.remove('filter-chip-active');
            }
        });
    }

    window.openFiltersModal = function () {
        var backdrop = document.getElementById('filters-modal-backdrop');
        if (backdrop) backdrop.setAttribute('data-state', 'open');
    };

    window.closeFiltersModal = function () {
        var backdrop = document.getElementById('filters-modal-backdrop');
        if (backdrop) backdrop.setAttribute('data-state', 'closed');
    };

    window.applyFilters = function () {
        fireFilterRequest();
        updateActiveFilters();
        closeFiltersModal();
    };

    // Single-select filter (for type, region)
    window.setFilter = function (filterName, value) {
        var input = document.getElementById('filter-' + filterName);
        if (input) {
            input.value = value;
            updateSingleChipSelection(filterName, value);
        }
    };

    function updateSingleChipSelection(filterName, activeValue) {
        document.querySelectorAll('.filter-chip[data-filter="' + filterName + '"]').forEach(function (chip) {
            if (chip.dataset.value === activeValue) {
                chip.classList.add('filter-chip-active');
            } else {
                chip.classList.remove('filter-chip-active');
            }
        });
    }

    window.clearAllFilters = function () {
        // Multi-select filters
        ['category', 'industry'].forEach(function (filter) {
            setMultiValues(filter, []);
        });
        // Single-select filters
        ['type'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input) {
                input.value = '';
                updateSingleChipSelection(filter, '');
            }
        });
        var searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        fireFilterRequest();
        updateActiveFilters();
        closeFiltersModal();
    };

    window.removeFilter = function (filterName, value) {
        if (filterName === 'category' || filterName === 'industry') {
            // Multi-select: remove specific value
            if (value) {
                var values = getMultiValues(filterName);
                var idx = values.indexOf(value);
                if (idx >= 0) values.splice(idx, 1);
                setMultiValues(filterName, values);
            } else {
                setMultiValues(filterName, []);
            }
        } else {
            var input = document.getElementById('filter-' + filterName);
            if (input) {
                input.value = '';
                updateSingleChipSelection(filterName, '');
            }
        }
        fireFilterRequest();
        updateActiveFilters();
    };

    window.updateActiveFilters = function () {
        var container = document.getElementById('active-filters');
        var chipsContainer = document.getElementById('active-filters-chips');
        if (!container || !chipsContainer) return;

        var count = 0;
        chipsContainer.innerHTML = '';

        var filterLabels = {
            category: '{% trans "Function" %}',
            industry: '{% trans "Industry" %}',
            type: '{% trans "Type" %}'
        };

        function getChipLabel(filterName, value) {
            var chip = document.querySelector('.filter-chip[data-filter="' + filterName + '"][data-value="' + CSS.escape(value) + '"]');
            return chip ? chip.textContent.trim() : value;
        }

        var closeSvg = '<svg viewBox="0 0 512 512" width="12" height="12"><path d="M289.94 256l95-95A24 24 0 00351 127l-95 95-95-95a24 24 0 00-34 34l95 95-95 95a24 24 0 1034 34l95-95 95 95a24 24 0 0034-34z" fill="currentColor"/></svg>';

        // Multi-select filters: one tag per selected value
        ['category', 'industry'].forEach(function (filter) {
            var values = getMultiValues(filter);
            values.forEach(function (val) {
                var displayValue = getChipLabel(filter, val);
                var tag = document.createElement('span');
                tag.className = 'datatable-filter-tag';
                tag.innerHTML = '<span class="datatable-filter-tag-label">' + filterLabels[filter] + ':</span> ' + displayValue +
                    ' <button class="datatable-filter-tag-remove" onclick="removeFilter(\'' + filter + '\', \'' + val + '\')">' + closeSvg + '</button>';
                chipsContainer.appendChild(tag);
                count++;
            });
        });

        // Single-select filters
        ['type'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input && input.value) {
                var displayValue = getChipLabel(filter, input.value);
                var tag = document.createElement('span');
                tag.className = 'datatable-filter-tag';
                tag.innerHTML = '<span class="datatable-filter-tag-label">' + filterLabels[filter] + ':</span> ' + displayValue +
                    ' <button class="datatable-filter-tag-remove" onclick="removeFilter(\'' + filter + '\')">' + closeSvg + '</button>';
                chipsContainer.appendChild(tag);
                count++;
            }
        });

        container.style.display = count > 0 ? 'flex' : 'none';

        var filterBtn = document.getElementById('filter-toggle-btn');
        if (filterBtn) {
            var badge = filterBtn.querySelector('.badge');
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge badge-sm color-error';
                    badge.style.cssText = 'position: absolute; top: -4px; right: -4px;';
                    filterBtn.appendChild(badge);
                }
                badge.textContent = count;
            } else if (badge) {
                badge.remove();
            }
        }
    };

    updateActiveFilters();
})();
</script>
