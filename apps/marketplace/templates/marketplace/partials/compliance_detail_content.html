{% load i18n component_tags djicons marketplace_tags %}

{% component "page" title=country.country_name|default:_("Compliance") back_hx_get="/marketplace/compliance/" back_hx_target="#main-content-area" back_hx_push_url="true" %}
    {% fill "content" %}

{% if error %}
<div class="callout callout-warning mt-5">
    <div class="callout-content">
        <p class="callout-text">{% icon "alert-circle-outline" %} {{ error }}</p>
    </div>
</div>
{% elif country %}

<div class="mt-5">
    {# Country header #}
    <div class="card glass mb-6">
        <div class="card-body p-6">
            <div class="flex items-start gap-4">
                <span class="text-4xl">{{ country.country_code|country_flag }}</span>
                <div class="flex-1">
                    <h2 class="text-xl font-bold mb-1">{{ country.country_name }}</h2>
                    {% if country.description %}
                    <p class="text-sm opacity-60">{{ country.description }}</p>
                    {% endif %}
                </div>
                <div class="flex flex-col items-end gap-1">
                    {% if supported_count == total_count and total_count > 0 %}
                    <span class="badge color-success">
                        {% icon "checkmark-circle" %}
                        {% trans "Fully Supported" %}
                    </span>
                    {% elif supported_count > 0 %}
                    <span class="badge color-warning">
                        {{ supported_count }}/{{ total_count }} {% trans "supported" %}
                    </span>
                    {% elif total_count > 0 %}
                    <span class="badge">
                        0/{{ total_count }} {% trans "supported" %}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Coverage summary #}
    {% if total_count > 0 and supported_count < total_count %}
    <div class="callout callout-warning mb-6">
        <div class="callout-icon">{% icon "alert-circle-outline" %}</div>
        <div class="callout-content">
            <div class="callout-title">{% trans "Partial Coverage" %}</div>
            <div class="callout-text">{% blocktrans with supported=supported_count total=total_count %}ERPlora currently covers {{ supported }} of {{ total }} requirements in this country. Some features may not be usable for full legal compliance.{% endblocktrans %}</div>
        </div>
    </div>
    {% elif total_count > 0 and supported_count == total_count %}
    <div class="callout callout-success mb-6">
        <div class="callout-icon">{% icon "checkmark-circle-outline" %}</div>
        <div class="callout-content">
            <div class="callout-title">{% trans "Full Coverage" %}</div>
            <div class="callout-text">{% trans "ERPlora covers all known requirements for this country." %}</div>
        </div>
    </div>
    {% endif %}

    {# Requirements grouped by category #}
    {% if categories %}
    {% for cat in categories %}
    <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
            {% icon cat.icon css_class="text-primary" %}
            {{ cat.label }}
            <span class="badge badge-sm">{{ cat.requirements|length }}</span>
        </h3>

        <div class="list list-inset glass">
            {% for req in cat.requirements %}
            <div class="list-item list-item-multiline">
                <div class="list-item-content">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="list-item-label">{{ req.name }}</span>
                        {% if req.is_mandatory %}
                        <span class="badge badge-sm color-error">{% trans "Mandatory" %}</span>
                        {% else %}
                        <span class="badge badge-sm">{% trans "Recommended" %}</span>
                        {% endif %}
                        {% if req.status == 'enforced' %}
                        <span class="badge badge-sm color-success">{% trans "Enforced" %}</span>
                        {% elif req.status == 'upcoming' %}
                        <span class="badge badge-sm color-warning">{% trans "Upcoming" %}{% if req.effective_date %} {{ req.effective_date }}{% endif %}</span>
                        {% elif req.status == 'planned' %}
                        <span class="badge badge-sm">{% trans "Planned" %}{% if req.effective_date %} {{ req.effective_date }}{% endif %}</span>
                        {% endif %}
                        {% if req.region %}
                        <span class="badge badge-sm color-primary">{{ req.region }}</span>
                        {% endif %}
                    </div>
                    {% if req.description %}
                    <span class="list-item-note mt-1">{{ req.description }}</span>
                    {% endif %}
                    {% if req.scope %}
                    <div class="flex items-center gap-1 mt-1">
                        {% icon "people-outline" css_class="text-xs opacity-40" %}
                        <span class="text-xs opacity-50">{{ req.scope }}</span>
                    </div>
                    {% endif %}
                    {% if req.legal_reference %}
                    <div class="flex items-center gap-1 mt-0.5">
                        {% icon "document-text-outline" css_class="text-xs opacity-40" %}
                        <span class="text-xs opacity-40">{{ req.legal_reference }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="list-item-end">
                    {% if req.module_slug %}
                        {% if req.is_installed %}
                        <span class="badge badge-sm color-success">
                            {% icon "checkmark-circle" %}
                            {% trans "Installed" %}
                        </span>
                        {% else %}
                        <button class="btn btn-sm color-primary"
                                onclick="installComplianceModule('{{ req.module_slug }}', this)"
                                data-module-slug="{{ req.module_slug }}">
                            {% icon "download-outline" %}
                            {% trans "Install" %}
                        </button>
                        {% endif %}
                    {% else %}
                    <span class="badge badge-sm opacity-60">
                        {% icon "close-circle-outline" %}
                        {% trans "Not available" %}
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="text-center py-8">
        {% icon "shield-checkmark-outline" css_class="text-4xl opacity-20 mb-2" %}
        <p class="text-sm opacity-60">{% trans "No specific compliance requirements defined for this country yet." %}</p>
    </div>
    {% endif %}
</div>

<script>
function installComplianceModule(moduleSlug, button) {
    var originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="loading loading-sm"></span>';

    fetch('/modules/api/marketplace/install/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
                || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            module_slug: moduleSlug,
            download_url: '{{ cloud_api_url|default:"https://erplora.com" }}/api/marketplace/modules/' + moduleSlug + '/download/'
        })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            button.outerHTML = '<span class="badge badge-sm color-success">{% icon "checkmark-circle" %} {% trans "Installed" %}</span>';
            if (typeof Toast !== 'undefined') Toast.success('{% trans "Module installed successfully" %}');
        } else {
            button.disabled = false;
            button.innerHTML = originalHtml;
            if (typeof Toast !== 'undefined') Toast.error(data.error || '{% trans "Installation failed" %}');
        }
    })
    .catch(function(e) {
        button.disabled = false;
        button.innerHTML = originalHtml;
        if (typeof Toast !== 'undefined') Toast.error(e.message);
    });
}
</script>
{% endif %}

    {% endfill %}
{% endcomponent %}
