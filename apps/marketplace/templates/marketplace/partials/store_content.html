{% load i18n static ui component_tags %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap -->
{% include "marketplace/partials/tabbar.html" with store_type=store_type cart_count=cart_count oob=True %}
<!-- Clear page header container -->
<div id="page-header-container" hx-swap-oob="innerHTML"></div>
{% endif %}

{% ui_page_header title=page_title action_icon="cart-outline" action_badge=cart_count action_hx_get="/marketplace/cart/" action_hx_target="#main-content-area" action_hx_push_url="true" %}

<div class="ion-padding">
    <form id="marketplace-filters-form"
        hx-get="{% if store_type == 'hubs' %}{% url 'marketplace:hubs_products_list' %}{% else %}{% url 'marketplace:products_list' %}{% endif %}"
        hx-target="#products-grid" hx-swap="innerHTML"
        hx-trigger="submit, change from:input[type=hidden], ionInput from:#search-input delay:300ms"
        hx-indicator="#loading-spinner">

        <div class="d-flex gap-sm mb-md align-center">
            <ion-searchbar id="search-input" name="q" placeholder="{% trans 'Search...' %}" debounce="300"
                show-cancel-button="never" class="flex-1 m-0" value="{{ request.GET.q|default:'' }}">
            </ion-searchbar>
            <ion-button id="filter-toggle-btn" fill="outline" type="button" onclick="openFiltersModal()">
                <ion-icon name="options-outline" slot="icon-only"></ion-icon>
                {% if active_filters_count %}
                <ion-badge color="danger"
                    style="position: absolute; top: -4px; right: -4px; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%;">
                    {{ active_filters_count }}
                </ion-badge>
                {% endif %}
            </ion-button>
        </div>

        <!-- Hidden inputs for filters -->
        <input type="hidden" name="category" id="filter-category" value="{{ request.GET.category|default:'' }}">
        <input type="hidden" name="industry" id="filter-industry" value="{{ request.GET.industry|default:'' }}">
        <input type="hidden" name="type" id="filter-type" value="{{ request.GET.type|default:'' }}">
        <input type="hidden" name="region" id="filter-region" value="{{ request.GET.region|default:'' }}">
        <input type="hidden" name="plan" id="filter-plan" value="{{ request.GET.plan|default:'' }}">

        <!-- Active Filters Display -->
        <div id="active-filters" class="d-flex flex-wrap gap-sm mb-md align-center" style="display: none;">
            <span class="fs-sm text-medium">{% trans "Active:" %}</span>
            <div id="active-filters-chips"></div>
        </div>
    </form>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="htmx-indicator justify-center py-xl">
        <ion-spinner name="crescent"></ion-spinner>
    </div>

    <!-- Products Grid Container with scroll -->
    <div id="products-scroll-container" style="height: 65vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div id="products-grid"
            hx-get="{% if store_type == 'hubs' %}{% url 'marketplace:hubs_products_list' %}{% else %}{% url 'marketplace:products_list' %}{% endif %}"
            hx-trigger="load" hx-swap="innerHTML" hx-indicator="#loading-spinner">
            <div class="d-flex justify-center py-xl">
                <ion-spinner name="crescent"></ion-spinner>
            </div>
        </div>
    </div>
</div>

<!-- Filters Modal -->
<ion-modal id="filters-modal">
    <ion-header>
        <ion-toolbar>
            <ion-title>{% trans "Filters" %}</ion-title>
            <ion-buttons slot="end">
                <ion-button onclick="closeFiltersModal()">
                    <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
            </ion-buttons>
        </ion-toolbar>
    </ion-header>
    <ion-content>
        <ion-accordion-group>
            {% if store_type == 'modules' %}
            <!-- Category Filter -->
            <ion-accordion value="category">
                <ion-item slot="header">
                    <ion-label>{% trans "Category" %}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content">
                    <div class="d-flex flex-wrap gap-xs">
                        <ion-chip class="cursor-pointer filter-chip" data-filter="category" data-value=""
                            color="{% if not request.GET.category %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('category', '')">
                            <ion-label>{% trans "All" %}</ion-label>
                        </ion-chip>
                        {% for category in filters.categories %}
                        <ion-chip class="cursor-pointer filter-chip" data-filter="category"
                            data-value="{{ category.id }}"
                            color="{% if request.GET.category == category.id %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('category', '{{ category.id }}')">
                            <ion-label>{{ category.name }}</ion-label>
                        </ion-chip>
                        {% endfor %}
                    </div>
                </div>
            </ion-accordion>

            <!-- Industry Filter -->
            <ion-accordion value="industry">
                <ion-item slot="header">
                    <ion-label>{% trans "Industry" %}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content">
                    <div class="d-flex flex-wrap gap-xs">
                        <ion-chip class="cursor-pointer filter-chip" data-filter="industry" data-value=""
                            color="{% if not request.GET.industry %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('industry', '')">
                            <ion-label>{% trans "All" %}</ion-label>
                        </ion-chip>
                        {% for industry in filters.industries %}
                        <ion-chip class="cursor-pointer filter-chip" data-filter="industry"
                            data-value="{{ industry.id }}"
                            color="{% if request.GET.industry == industry.id %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('industry', '{{ industry.id }}')">
                            <ion-label>{{ industry.name }}</ion-label>
                        </ion-chip>
                        {% endfor %}
                    </div>
                </div>
            </ion-accordion>

            <!-- Pricing Type Filter -->
            <ion-accordion value="pricing">
                <ion-item slot="header">
                    <ion-label>{% trans "Pricing" %}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content">
                    <div class="d-flex flex-wrap gap-xs">
                        <ion-chip class="cursor-pointer filter-chip" data-filter="type" data-value=""
                            color="{% if not request.GET.type %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('type', '')">
                            <ion-label>{% trans "All" %}</ion-label>
                        </ion-chip>
                        {% for type in filters.types %}
                        <ion-chip class="cursor-pointer filter-chip" data-filter="type" data-value="{{ type.id }}"
                            color="{% if request.GET.type == type.id %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('type', '{{ type.id }}')">
                            {% if type.icon %}<ion-icon name="{{ type.icon }}"></ion-icon>{% endif %}
                            <ion-label>{{ type.name }}</ion-label>
                        </ion-chip>
                        {% endfor %}
                    </div>
                </div>
            </ion-accordion>

            {% elif store_type == 'hubs' %}
            <!-- Region Filter -->
            <ion-accordion value="region">
                <ion-item slot="header">
                    <ion-label>{% trans "Region" %}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content">
                    <div class="d-flex flex-wrap gap-xs">
                        <ion-chip class="cursor-pointer filter-chip" data-filter="region" data-value=""
                            color="{% if not request.GET.region %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('region', '')">
                            <ion-label>{% trans "All" %}</ion-label>
                        </ion-chip>
                        {% for region in filters.regions %}
                        <ion-chip class="cursor-pointer filter-chip" data-filter="region" data-value="{{ region.id }}"
                            color="{% if request.GET.region == region.id %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('region', '{{ region.id }}')">
                            <ion-label>{{ region.name }}</ion-label>
                        </ion-chip>
                        {% endfor %}
                    </div>
                </div>
            </ion-accordion>

            <!-- Plan Filter -->
            <ion-accordion value="plan">
                <ion-item slot="header">
                    <ion-label>{% trans "Plan" %}</ion-label>
                </ion-item>
                <div class="ion-padding" slot="content">
                    <div class="d-flex flex-wrap gap-xs">
                        <ion-chip class="cursor-pointer filter-chip" data-filter="plan" data-value=""
                            color="{% if not request.GET.plan %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('plan', '')">
                            <ion-label>{% trans "All" %}</ion-label>
                        </ion-chip>
                        {% for plan in filters.plans %}
                        <ion-chip class="cursor-pointer filter-chip" data-filter="plan" data-value="{{ plan.id }}"
                            color="{% if request.GET.plan == plan.id %}primary{% else %}medium{% endif %}"
                            onclick="setFilter('plan', '{{ plan.id }}')">
                            <ion-label>{{ plan.name }}</ion-label>
                        </ion-chip>
                        {% endfor %}
                    </div>
                </div>
            </ion-accordion>
            {% endif %}
        </ion-accordion-group>
    </ion-content>
    <ion-footer>
        <ion-toolbar>
            <ion-buttons slot="start">
                <ion-button fill="clear" color="danger" onclick="clearAllFilters()">
                    <ion-icon name="trash-outline" slot="start"></ion-icon>
                    {% trans "Clear" %}
                </ion-button>
            </ion-buttons>
            <ion-buttons slot="end">
                <ion-button fill="solid" color="primary" onclick="applyFilters()">
                    {% trans "Apply" %}
                </ion-button>
            </ion-buttons>
        </ion-toolbar>
    </ion-footer>
</ion-modal>

<script>
(function () {
    // Modal functions
    window.openFiltersModal = function () {
        const modal = document.getElementById('filters-modal');
        if (modal) modal.present();
    };

    window.closeFiltersModal = function () {
        const modal = document.getElementById('filters-modal');
        if (modal) modal.dismiss();
    };

    window.applyFilters = function () {
        // Trigger HTMX request
        document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
        updateActiveFilters();
        closeFiltersModal();
    };

    // Set a filter value
    window.setFilter = function (filterName, value) {
        const input = document.getElementById('filter-' + filterName);
        if (input) {
            input.value = value;
            updateChipColors(filterName, value);
        }
    };

    // Update chip colors for a filter
    function updateChipColors(filterName, activeValue) {
        document.querySelectorAll('.filter-chip[data-filter="' + filterName + '"]').forEach(function (chip) {
            var chipValue = chip.dataset.value;
            chip.color = chipValue === activeValue ? 'primary' : 'medium';
        });
    }

    // Clear all filters
    window.clearAllFilters = function () {
        ['category', 'industry', 'type', 'region', 'plan'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input) {
                input.value = '';
                updateChipColors(filter, '');
            }
        });
        // Clear search
        var searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        // Trigger HTMX
        document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
        updateActiveFilters();
        closeFiltersModal();
    };

    // Update active filters display
    window.updateActiveFilters = function () {
        var container = document.getElementById('active-filters');
        var chipsContainer = document.getElementById('active-filters-chips');
        var filterToggleBtn = document.getElementById('filter-toggle-btn');

        var count = 0;

        // Clear previous chips
        chipsContainer.innerHTML = '';

        // Check search
        var searchInput = document.getElementById('search-input');
        var searchValue = searchInput ? searchInput.value : '';
        if (searchValue) {
            var searchChip = document.createElement('ion-chip');
            searchChip.color = 'warning';
            searchChip.className = 'cursor-pointer';
            searchChip.innerHTML = '<ion-icon name="search"></ion-icon><ion-label>' + searchValue + '</ion-label><ion-icon name="close-circle"></ion-icon>';
            searchChip.addEventListener('click', function() { clearSearch(); });
            chipsContainer.appendChild(searchChip);
            count++;
        }

        // Check filters
        ['category', 'industry', 'type', 'region', 'plan'].forEach(function (filter) {
            var input = document.getElementById('filter-' + filter);
            if (input && input.value) {
                var chip = document.createElement('ion-chip');
                chip.color = 'warning';
                chip.className = 'cursor-pointer';
                chip.innerHTML = '<ion-label>' + input.value + '</ion-label><ion-icon name="close-circle"></ion-icon>';
                chip.addEventListener('click', function() { removeFilter(filter); });
                chipsContainer.appendChild(chip);
                count++;
            }
        });

        // Update UI
        if (count > 0) {
            container.style.display = 'flex';
        } else {
            container.style.display = 'none';
        }

        // Update badge on filter button
        if (filterToggleBtn) {
            var badge = filterToggleBtn.querySelector('ion-badge');
            if (count > 0) {
                if (!badge) {
                    badge = document.createElement('ion-badge');
                    badge.color = 'danger';
                    badge.style.cssText = 'position: absolute; top: -4px; right: -4px; font-size: 10px; min-width: 18px; height: 18px; border-radius: 50%;';
                    filterToggleBtn.appendChild(badge);
                }
                badge.textContent = count;
            } else if (badge) {
                badge.remove();
            }
        }
    };

    // Remove a single filter
    window.removeFilter = function (filterName) {
        var input = document.getElementById('filter-' + filterName);
        if (input) {
            input.value = '';
            updateChipColors(filterName, '');
            input.dispatchEvent(new Event('change', { bubbles: true }));
        }
        updateActiveFilters();
    };

    // Clear search only
    window.clearSearch = function () {
        var searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.value = '';
            document.getElementById('filter-category').dispatchEvent(new Event('change', { bubbles: true }));
            updateActiveFilters();
        }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', updateActiveFilters);
    // Also run immediately for HTMX loads
    updateActiveFilters();
})();
</script>
