{% load i18n djicons %}

<div class="mt-5">
    {% if active_blocks_count > 0 %}
    <p class="text-sm opacity-50 mb-4">
        {% icon "checkmark-circle-outline" css_class="text-primary" %}
        {{ active_blocks_count }} {% trans "blocks active" %}
    </p>
    {% endif %}

    {% if grouped_blocks %}
    <div class="flex flex-col gap-6">
        {% for cat_key, cat_label, blocks in grouped_blocks %}
        <div>
            <h3 class="text-xs font-semibold uppercase tracking-wide opacity-40 mb-3">{{ cat_label }}</h3>
            <div class="module-grid module-grid-3">
                {% for solution in blocks %}
                <div class="module-card cursor-pointer {% if solution.is_active %}ring-2 ring-primary{% endif %}"
                     hx-get="{% url 'marketplace:solution_detail' slug=solution.slug %}"
                     hx-target="#main-content-area"
                     hx-push-url="true">
                    <div class="module-card-body">
                        <div class="module-card-header">
                            <div class="module-card-icon" style="background-color: {{ solution.color }}; color: white;">
                                {% icon solution.icon|default:"briefcase-outline" %}
                            </div>

                            <div class="module-card-info">
                                <h4 class="module-card-name">{{ solution.name }}</h4>
                                <div class="module-card-meta">
                                    <span class="chip chip-sm">{{ solution.all_modules_count }} {% trans "modules" %}</span>
                                </div>
                            </div>

                            <div class="module-card-badges">
                                {% if solution.is_active %}
                                <span class="badge badge-sm color-success">
                                    {% icon "checkmark-circle" %}
                                    {% trans "Active" %}
                                </span>
                                {% endif %}
                                {% if solution.is_featured %}
                                <span class="badge badge-sm color-warning">
                                    {% icon "star" %}
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <p class="module-card-description">{{ solution.tagline }}</p>

                        <div class="module-card-footer">
                            <span class="chip chip-sm">{{ solution.required_module_count|default:solution.all_modules_count }} {% trans "required" %}</span>

                            <div class="module-card-actions">
                                {% if solution.is_active %}
                                <span class="text-xs opacity-50">{% trans "Active" %}</span>
                                {% else %}
                                <button class="btn btn-sm color-primary"
                                        onclick="event.stopPropagation(); toggleBlock('{{ solution.slug }}', this)">
                                    {% icon "add-outline" %}
                                    {% trans "Activate" %}
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
    function toggleBlock(slug, button) {
        var originalHtml = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<span class="loading loading-sm"></span>';

        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
            || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';

        fetch('/marketplace/solutions/' + slug + '/toggle/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                if (typeof Toast !== 'undefined') {
                    Toast.success(data.action === 'activated'
                        ? '{% trans "Block activated" %}'
                        : '{% trans "Block deactivated" %}');
                }
                // Reload to refresh active state
                htmx.ajax('GET', '/marketplace/solutions/', {target: '#main-content-area', swap: 'innerHTML'});
            } else {
                button.disabled = false;
                button.innerHTML = originalHtml;
                if (typeof Toast !== 'undefined') Toast.error(data.error || '{% trans "Action failed." %}');
            }
        })
        .catch(function(e) {
            button.disabled = false;
            button.innerHTML = originalHtml;
            if (typeof Toast !== 'undefined') Toast.error(e.message);
        });
    }
    </script>
    {% else %}
    <div class="text-center py-16">
        {% icon "apps-outline" css_class="text-6xl opacity-20 mb-4" %}
        <h3 class="text-lg font-semibold mb-2">{% trans "No Blocks Available" %}</h3>
        <p class="text-sm opacity-60">{% trans "Could not load functional blocks. Please check your internet connection and try again." %}</p>
    </div>
    {% endif %}
</div>
