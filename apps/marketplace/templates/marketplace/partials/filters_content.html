{% load i18n djicons %}

<div x-data="filtersMenu()" x-init="init()" class="p-md">
    {% if store_type == 'modules' %}
    <!-- Category Filter -->
    <div class="mb-lg">
        <h3 class="fs-sm fw-semibold text-secondary mb-sm">{% trans "Category" %}</h3>
        <div class="flex flex-wrap gap-2">
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': categoryFilter === '' }"
                    @click="setCategory('')">
                {% trans "All Categories" %}
            </button>
            {% for category in filters.categories %}
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': categoryFilter === '{{ category.id }}' }"
                    @click="setCategory('{{ category.id }}')">
                {{ category.name }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Block Filter -->
    <div class="mb-lg">
        <h3 class="fs-sm fw-semibold text-secondary mb-sm">{% trans "Block" %}</h3>
        <div class="flex flex-wrap gap-2">
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': blockFilter === '' }"
                    @click="setBlock('')">
                {% trans "All Blocks" %}
            </button>
            {% for group in filters.blocks_grouped %}
                {% for block in group.blocks %}
                <button type="button"
                        class="chip"
                        :class="{ 'chip-active': blockFilter === '{{ block.id }}' }"
                        @click="setBlock('{{ block.id }}')">
                    {{ block.name }}
                </button>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- Type Filter -->
    <div class="mb-lg">
        <h3 class="fs-sm fw-semibold text-secondary mb-sm">{% trans "Pricing" %}</h3>
        <div class="flex flex-wrap gap-2">
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': typeFilter === '' }"
                    @click="setType('')">
                {% trans "All Types" %}
            </button>
            {% for type in filters.types %}
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': typeFilter === '{{ type.id }}' }"
                    @click="setType('{{ type.id }}')">
                {% if type.icon %}{% icon type.icon %}{% endif %}
                {{ type.name }}
            </button>
            {% endfor %}
        </div>
    </div>

    {% elif store_type == 'hubs' %}
    <!-- Region Filter -->
    <div class="mb-lg">
        <h3 class="fs-sm fw-semibold text-secondary mb-sm">{% trans "Region" %}</h3>
        <div class="flex flex-wrap gap-2">
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': regionFilter === '' }"
                    @click="setRegion('')">
                {% trans "All Regions" %}
            </button>
            {% for region in filters.regions %}
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': regionFilter === '{{ region.id }}' }"
                    @click="setRegion('{{ region.id }}')">
                {{ region.name }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Plan Filter -->
    <div class="mb-lg">
        <h3 class="fs-sm fw-semibold text-secondary mb-sm">{% trans "Plan" %}</h3>
        <div class="flex flex-wrap gap-2">
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': planFilter === '' }"
                    @click="setPlan('')">
                {% trans "All Plans" %}
            </button>
            {% for plan in filters.plans %}
            <button type="button"
                    class="chip"
                    :class="{ 'chip-active': planFilter === '{{ plan.id }}' }"
                    @click="setPlan('{{ plan.id }}')">
                {{ plan.name }}
            </button>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Apply Button (mobile friendly) -->
    <div class="mt-lg">
        <button type="button"
                class="btn btn-lg color-primary"
                style="width: 100%;"
                @click="applyAndClose()">
            {% icon "checkmark-outline" %}
            <span>{% trans "Apply Filters" %}</span>
        </button>
    </div>
</div>

<script>
(function() {
    const filtersMenuData = () => ({
        // Module filters
        categoryFilter: '',
        blockFilter: '',
        typeFilter: '',
        // Hub filters
        regionFilter: '',
        planFilter: '',

        init() {
            // Listen for clear events from main marketplace
            window.addEventListener('marketplace:clear-filter', (e) => {
                const { filterType } = e.detail;
                if (filterType === 'category') this.categoryFilter = '';
                if (filterType === 'block') this.blockFilter = '';
                if (filterType === 'type') this.typeFilter = '';
                if (filterType === 'region') this.regionFilter = '';
                if (filterType === 'plan') this.planFilter = '';
            });

            window.addEventListener('marketplace:clear-all-filters', () => {
                this.categoryFilter = '';
                this.blockFilter = '';
                this.typeFilter = '';
                this.regionFilter = '';
                this.planFilter = '';
            });
        },

        setCategory(value) {
            this.categoryFilter = value;
            this.emitFilterChange('category', value);
        },

        setBlock(value) {
            this.blockFilter = value;
            this.emitFilterChange('block', value);
        },

        setType(value) {
            this.typeFilter = value;
            this.emitFilterChange('type', value);
        },

        setRegion(value) {
            this.regionFilter = value;
            this.emitFilterChange('region', value);
        },

        setPlan(value) {
            this.planFilter = value;
            this.emitFilterChange('plan', value);
        },

        emitFilterChange(filterType, value) {
            window.dispatchEvent(new CustomEvent('marketplace:filter-changed', {
                detail: { filterType, value }
            }));
        },

        applyAndClose() {
            if (typeof menuController !== 'undefined') {
                menuController.close('filters-menu');
            }
        }
    });

    // Register with Alpine
    if (typeof Alpine !== 'undefined' && Alpine.data) {
        Alpine.data('filtersMenu', filtersMenuData);
    } else {
        document.addEventListener('alpine:init', () => {
            Alpine.data('filtersMenu', filtersMenuData);
        }, { once: true });
    }

    window.filtersMenu = filtersMenuData;
})();
</script>
