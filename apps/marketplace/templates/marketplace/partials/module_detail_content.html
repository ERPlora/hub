{% load i18n ui component_tags djicons %}

{% component "page" title=module.name|default:_("Module Details") back_hx_get="/marketplace/" back_hx_target="#main-content-area" back_hx_push_url="true" %}
    {# Marketplace tabbar - manual since it's not a module #}
    <script>
    (function() {
        if (typeof window.updateGlobalTabBar === 'function') {
            window.updateGlobalTabBar([
                {
                    url: '{% url "marketplace:index" %}',
                    icon: 'cube-outline',
                    label: '{% trans "Modules" %}',
                    active: true
                },
                {
                    url: '{% url "marketplace:store_hubs" %}',
                    icon: 'server-outline',
                    label: '{% trans "Hubs" %}',
                    active: false
                },
                {
                    url: '{% url "marketplace:cart_page" %}',
                    icon: 'cart-outline',
                    label: '{% trans "Cart" %}',
                    active: false
                }
            ]);
        }
    })();
    </script>
    {% fill "content" %}

{% if error %}
    <!-- Error State -->
    <div class="ux-callout ux-callout--danger mx-md my-md">
        <div class="ux-callout__icon">
            {% icon "alert-circle-outline" %}
        </div>
        <div class="ux-callout__content">
            <h3 class="ux-callout__title">{% trans "Error" %}</h3>
            <p class="ux-callout__text">{{ error }}</p>
        </div>
    </div>

{% elif module %}
    <div class="p-md">
        <!-- Hero Card -->
        <div class="ux-card mb-lg">
            <div class="ux-card__body">
                <div class="module-detail-header">
                    <!-- Icon -->
                    <div class="module-detail-icon">
                        <div class="ux-product-card__placeholder" style="width: 80px; height: 80px; border-radius: var(--ux-border-radius-lg);">
                            {% icon module.icon|default:"cube-outline" %}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="module-detail-info">
                        <h1 class="fs-2xl fw-bold mb-sm m-0">{{ module.name }}</h1>
                        <p class="text-secondary mb-sm m-0">
                            {% trans "by" %} <strong>{{ module.author|default:"ERPlora" }}</strong>
                        </p>
                        <p class="text-secondary mb-md m-0">{{ module.description }}</p>

                        <!-- Stats -->
                        <div class="d-flex flex-wrap gap-md align-center mb-md">
                            {% if module.downloads %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "download-outline" %}
                                {{ module.downloads }} {% trans "downloads" %}
                            </span>
                            {% endif %}
                            {% if module.rating %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "star" css_class="text-warning" %}
                                {{ module.rating|floatformat:1 }}
                            </span>
                            {% endif %}
                            {% if module.category_name %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "pricetag-outline" %}
                                {{ module.category_name }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Status Badges -->
                        <div class="d-flex flex-wrap gap-sm align-center">
                            {% if module.is_featured %}
                            <span class="ux-badge ux-color-warning">
                                {% icon "star" %}
                                {% trans "Featured" %}
                            </span>
                            {% endif %}
                            {% if is_installed %}
                            <span class="ux-chip ux-color-success--soft">
                                <span class="ux-chip__icon">{% icon "checkmark-circle-outline" %}</span>
                                {% trans "Installed" %}
                            </span>
                            {% elif is_owned %}
                            <span class="ux-chip ux-color-tertiary--soft">
                                <span class="ux-chip__icon">{% icon "bag-check-outline" %}</span>
                                {% trans "Owned" %}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Price & Actions -->
                    <div class="module-detail-actions">
                        {% if not is_installed and not is_owned %}
                        <div class="mb-md text-right">
                            {% if module.module_type == 'free' or is_free %}
                            <div class="fs-2xl fw-bold" style="color: var(--ux-success);">{% trans "Free" %}</div>
                            {% elif module.module_type == 'one_time' %}
                            <div class="fs-2xl fw-bold" style="color: var(--ux-primary);">&euro;{{ module.price }}</div>
                            <div class="fs-sm text-secondary">{% trans "one-time payment" %}</div>
                            {% elif module.module_type == 'subscription' %}
                            <div class="fs-2xl fw-bold" style="color: var(--ux-primary);">&euro;{{ module.subscription_price_monthly|default:module.price }}/{% trans "mo" %}</div>
                            <div class="fs-sm text-secondary">{% trans "monthly subscription" %}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex flex-column gap-sm">
                            {% if is_installed %}
                            <button type="button" class="ux-button ux-button--lg" disabled>
                                {% icon "checkmark-circle-outline" %}
                                <span>{% trans "Installed" %}</span>
                            </button>
                            {% elif is_owned %}
                            <button type="button"
                                    class="ux-button ux-button--lg ux-color-success"
                                    data-action="download"
                                    data-module-slug="{{ module.slug }}"
                                    data-download-url="{{ module.download_url }}">
                                {% icon "download-outline" %}
                                <span>{% trans "Download & Install" %}</span>
                            </button>
                            {% elif module.module_type == 'free' or is_free %}
                            <button type="button"
                                    class="ux-button ux-button--lg ux-color-primary"
                                    data-action="install-free"
                                    data-module-id="{{ module.id }}"
                                    data-module-slug="{{ module.slug }}"
                                    data-download-url="{{ module.download_url|default:'' }}">
                                {% icon "download-outline" %}
                                <span>{% trans "Get Free Module" %}</span>
                            </button>
                            {% else %}
                            <button type="button"
                                    class="ux-button ux-button--lg ux-color-primary"
                                    data-action="purchase"
                                    data-module-id="{{ module.id }}">
                                {% icon "cart-outline" %}
                                <span>{% trans "Purchase" %}</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="ux-tabs" x-data="{ activeTab: 'overview' }">
            <div class="ux-tab-bar">
                <button type="button"
                        class="ux-tab-button"
                        :class="{ 'ux-tab-button--selected': activeTab === 'overview' }"
                        @click="activeTab = 'overview'">
                    {% trans "Overview" %}
                </button>
                <button type="button"
                        class="ux-tab-button"
                        :class="{ 'ux-tab-button--selected': activeTab === 'reviews' }"
                        @click="activeTab = 'reviews'">
                    {% trans "Reviews" %} ({{ module.review_count|default:0 }})
                </button>
                <button type="button"
                        class="ux-tab-button"
                        :class="{ 'ux-tab-button--selected': activeTab === 'changelog' }"
                        @click="activeTab = 'changelog'">
                    {% trans "Changelog" %}
                </button>
            </div>

            <!-- Overview Tab -->
            <div class="ux-tab-panel" :class="{ 'ux-tab-panel--active': activeTab === 'overview' }" x-show="activeTab === 'overview'">
                <div class="ux-card mt-lg mb-lg">
                    <div class="ux-card__header">
                        <h3 class="ux-card__title">{% trans "About this module" %}</h3>
                    </div>
                    <div class="ux-card__body">
                        <div class="markdown-content">
                            {% if module.long_description %}
                            {{ module.long_description|linebreaks }}
                            {% else %}
                            {{ module.description|linebreaks }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="ux-card">
                    <div class="ux-card__header">
                        <h3 class="ux-card__title">{% trans "Module Information" %}</h3>
                    </div>
                    <div class="ux-card__body p-0">
                        <div class="ux-list">
                            <div class="ux-list__item">
                                <span class="ux-list__item-label">{% trans "Version" %}</span>
                                <span class="ux-list__item-value">{{ module.version }}</span>
                            </div>
                            <div class="ux-list__item">
                                <span class="ux-list__item-label">{% trans "Author" %}</span>
                                <span class="ux-list__item-value">{{ module.author|default:"ERPlora" }}</span>
                            </div>
                            <div class="ux-list__item">
                                <span class="ux-list__item-label">{% trans "Category" %}</span>
                                <span class="ux-list__item-value">{{ module.category_name|default:module.category }}</span>
                            </div>
                            <div class="ux-list__item">
                                <span class="ux-list__item-label">{% trans "License" %}</span>
                                <span class="ux-list__item-value">{{ module.license|default:"Proprietary" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="ux-tab-panel" :class="{ 'ux-tab-panel--active': activeTab === 'reviews' }" x-show="activeTab === 'reviews'">
                {% if module.recent_reviews %}
                {% for review in module.recent_reviews %}
                <div class="ux-card mt-lg mb-md">
                    <div class="ux-card__body">
                        <div class="d-flex justify-between align-start mb-sm">
                            <div>
                                <p class="fw-semibold m-0">{{ review.user_name|default:"Anonymous" }}</p>
                                <div class="d-flex gap-xxs mt-xs text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        {% icon "star" %}
                                        {% else %}
                                        {% icon "star-outline" css_class="text-medium" %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="fs-xs text-secondary">{{ review.created_at }}</span>
                        </div>
                        {% if review.title %}
                        <h4 class="fw-semibold mb-xs m-0">{{ review.title }}</h4>
                        {% endif %}
                        <p class="text-secondary m-0">{{ review.comment }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="ux-empty-state mt-lg">
                    <div class="ux-empty-state__icon">
                        {% icon "chatbubbles-outline" %}
                    </div>
                    <h3 class="ux-empty-state__title">{% trans "No reviews yet" %}</h3>
                    <p class="ux-empty-state__description">{% trans "Be the first to review this module" %}</p>
                </div>
                {% endif %}
            </div>

            <!-- Changelog Tab -->
            <div class="ux-tab-panel" :class="{ 'ux-tab-panel--active': activeTab === 'changelog' }" x-show="activeTab === 'changelog'">
                <div class="ux-card mt-lg">
                    <div class="ux-card__header">
                        <h3 class="ux-card__title">{% trans "Changelog" %}</h3>
                    </div>
                    <div class="ux-card__body">
                        {% if module.changelog %}
                        <div class="markdown-content">
                            {{ module.changelog|linebreaks }}
                        </div>
                        {% else %}
                        <div class="text-center py-xl">
                            {% icon "document-text-outline" css_class="fs-4xl text-medium" %}
                            <p class="text-secondary mt-md m-0">{% trans "No changelog available" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Modules -->
        {% if related_modules %}
        <div class="mt-xl">
            <h2 class="fs-xl fw-semibold mb-md">{% trans "Related Modules" %}</h2>
            <div class="ux-product-grid ux-product-grid--3">
                {% for related in related_modules %}
                <article class="ux-product-card"
                         hx-get="{% url 'marketplace:module_detail' related.slug %}"
                         hx-target="#main-content-area"
                         hx-push-url="true">
                    <div class="ux-product-card__image-wrapper">
                        <div class="ux-product-card__placeholder">
                            {% icon related.icon|default:"cube-outline" %}
                        </div>
                    </div>
                    <div class="ux-product-card__content">
                        <h3 class="ux-product-card__name">{{ related.name }}</h3>
                        <p class="fs-xs text-tertiary m-0">v{{ related.version|default:"1.0" }}</p>
                        <p class="fs-sm text-secondary mt-xs mb-0" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ related.description }}</p>
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

{% endif %}

    {% endfill %}
{% endcomponent %}

<!-- Module action handlers -->
<script>
document.addEventListener('click', function(e) {
    const button = e.target.closest('button[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        const originalContent = button.innerHTML;
        button.dataset.originalContent = originalContent;
        button.innerHTML = '<div class="ux-spinner ux-spinner--sm"></div>';
    } else if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
    }
}
</script>

<style>
.module-detail-header {
    display: flex;
    flex-wrap: wrap;
    gap: var(--ux-space-lg, 1.5rem);
}

.module-detail-icon {
    flex-shrink: 0;
}

.module-detail-info {
    flex: 1;
    min-width: 200px;
}

.module-detail-actions {
    flex-shrink: 0;
    min-width: 200px;
}

@media (max-width: 768px) {
    .module-detail-header {
        flex-direction: column;
    }

    .module-detail-actions {
        width: 100%;
    }
}

.markdown-content {
    line-height: 1.6;
}

.markdown-content p {
    margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

/* Simple list styles for module info */
.ux-list {
    display: flex;
    flex-direction: column;
}

.ux-list__item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--ux-space-md, 1rem) var(--ux-space-lg, 1.5rem);
    border-bottom: 1px solid var(--ux-border-color);
}

.ux-list__item:last-child {
    border-bottom: none;
}

.ux-list__item-label {
    color: var(--ux-text-secondary);
}

.ux-list__item-value {
    color: var(--ux-text);
    font-weight: 500;
}
</style>
