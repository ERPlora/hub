{% load i18n component_tags djicons %}

{% component "page" title=module.name|default:_("Module Details") back_hx_get="/marketplace/" back_hx_target="#main-content-area" back_hx_push_url="true" %}
    {# Marketplace tabbar - manual since it's not a module #}
    <script>
    (function() {
        if (typeof window.updateGlobalTabBar === 'function') {
            window.updateGlobalTabBar([
                {
                    url: '{% url "marketplace:index" %}',
                    icon: 'cube-outline',
                    label: '{% trans "Modules" %}',
                    active: true
                },
                {
                    url: '{% url "marketplace:store_hubs" %}',
                    icon: 'server-outline',
                    label: '{% trans "Hubs" %}',
                    active: false
                },
                {
                    url: '{% url "marketplace:cart_page" %}',
                    icon: 'cart-outline',
                    label: '{% trans "Cart" %}',
                    active: false
                }
            ]);
        }
    })();
    </script>
    {% fill "content" %}

{% if error %}
    <!-- Error State -->
    <div class="callout callout-error mx-4 my-4">
        <span class="callout-icon">
            {% icon "alert-circle-outline" %}
        </span>
        <div class="callout-content">
            <div class="callout-title">{% trans "Error" %}</div>
            <div class="callout-text">{{ error }}</div>
        </div>
    </div>

{% elif module %}
    <div class="p-md">
        <!-- Hero Card -->
        <div class="card mb-lg">
            <div class="card-body">
                <div class="module-detail-header">
                    <!-- Icon -->
                    <div class="module-detail-icon">
                        <div class="flex items-center justify-center" style="width: 80px; height: 80px; border-radius: var(--radius-lg);">
                            {% icon module.icon|default:"cube-outline" %}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="module-detail-info">
                        <h1 class="fs-2xl fw-bold mb-sm m-0">{{ module.name }}</h1>
                        <p class="text-secondary mb-sm m-0">
                            {% trans "by" %} <strong>{{ module.author|default:"ERPlora" }}</strong>
                        </p>
                        <p class="text-secondary mb-md m-0">{{ module.description }}</p>

                        <!-- Stats -->
                        <div class="d-flex flex-wrap gap-md align-center mb-md">
                            {% if module.downloads %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "download-outline" %}
                                {{ module.downloads }} {% trans "downloads" %}
                            </span>
                            {% endif %}
                            {% if module.rating %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "star" css_class="text-warning" %}
                                {{ module.rating|floatformat:1 }}
                            </span>
                            {% endif %}
                            {% if module.category_name %}
                            <span class="d-inline-flex align-center gap-xs text-secondary fs-sm">
                                {% icon "pricetag-outline" %}
                                {{ module.category_name }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Status Badges -->
                        <div class="d-flex flex-wrap gap-sm align-center">
                            {% if module.is_featured %}
                            <span class="badge color-warning">
                                {% icon "star" %}
                                {% trans "Featured" %}
                            </span>
                            {% endif %}
                            {% if is_installed %}
                            <span class="chip color-success">
                                {% icon "checkmark-circle-outline" %}
                                {% trans "Installed" %}
                            </span>
                            {% elif is_owned %}
                            <span class="chip color-secondary">
                                {% icon "bag-check-outline" %}
                                {% trans "Owned" %}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Price & Actions -->
                    <div class="module-detail-actions">
                        {% if not is_installed and not is_owned %}
                        <div class="mb-md text-right">
                            {% if module.module_type == 'free' or is_free %}
                            <div class="fs-2xl fw-bold" style="color: var(--color-success);">{% trans "Free" %}</div>
                            {% elif module.module_type == 'one_time' %}
                            <div class="fs-2xl fw-bold" style="color: var(--color-primary);">&euro;{{ module.price }}</div>
                            <div class="fs-sm text-secondary">{% trans "one-time payment" %}</div>
                            {% elif module.module_type == 'subscription' %}
                            <div class="fs-2xl fw-bold" style="color: var(--color-primary);">&euro;{{ module.subscription_price_monthly|default:module.price }}/{% trans "mo" %}</div>
                            <div class="fs-sm text-secondary">{% trans "monthly subscription" %}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex flex-column gap-sm">
                            {% if is_installed %}
                            <button type="button" class="btn btn-lg" disabled>
                                {% icon "checkmark-circle-outline" %}
                                <span>{% trans "Installed" %}</span>
                            </button>
                            {% elif is_owned %}
                            <button type="button"
                                    class="btn btn-lg color-success"
                                    data-action="download"
                                    data-module-slug="{{ module.slug }}"
                                    data-download-url="{{ module.download_url }}">
                                {% icon "download-outline" %}
                                <span>{% trans "Download & Install" %}</span>
                            </button>
                            {% elif module.module_type == 'free' or is_free %}
                            <button type="button"
                                    class="btn btn-lg color-primary"
                                    data-action="install-free"
                                    data-module-id="{{ module.id }}"
                                    data-module-slug="{{ module.slug }}"
                                    data-download-url="{{ module.download_url|default:'' }}">
                                {% icon "download-outline" %}
                                <span>{% trans "Get Free Module" %}</span>
                            </button>
                            {% else %}
                            <button type="button"
                                    class="btn btn-lg color-primary"
                                    data-action="purchase"
                                    data-module-id="{{ module.id }}">
                                {% icon "cart-outline" %}
                                <span>{% trans "Purchase" %}</span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" x-data="{ activeTab: 'overview' }">
            <div>
                <button type="button"
                        class="tab"
                        :class="{ 'tab-active': activeTab === 'overview' }"
                        @click="activeTab = 'overview'">
                    {% trans "Overview" %}
                </button>
                <button type="button"
                        class="tab"
                        :class="{ 'tab-active': activeTab === 'reviews' }"
                        @click="activeTab = 'reviews'">
                    {% trans "Reviews" %} ({{ module.review_count|default:0 }})
                </button>
                <button type="button"
                        class="tab"
                        :class="{ 'tab-active': activeTab === 'changelog' }"
                        @click="activeTab = 'changelog'">
                    {% trans "Changelog" %}
                </button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-panel" :class="{ 'tab-panel--active': activeTab === 'overview' }" x-show="activeTab === 'overview'">
                <div class="card mt-lg mb-lg">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "About this module" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="markdown-content">
                            {% if module.long_description %}
                            {{ module.long_description|linebreaks }}
                            {% else %}
                            {{ module.description|linebreaks }}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "Module Information" %}</h3>
                    </div>
                    <div class="card-body p-0">
                        <div class="list">
                            <div class="list-item">
                                <span class="list-item-label">{% trans "Version" %}</span>
                                <span class="list-item-value">{{ module.version }}</span>
                            </div>
                            <div class="list-item">
                                <span class="list-item-label">{% trans "Author" %}</span>
                                <span class="list-item-value">{{ module.author|default:"ERPlora" }}</span>
                            </div>
                            <div class="list-item">
                                <span class="list-item-label">{% trans "Category" %}</span>
                                <span class="list-item-value">{{ module.category_name|default:module.category }}</span>
                            </div>
                            <div class="list-item">
                                <span class="list-item-label">{% trans "License" %}</span>
                                <span class="list-item-value">{{ module.license|default:"Proprietary" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-panel" :class="{ 'tab-panel--active': activeTab === 'reviews' }" x-show="activeTab === 'reviews'">
                {% if module.recent_reviews %}
                {% for review in module.recent_reviews %}
                <div class="card mt-lg mb-md">
                    <div class="card-body">
                        <div class="d-flex justify-between align-start mb-sm">
                            <div>
                                <p class="fw-semibold m-0">{{ review.user_name|default:"Anonymous" }}</p>
                                <div class="d-flex gap-xxs mt-xs text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        {% icon "star" %}
                                        {% else %}
                                        {% icon "star-outline" css_class="text-medium" %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="fs-xs text-secondary">{{ review.created_at }}</span>
                        </div>
                        {% if review.title %}
                        <h4 class="fw-semibold mb-xs m-0">{{ review.title }}</h4>
                        {% endif %}
                        <p class="text-secondary m-0">{{ review.comment }}</p>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="flex flex-col items-center text-center py-12 mt-4">
                    <div class="text-4xl mb-4 opacity-40">
                        {% icon "chatbubbles-outline" %}
                    </div>
                    <h3 class="text-lg font-semibold mb-2">{% trans "No reviews yet" %}</h3>
                    <p class="text-sm opacity-60">{% trans "Be the first to review this module" %}</p>
                </div>
                {% endif %}
            </div>

            <!-- Changelog Tab -->
            <div class="tab-panel" :class="{ 'tab-panel--active': activeTab === 'changelog' }" x-show="activeTab === 'changelog'">
                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "Changelog" %}</h3>
                    </div>
                    <div class="card-body">
                        {% if module.changelog %}
                        <div class="markdown-content">
                            {{ module.changelog|linebreaks }}
                        </div>
                        {% else %}
                        <div class="text-center py-xl">
                            {% icon "document-text-outline" css_class="fs-4xl text-medium" %}
                            <p class="text-secondary mt-md m-0">{% trans "No changelog available" %}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Modules -->
        {% if related_modules %}
        <div class="mt-xl">
            <h2 class="fs-xl fw-semibold mb-md">{% trans "Related Modules" %}</h2>
            <div class="module-grid module-grid-3">
                {% for related in related_modules %}
                {% include "system/modules/partials/module_card.html" with module=related card_context='marketplace' %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

{% endif %}

    {% endfill %}
{% endcomponent %}

<!-- Module action handlers -->
<script>
if (!window._marketplaceDetailInit) {
window._marketplaceDetailInit = true;
document.addEventListener('click', function(e) {
    const button = e.target.closest('button[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl, button);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });

        let data;
        try {
            data = await response.json();
        } catch (e) {
            Toast.error('{% trans "Server error. Please try again later." %}');
            return;
        }

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');
            markAsInstalled(button);

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Mark button and card as installed after successful install
function markAsInstalled(button) {
    if (!button) return;

    // Update the clicked button to "Installed" disabled state
    button.disabled = true;
    button.className = 'btn btn-sm';
    button.removeAttribute('data-action');
    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg> {% trans "Installed" %}';

    // Also update the module card if on marketplace grid
    const card = button.closest('.module-card');
    if (card) {
        card.classList.add('module-card-installed');
        // Add "Installed" chip to card meta
        const meta = card.querySelector('.module-card-meta');
        if (meta) {
            const chip = document.createElement('span');
            chip.className = 'chip chip-sm color-success';
            chip.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14" fill="currentColor"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg> {% trans "Installed" %}';
            meta.prepend(chip);
        }
    }

    // If on detail page, update the hero actions section
    const detailActions = document.querySelector('.module-detail-actions');
    if (detailActions) {
        const actionBtn = detailActions.querySelector('button[data-action]');
        if (actionBtn) {
            actionBtn.disabled = true;
            actionBtn.className = 'btn btn-lg';
            actionBtn.removeAttribute('data-action');
            actionBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="20" height="20" fill="currentColor"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg> <span>{% trans "Installed" %}</span>';
        }
        // Add installed badge
        const badges = document.querySelector('.module-detail-info .d-flex.flex-wrap.gap-sm');
        if (badges && !badges.querySelector('.color-success')) {
            const chip = document.createElement('span');
            chip.className = 'chip color-success';
            chip.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor"><path d="M256 48C141.31 48 48 141.31 48 256s93.31 208 208 208 208-93.31 208-208S370.69 48 256 48zm108.25 138.29-134.4 160a16 16 0 01-12 5.71h-.27a16 16 0 01-11.89-5.3l-57.6-64a16 16 0 1123.78-21.4l45.29 50.32 122.59-145.91a16 16 0 0124.5 20.58z"/></svg> {% trans "Installed" %}';
            badges.prepend(chip);
        }
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        const originalContent = button.innerHTML;
        button.dataset.originalContent = originalContent;
        button.innerHTML = '<div class="loading loading-sm"></div>';
    } else if (button.dataset.originalContent) {
        button.innerHTML = button.dataset.originalContent;
    }
}
} // end guard
</script>

<style>
.module-detail-header {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.module-detail-icon {
    flex-shrink: 0;
}

.module-detail-info {
    flex: 1;
    min-width: 200px;
}

.module-detail-actions {
    flex-shrink: 0;
    min-width: 200px;
}

@media (max-width: 768px) {
    .module-detail-header {
        flex-direction: column;
    }

    .module-detail-actions {
        width: 100%;
    }
}

.markdown-content {
    line-height: 1.6;
}

.markdown-content p {
    margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

</style>
