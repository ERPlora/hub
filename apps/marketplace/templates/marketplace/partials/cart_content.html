{% load i18n djicons %}

{% if cart.items %}
{# Cart Items #}
<div class="p-4">
    <div class="flex items-center justify-between mb-4">
        <span class="text-sm opacity-60">{{ cart.items|length }} {% trans "item" %}{{ cart.items|length|pluralize:"s" }}</span>
        <button type="button"
                class="btn btn-ghost btn-sm color-error"
                hx-delete="{% url 'marketplace:cart_clear' %}"
                hx-target="#cart-sheet-content"
                hx-swap="innerHTML"
                hx-confirm="{% trans 'Clear cart?' %}">
            {% icon "trash-outline" %}
            {% trans "Clear" %}
        </button>
    </div>

    <div class="list list-inset glass">
        {% for item in cart.items %}
        <div class="list-item list-item-multiline">
            <div class="list-item-start">
                <span style="font-size: 20px; color: var(--color-primary);">
                    {% icon item.icon|default:"cube-outline" %}
                </span>
            </div>
            <div class="list-item-content">
                <span class="list-item-label">{{ item.name }}{% if item.tier_slug %} <span class="badge badge-sm">{{ item.tier_slug|title }}</span>{% endif %}</span>
                <span class="list-item-note">
                    {% if item.module_type == 'subscription' %}
                    &euro;{{ item.price|floatformat:2 }}/{% trans "mo" %}
                    {% elif item.price == 0 %}
                    {% trans "Free" %}
                    {% else %}
                    &euro;{{ item.price|floatformat:2 }}
                    {% endif %}
                </span>
            </div>
            <div class="list-item-end">
                <button type="button"
                        class="btn btn-ghost btn-sm"
                        hx-delete="{% url 'marketplace:cart_remove' item.id %}"
                        hx-target="#cart-sheet-content"
                        hx-swap="innerHTML">
                    {% icon "close-outline" %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{# Cart Summary + Checkout #}
<div class="p-4 mt-auto" style="border-top: 0.5px solid var(--color-base-200);">
    <div class="flex items-center justify-between mb-4">
        <span class="text-sm font-semibold">{% trans "Total" %}</span>
        <span class="text-lg font-bold" style="color: var(--color-primary);">
            {% if cart.total == 0 %}
            {% trans "Free" %}
            {% else %}
            &euro;{{ cart.total|floatformat:2 }}
            {% endif %}
        </span>
    </div>

    <p class="text-xs opacity-50 mb-3">{% trans "Tax will be calculated at checkout." %}</p>

    <button type="button"
            class="btn btn-lg btn-block color-primary"
            onclick="checkoutCart(this)">
        {% icon "card-outline" %}
        {% trans "Checkout" %}
    </button>
</div>

{% else %}
{# Empty Cart #}
<div class="flex flex-col items-center justify-center py-12 px-4 text-center">
    <span style="font-size: 48px; opacity: 0.2; margin-bottom: 1rem;">
        {% icon "cart-outline" %}
    </span>
    <h3 class="text-sm font-semibold mb-1">{% trans "Your cart is empty" %}</h3>
    <p class="text-xs opacity-50">{% trans "Add paid modules to get started." %}</p>
</div>
{% endif %}

<script>
async function checkoutCart(btn) {
    var originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-sm"></span> {% trans "Processing..." %}';
    try {
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value
            || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
        var response = await fetch('{% url "marketplace:cart_checkout" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        });
        var data = await response.json();
        if (data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            if (typeof Toast !== 'undefined') Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.message) {
            if (typeof Toast !== 'undefined') Toast.info(data.message);
        } else {
            if (typeof Toast !== 'undefined') Toast.error(data.error || '{% trans "Checkout failed" %}');
        }
    } catch (e) {
        if (typeof Toast !== 'undefined') Toast.error('{% trans "Error starting checkout" %}');
    }
    btn.disabled = false;
    btn.innerHTML = originalHtml;
}
</script>
