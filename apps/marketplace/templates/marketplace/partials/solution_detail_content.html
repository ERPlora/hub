{% load i18n component_tags djicons %}

{% component "page" title=solution.name|default:_("Block") back_hx_get="/marketplace/solutions/" back_hx_target="#main-content-area" back_hx_push_url="true" %}
    {% fill "content" %}

{% if error %}
<div class="callout callout-warning mt-5">
    <div class="callout-content">
        <p class="callout-text">{% icon "alert-circle-outline" %} {{ error }}</p>
    </div>
</div>
{% elif solution %}

<div class="mt-5" x-data="blockDetail()">
    {# Hero card #}
    <div class="card glass mb-6">
        <div class="card-body p-6">
            <div class="flex items-start gap-4">
                <div class="module-card-icon shrink-0" style="background-color: {{ solution.color }}; color: white; width: 56px; height: 56px;">
                    {% icon solution.icon|default:"briefcase-outline" css_class="text-2xl" %}
                </div>
                <div class="flex-1 min-w-0">
                    <h2 class="text-xl font-bold mb-1">{{ solution.name }}</h2>
                    {% if solution.block_type %}
                    <span class="chip chip-sm mb-2">{{ solution.block_type|title }}</span>
                    {% endif %}
                    <p class="text-sm opacity-60">{{ solution.tagline }}</p>
                </div>
                <div class="shrink-0 flex items-center gap-2">
                    {% if is_block_active %}
                    <span class="badge color-success mr-2">
                        {% icon "checkmark-circle" %}
                        {% trans "Active" %}
                    </span>
                    <button class="btn btn-outline btn-sm color-error"
                            @click="toggleBlock()"
                            :disabled="toggling">
                        <span x-show="!toggling">
                            {% icon "close-outline" %}
                            {% trans "Deactivate" %}
                        </span>
                        <span x-show="toggling" class="flex items-center gap-2">
                            <span class="loading loading-sm"></span>
                        </span>
                    </button>
                    {% else %}
                    <button class="btn color-primary"
                            @click="toggleBlock()"
                            :disabled="toggling">
                        <span x-show="!toggling">
                            {% icon "add-outline" %}
                            {% trans "Activate Block" %}
                        </span>
                        <span x-show="toggling" class="flex items-center gap-2">
                            <span class="loading loading-sm"></span>
                            {% trans "Activating..." %}
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Description #}
    {% if solution.description %}
    <div class="card glass mb-6">
        <div class="card-body p-6">
            <h3 class="text-sm font-semibold mb-3">{% trans "Description" %}</h3>
            <div class="text-sm opacity-70 leading-relaxed">{{ solution.description|linebreaksbr }}</div>
        </div>
    </div>
    {% endif %}

    {# Required modules #}
    {% if required_modules %}
    <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3">
            {% icon "checkmark-circle-outline" css_class="text-primary" %}
            {% trans "Required Modules" %}
            <span class="badge badge-sm ml-1">{{ required_modules|length }}</span>
        </h3>
        <div class="list list-inset glass">
            {% for mod in required_modules %}
            <div class="list-item list-item-multiline">
                <div class="list-item-start">
                    <div class="module-card-icon" style="width: 36px; height: 36px;">
                        {% icon mod.icon|default:"cube-outline" %}
                    </div>
                </div>
                <div class="list-item-content">
                    <span class="list-item-label">
                        {{ mod.name }}
                        {% if mod.is_coming_soon %}
                        <span class="badge badge-sm ml-1">{% trans "Coming soon" %}</span>
                        {% endif %}
                    </span>
                    <span class="list-item-note">{{ mod.description|truncatewords:15 }}</span>
                </div>
                <div class="list-item-end">
                    {% if mod.is_installed %}
                    <span class="badge badge-sm color-success">{% trans "Installed" %}</span>
                    {% elif mod.is_coming_soon %}
                    <span class="badge badge-sm">{% trans "Planned" %}</span>
                    {% elif mod.module_type == 'free' %}
                    <span class="badge badge-sm color-success">{% trans "Free" %}</span>
                    {% else %}
                    <span class="badge badge-sm">&euro;{{ mod.price }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Optional modules #}
    {% if optional_modules %}
    <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3">
            {% icon "add-circle-outline" css_class="opacity-50" %}
            {% trans "Optional Modules" %}
            <span class="badge badge-sm ml-1">{{ optional_modules|length }}</span>
        </h3>
        <div class="list list-inset glass">
            {% for mod in optional_modules %}
            <div class="list-item list-item-multiline">
                <div class="list-item-start">
                    <div class="module-card-icon" style="width: 36px; height: 36px;">
                        {% icon mod.icon|default:"cube-outline" %}
                    </div>
                </div>
                <div class="list-item-content">
                    <span class="list-item-label">
                        {{ mod.name }}
                        {% if mod.is_coming_soon %}
                        <span class="badge badge-sm ml-1">{% trans "Coming soon" %}</span>
                        {% endif %}
                    </span>
                    <span class="list-item-note">{{ mod.description|truncatewords:15 }}</span>
                </div>
                <div class="list-item-end">
                    {% if mod.is_installed %}
                    <span class="badge badge-sm color-success">{% trans "Installed" %}</span>
                    {% elif mod.is_coming_soon %}
                    <span class="badge badge-sm">{% trans "Planned" %}</span>
                    {% elif mod.module_type == 'free' %}
                    <span class="badge badge-sm color-success">{% trans "Free" %}</span>
                    {% else %}
                    <span class="badge badge-sm">&euro;{{ mod.price }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Roles #}
    {% if solution.roles %}
    <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3">
            {% icon "people-outline" css_class="opacity-50" %}
            {% trans "Pre-configured Roles" %}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for role in solution.roles %}
            <div class="card glass">
                <div class="card-body p-4">
                    <h4 class="font-semibold text-sm mb-1">{{ role.role_display_name }}</h4>
                    {% if role.role_description %}
                    <p class="text-xs opacity-60 mb-2">{{ role.role_description }}</p>
                    {% endif %}
                    <div class="flex flex-wrap gap-1">
                        {% for wc in role.wildcards %}
                        <span class="chip chip-sm">{{ wc }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Toggle result toast #}
    <div x-show="toggleResult" x-cloak class="callout mt-4"
         :class="toggleResult?.success ? 'callout-success' : 'callout-error'">
        <div class="callout-content">
            <p class="callout-text" x-text="toggleResult?.message"></p>
        </div>
    </div>
</div>

<script>
function blockDetail() {
    return {
        toggling: false,
        toggleResult: null,
        async toggleBlock() {
            this.toggling = true;
            this.toggleResult = null;
            try {
                const response = await fetch('{% url "marketplace:block_toggle" slug=solution.slug %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value
                            || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '',
                        'Content-Type': 'application/json',
                    },
                });
                const data = await response.json();
                if (data.success) {
                    const msg = data.action === 'activated'
                        ? '{% trans "Block activated successfully" %}'
                        : '{% trans "Block deactivated" %}';
                    this.toggleResult = { success: true, message: msg };
                    // Reload detail page to refresh state
                    setTimeout(() => {
                        htmx.ajax('GET', '/marketplace/solutions/{{ solution.slug }}/', {target: '#main-content-area', swap: 'innerHTML'});
                    }, 800);
                } else {
                    this.toggleResult = { success: false, message: data.error || '{% trans "Action failed." %}' };
                }
            } catch (e) {
                this.toggleResult = { success: false, message: e.message };
            }
            this.toggling = false;
        }
    };
}
</script>
{% endif %}

    {% endfill %}
{% endcomponent %}
