{% extends "base.html" %}
{% load static i18n djicons %}

{% block title %}ERPlora Hub - {% trans "Login" %}{% endblock %}

{% block extra_css %}
<style>
    /* Login Page Styles â€” uses @erplora/ux theme variables */
    .login-page {
        min-height: 100dvh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
        position: relative;
        overflow: hidden;
        background: var(--color-base-950);
    }

    /* Layered gradient background */
    .login-page::before {
        content: '';
        position: absolute;
        inset: 0;
        background:
            radial-gradient(ellipse 80% 60% at 70% 10%, rgba(var(--color-primary-rgb), 0.15) 0%, transparent 60%),
            radial-gradient(ellipse 70% 50% at 20% 90%, rgba(var(--color-tertiary-rgb), 0.12) 0%, transparent 60%),
            radial-gradient(ellipse 50% 40% at 50% 50%, rgba(var(--color-primary-rgb), 0.06) 0%, transparent 70%);
        z-index: 0;
    }

    /* Subtle grid pattern overlay */
    .login-page::after {
        content: '';
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
        background-size: 60px 60px;
        z-index: 0;
    }

    .login-page > * {
        position: relative;
        z-index: 1;
    }

    .login-container {
        width: 100%;
        max-width: 420px;
    }

    .login-logo {
        text-align: center;
        margin-bottom: var(--spacing-xl);
    }

    .login-logo img {
        width: 72px;
        height: 72px;
        margin-bottom: var(--spacing-md);
        filter: drop-shadow(0 4px 24px rgba(var(--color-primary-rgb), 0.3));
    }

    .login-logo h1 {
        color: #fff;
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 var(--spacing-xs);
        letter-spacing: -0.02em;
    }

    .login-logo p {
        color: var(--color-base-content-muted);
        font-size: var(--font-size-sm);
        margin: 0;
        font-weight: 400;
        letter-spacing: 0.04em;
        text-transform: uppercase;
    }

    .theme-toggle {
        position: fixed;
        top: var(--spacing-lg);
        right: var(--spacing-lg);
        z-index: 100;
    }

    /* Glass card override for login */
    .login-page .card.glass {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        box-shadow:
            var(--shadow-lg),
            inset 0 1px 0 var(--glass-highlight);
    }

    /* Employee Selection */
    .employee-selection h2 {
        color: #fff;
        text-align: center;
        font-size: var(--font-size-lg);
        font-weight: 600;
        margin-bottom: var(--spacing-lg);
    }

    .employee-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    /* PIN Section */
    .pin-section {
        text-align: center;
        margin-bottom: var(--spacing-lg);
    }

    .pin-section .avatar {
        margin-bottom: var(--spacing-md);
    }

    .pin-section h2 {
        color: #fff;
        font-size: var(--font-size-lg);
        font-weight: 600;
        margin: 0 0 var(--spacing-xs);
    }

    .pin-section p {
        color: var(--color-base-content-muted);
        font-size: var(--font-size-sm);
        margin: 0;
    }

    /* Segment override for dark bg */
    .login-page .tabs.glass {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
    }

    .login-page .tabs.glass .tab {
        color: var(--color-base-content-tertiary);
    }

    .login-page .tabs.glass .tab-active {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
    }

    /* Input overrides for dark bg */
    .login-page .input.glass {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: #fff;
    }

    .login-page .input.glass::placeholder {
        color: var(--color-base-content-muted);
    }

    .login-page .input.glass:focus {
        border-color: rgba(var(--color-primary-rgb), 0.5);
        box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.15);
    }

    .login-page .form-group-label {
        color: var(--color-base-content-tertiary);
    }

    /* PIN Error */
    .pin-error {
        margin: var(--spacing-md) 0;
    }

    /* PIN Setup Modal Content */
    .pin-setup-content {
        text-align: center;
        padding: var(--spacing-lg);
    }

    .pin-setup-header {
        margin-bottom: var(--spacing-xl);
    }

    .pin-setup-header svg {
        width: 48px;
        height: 48px;
        color: var(--color-primary);
        margin-bottom: var(--spacing-md);
    }

    .pin-setup-header h2 {
        font-size: var(--font-size-xl);
        font-weight: 600;
        margin: 0 0 var(--spacing-sm);
    }

    .pin-setup-header p {
        color: var(--color-base-content-secondary);
        margin: 0;
    }

    .pin-confirm-message {
        margin: var(--spacing-md) 0;
        color: var(--color-primary);
        font-weight: 500;
    }

    /* Hidden elements */
    [x-cloak] {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="loginApp()" x-init="init()">
    <!-- Theme Toggle -->
    <button class="btn btn-glass btn-circle theme-toggle" @click="toggleTheme()">
        <span x-show="isDark">{% icon "sunny-outline" %}</span>
        <span x-show="!isDark">{% icon "moon-outline" %}</span>
    </button>

    <!-- Login Page -->
    <div class="login-page">
        <div class="login-container">
            <!-- Logo -->
            <div class="login-logo">
                <img src="{% static 'img/logo.png' %}" alt="ERPlora">
                <h1>ERPlora</h1>
                <p>{% trans "Business Management System" %}</p>
            </div>

            <!-- Login Card -->
            <div class="card glass">
                <div class="card-body">
                    <!-- Login Tabs (Segment) -->
                    <div class="tabs tabs-box glass mb-6" x-data="{ indicator: null }" x-init="$nextTick(() => { indicator = $el.querySelector('.tab-active') })">
                        <button type="button"
                                class="tab"
                                :class="{ 'tab-active': loginMode === 'local' }"
                                @click="loginMode = 'local'">
                            {% trans "Local Login" %}
                        </button>
                        <button type="button"
                                class="tab"
                                :class="{ 'tab-active': loginMode === 'cloud' }"
                                @click="loginMode = 'cloud'">
                            {% trans "Cloud Login" %}
                        </button>
                    </div>

                    <!-- Local Login (Employee Selection + PIN) -->
                    <div x-show="loginMode === 'local'" x-cloak>
                        <!-- Employee Selection -->
                        <div x-show="!selectedEmployee">
                            <h2 class="employee-selection">{% trans "Select your profile" %}</h2>

                            <div class="employee-grid">
                                <template x-for="employee in employees" :key="employee.id">
                                    <div class="employee-card glass employee-card--clickable"
                                         @click="selectEmployee(employee)">
                                        <div class="employee-card-avatar" :class="'employee-card-avatar--' + employee.avatarColor">
                                            <span x-text="employee.initials"></span>
                                        </div>
                                        <div class="employee-card-info">
                                            <p class="employee-card-name" x-text="employee.name"></p>
                                        </div>
                                        <span class="chip chip-sm glass" x-text="employee.role"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- PIN Entry -->
                        <div x-show="selectedEmployee" x-cloak>
                            <div class="pin-section">
                                <div class="avatar avatar-xl avatar-primary">
                                    <span x-text="selectedEmployee?.initials"></span>
                                </div>
                                <h2 x-text="selectedEmployee?.name"></h2>
                                <p>{% trans "Enter your PIN" %}</p>
                            </div>

                            <!-- PIN Pad -->
                            <div class="numpad glass">
                                <!-- PIN Dots -->
                                <div class="numpad-dots">
                                    <template x-for="i in 4">
                                        <div class="numpad-dot"
                                             :class="{
                                                 'numpad-dot--filled': pinInput.length >= i,
                                                 'numpad-dot--error': pinError
                                             }"></div>
                                    </template>
                                </div>

                                <!-- Error Message -->
                                <p x-show="pinError" x-cloak class="numpad-error">
                                    {% trans "Incorrect PIN" %}
                                </p>

                                <!-- Keypad Grid -->
                                <div class="numpad-grid">
                                    <template x-for="num in [1, 2, 3, 4, 5, 6, 7, 8, 9]">
                                        <button type="button"
                                                class="numpad-key"
                                                @click="addPinDigit(num)"
                                                x-text="num"></button>
                                    </template>
                                    <button type="button"
                                            class="numpad-key"
                                            @click="selectedEmployee = null; pinInput = ''; pinError = false;">
                                        {% icon "arrow-back-outline" %}
                                    </button>
                                    <button type="button"
                                            class="numpad-key"
                                            @click="addPinDigit(0)">0</button>
                                    <button type="button"
                                            class="numpad-key"
                                            @click="clearPinDigit()">
                                        {% icon "backspace-outline" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cloud Login (Email/Password) -->
                    <div x-show="loginMode === 'cloud'" x-cloak>
                        <form @submit.prevent="cloudLogin()">
                            <div class="form-group mb-4">
                                <label class="form-group-label" for="cloud-email">{% trans "Email" %}</label>
                                <input type="email"
                                       id="cloud-email"
                                       class="input glass"
                                       x-model="cloudCredentials.email"
                                       placeholder="{% trans 'your@email.com' %}"
                                       required>
                            </div>

                            <div class="form-group mb-6">
                                <label class="form-group-label" for="cloud-password">{% trans "Password" %}</label>
                                <div class="input-password" x-data="{ showPassword: false }">
                                    <input :type="showPassword ? 'text' : 'password'"
                                           id="cloud-password"
                                           class="input glass"
                                           x-model="cloudCredentials.password"
                                           placeholder="********"
                                           required>
                                    <button type="button"
                                            class="input-password-toggle"
                                            @click="showPassword = !showPassword"
                                            style="color: rgba(255,255,255,0.8);">
                                        <template x-if="!showPassword">
                                            {% icon "eye-outline" %}
                                        </template>
                                        <template x-if="showPassword">
                                            {% icon "eye-off-outline" %}
                                        </template>
                                    </button>
                                </div>
                            </div>

                            <button type="submit"
                                    class="btn btn-block color-primary"
                                    :class="{ 'btn-loading': cloudLoading }"
                                    :disabled="cloudLoading">
                                <span x-text="cloudLoading ? '{% trans "Logging in..." %}' : '{% trans "Login" %}'"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN Setup Modal -->
    <div class="modal-backdrop"
         :class="{ 'modal-backdrop--open': showPinSetup }"
         @click.self="showPinSetup = false">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Setup your PIN" %}</h3>
            </div>
            <div class="modal-body">
                <div class="pin-setup-content">
                    <div class="pin-setup-header">
                        {% icon "key-outline" %}
                        <h2>{% trans "Welcome" %}, <span x-text="newUser?.name"></span></h2>
                        <p>{% trans "Setup a 4-digit PIN for quick access" %}</p>
                    </div>

                    <!-- PIN Setup Pad -->
                    <div class="numpad">
                        <!-- PIN Dots -->
                        <div class="numpad-dots">
                            <template x-for="i in 4">
                                <div class="numpad-dot"
                                     :class="{
                                         'numpad-dot--filled': setupPinInput.length >= i,
                                         'numpad-dot--error': setupPinError,
                                         'numpad-dot--success': setupPinConfirm && setupPinInput.length >= i
                                     }"></div>
                            </template>
                        </div>

                        <div x-show="setupPinConfirm" x-cloak class="pin-confirm-message">
                            <p>{% trans "Confirm your PIN" %}</p>
                        </div>

                        <!-- Error Message -->
                        <p x-show="setupPinError" x-cloak class="numpad-error">
                            {% trans "PINs don't match" %}
                        </p>

                        <!-- Keypad Grid -->
                        <div class="numpad-grid">
                            <template x-for="num in [1, 2, 3, 4, 5, 6, 7, 8, 9]">
                                <button type="button"
                                        class="numpad-key"
                                        @click="addSetupPinDigit(num)"
                                        x-text="num"></button>
                            </template>
                            <button type="button" class="numpad-key numpad-key--hidden"></button>
                            <button type="button"
                                    class="numpad-key"
                                    @click="addSetupPinDigit(0)">0</button>
                            <button type="button"
                                    class="numpad-key"
                                    @click="clearSetupPinDigit()">
                                {% icon "backspace-outline" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function loginApp() {
        return {
            isDark: window.ERPlora?.isDark || false,
            darkModeAuto: window.ERPlora?.darkModeAuto ?? true,
            loginMode: 'local',

            // Local Login
            selectedEmployee: null,
            pinInput: '',
            pinError: false,
            employees: {{ local_users_json|safe }},

            // Cloud Login
            cloudCredentials: { email: '', password: '' },
            cloudLoading: false,

            // PIN Setup
            showPinSetup: {% if show_pin_setup %}true{% else %}false{% endif %},
            newUser: {% if pending_user %}{{ pending_user|safe }}{% else %}null{% endif %},
            setupPinInput: '',
            setupPinConfirm: false,
            setupPinFirst: '',
            setupPinError: false,

            init() {
                // Dark mode is already applied by base.html
                // Sync localStorage for consistency
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
            },

            selectEmployee(employee) {
                this.selectedEmployee = employee;
                this.pinInput = '';
                this.pinError = false;
            },

            addPinDigit(digit) {
                if (this.pinInput.length < 4) {
                    this.pinInput += digit;
                    if (this.pinInput.length === 4) {
                        this.$nextTick(() => setTimeout(() => this.verifyPin(), 200));
                    }
                }
            },

            clearPinDigit() {
                this.pinInput = this.pinInput.slice(0, -1);
                this.pinError = false;
            },

            async verifyPin() {
                try {
                    const response = await fetch('{% url "auth:verify_pin" %}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: this.selectedEmployee.id,
                            pin: this.pinInput
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        await this.showToast(`{% trans "Welcome" %}, ${this.selectedEmployee.name}!`, 'success');
                        setTimeout(() => window.location.href = '{% url "main:index" %}', 1000);
                    } else {
                        this.pinError = true;
                        this.pinInput = '';
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    }
                } catch (error) {
                    this.pinError = true;
                    this.pinInput = '';
                }
            },

            async cloudLogin() {
                if (!this.cloudCredentials.email || !this.cloudCredentials.password) {
                    await this.showToast('{% trans "Please complete all fields" %}', 'warning');
                    return;
                }

                this.cloudLoading = true;

                try {
                    const response = await fetch('{% url "auth:cloud_login" %}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.cloudCredentials)
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.first_time) {
                            this.newUser = data.user;
                            this.showPinSetup = true;
                        } else {
                            await this.showToast(`{% trans "Welcome" %}, ${data.user.name}!`, 'success');
                            setTimeout(() => window.location.href = '{% url "main:index" %}', 1000);
                        }
                    } else {
                        await this.showToast(data.error || '{% trans "Login failed" %}', 'danger');
                    }
                } catch (error) {
                    await this.showToast('{% trans "Connection error. Please check your internet." %}', 'danger');
                } finally {
                    this.cloudLoading = false;
                }
            },

            addSetupPinDigit(digit) {
                if (this.setupPinInput.length < 4) {
                    this.setupPinInput += digit;
                    if (this.setupPinInput.length === 4) {
                        this.$nextTick(() => {
                            setTimeout(() => {
                                if (!this.setupPinConfirm) {
                                    this.setupPinFirst = this.setupPinInput;
                                    this.setupPinInput = '';
                                    this.setupPinConfirm = true;
                                } else {
                                    this.confirmSetupPin();
                                }
                            }, 200);
                        });
                    }
                }
            },

            clearSetupPinDigit() {
                this.setupPinInput = this.setupPinInput.slice(0, -1);
                this.setupPinError = false;
            },

            async confirmSetupPin() {
                if (this.setupPinInput === this.setupPinFirst) {
                    try {
                        const response = await fetch('{% url "auth:setup_pin" %}', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                user_id: this.newUser.id,
                                pin: this.setupPinInput
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            await this.showToast('{% trans "PIN configured successfully!" %}', 'success');
                            setTimeout(() => window.location.href = '{% url "main:index" %}', 1000);
                        }
                    } catch (error) {
                        console.error('Error setting up PIN:', error);
                    }
                } else {
                    this.setupPinError = true;
                    this.setupPinInput = '';
                    this.setupPinConfirm = false;
                    this.setupPinFirst = '';
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    setTimeout(() => this.setupPinError = false, 2000);
                }
            },

            async toggleTheme() {
                this.isDark = !this.isDark;
                document.body.classList.toggle('dark', this.isDark);
                document.documentElement.classList.toggle('dark', this.isDark);
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');

                // Save to database
                try {
                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `action=update_theme&dark_mode=${this.isDark}`
                    });
                } catch (e) {
                    console.log('Theme saved locally only');
                }
            },

            async showToast(message, type = 'primary') {
                // Use Notify from @erplora/ux if available
                if (typeof Notify !== 'undefined' && Notify[type]) {
                    Notify[type]('', message);
                } else {
                    // Fallback: create a simple toast
                    const toast = document.createElement('div');
                    toast.className = `snackbar snackbar--${type} snackbar--visible`;
                    toast.innerHTML = `<span class="snackbar-message">${message}</span>`;
                    toast.style.cssText = 'position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 9999;';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                }
            }
        }
    }
</script>
{% endblock %}
