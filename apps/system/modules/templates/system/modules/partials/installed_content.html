{% load i18n ui component_tags %}

{% component "page" title=_("My Modules") subtitle=_("Installed modules in your Hub") %}
    {% fill "content" %}
        <!-- Search Bar -->
        <form id="modules-search-form"
            hx-get="{% url 'mymodules:index' %}"
            hx-target="#modules-list"
            hx-swap="innerHTML"
            hx-trigger="submit, ionInput from:#modules-search delay:300ms"
            hx-indicator="#modules-loading">

            <ion-searchbar
                id="modules-search"
                name="q"
                placeholder="{% trans 'Search modules...' %}"
                debounce="300"
                show-cancel-button="never"
                class="m-0 mb-md"
                value="{{ request.GET.q|default:'' }}">
            </ion-searchbar>
        </form>

        <!-- Loading Spinner -->
        <div id="modules-loading" class="htmx-indicator justify-center py-lg">
            <ion-spinner name="crescent"></ion-spinner>
        </div>

        <!-- Modules List Container with internal scroll -->
        <div id="modules-scroll-container" style="height: calc(100vh - 220px); overflow-y: auto; -webkit-overflow-scrolling: touch;">
            <div id="modules-list">
                {% include "system/modules/partials/modules_list.html" %}
            </div>
        </div>
    {% endfill %}
{% endcomponent %}

<script>
(function() {
    // Handle module deactivate with Ionic alert
    document.body.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-action="module-deactivate"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const url = btn.dataset.url;
        const moduleName = btn.dataset.moduleName || '{% trans "this module" %}';

        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Deactivate Module" %}';
        alert.message = '{% trans "Are you sure you want to deactivate" %} <strong>' + moduleName + '</strong>?';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Deactivate" %}',
                role: 'confirm',
                handler: () => {
                    htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
                }
            }
        ];

        document.body.appendChild(alert);
        await alert.present();
    });

    // Handle module delete with Ionic alert
    document.body.addEventListener('click', async function(e) {
        const btn = e.target.closest('[data-action="module-delete"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const url = btn.dataset.url;
        const moduleName = btn.dataset.moduleName || '{% trans "this module" %}';

        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Delete Module" %}';
        alert.subHeader = '{% trans "This action cannot be undone" %}';
        alert.message = '{% trans "This will permanently delete" %} <strong>' + moduleName + '</strong> {% trans "and all its data." %}';
        alert.cssClass = 'alert-danger';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Delete" %}',
                role: 'destructive',
                cssClass: 'alert-button-danger',
                handler: () => {
                    htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
                }
            }
        ];

        document.body.appendChild(alert);
        await alert.present();
    });
})();
</script>
