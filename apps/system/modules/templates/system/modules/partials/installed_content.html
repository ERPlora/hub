{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "system/modules/partials/tabbar_system.html" %}
</div>
{% endif %}

<div class="ion-padding" x-data="modulesApp()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold">{% trans "Modules" %}</h1>
            <p class="text-medium">
                {{ active_count }} {% trans "active" %}, {{ inactive_count }} {% trans "inactive" %}
            </p>
        </div>
        <div class="flex gap-2">
            {% if requires_restart %}
            <ion-button color="warning" @click="restartServer()">
                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                {% trans "Restart Required" %}
            </ion-button>
            {% endif %}
            <ion-button
                hx-get="{% url 'system:marketplace' %}"
                hx-target="#dashboard-content"
                hx-push-url="true">
                <ion-icon slot="start" name="storefront-outline"></ion-icon>
                {% trans "Module Store" %}
            </ion-button>
        </div>
    </div>

    <!-- Modules Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for module in modules %}
        <ion-card>
            <ion-card-header>
                <div class="flex items-center gap-3">
                    <ion-icon name="{{ module.icon }}" class="text-2xl text-primary"></ion-icon>
                    <div class="flex-1 min-w-0">
                        <ion-card-title class="truncate">{{ module.name }}</ion-card-title>
                        <ion-card-subtitle>v{{ module.version }}</ion-card-subtitle>
                    </div>
                    <ion-chip :color="'{{ module.is_active }}'==='True' ? 'success' : 'medium'">
                        {% if module.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                    </ion-chip>
                </div>
            </ion-card-header>
            <ion-card-content>
                <p class="text-sm text-medium mb-4">{{ module.description|default:"-" }}</p>
                {% if module.author %}
                <p class="text-xs text-medium">{% trans "By" %} {{ module.author }}</p>
                {% endif %}
            </ion-card-content>
            <div class="flex border-t border-gray-200 dark:border-gray-700">
                {% if module.is_active %}
                <ion-button
                    fill="clear"
                    size="small"
                    color="warning"
                    class="flex-1"
                    @click="deactivateModule('{{ module.module_id }}')">
                    <ion-icon slot="start" name="pause-outline"></ion-icon>
                    {% trans "Deactivate" %}
                </ion-button>
                {% else %}
                <ion-button
                    fill="clear"
                    size="small"
                    color="success"
                    class="flex-1"
                    @click="activateModule('{{ module.module_id }}')">
                    <ion-icon slot="start" name="play-outline"></ion-icon>
                    {% trans "Activate" %}
                </ion-button>
                {% endif %}
                <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    class="flex-1"
                    @click="deleteModule('{{ module.module_id }}')">
                    <ion-icon slot="start" name="trash-outline"></ion-icon>
                    {% trans "Delete" %}
                </ion-button>
            </div>
        </ion-card>
        {% empty %}
        <ion-card class="col-span-full">
            <ion-card-content class="text-center py-8">
                <ion-icon name="extension-puzzle-outline" class="text-6xl text-medium mb-4"></ion-icon>
                <h3 class="text-lg font-semibold mb-2">{% trans "No modules installed" %}</h3>
                <p class="text-medium mb-4">{% trans "Explore the Module Store to extend your Hub" %}</p>
                <ion-button
                    hx-get="{% url 'system:marketplace' %}"
                    hx-target="#dashboard-content"
                    hx-push-url="true">
                    <ion-icon slot="start" name="storefront-outline"></ion-icon>
                    {% trans "Browse Module Store" %}
                </ion-button>
            </ion-card-content>
        </ion-card>
        {% endfor %}
    </div>
</div>

<script>
function modulesApp() {
    return {
        loading: false,

        async activateModule(moduleId) {
            if (this.loading) return;
            this.loading = true;

            try {
                const response = await fetch(`{% url 'system:module_activate' module_id='__ID__' %}`.replace('__ID__', moduleId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    await this.showToast(data.message || '{% trans "Module activated" %}', 'success');
                    htmx.ajax('GET', '{% url "system:modules" %}', {
                        target: '#dashboard-content',
                        swap: 'innerHTML'
                    });
                } else {
                    await this.showToast(data.error || '{% trans "Error activating module" %}', 'danger');
                }
            } catch (error) {
                await this.showToast('{% trans "Error activating module" %}', 'danger');
            } finally {
                this.loading = false;
            }
        },

        async deactivateModule(moduleId) {
            if (this.loading) return;

            const alert = document.createElement('ion-alert');
            alert.header = '{% trans "Deactivate Module" %}';
            alert.message = '{% trans "Are you sure you want to deactivate this module?" %}';
            alert.buttons = [
                { text: '{% trans "Cancel" %}', role: 'cancel' },
                {
                    text: '{% trans "Deactivate" %}',
                    handler: async () => {
                        this.loading = true;
                        try {
                            const response = await fetch(`{% url 'system:module_deactivate' module_id='__ID__' %}`.replace('__ID__', moduleId), {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();

                            if (data.success) {
                                await this.showToast('{% trans "Module deactivated" %}', 'success');
                                htmx.ajax('GET', '{% url "system:modules" %}', {
                                    target: '#dashboard-content',
                                    swap: 'innerHTML'
                                });
                            } else {
                                await this.showToast(data.error, 'danger');
                            }
                        } catch (error) {
                            await this.showToast('{% trans "Error deactivating module" %}', 'danger');
                        } finally {
                            this.loading = false;
                        }
                    }
                }
            ];
            document.body.appendChild(alert);
            await alert.present();
        },

        async deleteModule(moduleId) {
            if (this.loading) return;

            const alert = document.createElement('ion-alert');
            alert.header = '{% trans "Delete Module" %}';
            alert.message = '{% trans "This will permanently delete the module and all its data. Are you sure?" %}';
            alert.buttons = [
                { text: '{% trans "Cancel" %}', role: 'cancel' },
                {
                    text: '{% trans "Delete" %}',
                    role: 'destructive',
                    handler: async () => {
                        this.loading = true;
                        try {
                            const response = await fetch(`{% url 'system:module_delete' module_id='__ID__' %}`.replace('__ID__', moduleId), {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();

                            if (data.success) {
                                await this.showToast('{% trans "Module deleted" %}', 'success');
                                htmx.ajax('GET', '{% url "system:modules" %}', {
                                    target: '#dashboard-content',
                                    swap: 'innerHTML'
                                });
                            } else {
                                await this.showToast(data.error, 'danger');
                            }
                        } catch (error) {
                            await this.showToast('{% trans "Error deleting module" %}', 'danger');
                        } finally {
                            this.loading = false;
                        }
                    }
                }
            ];
            document.body.appendChild(alert);
            await alert.present();
        },

        async restartServer() {
            const alert = document.createElement('ion-alert');
            alert.header = '{% trans "Restart Server" %}';
            alert.message = '{% trans "This will restart the server and apply module changes. Continue?" %}';
            alert.buttons = [
                { text: '{% trans "Cancel" %}', role: 'cancel' },
                {
                    text: '{% trans "Restart" %}',
                    handler: async () => {
                        this.loading = true;
                        try {
                            const response = await fetch('{% url "system:module_restart" %}', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            const data = await response.json();

                            if (data.success) {
                                await this.showToast('{% trans "Server restarting..." %}', 'success');
                                setTimeout(() => window.location.reload(), 2000);
                            } else {
                                await this.showToast(data.error, 'danger');
                            }
                        } catch (error) {
                            await this.showToast('{% trans "Error restarting server" %}', 'danger');
                        } finally {
                            this.loading = false;
                        }
                    }
                }
            ];
            document.body.appendChild(alert);
            await alert.present();
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 2000;
            toast.color = color;
            document.body.appendChild(toast);
            await toast.present();
        }
    }
}
</script>
