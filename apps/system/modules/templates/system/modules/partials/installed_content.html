{% load i18n djicons %}

<div x-data="{
    view: '{{ current_view|default:'table' }}',
    columnsModal: false,
    cols: { author: true, version: true, status: true },
    toggleCol(col) {
        this.cols[col] = !this.cols[col];
        document.querySelectorAll('[data-col=' + col + ']').forEach(el => el.classList.toggle('hidden', !this.cols[col]));
    }
}">

    {% if skipped_dependencies %}
    <div class="callout callout-warning mb-4 mt-5">
        <div class="callout-icon">{% icon "warning-outline" %}</div>
        <div class="callout-content">
            <div class="callout-title">{% trans "Modules with missing dependencies" %}</div>
            <div class="callout-text">
                {% for module_id, missing in skipped_dependencies.items %}
                <div class="flex items-center gap-2 mt-1">
                    <span class="badge badge-sm">{{ module_id }}</span>
                    <span class="text-sm opacity-70">
                        {% trans "requires" %}:
                        {% for dep in missing %}
                        <span class="badge badge-sm color-error">{{ dep }}</span>{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="datatable glass mt-5" id="modules-datatable">

        <!-- Toolbar -->
        <div class="datatable-toolbar">
            <div class="datatable-toolbar-start">
                <label class="input input-sm datatable-search">
                    {% icon "search-outline" %}
                    <input type="search"
                           name="q"
                           placeholder="{% trans 'Search modules...' %}"
                           value="{{ search_query|default:'' }}"
                           autocomplete="off"
                           hx-get="{% url 'mymodules:index' %}"
                           hx-target="#datatable-body"
                           hx-include="#modules-datatable"
                           hx-trigger="input changed delay:300ms, search">
                </label>
                <select name="status"
                        class="select select-sm"
                        hx-get="{% url 'mymodules:index' %}"
                        hx-target="#datatable-body"
                        hx-include="#modules-datatable"
                        hx-trigger="change">
                    <option value="">{% trans "All Status" %}</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>{% trans "Inactive" %}</option>
                </select>
            </div>
            <div class="datatable-toolbar-end">
                <!-- Column Visibility -->
                <button class="datatable-column-btn" @click="columnsModal = true" title="{% trans 'Columns' %}">
                    {% icon "options-outline" %}
                </button>

                <!-- View Toggle -->
                <div class="datatable-view-toggle">
                    <button type="button"
                            class="datatable-view-btn"
                            :class="{ 'datatable-view-btn-active': view === 'table' }"
                            @click="view = 'table'"
                            hx-get="{% url 'mymodules:index' %}"
                            hx-target="#datatable-body"
                            hx-include="#modules-datatable"
                            hx-vals='{"view": "table"}'
                            title="{% trans 'Table view' %}">
                        {% icon "list-outline" %}
                    </button>
                    <button type="button"
                            class="datatable-view-btn"
                            :class="{ 'datatable-view-btn-active': view === 'cards' }"
                            @click="view = 'cards'"
                            hx-get="{% url 'mymodules:index' %}"
                            hx-target="#datatable-body"
                            hx-include="#modules-datatable"
                            hx-vals='{"view": "cards"}'
                            title="{% trans 'Card view' %}">
                        {% icon "grid-outline" %}
                    </button>
                </div>
            </div>
        </div>

        {% csrf_token %}

        <!-- Hidden state inputs -->
        <input type="hidden" name="sort" value="{{ sort_field|default:'name' }}">
        <input type="hidden" name="dir" value="{{ sort_dir|default:'asc' }}">
        <input type="hidden" name="view" :value="view">
        <input type="hidden" name="per_page" value="{{ per_page|default:'10' }}">

        <!-- Datatable Body (HTMX swap target) -->
        <div id="datatable-body">
            {% include "system/modules/partials/modules_list.html" %}
        </div>
    </div>

    <!-- Columns Modal -->
    <div class="modal-backdrop" :data-state="columnsModal ? 'open' : 'closed'" @click.self="columnsModal = false">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title">{% trans "Show / Hide Columns" %}</h3>
                <button class="modal-close" @click="columnsModal = false">
                    {% icon "close-outline" %}
                </button>
            </div>
            <div class="modal-body">
                <label class="flex items-center gap-3 py-2 cursor-not-allowed opacity-50">
                    <input type="checkbox" class="checkbox checkbox-sm" checked disabled>
                    <span class="text-sm">{% trans "Module" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('author')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.author" readonly>
                    <span class="text-sm">{% trans "Author" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('version')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.version" readonly>
                    <span class="text-sm">{% trans "Version" %}</span>
                </label>
                <label class="flex items-center gap-3 py-2 cursor-pointer" @click="toggleCol('status')">
                    <input type="checkbox" class="checkbox checkbox-sm" :checked="cols.status" readonly>
                    <span class="text-sm">{% trans "Status" %}</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm color-primary" @click="columnsModal = false">
                    {% trans "Done" %}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
if (!window._moduleActionsInitialized) {
    window._moduleActionsInitialized = true;

    function _moduleModalConfirm(btn, action) {
        var url = btn.dataset.url;
        var moduleName = btn.dataset.moduleName || '{% trans "this module" %}';
        var isDelete = action === 'delete';

        var title = isDelete ? '{% trans "Delete Module" %}' : '{% trans "Deactivate Module" %}';
        var body = isDelete
            ? '<p>{% trans "This will permanently delete" %} <strong>' + moduleName + '</strong> {% trans "and all its data." %}</p><p class="text-sm opacity-60 mt-2">{% trans "This action cannot be undone." %}</p>'
            : '<p>{% trans "Are you sure you want to deactivate" %} <strong>' + moduleName + '</strong>?</p>';
        var confirmLabel = isDelete ? '{% trans "Delete" %}' : '{% trans "Deactivate" %}';
        var confirmColor = isDelete ? 'color-error' : 'color-warning';

        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.setAttribute('data-state', 'open');
        backdrop.innerHTML =
            '<div class="modal modal-sm">' +
                '<div class="modal-header"><h3 class="modal-title">' + title + '</h3></div>' +
                '<div class="modal-body">' + body + '</div>' +
                '<div class="modal-footer">' +
                    '<button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>' +
                    '<button class="btn ' + confirmColor + '" data-role="confirm">' + confirmLabel + '</button>' +
                '</div>' +
            '</div>';

        function close() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(function() { backdrop.remove(); }, 300);
        }
        backdrop.querySelector('[data-role="cancel"]').addEventListener('click', close);
        backdrop.addEventListener('click', function(e) { if (e.target === backdrop) close(); });
        backdrop.querySelector('[data-role="confirm"]').addEventListener('click', function() {
            close();
            htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
        });
        document.body.appendChild(backdrop);
    }

    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('[data-action="module-deactivate"]');
        if (btn) { e.preventDefault(); e.stopPropagation(); _moduleModalConfirm(btn, 'deactivate'); return; }
        btn = e.target.closest('[data-action="module-delete"]');
        if (btn) { e.preventDefault(); e.stopPropagation(); _moduleModalConfirm(btn, 'delete'); }
    });
}
</script>
