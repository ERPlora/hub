{% load i18n ui component_tags %}

{% component "page" title=_("My Modules") subtitle=_("Installed modules in your Hub") %}
    {% fill "content" %}
        <!-- Search Bar -->
        <form id="modules-search-form"
            hx-get="{% url 'mymodules:index' %}"
            hx-target="#modules-list"
            hx-swap="innerHTML"
            hx-trigger="submit, input from:#modules-search delay:300ms"
            hx-indicator="#modules-loading">

            <input type="search"
                class="input"
                id="modules-search"
                name="q"
                placeholder="{% trans 'Search modules...' %}"
                value="{{ request.GET.q|default:'' }}"
                style="margin-bottom: var(--spacing-md);">
        </form>

        <!-- Loading Spinner -->
        <div id="modules-loading" class="htmx-indicator justify-center py-lg">
            <div class="loading"></div>
        </div>

        <!-- Modules List Container with internal scroll -->
        <div id="modules-scroll-container" style="height: calc(100vh - 220px); overflow-y: auto; -webkit-overflow-scrolling: touch;">
            <div id="modules-list">
                {% include "system/modules/partials/modules_list.html" %}
            </div>
        </div>
    {% endfill %}
{% endcomponent %}

<script>
(function() {
    // Handle module deactivate with UX alert
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action="module-deactivate"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const url = btn.dataset.url;
        const moduleName = btn.dataset.moduleName || '{% trans "this module" %}';

        // Create UX alert backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'alert-backdrop';
        backdrop.setAttribute('data-state', 'open');
        backdrop.innerHTML = `
            <div class="alert">
                <div class="alert-header">
                    <h3>{% trans "Deactivate Module" %}</h3>
                </div>
                <div class="alert-body">
                    <p>{% trans "Are you sure you want to deactivate" %} <strong>${moduleName}</strong>?</p>
                </div>
                <div class="alert-footer">
                    <button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>
                    <button class="btn color-warning" data-role="confirm">{% trans "Deactivate" %}</button>
                </div>
            </div>
        `;

        backdrop.querySelector('[data-role="cancel"]').addEventListener('click', function() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(() => backdrop.remove(), 300);
        });

        backdrop.querySelector('[data-role="confirm"]').addEventListener('click', function() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(() => backdrop.remove(), 300);
            htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
        });

        document.body.appendChild(backdrop);
    });

    // Handle module delete with UX alert
    document.body.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action="module-delete"]');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const url = btn.dataset.url;
        const moduleName = btn.dataset.moduleName || '{% trans "this module" %}';

        // Create UX alert backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'alert-backdrop';
        backdrop.setAttribute('data-state', 'open');
        backdrop.innerHTML = `
            <div class="alert">
                <div class="alert-header">
                    <h3>{% trans "Delete Module" %}</h3>
                    <p class="text-base-content/60">{% trans "This action cannot be undone" %}</p>
                </div>
                <div class="alert-body">
                    <p>{% trans "This will permanently delete" %} <strong>${moduleName}</strong> {% trans "and all its data." %}</p>
                </div>
                <div class="alert-footer">
                    <button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>
                    <button class="btn color-error" data-role="confirm">{% trans "Delete" %}</button>
                </div>
            </div>
        `;

        backdrop.querySelector('[data-role="cancel"]').addEventListener('click', function() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(() => backdrop.remove(), 300);
        });

        backdrop.querySelector('[data-role="confirm"]').addEventListener('click', function() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(() => backdrop.remove(), 300);
            htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
        });

        document.body.appendChild(backdrop);
    });
})();
</script>
