{% load i18n djicons %}

<!-- Search -->
<form id="modules-search-form"
      hx-get="{% url 'mymodules:index' %}"
      hx-target="#modules-list"
      hx-swap="innerHTML"
      hx-trigger="submit, input from:#modules-search delay:300ms">
    <div class="mb-4">
        <label class="input rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="ionicon icon opacity-50" viewBox="0 0 512 512" width="20" height="20" aria-hidden="true"><path d="M221.09 64a157.09 157.09 0 10157.09 157.09A157.1 157.1 0 00221.09 64z" fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M338.29 338.29L448 448"></path></svg>
            <input type="search"
                   class="grow"
                   id="modules-search"
                   name="q"
                   placeholder="{% trans 'Search modules...' %}"
                   value="{{ request.GET.q|default:'' }}">
        </label>
    </div>
</form>

<!-- Modules List -->
<div id="modules-list">
    {% include "system/modules/partials/modules_list.html" %}
</div>

<script>
if (!window._moduleActionsInitialized) {
    window._moduleActionsInitialized = true;

    function _moduleModalConfirm(btn, action) {
        var url = btn.dataset.url;
        var moduleName = btn.dataset.moduleName || '{% trans "this module" %}';
        var isDelete = action === 'delete';

        var title = isDelete ? '{% trans "Delete Module" %}' : '{% trans "Deactivate Module" %}';
        var body = isDelete
            ? '<p>{% trans "This will permanently delete" %} <strong>' + moduleName + '</strong> {% trans "and all its data." %}</p><p class="text-sm opacity-60 mt-2">{% trans "This action cannot be undone." %}</p>'
            : '<p>{% trans "Are you sure you want to deactivate" %} <strong>' + moduleName + '</strong>?</p>';
        var confirmLabel = isDelete ? '{% trans "Delete" %}' : '{% trans "Deactivate" %}';
        var confirmColor = isDelete ? 'color-error' : 'color-warning';

        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        backdrop.setAttribute('data-state', 'open');
        backdrop.innerHTML =
            '<div class="modal modal-sm">' +
                '<div class="modal-header"><h3 class="modal-title">' + title + '</h3></div>' +
                '<div class="modal-body">' + body + '</div>' +
                '<div class="modal-footer">' +
                    '<button class="btn btn-outline" data-role="cancel">{% trans "Cancel" %}</button>' +
                    '<button class="btn ' + confirmColor + '" data-role="confirm">' + confirmLabel + '</button>' +
                '</div>' +
            '</div>';

        function close() {
            backdrop.setAttribute('data-state', 'closed');
            setTimeout(function() { backdrop.remove(); }, 300);
        }
        backdrop.querySelector('[data-role="cancel"]').addEventListener('click', close);
        backdrop.addEventListener('click', function(e) { if (e.target === backdrop) close(); });
        backdrop.querySelector('[data-role="confirm"]').addEventListener('click', function() {
            close();
            htmx.ajax('POST', url, {target: '#main-content-area', swap: 'innerHTML'});
        });
        document.body.appendChild(backdrop);
    }

    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('[data-action="module-deactivate"]');
        if (btn) { e.preventDefault(); e.stopPropagation(); _moduleModalConfirm(btn, 'deactivate'); return; }
        btn = e.target.closest('[data-action="module-delete"]');
        if (btn) { e.preventDefault(); e.stopPropagation(); _moduleModalConfirm(btn, 'delete'); }
    });
}
</script>
