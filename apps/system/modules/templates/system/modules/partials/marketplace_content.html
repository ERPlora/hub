{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "system/modules/partials/tabbar_system.html" %}
</div>
{% endif %}

<div class="ion-padding" x-data="marketplaceFilters()">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold">{% trans "Module Store" %}</h1>
        <p class="text-medium">{% trans "Extend your Hub with powerful modules" %}</p>
    </div>

    <!-- Search and Filters Row -->
    <div class="flex flex-wrap gap-4 mb-4 items-center">
        <ion-searchbar
            id="search-input"
            placeholder="{% trans 'Search modules...' %}"
            class="flex-1 min-w-64"
            debounce="300"
            x-model="searchQuery"
            @ionInput="debouncedFetch()">
        </ion-searchbar>

        <ion-select
            id="category-select"
            placeholder="{% trans 'All Categories' %}"
            interface="popover"
            x-model="categoryFilter"
            @ionChange="fetchModules()">
            <ion-select-option value="">{% trans "All Categories" %}</ion-select-option>
            {% for category in categories %}
            <ion-select-option value="{{ category.slug }}">{{ category.name }}</ion-select-option>
            {% endfor %}
        </ion-select>
    </div>

    <!-- Type Filter Chips -->
    <div class="flex flex-wrap gap-2 mb-6">
        <ion-chip
            :color="typeFilter === '' ? 'primary' : 'medium'"
            @click="setTypeFilter('')"
            class="cursor-pointer">
            <ion-label>{% trans "All" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'free' ? 'success' : 'medium'"
            @click="setTypeFilter('free')"
            class="cursor-pointer">
            <ion-icon name="gift-outline" class="mr-1"></ion-icon>
            <ion-label>{% trans "Free" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'one_time' ? 'primary' : 'medium'"
            @click="setTypeFilter('one_time')"
            class="cursor-pointer">
            <ion-icon name="card-outline" class="mr-1"></ion-icon>
            <ion-label>{% trans "One-time" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'subscription' ? 'tertiary' : 'medium'"
            @click="setTypeFilter('subscription')"
            class="cursor-pointer">
            <ion-icon name="sync-outline" class="mr-1"></ion-icon>
            <ion-label>{% trans "Subscription" %}</ion-label>
        </ion-chip>
    </div>

    <!-- Active Filters Display -->
    <div class="flex flex-wrap gap-2 mb-4" x-show="hasActiveFilters()">
        <span class="text-medium text-sm py-2">{% trans "Active filters:" %}</span>
        <template x-if="searchQuery">
            <ion-chip color="light" class="cursor-pointer" @click="clearSearch()">
                <ion-label x-text="'{{ _("Search") }}: ' + searchQuery"></ion-label>
                <ion-icon name="close-circle"></ion-icon>
            </ion-chip>
        </template>
        <template x-if="categoryFilter">
            <ion-chip color="light" class="cursor-pointer" @click="clearCategory()">
                <ion-label x-text="'{{ _("Category") }}: ' + categoryFilter"></ion-label>
                <ion-icon name="close-circle"></ion-icon>
            </ion-chip>
        </template>
        <template x-if="typeFilter">
            <ion-chip color="light" class="cursor-pointer" @click="clearType()">
                <ion-label x-text="'{{ _("Type") }}: ' + getTypeLabel(typeFilter)"></ion-label>
                <ion-icon name="close-circle"></ion-icon>
            </ion-chip>
        </template>
        <ion-button size="small" fill="clear" @click="clearAllFilters()">
            {% trans "Clear all" %}
        </ion-button>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="htmx-indicator flex justify-center py-12">
        <ion-spinner name="crescent"></ion-spinner>
    </div>

    <!-- Modules Grid (loaded via HTMX) -->
    <div id="marketplace-modules-grid"
         hx-get="{% url 'system:marketplace_modules_list' %}"
         hx-trigger="load"
         hx-swap="innerHTML"
         hx-indicator="#loading-spinner">
        <!-- Initial loading state -->
        <div class="flex justify-center py-12">
            <ion-spinner name="crescent"></ion-spinner>
        </div>
    </div>
</div>

<!-- Alpine.js Filter Logic -->
<script>
function marketplaceFilters() {
    return {
        searchQuery: '',
        categoryFilter: '',
        typeFilter: '',
        searchTimeout: null,

        init() {
            // Sync with existing DOM elements after Alpine initializes
            this.$nextTick(() => {
                const searchInput = document.getElementById('search-input');
                const categorySelect = document.getElementById('category-select');
                if (searchInput) this.searchQuery = searchInput.value || '';
                if (categorySelect) this.categoryFilter = categorySelect.value || '';
            });
        },

        setTypeFilter(type) {
            this.typeFilter = type;
            this.fetchModules();
        },

        hasActiveFilters() {
            return this.searchQuery || this.categoryFilter || this.typeFilter;
        },

        clearSearch() {
            this.searchQuery = '';
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            this.fetchModules();
        },

        clearCategory() {
            this.categoryFilter = '';
            const categorySelect = document.getElementById('category-select');
            if (categorySelect) categorySelect.value = '';
            this.fetchModules();
        },

        clearType() {
            this.typeFilter = '';
            this.fetchModules();
        },

        clearAllFilters() {
            this.searchQuery = '';
            this.categoryFilter = '';
            this.typeFilter = '';
            const searchInput = document.getElementById('search-input');
            const categorySelect = document.getElementById('category-select');
            if (searchInput) searchInput.value = '';
            if (categorySelect) categorySelect.value = '';
            this.fetchModules();
        },

        getTypeLabel(type) {
            const labels = {
                'free': '{% trans "Free" %}',
                'one_time': '{% trans "One-time" %}',
                'subscription': '{% trans "Subscription" %}'
            };
            return labels[type] || type;
        },

        debouncedFetch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => this.fetchModules(), 300);
        },

        fetchModules() {
            const params = new URLSearchParams();
            if (this.searchQuery) params.set('q', this.searchQuery);
            if (this.categoryFilter) params.set('category', this.categoryFilter);
            if (this.typeFilter) params.set('type', this.typeFilter);

            const url = '{% url "system:marketplace_modules_list" %}' + (params.toString() ? '?' + params.toString() : '');
            htmx.ajax('GET', url, { target: '#marketplace-modules-grid', swap: 'innerHTML', indicator: '#loading-spinner' });
        }
    }
}
</script>

<!-- Marketplace module actions (uses global UI helpers from toast-helper.js) -->
<script>
// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        // First acquire the free module
        const purchaseResponse = await fetch('{% url "system:purchase_module" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        // Now download and install
        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "system:purchase_module" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module (for owned modules)
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "system:install_from_marketplace" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');
            // Refresh the modules grid
            htmx.ajax('GET', '{% url "system:marketplace_modules_list" %}', { target: '#marketplace-modules-grid', swap: 'innerHTML' });

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "system:module_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    const spinner = button.querySelector('.install-spinner');
    const icon = button.querySelector('.install-icon');
    if (spinner) spinner.style.display = loading ? 'block' : 'none';
    if (icon) icon.style.display = loading ? 'none' : 'block';
    button.disabled = loading;
}
</script>

<style>
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: flex;
}
.htmx-request .install-icon {
    display: none;
}
.htmx-request .install-spinner {
    display: block !important;
}
.cursor-pointer {
    cursor: pointer;
}
</style>
