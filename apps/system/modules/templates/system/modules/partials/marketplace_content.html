{% load i18n ui %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
{% include "system/modules/partials/tabbar_system.html" with current_tab='marketplace' oob=True %}
{% endif %}

<div x-data="marketplaceFilters()" x-init="init()">
    <!-- Header - No back button since this is a main tab -->
    {% ui_page_header title=_("Marketplace") subtitle=_("Discover and install modules") %}

    <!-- Search & Filters -->
    <ion-grid class="ion-no-padding ion-margin-bottom">
        <!-- Search Row -->
        <ion-row>
            <ion-col size="12">
                <ion-searchbar
                    id="search-input"
                    placeholder="{% trans 'Search modules...' %}"
                    debounce="300"
                    show-cancel-button="never"
                    @ionInput="onSearchInput($event)">
                </ion-searchbar>
            </ion-col>
        </ion-row>

        <!-- Filters Row: stacked on small, side by side on large -->
        <ion-row class="ion-align-items-center">
            <!-- Category Filter -->
            <ion-col size="12" size-lg="6">
                <ion-select
                    id="category-select"
                    aria-label="{% trans 'Categories' %}"
                    placeholder="{% trans 'Filter by category' %}"
                    :value="categoryFilter"
                    @ionChange="onCategoryChange($event)">
                    <ion-select-option value="">{% trans "All Categories" %}</ion-select-option>
                    {% for category in categories %}
                    <ion-select-option value="{{ category.id }}">{{ category.name }}</ion-select-option>
                    {% endfor %}
                </ion-select>
            </ion-col>

            <!-- Industry Filter -->
            <ion-col size="12" size-lg="6">
                <ion-select
                    id="industry-select"
                    aria-label="{% trans 'Industries' %}"
                    placeholder="{% trans 'Filter by industry' %}"
                    :value="industryFilter"
                    @ionChange="onIndustryChange($event)">
                    <ion-select-option value="">{% trans "All Industries" %}</ion-select-option>
                    {% for industry in industries %}
                    <ion-select-option value="{{ industry.id }}">{{ industry.name }}</ion-select-option>
                    {% endfor %}
                </ion-select>
            </ion-col>
        </ion-row>
    </ion-grid>

    <!-- Type Filter Chips -->
    <div class="d-flex flex-wrap gap-sm mb-md align-center">
        <ion-chip
            :color="typeFilter === '' ? 'primary' : 'medium'"
            @click="setTypeFilter('')"
            class="cursor-pointer">
            <ion-label>{% trans "All" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'free' ? 'success' : 'medium'"
            @click="setTypeFilter('free')"
            class="cursor-pointer">
            <ion-icon name="gift-outline" slot="start"></ion-icon>
            <ion-label>{% trans "Free" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'one_time' ? 'primary' : 'medium'"
            @click="setTypeFilter('one_time')"
            class="cursor-pointer">
            <ion-icon name="card-outline" slot="start"></ion-icon>
            <ion-label>{% trans "One-time" %}</ion-label>
        </ion-chip>
        <ion-chip
            :color="typeFilter === 'subscription' ? 'tertiary' : 'medium'"
            @click="setTypeFilter('subscription')"
            class="cursor-pointer">
            <ion-icon name="sync-outline" slot="start"></ion-icon>
            <ion-label>{% trans "Subscription" %}</ion-label>
        </ion-chip>
    </div>

    <!-- Active Filters Summary -->
    <div class="d-flex flex-wrap gap-sm mb-md align-center" x-show="hasActiveFilters()" x-cloak>
        <span class="fs-sm text-medium">{% trans "Active:" %}</span>
        <template x-if="searchQuery">
            <ion-chip color="warning" class="cursor-pointer" @click="clearSearch()">
                <ion-icon name="search" slot="start"></ion-icon>
                <ion-label x-text="searchQuery"></ion-label>
                <ion-icon name="close-circle" slot="end"></ion-icon>
            </ion-chip>
        </template>
        <template x-if="categoryFilter">
            <ion-chip color="warning" class="cursor-pointer" @click="setCategory('')">
                <ion-label x-text="getCategoryName(categoryFilter)"></ion-label>
                <ion-icon name="close-circle" slot="end"></ion-icon>
            </ion-chip>
        </template>
        <template x-if="industryFilter">
            <ion-chip color="warning" class="cursor-pointer" @click="setIndustry('')">
                <ion-label x-text="getIndustryName(industryFilter)"></ion-label>
                <ion-icon name="close-circle" slot="end"></ion-icon>
            </ion-chip>
        </template>
        <template x-if="typeFilter">
            <ion-chip color="warning" class="cursor-pointer" @click="setTypeFilter('')">
                <ion-label x-text="getTypeLabel(typeFilter)"></ion-label>
                <ion-icon name="close-circle" slot="end"></ion-icon>
            </ion-chip>
        </template>
        <ion-button size="small" fill="clear" color="danger" @click="clearAllFilters()">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            {% trans "Clear all" %}
        </ion-button>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="htmx-indicator d-flex justify-center py-xl">
        <ion-spinner name="crescent"></ion-spinner>
    </div>

    <!-- Modules Grid (loaded via HTMX) -->
    <div id="marketplace-modules-grid"
         hx-get="{% url 'mymodules:htmx_list' %}"
         hx-trigger="load"
         hx-swap="innerHTML"
         hx-indicator="#loading-spinner">
        <!-- Initial loading state -->
        <div class="d-flex justify-center py-xl">
            <ion-spinner name="crescent"></ion-spinner>
        </div>
    </div>
</div>

<!-- Alpine.js Filter Logic - HTMX compatible registration -->
<script>
(function() {
    // Extract Django context data before the IIFE
    const categoryMapData = {
        {% for category in categories %}
        '{{ category.id }}': '{{ category.name }}',
        {% endfor %}
    };
    const industryMapData = {
        {% for industry in industries %}
        '{{ industry.id }}': '{{ industry.name }}',
        {% endfor %}
    };
    const htmxListUrl = '{% url "mymodules:htmx_list" %}';
    const typeLabels = {
        'free': '{% trans "Free" %}',
        'one_time': '{% trans "One-time" %}',
        'subscription': '{% trans "Subscription" %}'
    };

    const marketplaceFiltersData = () => ({
        searchQuery: '',
        categoryFilter: '',
        industryFilter: '',
        typeFilter: '',
        searchTimeout: null,
        categoryMap: categoryMapData,
        industryMap: industryMapData,

        init() {
            // Nothing to sync on init - start fresh
        },

        onSearchInput(event) {
            this.searchQuery = event.target.value || '';
            this.debouncedFetch();
        },

        onCategoryChange(event) {
            this.categoryFilter = event.detail.value || '';
            this.fetchModules();
        },

        onIndustryChange(event) {
            this.industryFilter = event.detail.value || '';
            this.fetchModules();
        },

        setCategory(category) {
            this.categoryFilter = category;
            const select = document.getElementById('category-select');
            if (select) select.value = category;
            this.fetchModules();
        },

        setIndustry(industry) {
            this.industryFilter = industry;
            const select = document.getElementById('industry-select');
            if (select) select.value = industry;
            this.fetchModules();
        },

        setTypeFilter(type) {
            this.typeFilter = type;
            this.fetchModules();
        },

        hasActiveFilters() {
            return this.searchQuery || this.categoryFilter || this.industryFilter || this.typeFilter;
        },

        clearSearch() {
            this.searchQuery = '';
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            this.fetchModules();
        },

        clearAllFilters() {
            this.searchQuery = '';
            this.categoryFilter = '';
            this.industryFilter = '';
            this.typeFilter = '';
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            const categorySelect = document.getElementById('category-select');
            if (categorySelect) categorySelect.value = '';
            const industrySelect = document.getElementById('industry-select');
            if (industrySelect) industrySelect.value = '';
            this.fetchModules();
        },

        getCategoryName(catId) {
            return this.categoryMap[catId] || catId;
        },

        getIndustryName(indId) {
            return this.industryMap[indId] || indId;
        },

        getTypeLabel(type) {
            return typeLabels[type] || type;
        },

        debouncedFetch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => this.fetchModules(), 300);
        },

        fetchModules() {
            const params = new URLSearchParams();
            if (this.searchQuery) params.set('q', this.searchQuery);
            if (this.categoryFilter) params.set('category', this.categoryFilter);
            if (this.industryFilter) params.set('industry', this.industryFilter);
            if (this.typeFilter) params.set('type', this.typeFilter);

            const url = htmxListUrl + (params.toString() ? '?' + params.toString() : '');
            htmx.ajax('GET', url, { target: '#marketplace-modules-grid', swap: 'innerHTML', indicator: '#loading-spinner' });
        }
    });

    // Register with Alpine.data() if Alpine is ready
    if (typeof Alpine !== 'undefined' && Alpine.data) {
        Alpine.data('marketplaceFilters', marketplaceFiltersData);
    } else {
        document.addEventListener('alpine:init', () => {
            Alpine.data('marketplaceFilters', marketplaceFiltersData);
        }, { once: true });
    }

    // Also make available as global function for backwards compatibility
    window.marketplaceFilters = marketplaceFiltersData;
})();
</script>

<!-- Marketplace module actions (uses global UI helpers from toast-helper.js) -->
<script>
// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        // First acquire the free module
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        // Now download and install
        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module (for owned modules)
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');
            // Refresh the modules grid
            htmx.ajax('GET', '{% url "mymodules:htmx_list" %}', { target: '#marketplace-modules-grid', swap: 'innerHTML' });

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    const spinner = button.querySelector('.install-spinner');
    const icon = button.querySelector('.install-icon');
    if (spinner) spinner.style.display = loading ? 'block' : 'none';
    if (icon) icon.style.display = loading ? 'none' : 'block';
    button.disabled = loading;
}
</script>
