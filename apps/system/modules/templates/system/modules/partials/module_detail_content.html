{% load i18n ui component_tags djicons %}

{% if error %}
    <!-- Error State -->
    {% component "page" title=_("Error") %}
        {% fill "content" %}
            {% ui_card css_class="card-error" %}
                <div class="d-flex align-center gap-md">
                    {% icon "alert-circle-outline" css_class="fs-2xl text-danger" %}
                    <div>
                        <h3 class="fw-semibold mb-xs m-0">{% trans "Error" %}</h3>
                        <p class="m-0 text-medium">{{ error }}</p>
                    </div>
                </div>
            {% endui_card %}
            {% url 'marketplace:index' as marketplace_url %}
            {% ui_button label=_("Back to Marketplace") icon="arrow-back-outline" css_class="mt-md" hx_get=marketplace_url hx_target="#main-content-area" hx_swap="innerHTML" hx_push_url="true" %}
        {% endfill %}
    {% endcomponent %}

{% elif no_connection %}
    <!-- No Connection State -->
    {% component "page" title=_("No Connection") %}
        {% fill "content" %}
            {% ui_card css_class="card-warning" %}
                <div class="d-flex align-center gap-md">
                    {% icon "cloud-offline-outline" css_class="fs-2xl text-warning" %}
                    <div>
                        <h3 class="fw-semibold mb-xs m-0">{% trans "No Connection" %}</h3>
                        <p class="m-0 text-medium">{% trans "Unable to connect to ERPlora Cloud. Please check your internet connection and try again." %}</p>
                    </div>
                </div>
            {% endui_card %}
            {% url 'mymodules:installed' as installed_url %}
            {% ui_button label=_("Back to Modules") icon="arrow-back-outline" css_class="mt-md" hx_get=installed_url hx_target="#main-content-area" hx_swap="innerHTML" hx_push_url="true" %}
        {% endfill %}
    {% endcomponent %}

{% elif module %}
    {% url 'marketplace:index' as marketplace_url %}
    {% component "page" title=module.name back_hx_get=marketplace_url back_hx_target="#main-content-area" back_hx_push_url="true" %}
        {% fill "content" %}
            <!-- Hero Card -->
            {% ui_card css_class="mb-lg" %}
                <div class="module-detail-header">
                    <!-- Icon -->
                    <div class="module-detail-icon">
                        <div class="module-icon-box module-icon-box--large module-icon-box--{{ module.category|default:'default' }}">
                            {% icon module.icon|default:"cube-outline" %}
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="module-detail-info">
                        <h1 class="fs-2xl fw-bold mb-sm m-0">{{ module.name }}</h1>
                        <p class="text-medium mb-sm m-0">
                            {% trans "by" %} <strong>{{ module.author|default:"ERPlora" }}</strong>
                        </p>
                        <p class="text-medium mb-md m-0">{{ module.description }}</p>

                        <!-- Stats -->
                        <div class="d-flex flex-wrap gap-md align-center mb-md">
                            {% if module.downloads %}
                            <span class="d-inline-flex align-center gap-xs text-medium fs-sm">
                                {% icon "download-outline" %}
                                {{ module.downloads }} {% trans "downloads" %}
                            </span>
                            {% endif %}
                            {% if module.category_name %}
                            <span class="d-inline-flex align-center gap-xs text-medium fs-sm">
                                {% icon "pricetag-outline" %}
                                {{ module.category_name }}
                            </span>
                            {% endif %}
                        </div>

                        <!-- Status Badges -->
                        <div class="d-flex flex-wrap gap-sm align-center">
                            {% if module.is_featured %}
                            {% ui_badge label=_("Featured") color="warning" icon="star" %}
                            {% endif %}
                            {% if is_installed %}
                            {% ui_chip label=_("Installed") color="success" icon="checkmark-circle-outline" %}
                            {% elif is_owned %}
                            {% ui_chip label=_("Owned") color="tertiary" icon="bag-check-outline" %}
                            {% endif %}
                        </div>
                    </div>

                    <!-- Price & Actions -->
                    <div class="module-detail-actions">
                        {% if not is_installed and not is_owned %}
                        <div class="mb-md">
                            {% if module.module_type == 'free' or is_free %}
                            <div class="fs-2xl fw-bold text-success">{% trans "Free" %}</div>
                            {% elif module.module_type == 'one_time' %}
                            <div class="fs-2xl fw-bold text-primary">{{ module.price }}</div>
                            <div class="fs-sm text-medium">{% trans "one-time payment" %}</div>
                            {% elif module.module_type == 'subscription' %}
                            <div class="fs-2xl fw-bold text-primary">{{ module.subscription_price_monthly|default:module.price }}/{% trans "mo" %}</div>
                            <div class="fs-sm text-medium">{% trans "monthly subscription" %}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex flex-column gap-sm">
                            {% if is_installed %}
                            {% ui_button label=_("Installed") expand="block" color="medium" disabled=True icon="checkmark-circle-outline" %}
                            {% elif is_owned %}
                            {% ui_button label=_("Download & Install") expand="block" color="success" icon="download-outline" data_action="download" data_module_slug=module.slug data_download_url=module.download_url %}
                            {% elif module.module_type == 'free' or is_free %}
                            {% ui_button label=_("Get Free Module") expand="block" color="primary" icon="download-outline" data_action="install-free" data_module_id=module.id data_module_slug=module.slug data_download_url=module.download_url|default:"" %}
                            {% else %}
                            {% ui_button label=_("Purchase") expand="block" color="primary" icon="cart-outline" data_action="purchase" data_module_id=module.id %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endui_card %}

            <!-- Tabs -->
            <div x-data="{ activeTab: 'overview' }">
                <div class="tab-bar">
                    <button class="tab" :class="{ 'tab-active': activeTab === 'overview' }" @click="activeTab = 'overview'">
                        <span>{% trans "Overview" %}</span>
                    </button>
                    <button class="tab" :class="{ 'tab-active': activeTab === 'reviews' }" @click="activeTab = 'reviews'">
                        <span>{% trans "Reviews" %} ({{ module.review_count|default:0 }})</span>
                    </button>
                    <button class="tab" :class="{ 'tab-active': activeTab === 'changelog' }" @click="activeTab = 'changelog'">
                        <span>{% trans "Changelog" %}</span>
                    </button>
                </div>

                <!-- Overview Tab -->
                <div x-show="activeTab === 'overview'" class="mt-lg">
                    {% ui_card title=_("About this module") css_class="mb-lg" %}
                        <div class="markdown-content">
                            {% if module.long_description %}
                            {{ module.long_description|markdown }}
                            {% else %}
                            {{ module.description|linebreaks }}
                            {% endif %}
                        </div>
                    {% endui_card %}

                    {% ui_card title=_("Module Information") %}
                        {% ui_list lines="full" %}
                            <div class="list-item d-flex justify-between">
                                <span>{% trans "Version" %}</span>
                                <span>{{ module.version }}</span>
                            </div>
                            <div class="list-item d-flex justify-between">
                                <span>{% trans "Author" %}</span>
                                <span>{{ module.author|default:"ERPlora" }}</span>
                            </div>
                            <div class="list-item d-flex justify-between">
                                <span>{% trans "Category" %}</span>
                                <span>{{ module.category_name|default:module.category }}</span>
                            </div>
                            <div class="list-item d-flex justify-between">
                                <span>{% trans "License" %}</span>
                                <span>{{ module.license|default:"Proprietary" }}</span>
                            </div>
                        {% endui_list %}
                    {% endui_card %}
                </div>

                <!-- Reviews Tab -->
                <div x-show="activeTab === 'reviews'" class="mt-lg">
                    {% if module.recent_reviews %}
                    {% for review in module.recent_reviews %}
                    {% ui_card css_class="mb-md" %}
                        <div class="d-flex justify-between align-start mb-sm">
                            <div>
                                <p class="fw-semibold m-0">{{ review.user_name|default:"Anonymous" }}</p>
                                <div class="d-flex gap-xxs mt-xs text-warning">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        {% icon "star" %}
                                        {% else %}
                                        {% icon "star-outline" css_class="text-medium" %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <span class="fs-xs text-medium">{{ review.created_at }}</span>
                        </div>
                        {% if review.title %}
                        <h4 class="fw-semibold mb-xs m-0">{{ review.title }}</h4>
                        {% endif %}
                        <p class="text-medium m-0">{{ review.comment }}</p>
                    {% endui_card %}
                    {% endfor %}
                    {% else %}
                    {% ui_empty_state title=_("No reviews yet") description=_("Be the first to review this module") icon="chatbubbles-outline" %}
                    {% endif %}
                </div>

                <!-- Changelog Tab -->
                <div x-show="activeTab === 'changelog'" class="mt-lg">
                    {% ui_card title=_("Changelog") %}
                        {% if module.changelog %}
                        <div class="markdown-content">
                            {{ module.changelog|markdown }}
                        </div>
                        {% else %}
                        <div class="text-center py-xl">
                            {% icon "document-text-outline" css_class="fs-4xl text-medium" %}
                            <p class="text-medium mt-md m-0">{% trans "No changelog available" %}</p>
                        </div>
                        {% endif %}
                    {% endui_card %}
                </div>
            </div>

            <!-- Related Modules -->
            {% if related_modules %}
            <div class="mt-xl">
                <h2 class="fs-xl fw-semibold mb-md">{% trans "Related Modules" %}</h2>
                {% ui_grid_start padding=False %}
                    {% ui_row_start %}
                    {% for related in related_modules %}
                        {% include "system/modules/partials/module_card.html" with module=related mode="marketplace" %}
                    {% endfor %}
                    {% ui_row_end %}
                {% ui_grid_end %}
            </div>
            {% endif %}
        {% endfill %}
    {% endcomponent %}

{% endif %}

<!-- Module action handlers -->
<script>
document.addEventListener('click', function(e) {
    const button = e.target.closest('button[data-action], .btn[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.innerHTML = '<div class="loading"></div>';
    }
}
</script>

<style>
/* Markdown content styles */
.markdown-content {
    line-height: 1.6;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.markdown-content h1 { font-size: 1.5rem; }
.markdown-content h2 { font-size: 1.25rem; }
.markdown-content h3 { font-size: 1.125rem; }

.markdown-content p {
    margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content code {
    background: var(--color-base-200);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-family: 'Courier New', monospace;
}

.markdown-content pre {
    background: var(--color-base-200);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 1rem;
}

.markdown-content pre code {
    background: none;
    padding: 0;
}

.markdown-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: 1rem;
    margin: 1rem 0;
    color: var(--color-base-content-secondary);
}

.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.markdown-content table th,
.markdown-content table td {
    border: 1px solid var(--color-base-200);
    padding: 0.5rem;
    text-align: left;
}

.markdown-content table th {
    background: var(--color-base-200);
    font-weight: 600;
}

.markdown-content a {
    color: var(--color-primary);
    text-decoration: none;
}

.markdown-content a:hover {
    text-decoration: underline;
}
</style>
