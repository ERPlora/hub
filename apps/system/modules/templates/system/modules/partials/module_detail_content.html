{% load i18n %}

{% if request.htmx %}
<!-- Tab bar update via OOB swap (only on HTMX navigation) -->
<div id="dashboard-tabbar" hx-swap-oob="innerHTML">
{% include "system/modules/partials/tabbar_system.html" %}
</div>
{% endif %}

<div class="ion-padding" x-data="moduleDetailData()">
    {% if error %}
    <!-- Error State -->
    <ion-card color="danger">
        <ion-card-content>
            <div class="flex items-center gap-3">
                <ion-icon name="alert-circle-outline" class="text-2xl"></ion-icon>
                <div>
                    <h3 class="font-semibold mb-1">{% trans "Error" %}</h3>
                    <p class="m-0">{{ error }}</p>
                </div>
            </div>
        </ion-card-content>
    </ion-card>
    <ion-button
        href="{% url 'system:marketplace' %}"
        hx-get="{% url 'system:marketplace' %}"
        hx-target="#main-content"
        hx-swap="innerHTML"
        hx-push-url="true"
        class="mt-4">
        <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
        {% trans "Back to Marketplace" %}
    </ion-button>
    {% elif module %}

    <!-- Breadcrumb -->
    <div class="mb-6">
        <div class="flex items-center gap-2 text-medium flex-wrap">
            <a href="{% url 'system:marketplace' %}"
               hx-get="{% url 'system:marketplace' %}"
               hx-target="#main-content"
               hx-swap="innerHTML"
               hx-push-url="true"
               class="no-underline text-medium hover:text-primary">
                {% trans "Marketplace" %}
            </a>
            <ion-icon name="chevron-forward-outline" class="text-sm"></ion-icon>
            <span>{{ module.name }}</span>
        </div>
    </div>

    <!-- Module Header Card -->
    <ion-card class="mb-6">
        <ion-card-content class="p-4 md:p-6">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Icon -->
                <div class="flex justify-center md:justify-start">
                    {% if module.icon_url %}
                    <img src="{{ module.icon_url }}" alt="{{ module.name }}" class="w-20 h-20 rounded-2xl">
                    {% else %}
                    <div class="w-20 h-20 rounded-2xl flex items-center justify-center"
                         style="background: {{ module.category_color|default:'var(--ion-color-primary)' }};">
                        <ion-icon name="{{ module.icon|default:'cube-outline' }}" class="text-4xl text-white"></ion-icon>
                    </div>
                    {% endif %}
                </div>

                <!-- Info -->
                <div class="flex-1 text-center md:text-left">
                    <h1 class="text-2xl md:text-3xl font-bold mb-2">{{ module.name }}</h1>
                    <p class="text-medium mb-4">
                        {% trans "by" %} <strong>{{ module.author|default:"ERPlora" }}</strong> â€¢ v{{ module.version }}
                    </p>
                    <div class="flex flex-wrap gap-2 md:gap-4 items-center justify-center md:justify-start">
                        {% if module.category_name %}
                        <ion-chip>
                            <ion-icon name="pricetag-outline"></ion-icon>
                            <ion-label>{{ module.category_name }}</ion-label>
                        </ion-chip>
                        {% endif %}
                        <div class="flex flex-wrap gap-4 text-sm text-medium">
                            {% if module.downloads %}
                            <span class="flex items-center gap-1">
                                <ion-icon name="download-outline"></ion-icon>
                                {{ module.downloads }} {% trans "downloads" %}
                            </span>
                            {% endif %}
                            {% if module.rating %}
                            <span class="flex items-center gap-1">
                                <ion-icon name="star" style="color: var(--ion-color-warning);"></ion-icon>
                                {{ module.rating|floatformat:1 }}
                                {% if module.reviews_count %}({{ module.reviews_count }} {% trans "reviews" %}){% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Price & Actions -->
                <div class="text-center md:text-right min-w-[200px]">
                    {% if is_installed %}
                    <ion-badge color="success" class="text-base py-3 px-4 mb-4 inline-flex items-center gap-2">
                        <ion-icon name="checkmark-circle-outline"></ion-icon>
                        {% trans "Installed" %}
                    </ion-badge>
                    {% elif is_owned %}
                    <ion-badge color="tertiary" class="text-base py-3 px-4 mb-4 inline-flex items-center gap-2">
                        <ion-icon name="bag-check-outline"></ion-icon>
                        {% trans "Owned" %}
                    </ion-badge>
                    {% else %}
                    <div class="mb-4">
                        {% if module.module_type == 'free' or is_free %}
                        <div class="text-2xl font-bold" style="color: var(--ion-color-success);">
                            {% trans "Free" %}
                        </div>
                        {% elif module.module_type == 'one_time' %}
                        <div class="text-2xl font-bold" style="color: var(--ion-color-primary);">
                            {{ module.currency|default:"EUR" }} {{ module.price }}
                        </div>
                        <div class="text-sm text-medium">{% trans "one-time payment" %}</div>
                        {% elif module.module_type == 'subscription' %}
                        <div class="text-2xl font-bold" style="color: var(--ion-color-primary);">
                            {{ module.currency|default:"EUR" }} {{ module.price }}/{% trans "mo" %}
                        </div>
                        <div class="text-sm text-medium">{% trans "monthly subscription" %}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-2">
                        {% if is_installed %}
                        <ion-button expand="block" color="medium" disabled>
                            <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                            {% trans "Installed" %}
                        </ion-button>
                        {% elif is_owned %}
                        <ion-button expand="block" color="success"
                                    onclick="downloadAndInstall('{{ module.slug }}', '{{ module.download_url }}', this)">
                            <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                            <ion-icon slot="start" name="download-outline" class="install-icon"></ion-icon>
                            {% trans "Download & Install" %}
                        </ion-button>
                        {% elif module.module_type == 'free' or is_free %}
                        <ion-button expand="block" color="primary"
                                    onclick="installFreeModule('{{ module.id }}', '{{ module.slug }}', '{{ module.download_url|default:'' }}', this)">
                            <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                            <ion-icon slot="start" name="download-outline" class="install-icon"></ion-icon>
                            {% trans "Get Free Module" %}
                        </ion-button>
                        {% else %}
                        <ion-button expand="block" color="primary"
                                    onclick="purchaseModule('{{ module.id }}', this)">
                            <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                            <ion-icon slot="start" name="cart-outline" class="install-icon"></ion-icon>
                            {% trans "Purchase" %}
                        </ion-button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column (2/3) -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Description -->
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Description" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <div class="prose max-w-none">
                        {{ module.description|linebreaks }}
                    </div>
                </ion-card-content>
            </ion-card>

            <!-- Screenshots -->
            {% if module.screenshots %}
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Screenshots" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {% for screenshot in module.screenshots %}
                        <img src="{{ screenshot.url }}"
                             alt="{{ screenshot.caption|default:module.name }}"
                             class="w-full rounded-lg cursor-pointer hover:opacity-80 transition-opacity"
                             @click="openImageModal('{{ screenshot.url }}')">
                        {% endfor %}
                    </div>
                </ion-card-content>
            </ion-card>
            {% endif %}

            <!-- Features -->
            {% if module.features %}
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Features" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <ion-list lines="none">
                        {% for feature in module.features %}
                        <ion-item style="--padding-start: 0;">
                            <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
                            <ion-label>{{ feature }}</ion-label>
                        </ion-item>
                        {% endfor %}
                    </ion-list>
                </ion-card-content>
            </ion-card>
            {% endif %}

            <!-- Reviews -->
            {% if module.reviews %}
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Reviews" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <ion-list lines="full">
                        {% for review in module.reviews %}
                        <ion-item class="ion-no-padding">
                            <ion-label class="ion-text-wrap">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start mb-2 gap-1">
                                    <div>
                                        <h3 class="font-semibold">{{ review.user|default:"Anonymous" }}</h3>
                                        <div class="mt-1" style="color: var(--ion-color-warning);">
                                            {% for i in "12345" %}
                                            {% if forloop.counter <= review.rating %}
                                            <ion-icon name="star"></ion-icon>
                                            {% else %}
                                            <ion-icon name="star-outline"></ion-icon>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <span class="text-sm text-medium">{{ review.created_at }}</span>
                                </div>
                                <p class="m-0 text-medium">{{ review.comment }}</p>
                            </ion-label>
                        </ion-item>
                        {% endfor %}
                    </ion-list>
                </ion-card-content>
            </ion-card>
            {% endif %}
        </div>

        <!-- Right Sidebar (1/3) -->
        <div class="space-y-6">
            <!-- Module Information -->
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Information" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <ion-list lines="none">
                        <ion-item style="--padding-start: 0; --inner-padding-end: 0;">
                            <ion-label>
                                <p class="mb-1 text-medium text-sm">{% trans "Version" %}</p>
                                <h3>{{ module.version }}</h3>
                            </ion-label>
                        </ion-item>
                        <ion-item style="--padding-start: 0; --inner-padding-end: 0;">
                            <ion-label>
                                <p class="mb-1 text-medium text-sm">{% trans "Author" %}</p>
                                <h3>{{ module.author|default:"ERPlora" }}</h3>
                            </ion-label>
                        </ion-item>
                        {% if module.category_name %}
                        <ion-item style="--padding-start: 0; --inner-padding-end: 0;">
                            <ion-label>
                                <p class="mb-1 text-medium text-sm">{% trans "Category" %}</p>
                                <h3>{{ module.category_name }}</h3>
                            </ion-label>
                        </ion-item>
                        {% endif %}
                        {% if module.updated_at %}
                        <ion-item style="--padding-start: 0; --inner-padding-end: 0;">
                            <ion-label>
                                <p class="mb-1 text-medium text-sm">{% trans "Last Updated" %}</p>
                                <h3>{{ module.updated_at }}</h3>
                            </ion-label>
                        </ion-item>
                        {% endif %}
                        {% if module.min_hub_version %}
                        <ion-item style="--padding-start: 0; --inner-padding-end: 0;">
                            <ion-label>
                                <p class="mb-1 text-medium text-sm">{% trans "Requires Hub" %}</p>
                                <h3>v{{ module.min_hub_version }}+</h3>
                            </ion-label>
                        </ion-item>
                        {% endif %}
                    </ion-list>
                </ion-card-content>
            </ion-card>

            <!-- Related Modules -->
            {% if related_modules %}
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Related Modules" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <ion-list lines="none">
                        {% for related in related_modules %}
                        <ion-item button
                                  href="{% url 'system:module_detail' related.slug %}"
                                  hx-get="{% url 'system:module_detail' related.slug %}"
                                  hx-target="#main-content"
                                  hx-swap="innerHTML"
                                  hx-push-url="true"
                                  detail="true"
                                  style="--padding-start: 0;">
                            <div slot="start" class="w-10 h-10 rounded-lg flex items-center justify-center"
                                 style="background: {{ related.category_color|default:'var(--ion-color-light)' }};">
                                <ion-icon name="{{ related.icon|default:'cube-outline' }}" style="color: white;"></ion-icon>
                            </div>
                            <ion-label>
                                <h3>{{ related.name }}</h3>
                                <p>{{ related.author|default:"ERPlora" }}</p>
                            </ion-label>
                        </ion-item>
                        {% endfor %}
                    </ion-list>
                </ion-card-content>
            </ion-card>
            {% endif %}

            <!-- Support -->
            <ion-card>
                <ion-card-header>
                    <ion-card-title>{% trans "Support" %}</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    {% if module.documentation_url %}
                    <ion-button expand="block" fill="outline" href="{{ module.documentation_url }}" target="_blank">
                        <ion-icon slot="start" name="document-text-outline"></ion-icon>
                        {% trans "Documentation" %}
                    </ion-button>
                    {% endif %}
                    {% if module.support_url %}
                    <ion-button expand="block" fill="outline" href="{{ module.support_url }}" target="_blank" class="mt-2">
                        <ion-icon slot="start" name="help-circle-outline"></ion-icon>
                        {% trans "Get Support" %}
                    </ion-button>
                    {% endif %}
                    <ion-button expand="block" fill="outline" href="mailto:support@erplora.com" class="mt-2">
                        <ion-icon slot="start" name="mail-outline"></ion-icon>
                        {% trans "Contact Us" %}
                    </ion-button>
                </ion-card-content>
            </ion-card>
        </div>
    </div>

    <!-- Image Modal -->
    <ion-modal :is-open="showImageModal" @didDismiss="closeImageModal()">
        <ion-header>
            <ion-toolbar>
                <ion-title>{% trans "Screenshot" %}</ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="closeImageModal()">
                        <ion-icon name="close" slot="icon-only"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <img :src="selectedImage" style="width: 100%; height: auto;">
        </ion-content>
    </ion-modal>

    {% endif %}
</div>

<script>
function moduleDetailData() {
    return {
        showImageModal: false,
        selectedImage: '',

        openImageModal(imageUrl) {
            this.selectedImage = imageUrl;
            this.showImageModal = true;
        },

        closeImageModal() {
            this.showImageModal = false;
            this.selectedImage = '';
        }
    }
}

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "system:purchase_module" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "system:purchase_module" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button) {
    if (button) setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "system:install_from_marketplace" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_slug: moduleSlug, download_url: downloadUrl })
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "system:module_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    const spinner = button.querySelector('.install-spinner');
    const icon = button.querySelector('.install-icon');
    if (spinner) spinner.style.display = loading ? 'block' : 'none';
    if (icon) icon.style.display = loading ? 'none' : 'block';
    button.disabled = loading;
}
</script>

<style>
.no-underline {
    text-decoration: none;
}
.space-y-6 > * + * {
    margin-top: 1.5rem;
}
.prose {
    line-height: 1.6;
}
.prose p {
    margin-bottom: 1rem;
}
</style>
