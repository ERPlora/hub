{% load i18n djicons %}
<div data-back-url="{% url 'marketplace:index' %}" hidden></div>

{% if error %}
    <!-- Error State -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="flex items-center gap-4">
                {% icon "alert-circle-outline" class="text-2xl" %}
                <div>
                    <h3 class="font-semibold mb-1">{% trans "Error" %}</h3>
                    <p class="opacity-60 mb-0">{{ error }}</p>
                </div>
            </div>
        </div>
    </div>
    <a class="btn btn-outline"
       href="{% url 'marketplace:index' %}"
       hx-get="{% url 'marketplace:index' %}"
       hx-target="#main-content-area"
       hx-push-url="true">
        {% icon "arrow-back-outline" %}
        {% trans "Back to Marketplace" %}
    </a>

{% elif no_connection %}
    <!-- No Connection State -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="flex items-center gap-4">
                {% icon "cloud-offline-outline" class="text-2xl" %}
                <div>
                    <h3 class="font-semibold mb-1">{% trans "No Connection" %}</h3>
                    <p class="opacity-60 mb-0">{% trans "Unable to connect to ERPlora Cloud. Please check your internet connection and try again." %}</p>
                </div>
            </div>
        </div>
    </div>
    <a class="btn btn-outline"
       href="{% url 'mymodules:installed' %}"
       hx-get="{% url 'mymodules:installed' %}"
       hx-target="#main-content-area"
       hx-push-url="true">
        {% icon "arrow-back-outline" %}
        {% trans "Back to Modules" %}
    </a>

{% elif module %}
    <!-- Hero Card -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="module-detail-header">
                <!-- Icon -->
                <div class="module-detail-icon">
                    <div class="module-icon-box module-icon-box--large module-icon-box--{{ module.category|default:'default' }}">
                        {% icon module.icon|default:"cube-outline" %}
                    </div>
                </div>

                <!-- Info -->
                <div class="module-detail-info">
                    <h1 class="text-2xl font-bold mb-2 m-0">{{ module.name }}</h1>
                    <p class="opacity-60 mb-2 m-0">
                        {% trans "by" %} <strong>{{ module.author|default:"ERPlora" }}</strong>
                    </p>
                    <p class="opacity-60 mb-3 m-0">{{ module.description }}</p>

                    <!-- Stats -->
                    <div class="flex flex-wrap gap-3 items-center mb-3">
                        {% if module.downloads %}
                        <span class="inline-flex items-center gap-1 opacity-60 text-sm">
                            {% icon "download-outline" %}
                            {{ module.downloads }} {% trans "downloads" %}
                        </span>
                        {% endif %}
                        {% if module.category_name %}
                        <span class="inline-flex items-center gap-1 opacity-60 text-sm">
                            {% icon "pricetag-outline" %}
                            {{ module.category_name }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Status Badges -->
                    <div class="flex flex-wrap gap-2 items-center">
                        {% if module.is_featured %}
                        <span class="badge color-warning">{% icon "star" %} {% trans "Featured" %}</span>
                        {% endif %}
                        {% if is_installed %}
                        <span class="chip color-success">{% icon "checkmark-circle-outline" %} {% trans "Installed" %}</span>
                        {% elif is_owned %}
                        <span class="chip">{% icon "bag-check-outline" %} {% trans "Owned" %}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Price & Actions -->
                <div class="module-detail-actions">
                    {% if not is_installed and not is_owned %}
                    <div class="mb-3">
                        {% if module.module_type == 'free' or is_free %}
                        <div class="text-2xl font-bold color-success">{% trans "Free" %}</div>
                        {% elif module.module_type == 'one_time' %}
                        <div class="text-2xl font-bold color-primary">{{ module.price }}</div>
                        <div class="text-sm opacity-60">{% trans "one-time payment" %}</div>
                        {% elif module.module_type == 'subscription' %}
                        <div class="text-2xl font-bold color-primary">{{ module.subscription_price_monthly|default:module.price }}/{% trans "mo" %}</div>
                        <div class="text-sm opacity-60">{% trans "monthly subscription" %}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-2">
                        {% if is_installed %}
                        <button class="btn btn-block" disabled>
                            {% icon "checkmark-circle-outline" %} {% trans "Installed" %}
                        </button>
                        {% elif is_owned %}
                        <button class="btn btn-block color-success"
                                data-action="download"
                                data-module-slug="{{ module.slug }}"
                                data-module-dir="{{ module.module_id }}"
                                data-download-url="{{ module.download_url|default:'' }}">
                            {% icon "download-outline" %} {% trans "Download & Install" %}
                        </button>
                        {% elif module.module_type == 'free' or is_free %}
                        <button class="btn btn-block color-primary"
                                data-action="install-free"
                                data-module-id="{{ module.id }}"
                                data-module-slug="{{ module.slug }}"
                                data-module-dir="{{ module.module_id }}"
                                data-download-url="{{ module.download_url|default:'' }}">
                            {% icon "download-outline" %} {% trans "Get Free Module" %}
                        </button>
                        {% else %}
                        <button class="btn btn-block color-primary"
                                data-action="purchase"
                                data-module-id="{{ module.id }}">
                            {% icon "cart-outline" %} {% trans "Purchase" %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div x-data="{ activeTab: 'overview' }">
        <div class="tabs tabs-border">
            <button class="tab" :class="{ 'tab-active': activeTab === 'overview' }" @click="activeTab = 'overview'">
                <span>{% trans "Overview" %}</span>
            </button>
            <button class="tab" :class="{ 'tab-active': activeTab === 'reviews' }" @click="activeTab = 'reviews'">
                <span>{% trans "Reviews" %} ({{ module.review_count|default:0 }})</span>
            </button>
            <button class="tab" :class="{ 'tab-active': activeTab === 'changelog' }" @click="activeTab = 'changelog'">
                <span>{% trans "Changelog" %}</span>
            </button>
        </div>

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" class="mt-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title">{% trans "About this module" %}</h3>
                </div>
                <div class="card-body">
                    <div class="markdown-content">
                        {% if module.long_description %}
                        {{ module.long_description|linebreaks }}
                        {% else %}
                        {{ module.description|linebreaks }}
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{% trans "Module Information" %}</h3>
                </div>
                <div class="card-body p-0">
                    <div class="list">
                        <div class="list-item">
                            <div class="list-item-content">
                                <span class="list-item-label">{% trans "Version" %}</span>
                            </div>
                            <div class="list-item-end">
                                <span class="list-item-value">{{ module.version }}</span>
                            </div>
                        </div>
                        <div class="list-item">
                            <div class="list-item-content">
                                <span class="list-item-label">{% trans "Author" %}</span>
                            </div>
                            <div class="list-item-end">
                                <span class="list-item-value">{{ module.author|default:"ERPlora" }}</span>
                            </div>
                        </div>
                        <div class="list-item">
                            <div class="list-item-content">
                                <span class="list-item-label">{% trans "Category" %}</span>
                            </div>
                            <div class="list-item-end">
                                <span class="list-item-value">{{ module.category_name|default:module.category }}</span>
                            </div>
                        </div>
                        <div class="list-item">
                            <div class="list-item-content">
                                <span class="list-item-label">{% trans "License" %}</span>
                            </div>
                            <div class="list-item-end">
                                <span class="list-item-value">{{ module.license|default:"Proprietary" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reviews Tab -->
        <div x-show="activeTab === 'reviews'" class="mt-4">
            {# Review Form #}
            <div class="card glass mb-4" x-data="{ rating: 0, hoverRating: 0, comment: '', submitting: false, submitted: false }">
                <div class="card-body">
                    <h3 class="font-semibold text-sm mb-3 m-0">{% trans "Write a Review" %}</h3>

                    {# Star selector #}
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-sm opacity-60">{% trans "Your rating:" %}</span>
                        <div class="flex gap-1">
                            {% for i in "12345" %}
                            <button type="button"
                                    class="p-0 border-none bg-transparent cursor-pointer"
                                    style="line-height: 0; color: var(--color-warning); opacity: 0.3; transition: opacity 0.15s;"
                                    :style="(hoverRating >= {{ forloop.counter }} || (!hoverRating && rating >= {{ forloop.counter }})) ? 'opacity: 1' : 'opacity: 0.3'"
                                    @mouseenter="hoverRating = {{ forloop.counter }}"
                                    @mouseleave="hoverRating = 0"
                                    @click="rating = {{ forloop.counter }}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="currentColor">
                                    <path d="M394 480a16 16 0 01-9.39-3L256 383.76 127.39 477a16 16 0 01-24.55-18.08L153 310.35 23 221.2a16 16 0 019-29.2h160.38l48.4-148.95a16 16 0 0130.44 0l48.4 149H480a16 16 0 019.05 29.2L359 310.35l50.13 148.53A16 16 0 01394 480z"/>
                                </svg>
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    {# Comment textarea #}
                    <textarea class="textarea w-full mb-3"
                              rows="3"
                              x-model="comment"
                              placeholder="{% trans 'Share your experience with this module (optional)...' %}"></textarea>

                    {# Submit button #}
                    <div class="flex items-center gap-3">
                        <button class="btn btn-sm color-primary"
                                :disabled="!rating || submitting"
                                @click="
                                    submitting = true;
                                    fetch('{% url 'mymodules:api_rate' %}', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                                        body: JSON.stringify({ module_slug: '{{ module.slug }}', rating: rating, comment: comment })
                                    })
                                    .then(r => r.json())
                                    .then(d => { submitted = true; if (typeof Toast !== 'undefined') Toast.success('{% trans 'Review submitted!' %}'); })
                                    .catch(() => { if (typeof Toast !== 'undefined') Toast.error('{% trans 'Error submitting review' %}'); })
                                    .finally(() => { submitting = false; })
                                ">
                            <template x-if="submitting"><div class="loading loading-sm"></div></template>
                            <template x-if="!submitting">
                                <span>{% icon "send-outline" %} {% trans "Submit Review" %}</span>
                            </template>
                        </button>
                        <span class="text-xs color-success" x-show="submitted" x-transition>
                            {% icon "checkmark-circle-outline" %} {% trans "Thank you for your review!" %}
                        </span>
                    </div>
                </div>
            </div>

            {# Existing reviews #}
            {% if module.recent_reviews %}
            {% for review in module.recent_reviews %}
            <div class="card glass mb-3">
                <div class="card-body">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-sm m-0">{{ review.user_name|default:"Anonymous" }}</p>
                            <div class="flex gap-0.5 mt-1" style="color: var(--color-warning);">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                    {% icon "star" %}
                                    {% else %}
                                    {% icon "star-outline" class="opacity-30" %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        <span class="text-xs opacity-50">{{ review.created_at }}</span>
                    </div>
                    {% if review.title %}
                    <h4 class="font-semibold text-sm mb-1 m-0">{{ review.title }}</h4>
                    {% endif %}
                    {% if review.comment %}
                    <p class="text-sm opacity-60 m-0">{{ review.comment }}</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="flex flex-col items-center justify-center py-8 text-center">
                {% icon "chatbubbles-outline" class="text-3xl opacity-40 mb-3" %}
                <p class="text-sm opacity-50 m-0">{% trans "No reviews yet â€” be the first!" %}</p>
            </div>
            {% endif %}
        </div>

        <!-- Changelog Tab -->
        <div x-show="activeTab === 'changelog'" class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{% trans "Changelog" %}</h3>
                </div>
                <div class="card-body">
                    {% if module.changelog %}
                    <div class="markdown-content">
                        {{ module.changelog|linebreaks }}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        {% icon "document-text-outline" class="text-4xl opacity-40" %}
                        <p class="opacity-60 mt-3 m-0">{% trans "No changelog available" %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Related Modules -->
    {% if related_modules %}
    <div class="mt-6">
        <h2 class="text-xl font-semibold mb-3">{% trans "Related Modules" %}</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for related in related_modules %}
                {% include "system/modules/partials/module_card.html" with module=related mode="marketplace" %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endif %}

<!-- Module action handlers -->
<script>
if (!window._sysModuleDetailInit) {
window._sysModuleDetailInit = true;
document.addEventListener('click', function(e) {
    const button = e.target.closest('button[data-action], .btn[data-action]');
    if (!button) return;

    const action = button.dataset.action;
    e.preventDefault();
    e.stopPropagation();

    if (action === 'download') {
        downloadAndInstall(button.dataset.moduleSlug, button.dataset.downloadUrl, button, button.dataset.moduleDir);
    } else if (action === 'install-free') {
        installFreeModule(button.dataset.moduleId, button.dataset.moduleSlug, button.dataset.downloadUrl, button, button.dataset.moduleDir);
    } else if (action === 'purchase') {
        purchaseModule(button.dataset.moduleId, button);
    }
});

// Install free module
async function installFreeModule(moduleId, moduleSlug, downloadUrl, button, moduleDir) {
    setButtonLoading(button, true);
    try {
        const purchaseResponse = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const purchaseData = await purchaseResponse.json();

        if (!purchaseData.success && !purchaseData.is_free && !purchaseData.already_owned) {
            Toast.error(purchaseData.error || '{% trans "Error acquiring module" %}');
            return;
        }

        if (downloadUrl) {
            await downloadAndInstall(moduleSlug, downloadUrl, null, moduleDir);
        } else {
            Toast.warning('{% trans "Module acquired. Download not available yet." %}');
            setTimeout(() => window.location.reload(), 1500);
        }
    } catch (error) {
        Toast.error('{% trans "Error acquiring module" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Purchase paid module
async function purchaseModule(moduleId, button) {
    setButtonLoading(button, true);
    try {
        const response = await fetch('{% url "mymodules:api_purchase" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify({ module_id: moduleId })
        });
        const data = await response.json();

        if (data.success && data.checkout_url) {
            window.open(data.checkout_url, '_blank');
            Toast.info('{% trans "Complete payment in the opened window" %}');
        } else if (data.already_owned) {
            Toast.warning('{% trans "You already own this module" %}');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            Toast.error(data.error || '{% trans "Error starting purchase" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error processing purchase" %}');
    } finally {
        setButtonLoading(button, false);
    }
}

// Download and install module
async function downloadAndInstall(moduleSlug, downloadUrl, button, moduleDir) {
    if (button) setButtonLoading(button, true);
    try {
        const payload = { module_slug: moduleSlug, download_url: downloadUrl };
        if (moduleDir) payload.module_id = moduleDir;
        const response = await fetch('{% url "mymodules:api_install" %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.success) {
            Toast.success('{% trans "Module installed successfully!" %}');

            if (data.requires_restart) {
                showConfirm(
                    '{% trans "Restart Required" %}',
                    '{% trans "The server needs to restart to complete module setup. Restart now?" %}',
                    () => {
                        fetch('{% url "mymodules:api_restart" %}', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
                            .then(() => setTimeout(() => window.location.reload(), 2000));
                    },
                    '{% trans "Restart" %}',
                    '{% trans "Later" %}'
                );
            } else {
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            Toast.error(data.error || '{% trans "Error installing module" %}');
        }
    } catch (error) {
        Toast.error('{% trans "Error downloading module" %}');
    } finally {
        if (button) setButtonLoading(button, false);
    }
}

// Button loading state helper
function setButtonLoading(button, loading) {
    if (!button) return;
    button.disabled = loading;
    if (loading) {
        button.innerHTML = '<div class="loading"></div>';
    }
}
} // end guard
</script>

<style>
/* Markdown content styles */
.markdown-content {
    line-height: 1.6;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    font-weight: 600;
}

.markdown-content h1 { font-size: 1.5rem; }
.markdown-content h2 { font-size: 1.25rem; }
.markdown-content h3 { font-size: 1.125rem; }

.markdown-content p {
    margin-bottom: 1rem;
}

.markdown-content ul,
.markdown-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.markdown-content li {
    margin-bottom: 0.5rem;
}

.markdown-content code {
    background: var(--color-base-200);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-family: 'Courier New', monospace;
}

.markdown-content pre {
    background: var(--color-base-200);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 1rem;
}

.markdown-content pre code {
    background: none;
    padding: 0;
}

.markdown-content blockquote {
    border-left: 4px solid var(--color-primary);
    padding-left: 1rem;
    margin: 1rem 0;
    color: var(--color-base-content-secondary);
}

.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
}

.markdown-content table th,
.markdown-content table td {
    border: 1px solid var(--color-base-200);
    padding: 0.5rem;
    text-align: left;
}

.markdown-content table th {
    background: var(--color-base-200);
    font-weight: 600;
}

.markdown-content a {
    color: var(--color-primary);
    text-decoration: none;
}

.markdown-content a:hover {
    text-decoration: underline;
}
</style>
