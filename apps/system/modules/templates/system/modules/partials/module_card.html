{% load i18n djicons module_icons %}

<div class="module-card{% if card_context == 'installed' and module.is_active %} module-card-installed{% endif %}{% if card_context == 'marketplace' and module.is_installed %} module-card-installed{% elif card_context == 'marketplace' and module.is_owned %} module-card-owned{% endif %} glass"{% if module.assistant_tiers %} data-tier-slug="{{ module.assistant_tiers.0.slug }}" data-module-price="{{ module.assistant_tiers.0.price_monthly }}"{% endif %}{% if card_context == 'marketplace' %} data-module-slug="{{ module.slug }}" data-dependencies="{{ module.dependency_ids|join:',' }}"{% endif %}>
    <div class="module-card-body">
        {# Header: Icon + Name/Meta + Badges #}
        <div class="module-card-header">
            <div class="module-card-icon module-card-icon-soft">
                {% if card_context == 'marketplace' and module.icon %}
                    <img src="{{ module.icon }}" alt="{{ module.name }}">
                {% elif card_context == 'marketplace' %}
                    {% icon module.display_icon|default:"cube-outline" %}
                {% else %}
                    {% module_icon module_id=module.module_id icon=module.icon|default:"cube-outline" size="text-xl" %}
                {% endif %}
            </div>

            <div class="module-card-info">
                <h3 class="module-card-name">{{ module.name }}</h3>
                <span class="module-card-author">
                    {% if module.author %}{{ module.author }} &middot; {% endif %}v{{ module.version }}
                </span>

                {# Status chips + price badges #}
                <div class="module-card-meta">
                    {% if card_context == 'installed' %}
                        {% if module.is_active %}
                        <span class="badge badge-sm color-success">{% trans "Active" %}</span>
                        {% else %}
                        <span class="badge badge-sm">{% trans "Inactive" %}</span>
                        {% endif %}
                    {% endif %}

                    {% if card_context == 'marketplace' %}
                        {% if module.is_essential is not None and module.is_essential %}
                        <span class="badge badge-sm color-success">{% trans "Essential" %}</span>
                        {% elif module.is_essential is not None and not module.is_essential %}
                        <span class="badge badge-sm color-info">{% trans "Recommended" %}</span>
                        {% endif %}

                        {% if module.is_installed %}
                        <span class="chip chip-sm color-success">
                            {% icon "checkmark-circle-outline" %}
                            {% trans "Installed" %}
                        </span>
                        {% elif module.is_owned %}
                        <span class="chip chip-sm color-info">
                            {% icon "bag-check-outline" %}
                            {% trans "Owned" %}
                        </span>
                        {% endif %}

                        {% if module.is_featured %}
                        <span class="badge badge-sm color-warning">{% trans "Featured" %}</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            {% if card_context == 'marketplace' %}
            <label class="checkbox shrink-0 ml-auto" @click.stop>
                <input type="checkbox" class="checkbox-input"
                       @change="toggle('{{ module.slug }}')"
                       :checked="selected.has('{{ module.slug }}')">
                <span class="checkbox-box">
                    <svg class="checkbox-mark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </span>
            </label>
            {% endif %}
        </div>

        {# Description #}
        {% if module.description %}
        <p class="module-card-description">{{ module.description }}</p>
        {% endif %}

        {# Rating stars — marketplace only, click to review #}
        {% if card_context == 'marketplace' %}
        <div class="module-card-rating"
             style="cursor: pointer;"
             data-module-id="{{ module.id }}"
             data-module-name="{{ module.name }}"
             onclick="event.stopPropagation(); if (typeof openReviewModal === 'function') openReviewModal(this);">
            <div class="module-card-stars">
                {% for i in "12345" %}
                <span class="module-card-star{% if module.rating and forloop.counter <= module.rating %} module-card-star-filled{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                        <path d="M394 480a16 16 0 01-9.39-3L256 383.76 127.39 477a16 16 0 01-24.55-18.08L153 310.35 23 221.2a16 16 0 019-29.2h160.38l48.4-148.95a16 16 0 0130.44 0l48.4 149H480a16 16 0 019.05 29.2L359 310.35l50.13 148.53A16 16 0 01394 480z"/>
                    </svg>
                </span>
                {% endfor %}
            </div>
            {% if module.rating %}
            <span class="module-card-rating-value">{{ module.rating|floatformat:1 }}</span>
            {% endif %}
            {% if module.review_count %}
            <span class="module-card-rating-count">({{ module.review_count }})</span>
            {% endif %}
        </div>
        {% endif %}

        {# Footer: Price + Actions #}
        <div class="module-card-footer">
            {% if card_context == 'marketplace' %}
            <div>
                {% if module.assistant_tiers %}
                <select class="select select-sm w-full"
                        onchange="var c=this.closest('.module-card');c.dataset.tierSlug=this.value;c.dataset.modulePrice=this.selectedOptions[0].dataset.price"
                        style="font-size: 0.75rem;">
                    {% for tier in module.assistant_tiers %}
                    <option value="{{ tier.slug }}" data-price="{{ tier.price_monthly }}">{{ tier.name }} — &euro;{{ tier.price_monthly }}/{% trans "mo" %}</option>
                    {% endfor %}
                </select>
                {% elif module.is_free or module.module_type == 'free' or module.price == 0 %}
                <span class="module-card-price module-card-price-free">{% trans "Free" %}</span>
                {% elif module.module_type == 'subscription' %}
                <span class="module-card-price">&euro;{{ module.subscription_price_monthly|default:module.price }}<span class="module-card-price-period">/{% trans "mo" %}</span></span>
                {% elif module.price %}
                <span class="module-card-price">&euro;{{ module.price }}</span>
                {% endif %}
            </div>

            <div class="module-card-actions">
                {% if module.is_installed %}
                <span class="badge badge-sm color-success">{% icon "checkmark-circle-outline" %} {% trans "Installed" %}</span>
                {% else %}
                <button class="btn btn-sm btn-outline" @click.stop="toggle('{{ module.slug }}')">
                    {% icon "add-outline" %}
                    {% trans "Select" %}
                </button>
                {% endif %}
            </div>
            {% endif %}

            {% if card_context == 'installed' %}
            <div class="module-card-actions flex-1">
                {% if module.is_active %}
                <button class="btn btn-sm btn-soft color-warning flex-1"
                        data-action="module-deactivate"
                        data-url="{{ module.deactivate_url }}"
                        data-module-name="{{ module.name }}">
                    {% icon "pause-outline" %}
                    {% trans "Deactivate" %}
                </button>
                {% else %}
                <button class="btn btn-sm btn-soft color-success flex-1"
                        hx-post="{{ module.activate_url }}"
                        hx-target="#main-content-area"
                        hx-swap="innerHTML">
                    {% icon "play-outline" %}
                    {% trans "Activate" %}
                </button>
                {% endif %}
                <button class="btn btn-sm btn-ghost color-error"
                        data-action="module-delete"
                        data-url="{{ module.delete_url }}"
                        data-module-name="{{ module.name }}">
                    {% icon "trash-outline" %}
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>
