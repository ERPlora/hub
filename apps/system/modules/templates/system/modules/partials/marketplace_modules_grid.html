{% load i18n %}

{% if modules %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {% for module in modules %}
    <ion-card id="module-card-{{ module.slug }}" class="module-card m-0">
        <!-- Card Header with clickable link to detail -->
        <a href="{% url 'system:module_detail' module.slug %}"
           hx-get="{% url 'system:module_detail' module.slug %}"
           hx-target="#main-content"
           hx-swap="innerHTML"
           hx-push-url="true"
           class="no-underline text-inherit">
            <ion-card-header class="pb-2">
                <div class="flex items-start gap-3">
                    <!-- Module Icon -->
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center flex-shrink-0"
                         style="background: {{ module.category_color|default:'var(--ion-color-primary)' }};">
                        <ion-icon name="{{ module.icon|default:'cube-outline' }}" class="text-2xl text-white"></ion-icon>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                            <ion-card-title class="text-base truncate">{{ module.name }}</ion-card-title>
                            {% if module.is_featured %}
                            <ion-badge color="warning" class="text-xs">{% trans "Featured" %}</ion-badge>
                            {% endif %}
                        </div>
                        <ion-card-subtitle class="text-sm">
                            {% trans "by" %} {{ module.author|default:"ERPlora" }} • v{{ module.version }}
                        </ion-card-subtitle>
                    </div>
                    <!-- Status Badge -->
                    <div class="flex-shrink-0">
                        {% if module.is_installed %}
                        <ion-chip color="success" class="m-0 text-xs">
                            <ion-icon name="checkmark-circle-outline" class="mr-1"></ion-icon>
                            {% trans "Installed" %}
                        </ion-chip>
                        {% elif module.is_owned %}
                        <ion-chip color="tertiary" class="m-0 text-xs">
                            <ion-icon name="bag-check-outline" class="mr-1"></ion-icon>
                            {% trans "Owned" %}
                        </ion-chip>
                        {% endif %}
                    </div>
                </div>
            </ion-card-header>
            <ion-card-content class="pt-0">
                <p class="text-sm text-medium mb-3 line-clamp-2">{{ module.description }}</p>

                <!-- Stats Row -->
                <div class="flex items-center gap-4 text-xs text-medium mb-3">
                    {% if module.rating %}
                    <span class="flex items-center gap-1">
                        <ion-icon name="star" style="color: var(--ion-color-warning);"></ion-icon>
                        {{ module.rating|floatformat:1 }}
                    </span>
                    {% endif %}
                    {% if module.downloads %}
                    <span class="flex items-center gap-1">
                        <ion-icon name="download-outline"></ion-icon>
                        {{ module.downloads }}
                    </span>
                    {% endif %}
                    {% if module.category_name %}
                    <span class="flex items-center gap-1">
                        <ion-icon name="pricetag-outline"></ion-icon>
                        {{ module.category_name }}
                    </span>
                    {% endif %}
                </div>

                <!-- Price Display -->
                <div class="flex justify-between items-center">
                    <span class="font-semibold">
                        {% if module.is_free or module.module_type == 'free' %}
                        <span style="color: var(--ion-color-success);">{% trans "Free" %}</span>
                        {% elif module.module_type == 'subscription' %}
                        <span style="color: var(--ion-color-primary);">€{{ module.price }}/{% trans "mo" %}</span>
                        {% else %}
                        <span style="color: var(--ion-color-primary);">€{{ module.price }}</span>
                        {% endif %}
                    </span>
                </div>
            </ion-card-content>
        </a>

        <!-- Action Buttons -->
        <div class="flex border-t border-gray-200 dark:border-gray-700">
            {% if module.is_installed %}
            {# Already installed locally #}
            <ion-button fill="clear" size="small" color="medium" class="flex-1" disabled>
                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                {% trans "Installed" %}
            </ion-button>
            {% elif module.is_owned %}
            {# Owned (purchased or free) but not installed - show Download #}
            <ion-button
                fill="clear"
                size="small"
                color="success"
                class="flex-1"
                onclick="event.preventDefault(); event.stopPropagation(); downloadAndInstall('{{ module.slug }}', '{{ module.download_url }}', this)">
                <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                <ion-icon slot="start" name="download-outline" class="install-icon"></ion-icon>
                {% trans "Download" %}
            </ion-button>
            {% elif module.is_free or module.module_type == 'free' %}
            {# Free module not yet acquired - acquire and install #}
            <ion-button
                fill="clear"
                size="small"
                color="primary"
                class="flex-1"
                onclick="event.preventDefault(); event.stopPropagation(); installFreeModule('{{ module.id }}', '{{ module.slug }}', '{{ module.download_url|default:'' }}', this)">
                <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                <ion-icon slot="start" name="download-outline" class="install-icon"></ion-icon>
                {% trans "Get Free" %}
            </ion-button>
            {% else %}
            {# Paid module not owned - show Purchase #}
            <ion-button
                fill="clear"
                size="small"
                color="primary"
                class="flex-1"
                onclick="event.preventDefault(); event.stopPropagation(); purchaseModule('{{ module.id }}', this)">
                <ion-spinner name="crescent" class="install-spinner mr-2" style="display: none;"></ion-spinner>
                <ion-icon slot="start" name="cart-outline" class="install-icon"></ion-icon>
                {% trans "Purchase" %}
            </ion-button>
            {% endif %}

            <!-- View Details Button -->
            <ion-button
                fill="clear"
                size="small"
                color="medium"
                href="{% url 'system:module_detail' module.slug %}"
                hx-get="{% url 'system:module_detail' module.slug %}"
                hx-target="#main-content"
                hx-swap="innerHTML"
                hx-push-url="true">
                <ion-icon slot="icon-only" name="chevron-forward-outline"></ion-icon>
            </ion-button>
        </div>
    </ion-card>
    {% endfor %}
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="flex items-center justify-center gap-2 mt-8 flex-wrap">
    {% if page_obj.has_previous %}
    <ion-button
        fill="outline"
        size="small"
        hx-get="{% url 'system:marketplace_modules_list' %}?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
        hx-target="#marketplace-modules-grid"
        hx-swap="innerHTML"
        hx-indicator="#loading-spinner">
        <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
        {% trans "First" %}
    </ion-button>
    <ion-button
        fill="outline"
        size="small"
        hx-get="{% url 'system:marketplace_modules_list' %}?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
        hx-target="#marketplace-modules-grid"
        hx-swap="innerHTML"
        hx-indicator="#loading-spinner">
        <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
    </ion-button>
    {% endif %}

    <ion-text color="medium" class="px-4">
        {% trans "Page" %} {{ page_obj.number }} {% trans "of" %} {{ page_obj.paginator.num_pages }}
    </ion-text>

    {% if page_obj.has_next %}
    <ion-button
        fill="outline"
        size="small"
        hx-get="{% url 'system:marketplace_modules_list' %}?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
        hx-target="#marketplace-modules-grid"
        hx-swap="innerHTML"
        hx-indicator="#loading-spinner">
        <ion-icon name="chevron-forward-outline" slot="icon-only"></ion-icon>
    </ion-button>
    <ion-button
        fill="outline"
        size="small"
        hx-get="{% url 'system:marketplace_modules_list' %}?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}"
        hx-target="#marketplace-modules-grid"
        hx-swap="innerHTML"
        hx-indicator="#loading-spinner">
        {% trans "Last" %}
        <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
    </ion-button>
    {% endif %}
</div>
{% endif %}

{% else %}
<!-- Empty State -->
<ion-card>
    <ion-card-content class="text-center py-8">
        <ion-icon name="search-outline" class="text-6xl text-medium mb-4"></ion-icon>
        <h3 class="text-lg font-semibold mb-2">{% trans "No modules found" %}</h3>
        <p class="text-medium">{% trans "Try adjusting your search or filters" %}</p>
    </ion-card-content>
</ion-card>
{% endif %}

<style>
.module-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.module-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.no-underline {
    text-decoration: none;
}
.text-inherit {
    color: inherit;
}
</style>
