{% extends "base.html" %}
{% load static i18n ui %}
{#
    UI Base Template - Base para todas las páginas del dashboard

    Este template provee:
    - Estructura ion-app con split-pane
    - Sidebar con navegación
    - Header con controles
    - Área de contenido principal
    - Contenedor para tabbar (vacío por defecto)
    - Alpine.js dashboard app
    - Dynamic Tab Bar Manager

    Templates que extienden este:
    - ui/base_module.html - Para módulos (con tabbar)
    - ui/base_dashboard.html - Para páginas principales (sin tabbar)
#}

{% block title %}{% block page_title %}Dashboard{% endblock %} - ERPlora Hub{% endblock %}

{% block extra_css %}
{% block section_css %}{% endblock %}
{% endblock %}

{% block content %}
<!-- HTMX Loading Indicator -->
<div id="htmx-indicator"></div>

<ion-app id="dashboard-app" x-data="dashboardApp()" x-init="init()" :class="isDark ? 'dark' : ''">
    <ion-split-pane id="dashboard-split-pane" content-id="main-content">
        <!-- Sidebar Menu -->
        <ion-menu id="dashboard-sidebar" content-id="main-content" menu-id="main-menu" type="push">
            {% include "ui/partials/sidebar.html" %}
        </ion-menu>

        <!-- Main Content Area -->
        <div class="ion-page section-tabs" id="main-content">
            <!-- Global Header -->
            <div id="dashboard-header">
                {% include "ui/partials/app_header.html" %}
            </div>

            <!-- Content (SPA target) -->
            <ion-content id="main-content-area" class="ion-padding">
                {% block dashboard_content %}
                <!-- Page content loaded here via HTMX -->
                {% endblock %}
            </ion-content>

            <!-- Tab Bar (ion-footer must be direct child of ion-page) -->
            <!-- Default empty tabbar - will be replaced via OOB swap by modules -->
            {% block section_tabbar %}
            <ion-footer id="dashboard-tabbar" style="display: none;"></ion-footer>
            {% endblock %}
        </div>
    </ion-split-pane>

    <!-- Action Sheet (reusable) -->
    <ion-action-sheet class="custom-action-sheet"></ion-action-sheet>
</ion-app>
{% endblock %}

{% block scripts %}
<script>
    function dashboardApp() {
        return {
            isDark: window.ERPlora?.isDark || false,
            darkModeAuto: window.ERPlora?.darkModeAuto ?? true,
            isFullscreen: false,
            currentSection: '{{ current_section|default:"dashboard" }}',
            userName: '{{ request.session.user_name|default:"" }}',
            userEmail: '{{ request.session.user_email|default:"" }}',
            userRole: '{{ request.session.user_role|default:"" }}',
            canInstall: false,

            init() {
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');

                document.body.addEventListener('htmx:pushedIntoHistory', (e) => {
                    this.updateCurrentSection(e.detail.path);
                });

                window.addEventListener('popstate', () => {
                    this.updateCurrentSection(window.location.pathname);
                });

                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                });

                this.canInstall = typeof canInstallPWA === 'function' && canInstallPWA();

                document.addEventListener('pwa-installable', () => {
                    this.canInstall = true;
                });

                document.addEventListener('pwa-installed', () => {
                    this.canInstall = false;
                    this.showToast('{% trans "App installed successfully!" %}', 'success');
                });
            },

            updateCurrentSection(path) {
                if (path.includes('/settings')) this.currentSection = 'settings';
                else if (path.includes('/modules') || path.includes('/marketplace')) this.currentSection = 'modules';
                else if (path.includes('/employees')) this.currentSection = 'employees';
                else this.currentSection = 'dashboard';

                this.updateTabBar();
            },

            updateTabBar() {
                document.querySelectorAll('ion-tab-button').forEach(btn => {
                    const href = btn.getAttribute('hx-get') || btn.getAttribute('href');
                    if (href && window.location.pathname.startsWith(href)) {
                        btn.classList.add('tab-selected');
                    } else {
                        btn.classList.remove('tab-selected');
                    }
                });
            },

            toggleMenu() {
                const menu = document.querySelector('ion-menu[menu-id="main-menu"]');
                if (menu) menu.toggle();
            },

            async toggleTheme() {
                this.isDark = !this.isDark;
                document.body.classList.toggle('dark');

                document.dispatchEvent(new CustomEvent('theme-changed', {
                    detail: { isDark: this.isDark }
                }));

                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Error saving dark mode:', error);
                }
            },

            toggleFullscreen() {
                if (window.pywebview && window.pywebview.api) {
                    window.pywebview.api.toggle_fullscreen().then(response => {
                        this.isFullscreen = response.fullscreen;
                    });
                } else {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                        this.isFullscreen = true;
                    } else {
                        document.exitFullscreen();
                        this.isFullscreen = false;
                    }
                }
            },

            async installApp() {
                if (typeof installPWA === 'function') {
                    const installed = await installPWA();
                    if (installed) {
                        this.canInstall = false;
                    }
                }
            },

            async showToast(message, color = 'primary') {
                const toast = document.createElement('ion-toast');
                toast.message = message;
                toast.duration = 2000;
                toast.position = 'bottom';
                toast.color = color;
                document.body.appendChild(toast);
                await toast.present();
            },

            async handleUserMenu() {
                const actionSheet = document.querySelector('ion-action-sheet');
                actionSheet.header = this.userName;
                actionSheet.subHeader = this.userEmail;
                actionSheet.buttons = [
                    {
                        text: '{% trans "Settings" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:settings" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:settings" %}');
                            this.currentSection = 'settings';
                        }
                    },
                    {
                        text: '{% trans "Employees" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:employees" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:employees" %}');
                            this.currentSection = 'employees';
                        }
                    },
                    {
                        text: '{% trans "Sign Out" %}',
                        role: 'destructive',
                        handler: () => {
                            window.location.href = '{% url "auth:logout" %}';
                        }
                    },
                    {
                        text: '{% trans "Cancel" %}',
                        role: 'cancel'
                    }
                ];

                await actionSheet.present();
            },

            navigateTo(url) {
                htmx.ajax('GET', url, {
                    target: '#main-content-area',
                    swap: 'innerHTML'
                });
                history.pushState({}, '', url);
                this.updateCurrentSection(url);
            }
        }
    }
</script>

{% include "ui/_tabbar_manager.html" %}

{% block section_scripts %}{% endblock %}
{% endblock %}
