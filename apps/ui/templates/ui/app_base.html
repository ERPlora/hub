{% extends "base.html" %}
{% load static i18n ui %}
{#
    UI Base Template - Base para todas las páginas del dashboard

    Este template provee:
    - Estructura ion-app con ion-menu
    - Sidebar con navegación
    - Global header (siempre visible)
    - Área de contenido principal (#main-content-area) dentro de ion-content
    - Alpine.js dashboard app

    Estructura:
    ion-app
    ├── ion-menu (sidebar)
    └── div.ion-page#main-content
        ├── ion-header (GLOBAL - "ERPlora", hamburger, theme, user)
        └── ion-content#main-content-area (HTMX target)
            └── [partial content: page-header + page-content + tabbar]

    Los partials NO generan ion-page porque están dentro de ion-content.
    El tabbar se renderiza inline dentro del partial.

    Templates que extienden este:
    - ui/base_module.html - Para módulos (con tabbar)
    - ui/base_dashboard.html - Para páginas principales (sin tabbar)
#}

{% block title %}{% block page_title %}Dashboard{% endblock %} - ERPlora Hub{% endblock %}

{% block extra_css %}
{% block section_css %}{% endblock %}
{% endblock %}

{% block content %}
<!-- Global tabbar update function - must be defined before page_content executes -->
<script>
    /**
     * Global function to update the tabbar via JavaScript
     * Called by the tabbar component in page_content
     * @param {Array} tabs - Array of tab objects with url, icon, label, active
     */
    function updateGlobalTabBar(tabs) {
        const tabBar = document.getElementById('global-tabbar');
        if (!tabBar) return;

        const footer = tabBar.closest('ion-footer');

        if (!tabs || tabs.length === 0) {
            tabBar.innerHTML = '';
            if (footer) footer.style.display = 'none';
            return;
        }

        const html = tabs.map(tab => `
            <ion-tab-button
                hx-get="${tab.url}"
                hx-target="#main-content-area"
                hx-push-url="true"
                class="${tab.active ? 'tab-selected' : ''}">
                <ion-icon name="${tab.icon}"></ion-icon>
                <ion-label>${tab.label}</ion-label>
            </ion-tab-button>
        `).join('');

        tabBar.innerHTML = html;

        if (footer) footer.style.display = '';
        tabBar.removeAttribute('hidden');

        if (typeof htmx !== 'undefined') {
            htmx.process(tabBar);
        }
    }
    window.updateGlobalTabBar = updateGlobalTabBar;
</script>

<!-- HTMX Loading Indicator -->
<div id="htmx-indicator"></div>

<ion-app id="dashboard-app" x-data="dashboardApp()" x-init="init()" :class="isDark ? 'dark' : ''">
    <!-- Sidebar Menu -->
    <ion-menu content-id="main-content" menu-id="main-menu" type="reveal">
        {% include "ui/partials/sidebar.html" %}
    </ion-menu>

    <!-- Main Content -->
    <div class="ion-page" id="main-content">
        <!-- Global Header -->
        <ion-header>
            <ion-toolbar>
                <ion-buttons slot="start">
                    <ion-menu-button></ion-menu-button>
                </ion-buttons>
                <ion-title>ERPlora</ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="toggleTheme()">
                        <ion-icon :name="isDark ? 'sunny-outline' : 'moon-outline'" slot="icon-only"></ion-icon>
                    </ion-button>
                    <ion-button @click="handleUserMenu()">
                        <ion-icon name="person-circle-outline" slot="icon-only"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <!-- Page Content (HTMX target) -->
        <!-- Cada partial genera: content-header + page-content (sin tabbar) -->
        <div id="main-content-area" class="ion-padding">
            {% block page_content %}{% endblock %}
        </div>
        <!-- Global Tabbar (updated via JavaScript) -->
        <ion-footer style="display: none;">
            <ion-tab-bar id="global-tabbar">
                {# Initially hidden, shown via updateGlobalTabBar() when module has tabs #}
            </ion-tab-bar>
        </ion-footer>
    </div>

    <!-- Action Sheet (reusable) -->
    <ion-action-sheet class="custom-action-sheet"></ion-action-sheet>
</ion-app>
{% endblock %}

{% block scripts %}
<script>
    function dashboardApp() {
        return {
            isDark: window.ERPlora?.isDark || false,
            darkModeAuto: window.ERPlora?.darkModeAuto ?? true,
            isFullscreen: false,
            currentSection: '{{ current_section|default:"dashboard" }}',
            userName: '{{ request.session.user_name|default:"" }}',
            userEmail: '{{ request.session.user_email|default:"" }}',
            userRole: '{{ request.session.user_role|default:"" }}',
            canInstall: false,

            init() {
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');

                document.body.addEventListener('htmx:pushedIntoHistory', (e) => {
                    this.updateCurrentSection(e.detail.path);
                });

                window.addEventListener('popstate', () => {
                    this.updateCurrentSection(window.location.pathname);
                });

                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                });

                this.canInstall = typeof canInstallPWA === 'function' && canInstallPWA();

                document.addEventListener('pwa-installable', () => {
                    this.canInstall = true;
                });

                document.addEventListener('pwa-installed', () => {
                    this.canInstall = false;
                    this.showToast('{% trans "App installed successfully!" %}', 'success');
                });
            },

            updateCurrentSection(path) {
                if (path.includes('/settings')) this.currentSection = 'settings';
                else if (path.includes('/modules') || path.includes('/marketplace')) this.currentSection = 'modules';
                else if (path.includes('/employees')) this.currentSection = 'employees';
                else this.currentSection = 'dashboard';

                this.updateTabBar();
            },

            updateTabBar() {
                document.querySelectorAll('ion-tab-button').forEach(btn => {
                    const href = btn.getAttribute('hx-get') || btn.getAttribute('href');
                    if (href && window.location.pathname.startsWith(href)) {
                        btn.classList.add('tab-selected');
                    } else {
                        btn.classList.remove('tab-selected');
                    }
                });
            },

            async toggleSidebar() {
                const menu = document.querySelector('ion-menu');
                if (menu) {
                    await menu.toggle();
                }
            },

            async toggleTheme() {
                this.isDark = !this.isDark;
                document.body.classList.toggle('dark');

                document.dispatchEvent(new CustomEvent('theme-changed', {
                    detail: { isDark: this.isDark }
                }));

                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Error saving dark mode:', error);
                }
            },

            toggleFullscreen() {
                if (window.pywebview && window.pywebview.api) {
                    window.pywebview.api.toggle_fullscreen().then(response => {
                        this.isFullscreen = response.fullscreen;
                    });
                } else {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                        this.isFullscreen = true;
                    } else {
                        document.exitFullscreen();
                        this.isFullscreen = false;
                    }
                }
            },

            async installApp() {
                if (typeof installPWA === 'function') {
                    const installed = await installPWA();
                    if (installed) {
                        this.canInstall = false;
                    }
                }
            },

            async showToast(message, color = 'primary') {
                const toast = document.createElement('ion-toast');
                toast.message = message;
                toast.duration = 2000;
                toast.position = 'bottom';
                toast.color = color;
                document.body.appendChild(toast);
                await toast.present();
            },

            async handleUserMenu() {
                const actionSheet = document.querySelector('ion-action-sheet');
                actionSheet.header = this.userName;
                actionSheet.subHeader = this.userEmail;
                actionSheet.buttons = [
                    {
                        text: '{% trans "Settings" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:settings" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:settings" %}');
                            this.currentSection = 'settings';
                        }
                    },
                    {
                        text: '{% trans "Employees" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:employees" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:employees" %}');
                            this.currentSection = 'employees';
                        }
                    },
                    {
                        text: '{% trans "Sign Out" %}',
                        role: 'destructive',
                        handler: () => {
                            window.location.href = '{% url "auth:logout" %}';
                        }
                    },
                    {
                        text: '{% trans "Cancel" %}',
                        role: 'cancel'
                    }
                ];

                await actionSheet.present();
            },

            navigateTo(url) {
                htmx.ajax('GET', url, {
                    target: '#main-content-area',
                    swap: 'innerHTML'
                });
                history.pushState({}, '', url);
                this.updateCurrentSection(url);
            }
        }
    }

</script>

{% block section_scripts %}{% endblock %}
{% endblock %}
