{% extends "app.html" %}
{% load static i18n ui djicons %}
{#
    UI Base Template - Base para todas las páginas del dashboard

    Este template provee:
    - Estructura ux-shell con sidebar
    - Sidebar con navegación (incluye backdrop para mobile)
    - Área de contenido principal con scroll
    - Alpine.js store para estado del sidebar

    Estructura:
    ux-shell ux-shell--sidebar
    ├── ux-shell__sidebar (menu lateral)
    │   └── include sidebar.html
    └── ux-shell__main
        └── ux-content (área principal con scroll)
            └── block main_content

    Templates que extienden este:
    - ui/base_module.html - Para módulos (con tabbar)
    - ui/base_dashboard.html - Para páginas principales (sin tabbar)
#}

{% block title %}{% block page_title %}Dashboard{% endblock %} - ERPlora Hub{% endblock %}

{% block extra_css %}
{% block section_css %}{% endblock %}
{% endblock %}

{% block app_content %}
<!-- Alpine.js Store for Sidebar -->
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('sidebar', {
            open: false,
            toggle() { this.open = !this.open; },
            close() { this.open = false; }
        });
    });
</script>

<!-- HTMX Loading Indicator -->
<div id="htmx-indicator"></div>

<div class="ux-shell ux-shell--sidebar" x-data>
    <!-- Sidebar Backdrop (mobile) -->
    <div
        class="ux-shell__backdrop"
        x-show="$store.sidebar.open"
        x-transition:enter="ux-transition-fade"
        x-transition:leave="ux-transition-fade"
        @click="$store.sidebar.close()"
        x-cloak
    ></div>

    <!-- Sidebar -->
    <aside
        class="ux-shell__sidebar"
        :data-state="$store.sidebar.open ? 'open' : 'closed'"
    >
        {% block sidebar %}
        {% include "ui/partials/sidebar.html" %}
        {% endblock %}
    </aside>

    <!-- Main Content Area -->
    <main class="ux-shell__main">
        {% block main_header %}{% endblock %}

        <div class="ux-content" id="main-content-area">
            {% block main_content %}
            {% block page_content %}{% endblock %}
            {% endblock %}
        </div>

        {% block main_footer %}{% endblock %}
    </main>
</div>
{% endblock %}

{% block app_scripts %}
<script>
    // Dashboard functionality
    (function() {
        const dashboard = {
            isDark: window.ERPlora?.isDark || false,
            darkModeAuto: window.ERPlora?.darkModeAuto ?? true,
            currentSection: '{{ current_section|default:"dashboard" }}',
            userName: '{{ request.session.user_name|default:"" }}',
            userEmail: '{{ request.session.user_email|default:"" }}',
            userRole: '{{ request.session.user_role|default:"" }}',

            init() {
                // HTMX navigation tracking
                document.body.addEventListener('htmx:pushedIntoHistory', (e) => {
                    this.updateCurrentSection(e.detail.path);
                });

                window.addEventListener('popstate', () => {
                    this.updateCurrentSection(window.location.pathname);
                });

                // Close sidebar on HTMX navigation (mobile)
                document.body.addEventListener('htmx:afterSwap', () => {
                    if (window.Alpine && Alpine.store('sidebar')) {
                        Alpine.store('sidebar').close();
                    }
                });
            },

            updateCurrentSection(path) {
                if (path.includes('/settings')) this.currentSection = 'settings';
                else if (path.includes('/modules') || path.includes('/marketplace')) this.currentSection = 'modules';
                else if (path.includes('/employees')) this.currentSection = 'employees';
                else this.currentSection = 'dashboard';
            },

            async toggleTheme() {
                this.isDark = !this.isDark;
                document.documentElement.classList.toggle('ux-dark', this.isDark);

                document.dispatchEvent(new CustomEvent('theme-changed', {
                    detail: { isDark: this.isDark }
                }));

                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Error saving dark mode:', error);
                }
            },

            navigateTo(url) {
                htmx.ajax('GET', url, {
                    target: '#main-content-area',
                    swap: 'innerHTML'
                });
                history.pushState({}, '', url);
                this.updateCurrentSection(url);
            }
        };

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => dashboard.init());
        } else {
            dashboard.init();
        }

        // Expose for global access if needed
        window.ERPloraDashboard = dashboard;
    })();
</script>

{% block section_scripts %}{% endblock %}
{% endblock %}
