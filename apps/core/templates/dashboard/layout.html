{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% block page_title %}Dashboard{% endblock %} - ERPlora Hub{% endblock %}

{% block extra_css %}
{% block section_css %}{% endblock %}
{% endblock %}

{% block content %}
<!-- HTMX Loading Indicator -->
<div id="htmx-indicator"></div>

<ion-app id="dashboard-app" x-data="dashboardApp()" x-init="init()" :class="isDark ? 'dark' : ''">
    <ion-split-pane id="dashboard-split-pane" content-id="main-content">
        <!-- Sidebar Menu -->
        <ion-menu id="dashboard-sidebar" content-id="main-content" menu-id="main-menu" type="push">
            {% include "dashboard/partials/sidebar.html" %}
        </ion-menu>

        <!-- Main Content Area -->
        <div class="ion-page section-tabs" id="main-content">
            <!-- Header -->
            <div id="dashboard-header">
                {% include "dashboard/partials/header.html" %}
            </div>

            <!-- Content (SPA target) -->
            <ion-content id="main-content-area" class="ion-padding">
                {% block dashboard_content %}
                <!-- Page content loaded here via HTMX -->
                {% endblock %}
            </ion-content>

            <!-- Tab Bar (outside ion-content for proper Ionic structure) -->
            <div id="dashboard-tabbar">
                {% block section_tabbar %}
                {% include "dashboard/partials/tabbar.html" %}
                {% endblock %}
            </div>
        </div>
    </ion-split-pane>

    <!-- Action Sheet (reusable) -->
    <ion-action-sheet class="custom-action-sheet"></ion-action-sheet>
</ion-app>
{% endblock %}

{% block scripts %}
<script>
    function dashboardApp() {
        return {
            isDark: window.ERPlora?.isDark || false,
            darkModeAuto: window.ERPlora?.darkModeAuto ?? true,
            isFullscreen: false,
            currentSection: '{{ current_section|default:"dashboard" }}',
            userName: '{{ request.session.user_name|default:"" }}',
            userEmail: '{{ request.session.user_email|default:"" }}',
            userRole: '{{ request.session.user_role|default:"" }}',
            canInstall: false,

            init() {
                // Dark mode is already applied by base.html
                // Sync localStorage for consistency
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');

                // Listen to HTMX URL changes for SPA navigation
                document.body.addEventListener('htmx:pushedIntoHistory', (e) => {
                    this.updateCurrentSection(e.detail.path);
                });

                // Listen to popstate for back/forward navigation
                window.addEventListener('popstate', () => {
                    this.updateCurrentSection(window.location.pathname);
                });

                // Listen to fullscreen changes
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                });

                // PWA Install - check if installable
                this.canInstall = typeof canInstallPWA === 'function' && canInstallPWA();

                // Listen for PWA installable event
                document.addEventListener('pwa-installable', () => {
                    this.canInstall = true;
                });

                // Listen for PWA installed event
                document.addEventListener('pwa-installed', () => {
                    this.canInstall = false;
                    this.showToast('{% trans "App installed successfully!" %}', 'success');
                });
            },

            updateCurrentSection(path) {
                if (path.includes('/settings')) this.currentSection = 'settings';
                else if (path.includes('/modules') || path.includes('/marketplace')) this.currentSection = 'modules';
                else if (path.includes('/employees')) this.currentSection = 'employees';
                else this.currentSection = 'dashboard';

                // Update tab bar active state
                this.updateTabBar();
            },

            updateTabBar() {
                document.querySelectorAll('ion-tab-button').forEach(btn => {
                    const href = btn.getAttribute('hx-get') || btn.getAttribute('href');
                    if (href && window.location.pathname.startsWith(href)) {
                        btn.classList.add('tab-selected');
                    } else {
                        btn.classList.remove('tab-selected');
                    }
                });
            },

            toggleMenu() {
                const menu = document.querySelector('ion-menu[menu-id="main-menu"]');
                if (menu) menu.toggle();
            },

            async toggleTheme() {
                this.isDark = !this.isDark;
                document.body.classList.toggle('dark');

                // Dispatch event for child components
                document.dispatchEvent(new CustomEvent('theme-changed', {
                    detail: { isDark: this.isDark }
                }));

                // Save to database
                try {
                    const formData = new FormData();
                    formData.append('action', 'update_theme');
                    formData.append('dark_mode', this.isDark);
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    await fetch('{% url "main:settings" %}', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Error saving dark mode:', error);
                }
            },

            toggleFullscreen() {
                if (window.pywebview && window.pywebview.api) {
                    // PyWebView (Desktop Hub)
                    window.pywebview.api.toggle_fullscreen().then(response => {
                        this.isFullscreen = response.fullscreen;
                    });
                } else {
                    // Browser fallback
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen();
                        this.isFullscreen = true;
                    } else {
                        document.exitFullscreen();
                        this.isFullscreen = false;
                    }
                }
            },

            async installApp() {
                if (typeof installPWA === 'function') {
                    const installed = await installPWA();
                    if (installed) {
                        this.canInstall = false;
                    }
                }
            },

            async showToast(message, color = 'primary') {
                const toast = document.createElement('ion-toast');
                toast.message = message;
                toast.duration = 2000;
                toast.position = 'bottom';
                toast.color = color;
                document.body.appendChild(toast);
                await toast.present();
            },

            async handleUserMenu() {
                const actionSheet = document.querySelector('ion-action-sheet');
                actionSheet.header = this.userName;
                actionSheet.subHeader = this.userEmail;
                actionSheet.buttons = [
                    {
                        text: '{% trans "Settings" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:settings" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:settings" %}');
                            this.currentSection = 'settings';
                        }
                    },
                    {
                        text: '{% trans "Employees" %}',
                        handler: () => {
                            htmx.ajax('GET', '{% url "main:employees" %}', {
                                target: '#main-content-area',
                                swap: 'innerHTML'
                            });
                            history.pushState({}, '', '{% url "main:employees" %}');
                            this.currentSection = 'employees';
                        }
                    },
                    {
                        text: '{% trans "Sign Out" %}',
                        role: 'destructive',
                        handler: () => {
                            window.location.href = '{% url "auth:logout" %}';
                        }
                    },
                    {
                        text: '{% trans "Cancel" %}',
                        role: 'cancel'
                    }
                ];

                await actionSheet.present();
            },

            // SPA Navigation helper
            navigateTo(url) {
                htmx.ajax('GET', url, {
                    target: '#main-content-area',
                    swap: 'innerHTML'
                });
                history.pushState({}, '', url);
                this.updateCurrentSection(url);
            }
        }
    }
</script>

<!-- Dynamic Tab Bar Manager -->
<script>
    if (typeof DynamicTabBar === 'undefined') {
    class DynamicTabBar {
        constructor() {
            this.TAB_MIN_WIDTH = 72;
            this.moreModalOpen = false;
            this.hiddenTabs = [];
            this.init();
        }

        init() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.setup());
            } else {
                setTimeout(() => this.setup(), 100);
            }
        }

        setup() {
            const tabBar = document.querySelector('ion-tab-bar');
            if (!tabBar) return;

            this.tabBar = tabBar;
            this.originalTabs = Array.from(tabBar.querySelectorAll('ion-tab-button:not(.tab-more)'));

            // Make HTMX tabs work
            this.originalTabs.forEach(tab => {
                if (!tab.hasAttribute('hx-get')) return;

                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            if (this.originalTabs.length <= 3) return;

            this.createMoreButton();
            this.calculateWithRetry();

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => this.calculateVisibleTabs(), 100);
            });
        }

        createMoreButton() {
            if (this.tabBar.querySelector('.tab-more')) return;

            this.moreButton = document.createElement('ion-tab-button');
            this.moreButton.className = 'tab-more tab-hidden';
            this.moreButton.innerHTML = `
                <ion-icon name="ellipsis-horizontal-outline"></ion-icon>
                <ion-label>{% trans "More" %}</ion-label>
            `;
            this.moreButton.addEventListener('click', (e) => {
                e.preventDefault();
                this.showMoreModal();
            });
            this.tabBar.appendChild(this.moreButton);
        }

        calculateWithRetry(attempts = 0) {
            const availableWidth = this.tabBar.offsetWidth;
            if (availableWidth === 0 && attempts < 5) {
                setTimeout(() => this.calculateWithRetry(attempts + 1), 100);
                return;
            }
            this.calculateVisibleTabs();
        }

        calculateVisibleTabs() {
            const availableWidth = this.tabBar.offsetWidth;
            const totalTabs = this.originalTabs.length;

            if (availableWidth < 100) {
                this.originalTabs.forEach(tab => tab.classList.remove('tab-hidden'));
                if (this.moreButton) this.moreButton.classList.add('tab-hidden');
                this.hiddenTabs = [];
                return;
            }

            const maxVisibleTabs = Math.floor(availableWidth / this.TAB_MIN_WIDTH);

            if (maxVisibleTabs >= totalTabs) {
                this.originalTabs.forEach(tab => tab.classList.remove('tab-hidden'));
                this.moreButton.classList.add('tab-hidden');
                this.hiddenTabs = [];
                return;
            }

            const visibleCount = Math.max(1, maxVisibleTabs - 1);
            this.hiddenTabs = [];

            this.originalTabs.forEach((tab, index) => {
                if (index < visibleCount) {
                    tab.classList.remove('tab-hidden');
                } else {
                    tab.classList.add('tab-hidden');
                    this.hiddenTabs.push({
                        href: tab.getAttribute('hx-get') || tab.getAttribute('href'),
                        icon: tab.querySelector('ion-icon')?.getAttribute('name') || 'ellipse',
                        label: tab.querySelector('ion-label')?.textContent?.trim() || '',
                        isActive: tab.classList.contains('tab-selected')
                    });
                }
            });

            this.moreButton.classList.remove('tab-hidden');
            const hasActiveHidden = this.hiddenTabs.some(t => t.isActive);
            this.moreButton.classList.toggle('has-active', hasActiveHidden);
            this.moreButton.classList.toggle('tab-selected', hasActiveHidden);
        }

        async showMoreModal() {
            if (this.moreModalOpen || this.hiddenTabs.length === 0) return;
            this.moreModalOpen = true;

            const modal = document.createElement('ion-modal');
            modal.initialBreakpoint = 0.5;
            modal.breakpoints = [0, 0.5, 0.75, 1];
            modal.handleBehavior = 'cycle';
            modal.showBackdrop = true;
            modal.backdropDismiss = true;

            modal.innerHTML = `
                <ion-header>
                    <ion-toolbar>
                        <ion-title>{% trans "More Options" %}</ion-title>
                        <ion-buttons slot="end">
                            <ion-button id="close-more-modal">
                                <ion-icon name="close"></ion-icon>
                            </ion-button>
                        </ion-buttons>
                    </ion-toolbar>
                </ion-header>
                <ion-content class="ion-padding">
                    <div class="more-tabs-grid">
                        ${this.hiddenTabs.map(tab => `
                            <div class="more-tab-item ${tab.isActive ? 'active' : ''}"
                                 hx-get="${tab.href}"
                                 hx-target="#main-content-area"
                                 hx-push-url="true"
                                 onclick="this.closest('ion-modal').dismiss()">
                                <div class="more-tab-icon">
                                    <ion-icon name="${tab.icon}"></ion-icon>
                                </div>
                                <span class="more-tab-label">${tab.label}</span>
                            </div>
                        `).join('')}
                    </div>
                </ion-content>
            `;

            document.body.appendChild(modal);

            modal.querySelector('#close-more-modal').addEventListener('click', () => {
                modal.dismiss();
            });

            modal.addEventListener('didDismiss', () => {
                this.moreModalOpen = false;
                modal.remove();
            });

            await modal.present();
            htmx.process(modal);
        }
    }

    window.DynamicTabBar = DynamicTabBar;
    }

    // Only create new instance if not already exists
    if (!window._dynamicTabBarInstance) {
        window._dynamicTabBarInstance = new DynamicTabBar();
    }
</script>
{% block section_scripts %}{% endblock %}
{% endblock %}
