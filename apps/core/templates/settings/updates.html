{% extends "base.html" %}

{% block title %}Actualizaciones - ERPlora Hub{% endblock %}

{% block content %}
<div x-data="updatesPage()" x-init="init()">
    <ion-header>
        <ion-toolbar>
            <ion-buttons slot="start">
                <ion-back-button default-href="/settings"></ion-back-button>
            </ion-buttons>
            <ion-title>Actualizaciones</ion-title>
            <ion-buttons slot="end">
                <ion-button @click="checkForUpdates()" :disabled="checking">
                    <ion-icon :name="checking ? 'sync-outline' : 'refresh-outline'"></ion-icon>
                </ion-button>
            </ion-buttons>
        </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">

        <!-- Current Version Info -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>Versi√≥n Actual</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <ion-icon name="information-circle-outline" style="font-size: 48px; color: var(--ion-color-primary);"></ion-icon>
                    <div>
                        <h2 style="margin: 0; font-size: 24px;" x-text="currentVersion"></h2>
                        <p style="margin: 4px 0 0 0; color: var(--ion-color-medium);" x-text="'Sistema: ' + os"></p>
                        <p style="margin: 4px 0 0 0; color: var(--ion-color-medium);" x-text="lastCheck ? '√öltima verificaci√≥n: ' + formatDate(lastCheck) : 'No verificado'"></p>
                    </div>
                </div>

                <template x-if="!updateAvailable">
                    <ion-chip color="success">
                        <ion-icon name="checkmark-circle"></ion-icon>
                        <ion-label>Actualizado</ion-label>
                    </ion-chip>
                </template>
            </ion-card-content>
        </ion-card>

        <!-- Update Available Card -->
        <template x-if="updateAvailable">
            <ion-card color="primary">
                <ion-card-header>
                    <ion-card-title>üéâ Actualizaci√≥n Disponible</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                    <div style="margin-bottom: 16px;">
                        <h3 x-text="'Versi√≥n ' + latestVersion"></h3>
                        <ion-chip :color="updateTypeColor">
                            <ion-label x-text="'Actualizaci√≥n ' + updateType"></ion-label>
                        </ion-chip>
                    </div>

                    <!-- Release Notes -->
                    <template x-if="releaseNotes">
                        <div style="margin: 16px 0;">
                            <h4>Novedades:</h4>
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <pre style="white-space: pre-wrap; margin: 0; font-size: 14px;" x-text="releaseNotes"></pre>
                            </div>
                        </div>
                    </template>

                    <!-- Update Progress -->
                    <template x-if="updateStatus !== 'available'">
                        <div style="margin: 16px 0;">
                            <ion-progress-bar :value="progressValue" :type="progressType"></ion-progress-bar>
                            <p style="margin-top: 8px; text-align: center;" x-text="statusMessage"></p>
                        </div>
                    </template>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <template x-if="updateStatus === 'available'">
                            <ion-button expand="block" @click="downloadUpdate()">
                                <ion-icon slot="start" name="cloud-download-outline"></ion-icon>
                                Descargar Actualizaci√≥n
                            </ion-button>
                        </template>

                        <template x-if="updateStatus === 'downloaded'">
                            <ion-button expand="block" color="success" @click="installUpdate()">
                                <ion-icon slot="start" name="download-outline"></ion-icon>
                                Instalar Ahora
                            </ion-button>
                        </template>

                        <template x-if="updateStatus === 'ready'">
                            <ion-button expand="block" color="success" @click="confirmApplyUpdate()">
                                <ion-icon slot="start" name="refresh-outline"></ion-icon>
                                Aplicar y Reiniciar
                            </ion-button>
                        </template>
                    </div>

                    <template x-if="downloadedFilePath">
                        <p style="margin-top: 8px; font-size: 12px; color: var(--ion-color-medium);">
                            Tama√±o: <span x-text="fileSizeMB + ' MB'"></span>
                        </p>
                    </template>
                </ion-card-content>
            </ion-card>
        </template>

        <!-- Update Settings -->
        <ion-card>
            <ion-card-header>
                <ion-card-title>Configuraci√≥n de Actualizaciones</ion-card-title>
            </ion-card-header>
            <ion-card-content>
                <ion-list>
                    <ion-item>
                        <ion-label>
                            <h2>Verificar autom√°ticamente</h2>
                            <p>Buscar actualizaciones al iniciar</p>
                        </ion-label>
                        <ion-toggle slot="end" checked></ion-toggle>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h2>Notificar actualizaciones</h2>
                            <p>Mostrar banner cuando hay nueva versi√≥n</p>
                        </ion-label>
                        <ion-toggle slot="end" checked></ion-toggle>
                    </ion-item>

                    <ion-item>
                        <ion-label>
                            <h2>Tipo de actualizaciones</h2>
                            <p>Incluir versiones beta</p>
                        </ion-label>
                        <ion-toggle slot="end"></ion-toggle>
                    </ion-item>
                </ion-list>
            </ion-card-content>
        </ion-card>

        <!-- Backups List -->
        <template x-if="backups.length > 0">
            <ion-card>
                <ion-card-header>
                    <ion-card-title>Backups Disponibles</ion-card-title>
                    <ion-card-subtitle>Puedes restaurar una copia de seguridad anterior</ion-card-subtitle>
                </ion-card-header>
                <ion-card-content>
                    <ion-list>
                        <template x-for="backup in backups" :key="backup.path">
                            <ion-item>
                                <ion-icon name="folder-outline" slot="start"></ion-icon>
                                <ion-label>
                                    <h2 x-text="backup.name"></h2>
                                    <p x-text="'Versi√≥n: ' + backup.version + ' - ' + formatDate(backup.created_at)"></p>
                                </ion-label>
                                <ion-button fill="clear" slot="end" @click="confirmRollback(backup.path)">
                                    Restaurar
                                </ion-button>
                            </ion-item>
                        </template>
                    </ion-list>
                </ion-card-content>
            </ion-card>
        </template>

    </ion-content>
</div>
{% endblock %}

{% block scripts %}
<script>
function updatesPage() {
    return {
        // Current state
        currentVersion: '{{ current_version|default:"0.0.0" }}',
        os: '{{ os|default:"unknown" }}',
        lastCheck: null,

        // Update info
        updateAvailable: false,
        latestVersion: null,
        updateType: null,
        releaseNotes: null,
        downloadUrl: null,
        fileSizeMB: null,

        // Update process
        updateStatus: 'available',  // available, downloading, downloaded, installing, ready
        checking: false,
        downloadedFilePath: null,
        backupPath: null,

        // Backups
        backups: [],

        get updateTypeColor() {
            switch(this.updateType) {
                case 'major': return 'danger';
                case 'minor': return 'warning';
                case 'patch': return 'success';
                default: return 'medium';
            }
        },

        get statusMessage() {
            switch(this.updateStatus) {
                case 'downloading': return 'Descargando actualizaci√≥n...';
                case 'installing': return 'Preparando instalaci√≥n...';
                case 'ready': return '‚úÖ Lista para aplicar';
                default: return '';
            }
        },

        get progressValue() {
            return this.updateStatus === 'ready' ? 1 : undefined;
        },

        get progressType() {
            return this.updateStatus === 'ready' ? 'determinate' : 'indeterminate';
        },

        init() {
            this.loadUpdateStatus();
        },

        async loadUpdateStatus() {
            try {
                const response = await fetch('/api/update/status/');
                const data = await response.json();

                this.currentVersion = data.current_version;
                this.os = data.os;
                this.lastCheck = data.last_check;
                this.updateAvailable = data.update_available;
                this.latestVersion = data.latest_version;

            } catch (error) {
                console.error('Error loading status:', error);
            }
        },

        async checkForUpdates() {
            this.checking = true;

            try {
                const response = await fetch('/api/update/check/');
                const data = await response.json();

                if (data.error) {
                    await this.showAlert('Error', data.error, 'danger');
                    return;
                }

                this.updateAvailable = data.update_available;
                this.latestVersion = data.latest_version;
                this.updateType = data.update_type;
                this.releaseNotes = data.release_notes;
                this.downloadUrl = data.download_url;
                this.fileSizeMB = data.file_size_mb;
                this.lastCheck = new Date().toISOString();

                if (!data.update_available) {
                    await this.showToast('‚úÖ Ya tienes la √∫ltima versi√≥n', 'success');
                } else {
                    await this.showToast(`üéâ Nueva versi√≥n ${data.latest_version} disponible`, 'primary');
                }

            } catch (error) {
                await this.showAlert('Error', 'No se pudo verificar actualizaciones: ' + error.message, 'danger');
            } finally {
                this.checking = false;
            }
        },

        async downloadUpdate() {
            this.updateStatus = 'downloading';

            try {
                const response = await fetch('/api/update/download/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        download_url: this.downloadUrl,
                        version: this.latestVersion,
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                this.downloadedFilePath = data.file_path;
                this.updateStatus = 'downloaded';

                await this.showToast('‚úÖ Actualizaci√≥n descargada', 'success');

            } catch (error) {
                this.updateStatus = 'available';
                await this.showAlert('Error', 'Error descargando actualizaci√≥n: ' + error.message, 'danger');
            }
        },

        async installUpdate() {
            this.updateStatus = 'installing';

            try {
                const response = await fetch('/api/update/install/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        file_path: this.downloadedFilePath,
                        version: this.latestVersion,
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                this.backupPath = data.backup_path;
                this.updateStatus = 'ready';

                await this.showToast('‚úÖ Actualizaci√≥n lista para aplicar', 'success');

            } catch (error) {
                this.updateStatus = 'downloaded';
                await this.showAlert('Error', 'Error preparando actualizaci√≥n: ' + error.message, 'danger');
            }
        },

        async confirmApplyUpdate() {
            const alert = document.createElement('ion-alert');
            alert.header = '¬øAplicar actualizaci√≥n?';
            alert.message = `El Hub se cerrar√° y reiniciar√° con la versi√≥n ${this.latestVersion}. Este proceso tarda aproximadamente 30 segundos.`;
            alert.buttons = [
                {
                    text: 'Cancelar',
                    role: 'cancel',
                },
                {
                    text: 'Aplicar',
                    handler: () => {
                        this.applyUpdate();
                    }
                }
            ];

            document.body.appendChild(alert);
            await alert.present();
        },

        async applyUpdate() {
            try {
                await this.showToast('Aplicando actualizaci√≥n...', 'primary');

                const response = await fetch('/api/update/apply/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                });

                // Si llegamos aqu√≠, algo fall√≥ (normalmente el Hub deber√≠a cerrarse)
                const data = await response.json();
                await this.showAlert('Info', data.message || 'Actualizaci√≥n en proceso', 'primary');

            } catch (error) {
                // Es normal que falle la petici√≥n porque el Hub se cierra
                console.log('Hub exiting for update (expected)');
            }
        },

        async confirmRollback(backupPath) {
            const alert = document.createElement('ion-alert');
            alert.header = '¬øRestaurar backup?';
            alert.message = 'Esto revertir√° el Hub a la versi√≥n anterior. Los datos actuales se perder√°n.';
            alert.buttons = [
                {
                    text: 'Cancelar',
                    role: 'cancel',
                },
                {
                    text: 'Restaurar',
                    handler: () => {
                        this.rollback(backupPath);
                    }
                }
            ];

            document.body.appendChild(alert);
            await alert.present();
        },

        async rollback(backupPath) {
            try {
                const response = await fetch('/api/update/rollback/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        backup_path: backupPath,
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error);
                }

                await this.showAlert('√âxito', data.message, 'success');

            } catch (error) {
                await this.showAlert('Error', 'Error en rollback: ' + error.message, 'danger');
            }
        },

        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString();
        },

        async showToast(message, color = 'primary') {
            const toast = document.createElement('ion-toast');
            toast.message = message;
            toast.duration = 3000;
            toast.color = color;
            toast.position = 'bottom';
            document.body.appendChild(toast);
            await toast.present();
        },

        async showAlert(header, message, color = 'primary') {
            const alert = document.createElement('ion-alert');
            alert.header = header;
            alert.message = message;
            alert.buttons = ['OK'];
            document.body.appendChild(alert);
            await alert.present();
        }
    }
}
</script>
{% endblock %}
