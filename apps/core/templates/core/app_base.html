{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ERPlora Hub - POS System{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">

    <!-- Ionic CSS (offline) -->
    <link rel="stylesheet" href="{% static 'css/ionic.bundle.css' %}" />

    <!-- Theme Colors (carga desde carpeta del tema: default o blue) -->
    <link rel="stylesheet" href="{% static 'css/themes/' %}{{ hub_config.color_theme }}/ionic-theme.css" id="theme-stylesheet">

    <!-- Base Styles (variables base, componentes y utilidades) -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- Tailwind CSS (offline) -->
    <script src="{% static 'js/tailwind.cdn.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/tailwind-ionic.css' %}">

    <!-- Alpine.js (offline) -->
    <script defer src="{% static 'js/alpine.min.js' %}"></script>

    <!-- Ionic Core (offline) -->
    <script type="module" src="{% static 'js/ionic/ionic.esm.js' %}"></script>

    <!-- Ionicons (offline) -->
    <script type="module" src="{% static 'ionicons/dist/ionicons/ionicons.esm.js' %}"></script>
    <script nomodule src="{% static 'ionicons/dist/ionicons/ionicons.js' %}"></script>

    <!-- Theme Switcher Script -->
    <script>
        // Theme already loaded from template (line 15)
        // Dark mode is handled by Alpine.js with :class="isDark ? 'dark' : ''"

        function setTheme(themeName) {
            const themeLink = document.getElementById('theme-stylesheet');
            const themeUrl = `/static/css/themes/${themeName}/ionic-theme.css`;

            if (themeLink) {
                themeLink.href = themeUrl;
            }
        }

        function getCurrentTheme() {
            return '{{ hub_config.color_theme }}';
        }

        function getThemeLogo() {
            return `/static/css/themes/{{ hub_config.color_theme }}/erplorer-logo.svg`;
        }
    </script>

    <style>
        [x-cloak] {
            display: none !important;
        }

        ion-menu {
            --width: 16rem;
        }

        /* Custom menu styles */
        .menu-header {
            border-bottom: 1px solid var(--ion-border-color);
        }

        .menu-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-box {
            width: 2rem;
            height: 2rem;
            background: var(--ion-color-primary);
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-footer {
            border-top: 1px solid var(--ion-border-color);
            margin-top: auto;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--ion-color-medium);
            margin-bottom: 0.5rem;
            padding: 0 0.5rem;
            text-transform: uppercase;
        }

        /* Override ion-item styles for navigation */
        ion-item.nav-item {
            --padding-start: 0.75rem;
            --padding-end: 0.75rem;
            --inner-padding-end: 0;
            --background: transparent;
            --background-hover: var(--ion-color-secondary);
            --background-activated: var(--ion-color-secondary);
            --color: var(--ion-color-medium);
            --border-radius: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        ion-item.nav-item.active {
            --background: var(--ion-color-secondary);
            --color: var(--ion-text-color);
        }

        ion-item.nav-item ion-icon {
            margin-right: 0.75rem;
        }

        /* Remove ion-page padding */
        .ion-page {
            --padding-top: 0;
            --padding-bottom: 0;
            --padding-start: 0;
            --padding-end: 0;
        }

        .custom-action-sheet {
            --background: var(--ion-color-step-850,#262626);
            --backdrop-opacity: 0.6;
            --button-background-selected: var(--ion-action-sheet-button-background-selected);
            --button-color: var(--ion-action-sheet-button-color);
            /* role: "destructive" button iOS styling override */
            --ion-color-danger: var(--ion-color-danger);
        }
       .action-sheet-title,.action-sheet-has-sub-title {
            color: var(--ion-color-danger)
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body x-data="hubApp()" :class="isDark ? 'dark' : ''">
    <ion-app mode="ios">
        <!-- Menu (Sidebar) -->
        <ion-menu content-id="main-content" menu-id="main-menu" type="reveal">
            <ion-header>
                <ion-toolbar class="ion-padding">
                    <div class="menu-logo">
                        <img src="{% static 'img/logo.png' %}" alt="ERPlora" style="width: 2rem; height: 2rem;">
                        <div style="margin-left: 0.5rem;">
                            <div style="font-weight: 600;">ERPlora</div>
                            <div style="font-size: 0.75rem; color: var(--ion-color-medium);">{% trans "Business Management" %}</div>
                        </div>
                    </div>
                </ion-toolbar>

                <!-- Logged User Info -->
                <ion-toolbar class="ion-padding-horizontal" style="padding-top: 0;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--ion-color-step-50); border-radius: 0.5rem;">
                        <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: var(--ion-color-primary); display: flex; align-items: center; justify-content: center; color: var(--ion-color-primary-contrast); font-weight: 600; font-size: 0.875rem;">
                            {{ request.session.user_name|first|upper }}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ request.session.user_name }}
                            </div>
                            <ion-chip color="{% if request.session.user_role == 'admin' %}primary{% elif request.session.user_role == 'manager' %}success{% else %}secondary{% endif %}" style="margin: 0; height: 1.25rem; padding: 0 0.5rem;">
                                <ion-label style="font-size: 0.625rem; text-transform: capitalize;">{{ request.session.user_role }}</ion-label>
                            </ion-chip>
                        </div>
                    </div>
                </ion-toolbar>
            </ion-header>

            <ion-content>
                <ion-list class="ion-padding">
                    <!-- Navigation Items -->
                    <ion-item button @click="navigateTo('dashboard')"
                        :class="currentView === 'dashboard' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="grid-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Dashboard" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('pos')"
                        :class="currentView === 'pos' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="cart-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Point of Sale" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('products')"
                        :class="currentView === 'products' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="cube-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Products" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('sales')"
                        :class="currentView === 'sales' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="receipt-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Sales" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('reports')"
                        :class="currentView === 'reports' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="bar-chart-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Reports" %}</ion-label>
                    </ion-item>

                    <!-- Separator -->
                    <div style="height: 1px; background: var(--ion-border-color); margin: 1rem 0;"></div>

                    <ion-item button @click="navigateTo('employees')"
                        :class="currentView === 'employees' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="people-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Employees" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('plugins')"
                        :class="currentView === 'plugins' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="extension-puzzle-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Plugins" %}</ion-label>
                    </ion-item>

                    <ion-item button @click="navigateTo('settings')"
                        :class="currentView === 'settings' ? 'nav-item active' : 'nav-item'" detail="false">
                        <ion-icon name="settings-outline" slot="start"></ion-icon>
                        <ion-label>{% trans "Settings" %}</ion-label>
                    </ion-item>

                    <!-- Separator -->
                    <div style="height: 1px; background: var(--ion-border-color); margin: 1rem 0;"></div>

                    <!-- Logout Button -->
                    <ion-item button href="{% url 'accounts:logout' %}" detail="false" lines="none">
                        <ion-icon name="log-out-outline" slot="start" color="danger"></ion-icon>
                        <ion-label color="danger">{% trans "Sign Out" %}</ion-label>
                    </ion-item>
                </ion-list>
            </ion-content>

            <!-- Footer -->
            <ion-footer class="menu-footer">
                <ion-toolbar class="ion-padding">
                    <ion-button expand="block" fill="clear" href="{{ CLOUD_URL }}" target="_blank">
                        <ion-icon slot="start" name="cloud-outline"></ion-icon>
                        {% trans "Go to CPOS Cloud" %}
                    </ion-button>
                </ion-toolbar>
            </ion-footer>
        </ion-menu>

        <!-- Main Content -->
        <div class="ion-page" id="main-content">
            <ion-header>
                <ion-toolbar>
                    <ion-buttons slot="start">
                        <!-- Menu Toggle Button -->
                        <ion-button @click="toggleMenu()">
                            <ion-icon slot="icon-only" name="menu-outline"></ion-icon>
                        </ion-button>
                    </ion-buttons>

                    <ion-title>{% block page_title %}Dashboard{% endblock %}</ion-title>

                    <ion-buttons slot="end">
                        <!-- Fullscreen Toggle -->
                        <ion-button @click="toggleFullscreen()">
                            <ion-icon slot="icon-only" :name="isFullscreen ? 'contract-outline' : 'expand-outline'"></ion-icon>
                        </ion-button>

                        <!-- Theme Toggle -->
                        <ion-button @click="toggleTheme()">
                            <ion-icon slot="icon-only" :name="isDark ? 'sunny-outline' : 'moon-outline'"></ion-icon>
                        </ion-button>

                        <!-- User Menu -->
                        <ion-button @click="handleUserMenu()">
                            <ion-icon slot="icon-only" name="person-circle-outline"></ion-icon>
                        </ion-button>
                    </ion-buttons>
                </ion-toolbar>
            </ion-header>

            <ion-content>
                {% block content %}
                <!-- Page content goes here -->
                {% endblock %}
            </ion-content>
        </div>

        <ion-action-sheet
            trigger="open-action-sheet"
            class="custom-action-sheet text-justify"
        ></ion-action-sheet>
    </ion-app>

    <script>
        function hubApp() {
            return {
                isDark: false,
                isFullscreen: false,
                currentView: '{{ current_view|default:"dashboard" }}',

                toggleMenu() {
                    const menu = document.querySelector('ion-menu[menu-id="main-menu"]');
                    menu.toggle();
                },

                async toggleTheme() {
                    this.isDark = !this.isDark;
                    document.body.classList.toggle('dark');

                    // Dispatch event for child components (like settingsApp)
                    document.dispatchEvent(new CustomEvent('theme-changed', {
                        detail: { isDark: this.isDark }
                    }));

                    // Save to database
                    try {
                        const formData = new FormData();
                        formData.append('action', 'update_theme');
                        formData.append('color_theme', '{{ hub_config.color_theme }}');
                        formData.append('dark_mode', this.isDark);
                        formData.append('auto_print', '{{ hub_config.auto_print|yesno:"true,false" }}');
                        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                        await fetch('{% url "configuration:settings" %}', {
                            method: 'POST',
                            body: formData
                        });
                    } catch (error) {
                        console.error('Error saving dark mode:', error);
                    }
                },

                toggleFullscreen() {
                    // Verificar si estamos en pywebview (app empaquetada)
                    if (window.pywebview && window.pywebview.api) {
                        // Llamar a la API de Python
                        window.pywebview.api.toggle_fullscreen().then(response => {
                            if (response.error) {
                                console.error('Fullscreen error:', response.error);
                                this.showToast('Fullscreen not available');
                            } else {
                                console.log('Fullscreen toggled:', response);
                                this.isFullscreen = response.fullscreen;
                            }
                        }).catch(err => {
                            console.error('Failed to toggle fullscreen:', err);
                            this.showToast('Fullscreen error');
                        });
                    } else {
                        // Fallback para navegador web (desarrollo)
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen();
                            this.isFullscreen = true;
                        } else {
                            if (document.exitFullscreen) {
                                document.exitFullscreen();
                                this.isFullscreen = false;
                            }
                        }
                    }
                },

                async showToast(message) {
                    const toast = document.createElement('ion-toast');
                    toast.message = message;
                    toast.duration = 1500;
                    toast.position = 'bottom';
                    toast.color = 'primary';
                    document.body.appendChild(toast);
                    await toast.present();
                },

                async handleUserMenu() {
                    // const actionSheet = document.createElement('ion-action-sheet');
                    var actionSheet = document.querySelector('ion-action-sheet');
                    actionSheet.header = '{{ request.session.user_name }}';
                    actionSheet.subHeader = '{{ request.session.user_email }}';
                    actionSheet.buttons = [
                        {
                            text: '{% trans "Settings" %}',
                            handler: () => {
                                window.location.href = "{% url 'configuration:settings' %}";
                            }
                        },
                        {
                            text: '{% trans "Employees" %}',
                            handler: () => {
                                window.location.href = "{% url 'accounts:employees' %}";
                            }
                        },
                        {
                            text: '{% trans "Sign Out" %}',
                            role: 'destructive',
                            handler: () => {
                                window.location.href = "{% url 'accounts:logout' %}";
                            }
                        },
                         {
      text: '{% trans "Cancel" %}',
      role: 'cancel',
      data: {
        action: 'cancel',
      },
    },
                    ];

                    document.body.appendChild(actionSheet);
                    await actionSheet.present();
                },

                navigateTo(view) {
                    const routes = {
                        'dashboard': "{% url 'configuration:dashboard' %}",
                        'pos': "{% url 'configuration:pos' %}",
                        'employees': "{% url 'accounts:employees' %}",
                        'plugins': "{% url 'plugins:plugins' %}",
                        'settings': "{% url 'configuration:settings' %}",
                        'products': '#',
                        'sales': '#',
                        'reports': '#'
                    };

                    if (routes[view] && routes[view] !== '#') {
                        window.location.href = routes[view];
                    }
                },

                init() {
                    // Initialize theme from database (already applied by script above)
                    this.isDark = {{ hub_config.dark_mode|yesno:"true,false" }};

                    // Listen to fullscreen changes
                    document.addEventListener('fullscreenchange', () => {
                        this.isFullscreen = !!document.fullscreenElement;
                    });
                }
            }
        }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
