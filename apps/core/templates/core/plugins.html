{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ERPlora Hub - {% trans "Plugins" %}{% endblock %}
{% block page_title %}{% trans "Plugins" %}{% endblock %}

{% block section_tabbar %}
<ion-footer>
    <ion-tab-bar>
        <ion-tab-button href="{% url 'configuration:marketplace' %}">
            <ion-icon name="storefront-outline"></ion-icon>
            <ion-label>{% trans "Marketplace" %}</ion-label>
        </ion-tab-button>
        <ion-tab-button href="{% url 'configuration:plugins' %}" class="tab-selected">
            <ion-icon name="download-outline"></ion-icon>
            <ion-label>{% trans "Installed" %}</ion-label>
        </ion-tab-button>
    </ion-tab-bar>
</ion-footer>
{% endblock %}

{% block extra_head %}
<script>
    // Activate plugin with Ionic alert
    async function confirmActivate(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Activate Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "The plugin will be activated. A server restart is required to apply migrations." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Activate" %}',
                role: 'confirm',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/activate/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            // Show success and ask if restart now
                            await showRestartConfirmation(pluginName);
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to activate plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }

    // Show restart confirmation after activation
    async function showRestartConfirmation(pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Plugin Activated" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "The plugin has been activated successfully. Do you want to restart the server now to apply migrations?" %}';
        alert.buttons = [
            {
                text: '{% trans "Later" %}',
                role: 'cancel',
                handler: () => {
                    window.location.reload();
                }
            },
            {
                text: '{% trans "Restart Now" %}',
                role: 'confirm',
                handler: async () => {
                    await restartServerNow();
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }

    // Restart server now
    async function restartServerNow() {
        const loading = document.createElement('ion-loading');
        loading.message = '{% trans "Restarting server and applying migrations..." %}';
        document.body.appendChild(loading);
        await loading.present();

        try {
            const response = await fetch('/plugins/restart/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            const result = await response.json();

            await loading.dismiss();

            if (result.success) {
                await showSuccessAlert('{% trans "Server restarted successfully. Migrations applied." %}', '{% trans "Success" %}');
                // Wait a moment for server to restart, then reload
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                await showErrorAlert(result.error || '{% trans "Failed to restart server" %}', '{% trans "Error" %}');
            }
        } catch (error) {
            await loading.dismiss();
            await showErrorAlert('{% trans "Error:" %} ' + error.message, '{% trans "Error" %}');
        }
    }

    // Deactivate plugin with Ionic alert
    async function confirmDeactivate(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Deactivate Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "You will need to restart the application for changes to take effect." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Deactivate" %}',
                role: 'confirm',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/deactivate/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            await showSuccessAlert('{% trans "Plugin deactivated successfully. Please restart the application." %}', '{% trans "Success" %}');
                            window.location.reload();
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to deactivate plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }

    // Delete plugin with Ionic alert
    async function confirmDelete(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Delete Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "WARNING: This will permanently remove all plugin files." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Delete" %}',
                role: 'destructive',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/delete/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            await showSuccessAlert('{% trans "Plugin deleted successfully." %}', '{% trans "Success" %}');
                            window.location.reload();
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to delete plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }
</script>
{% endblock %}

{% block content %}
<div style="padding: 24px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2 style="margin: 0;">{% trans "Plugin Management" %}</h2>
            <p style="color: var(--ion-color-medium); margin-top: 4px;">
                {% trans "Activate, deactivate and manage your plugins" %}
            </p>
        </div>
    </div>

    <!-- Restart Banner (shown when plugins need restart) -->
    {% if requires_restart %}
    <ion-card color="warning" style="margin-bottom: 24px;">
        <ion-card-content>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <ion-icon name="alert-circle-outline" style="font-size: 32px;"></ion-icon>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            {% trans "Restart Required" %}
                        </div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">
                            {% trans "Some plugins have been activated and need a server restart to apply migrations." %}
                        </div>
                    </div>
                </div>
                <ion-button color="dark" onclick="restartServerNow()">
                    <ion-icon slot="start" name="reload-outline"></ion-icon>
                    {% trans "Restart Now" %}
                </ion-button>
            </div>
        </ion-card-content>
    </ion-card>
    {% endif %}

    <!-- Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-primary);">
                    {{ plugins|length }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Installed" %}
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-success);">
                    {{ active_count }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Active" %}
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-medium);">
                    {{ inactive_count }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Inactive" %}
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Plugins Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
        {% for plugin in plugins %}
        <ion-card style="display: flex; flex-direction: column; height: 100%;">
            <ion-card-content style="flex: 1; display: flex; flex-direction: column;">
                <div style="display: flex; align-items: start; gap: 16px; flex: 1;">
                    <!-- Icon -->
                    <div style="width: 56px; height: 56px; border-radius: 12px; background: var(--ion-color-light); color: var(--ion-color-primary); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0;">
                        <ion-icon name="{{ plugin.icon }}"></ion-icon>
                    </div>

                    <!-- Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 4px;">
                            {{ plugin.name }}
                        </div>
                        <div style="color: var(--ion-color-medium); font-size: 0.875rem; margin-bottom: 8px;">
                            {{ plugin.description|truncatewords:15 }}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <ion-badge color="{% if plugin.is_active %}success{% else %}medium{% endif %}">
                                {% if plugin.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                            </ion-badge>
                            <span style="color: var(--ion-color-medium); font-size: 0.75rem;">
                                v{{ plugin.version }}
                            </span>
                            {% if plugin.author %}
                            <span style="color: var(--ion-color-medium); font-size: 0.75rem;">
                                â€¢ {{ plugin.author }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </ion-card-content>

            <!-- Actions Toolbar - Always at bottom -->
            <ion-toolbar class="ion-no-border" style="--background: transparent; --border-color: var(--ion-color-light-shade); border-top: 1px solid var(--ion-color-light-shade);">
                <ion-buttons slot="end" class="ion-padding" style="gap: 8px;">
                    {% if plugin.is_active %}
                    <ion-button
                        fill="outline"
                        color="medium"
                        onclick="confirmDeactivate('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="start" name="pause-outline"></ion-icon>
                        {% trans "Deactivate" %}
                    </ion-button>
                    <ion-button fill="outline" href="/plugins/{{ plugin.plugin_id }}/">
                        <ion-icon slot="start" name="open-outline"></ion-icon>
                        {% trans "Open" %}
                    </ion-button>
                    {% else %}
                    <ion-button
                        fill="outline"
                        color="success"
                        onclick="confirmActivate('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="start" name="play-outline"></ion-icon>
                        {% trans "Activate" %}
                    </ion-button>
                    {% endif %}
                    <ion-button
                        fill="outline"
                        color="danger"
                        onclick="confirmDelete('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-card>
        {% empty %}
        <ion-card>
            <ion-card-content style="text-align: center; padding: 40px;">
                <ion-icon name="cube-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
                <p style="color: var(--ion-color-medium); margin-top: 16px;">
                    {% trans "No plugins installed" %}
                </p>
                <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 8px;">
                    {% trans "Install plugins from the Plugin Store" %}
                </p>
            </ion-card-content>
        </ion-card>
        {% endfor %}
    </div>
</div>
{% endblock %}
