{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ERPlora Hub - {% trans "Plugins" %}{% endblock %}
{% block page_title %}{% trans "Plugins" %}{% endblock %}

{% block extra_head %}
<script>
    // Activate plugin with Ionic alert
    async function confirmActivate(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Activate Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "You will need to restart the application for changes to take effect." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Activate" %}',
                role: 'confirm',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/activate/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            await showSuccessAlert('{% trans "Plugin activated successfully. Please restart the application." %}', '{% trans "Success" %}');
                            window.location.reload();
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to activate plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }

    // Deactivate plugin with Ionic alert
    async function confirmDeactivate(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Deactivate Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "You will need to restart the application for changes to take effect." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Deactivate" %}',
                role: 'confirm',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/deactivate/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            await showSuccessAlert('{% trans "Plugin deactivated successfully. Please restart the application." %}', '{% trans "Success" %}');
                            window.location.reload();
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to deactivate plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }

    // Delete plugin with Ionic alert
    async function confirmDelete(pluginId, pluginName) {
        const alert = document.createElement('ion-alert');
        alert.header = '{% trans "Delete Plugin" %}';
        alert.subHeader = pluginName;
        alert.message = '{% trans "WARNING: This will permanently remove all plugin files." %}';
        alert.buttons = [
            {
                text: '{% trans "Cancel" %}',
                role: 'cancel'
            },
            {
                text: '{% trans "Delete" %}',
                role: 'destructive',
                handler: async () => {
                    try {
                        const response = await fetch(`/plugins/delete/${pluginId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });
                        const result = await response.json();

                        if (result.success) {
                            await showSuccessAlert('{% trans "Plugin deleted successfully." %}', '{% trans "Success" %}');
                            window.location.reload();
                        } else {
                            await showErrorAlert(result.error || '{% trans "Failed to delete plugin" %}', '{% trans "Error" %}');
                        }
                    } catch (error) {
                        await showErrorAlert('{% trans "Network error:" %} ' + error.message, '{% trans "Error" %}');
                    }
                }
            }
        ];
        document.body.appendChild(alert);
        await alert.present();
    }
</script>
{% endblock %}

{% block content %}
<div style="padding: 24px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2 style="margin: 0;">{% trans "Plugin Management" %}</h2>
            <p style="color: var(--ion-color-medium); margin-top: 4px;">
                {% trans "Activate, deactivate and manage your plugins" %}
            </p>
        </div>
    </div>

    <!-- Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-primary);">
                    {{ plugins|length }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Installed" %}
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-success);">
                    {{ active_count }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Active" %}
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card>
            <ion-card-content style="text-align: center; padding: 20px;">
                <div style="font-size: 2rem; font-weight: 700; color: var(--ion-color-medium);">
                    {{ inactive_count }}
                </div>
                <div style="color: var(--ion-color-medium); margin-top: 4px;">
                    {% trans "Inactive" %}
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Plugins Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
        {% for plugin in plugins %}
        <ion-card>
            <ion-card-content>
                <div style="display: flex; align-items: start; gap: 16px;">
                    <!-- Icon -->
                    <div style="width: 56px; height: 56px; border-radius: 12px; background: var(--ion-color-light); color: var(--ion-color-primary); display: flex; align-items: center; justify-content: center; font-size: 28px; flex-shrink: 0;">
                        <ion-icon name="{{ plugin.icon }}"></ion-icon>
                    </div>

                    <!-- Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 4px;">
                            {{ plugin.name }}
                        </div>
                        <div style="color: var(--ion-color-medium); font-size: 0.875rem; margin-bottom: 8px;">
                            {{ plugin.description|truncatewords:15 }}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            <ion-badge color="{% if plugin.is_active %}success{% else %}medium{% endif %}">
                                {% if plugin.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                            </ion-badge>
                            <span style="color: var(--ion-color-medium); font-size: 0.75rem;">
                                v{{ plugin.version }}
                            </span>
                            {% if plugin.author %}
                            <span style="color: var(--ion-color-medium); font-size: 0.75rem;">
                                â€¢ {{ plugin.author }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ion-color-light-shade);">
                    {% if plugin.is_active %}
                    <ion-button
                        size="large"
                        fill="outline"
                        color="medium"
                        onclick="confirmDeactivate('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="start" name="pause-outline"></ion-icon>
                        {% trans "Deactivate" %}
                    </ion-button>
                    <ion-button size="large" fill="outline" href="/plugins/{{ plugin.plugin_id }}/">
                        <ion-icon slot="start" name="open-outline"></ion-icon>
                        {% trans "Open" %}
                    </ion-button>
                    {% else %}
                    <ion-button
                        size="large"
                        fill="outline"
                        color="success"
                        onclick="confirmActivate('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="start" name="play-outline"></ion-icon>
                        {% trans "Activate" %}
                    </ion-button>
                    {% endif %}

                    <ion-button
                        size="large"
                        fill="outline"
                        color="danger"
                        onclick="confirmDelete('{{ plugin.plugin_id }}', '{{ plugin.name }}')">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                    </ion-button>
                </div>
            </ion-card-content>
        </ion-card>
        {% empty %}
        <ion-card>
            <ion-card-content style="text-align: center; padding: 40px;">
                <ion-icon name="cube-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
                <p style="color: var(--ion-color-medium); margin-top: 16px;">
                    {% trans "No plugins installed" %}
                </p>
                <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 8px;">
                    {% trans "Install plugins from the Plugin Store" %}
                </p>
            </ion-card-content>
        </ion-card>
        {% endfor %}
    </div>
</div>
{% endblock %}
