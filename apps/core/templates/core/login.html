{% extends "core/base.html" %}
{% load static %}
{% load i18n %}

{% block title %}CPOS Hub - {% trans "Login" %}{% endblock %}

{% block extra_css %}
<style>
    .login-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 1rem;
    }

    .login-card {
        width: 100%;
        max-width: 500px;
        margin: 0;
    }

    .logo-container {
        text-align: center;
        margin-bottom: 2rem;
    }

    .logo-box {
        width: 4rem;
        height: 4rem;
        background: var(--ion-color-primary);
        border-radius: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }

    .logo-box ion-icon {
        font-size: 2rem;
        color: white;
    }

    .employee-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .employee-card {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin: 0;
    }

    .employee-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .employee-card.selected {
        border: 2px solid var(--ion-color-primary);
    }

    .employee-avatar {
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        background: var(--ion-color-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 0.5rem;
        color: white;
        font-weight: 600;
        font-size: 1.25rem;
    }

    .pin-input-container {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin: 1.5rem 0;
    }

    .pin-dot {
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        border: 2px solid var(--ion-color-medium);
        background: transparent;
        transition: all 0.2s;
    }

    .pin-dot.filled {
        background: var(--ion-color-primary);
        border-color: var(--ion-color-primary);
    }

    .pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        max-width: 300px;
        margin: 0 auto;
    }

    .pin-key {
        aspect-ratio: 1;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="loginApp()" x-init="init()">
    <!-- Theme Toggle -->
    <ion-button class="theme-toggle" fill="clear" @click="toggleTheme()">
        <ion-icon slot="icon-only" :name="isDark ? 'sunny-outline' : 'moon-outline'"></ion-icon>
    </ion-button>

    <!-- Login Container -->
    <div class="login-container">
        <ion-card class="login-card">
            <!-- Logo -->
            <div class="logo-container">
                <div class="logo-box">
                    <ion-icon name="storefront"></ion-icon>
                </div>
                <h1 style="margin: 0; font-size: 1.75rem; font-weight: 700;">CPOS Hub</h1>
                <p style="margin: 0.5rem 0 0 0; color: var(--ion-color-medium);">{% trans "Point of Sale System" %}</p>
            </div>

            <ion-card-content>
                <!-- Login Tabs -->
                <ion-segment :value="loginMode" style="margin-bottom: 2rem;">
                    <ion-segment-button value="local" @click="loginMode = 'local'">
                        <ion-label>{% trans "Local Login" %}</ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="cloud" @click="loginMode = 'cloud'">
                        <ion-label>{% trans "Cloud Login" %}</ion-label>
                    </ion-segment-button>
                </ion-segment>

                <!-- Local Login (Employee Selection + PIN) -->
                <div x-show="loginMode === 'local'" style="display: none;" x-cloak>
                    <!-- Employee Selection -->
                    <div x-show="!selectedEmployee">
                        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">{% trans "Select your profile" %}</h2>

                        <div class="employee-grid">
                            <template x-for="employee in employees" :key="employee.id">
                                <div class="employee-card" @click="selectEmployee(employee)">
                                    <ion-card style="margin: 0;">
                                        <ion-card-content style="padding: 1rem; text-align: center;">
                                            <div class="employee-avatar">
                                                <span x-text="employee.initials"></span>
                                            </div>
                                            <p style="margin: 0; font-size: 0.875rem; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" x-text="employee.name"></p>
                                            <ion-chip :color="employee.roleColor" style="margin: 0.25rem 0 0 0; height: 1.25rem;">
                                                <ion-label style="font-size: 0.625rem;" x-text="employee.role"></ion-label>
                                            </ion-chip>
                                        </ion-card-content>
                                    </ion-card>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- PIN Entry -->
                    <div x-show="selectedEmployee" x-cloak>
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div class="employee-avatar" style="display: inline-flex;">
                                <span x-text="selectedEmployee?.initials"></span>
                            </div>
                            <h2 style="margin: 0.75rem 0 0 0; font-size: 1.25rem; font-weight: 600;" x-text="selectedEmployee?.name"></h2>
                            <p style="margin: 0.25rem 0 0 0; color: var(--ion-color-medium);">{% trans "Enter your PIN" %}</p>
                        </div>

                        <!-- PIN Dots -->
                        <div class="pin-input-container">
                            <template x-for="i in 4">
                                <div class="pin-dot" :class="{ 'filled': pinInput.length >= i }"></div>
                            </template>
                        </div>

                        <!-- Error Message -->
                        <div x-show="pinError" x-cloak style="text-align: center; margin-bottom: 1rem;">
                            <ion-chip color="danger">
                                <ion-icon name="alert-circle-outline"></ion-icon>
                                <ion-label>{% trans "Incorrect PIN" %}</ion-label>
                            </ion-chip>
                        </div>

                        <!-- Keypad -->
                        <div class="pin-keypad">
                            <template x-for="num in [1, 2, 3, 4, 5, 6, 7, 8, 9]">
                                <ion-button class="pin-key" @click="addPinDigit(num)" expand="block" fill="outline">
                                    <span x-text="num"></span>
                                </ion-button>
                            </template>
                            <ion-button class="pin-key" @click="selectedEmployee = null; pinInput = ''; pinError = false;" expand="block" fill="clear">
                                <ion-icon name="arrow-back-outline"></ion-icon>
                            </ion-button>
                            <ion-button class="pin-key" @click="addPinDigit(0)" expand="block" fill="outline">
                                <span>0</span>
                            </ion-button>
                            <ion-button class="pin-key" @click="clearPinDigit()" expand="block" fill="clear">
                                <ion-icon name="backspace-outline"></ion-icon>
                            </ion-button>
                        </div>
                    </div>
                </div>

                <!-- Cloud Login (Email/Password) -->
                <div x-show="loginMode === 'cloud'" style="display: none;" x-cloak>
                    <form @submit.prevent="cloudLogin()" style="display: flex; flex-direction: column; gap: 1.5rem;">
                        {% csrf_token %}
                        <div>
                            <ion-label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{% trans "Email" %}</ion-label>
                            <ion-input
                                x-model="cloudCredentials.email"
                                type="email"
                                placeholder="{% trans 'your@email.com' %}"
                                fill="outline"
                                required
                                style="--background: var(--ion-background-color);">
                            </ion-input>
                        </div>

                        <div>
                            <ion-label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">{% trans "Password" %}</ion-label>
                            <ion-input
                                x-model="cloudCredentials.password"
                                type="password"
                                placeholder="••••••••"
                                fill="outline"
                                required
                                style="--background: var(--ion-background-color);">
                            </ion-input>
                        </div>

                        <ion-button type="submit" expand="block" :disabled="cloudLoading">
                            <ion-spinner x-show="cloudLoading" name="crescent" style="margin-right: 0.5rem;"></ion-spinner>
                            <span x-text="cloudLoading ? '{% trans "Logging in..." %}' : '{% trans "Login" %}'"></span>
                        </ion-button>
                    </form>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- PIN Setup Modal (First Time Cloud Login) -->
    <ion-modal :is-open="showPinSetup" @didDismiss="showPinSetup = false">
        <ion-header>
            <ion-toolbar>
                <ion-title>{% trans "Setup your PIN" %}</ion-title>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <div style="max-width: 400px; margin: 0 auto;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <ion-icon name="key-outline" style="font-size: 4rem; color: var(--ion-color-primary);"></ion-icon>
                    <h2 style="margin: 1rem 0 0.5rem 0;">{% trans "Welcome" %}, <span x-text="newUser?.name"></span></h2>
                    <p style="margin: 0; color: var(--ion-color-medium);">{% trans "Setup a 4-digit PIN for quick access" %}</p>
                </div>

                <!-- PIN Setup Dots -->
                <div class="pin-input-container">
                    <template x-for="i in 4">
                        <div class="pin-dot" :class="{ 'filled': setupPinInput.length >= i }"></div>
                    </template>
                </div>

                <div x-show="setupPinConfirm" x-cloak style="text-align: center; margin: 1rem 0;">
                    <p style="color: var(--ion-color-medium);">{% trans "Confirm your PIN" %}</p>
                </div>

                <!-- Error Message -->
                <div x-show="setupPinError" x-cloak style="text-align: center; margin-bottom: 1rem;">
                    <ion-chip color="danger">
                        <ion-icon name="alert-circle-outline"></ion-icon>
                        <ion-label>{% trans "PINs don't match" %}</ion-label>
                    </ion-chip>
                </div>

                <!-- Keypad -->
                <div class="pin-keypad">
                    <template x-for="num in [1, 2, 3, 4, 5, 6, 7, 8, 9]">
                        <ion-button class="pin-key" @click="addSetupPinDigit(num)" expand="block" fill="outline">
                            <span x-text="num"></span>
                        </ion-button>
                    </template>
                    <div></div>
                    <ion-button class="pin-key" @click="addSetupPinDigit(0)" expand="block" fill="outline">
                        <span>0</span>
                    </ion-button>
                    <ion-button class="pin-key" @click="clearSetupPinDigit()" expand="block" fill="clear">
                        <ion-icon name="backspace-outline"></ion-icon>
                    </ion-button>
                </div>
            </div>
        </ion-content>
    </ion-modal>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function loginApp() {
        return {
            // Theme
            isDark: false,

            // Login Mode
            loginMode: 'local', // 'local' or 'cloud'

            // Local Login
            selectedEmployee: null,
            pinInput: '',
            pinError: false,

            // Cloud Login
            cloudCredentials: {
                email: '',
                password: ''
            },
            cloudLoading: false,

            // PIN Setup (First Time)
            showPinSetup: false,
            newUser: null,
            setupPinInput: '',
            setupPinConfirm: false,
            setupPinFirst: '',
            setupPinError: false,

            // Employees Data (loaded from backend)
            employees: {{ local_users_json|safe }},

            init() {
                // Load theme
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    this.isDark = true;
                    document.body.classList.add('dark');
                }
            },

            // Local Login Methods
            selectEmployee(employee) {
                this.selectedEmployee = employee;
                this.pinInput = '';
                this.pinError = false;
            },

            addPinDigit(digit) {
                if (this.pinInput.length < 4) {
                    this.pinInput += digit;

                    // Auto verify when 4 digits entered
                    if (this.pinInput.length === 4) {
                        this.$nextTick(() => {
                            setTimeout(() => this.verifyPin(), 200);
                        });
                    }
                }
            },

            clearPinDigit() {
                this.pinInput = this.pinInput.slice(0, -1);
                this.pinError = false;
            },

            async verifyPin() {
                try {
                    const response = await fetch('{% url "core:verify_pin" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            user_id: this.selectedEmployee.id,
                            pin: this.pinInput
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Success
                        const toast = document.createElement('ion-toast');
                        toast.message = `{% trans "Welcome" %}, ${this.selectedEmployee.name}!`;
                        toast.duration = 2000;
                        toast.color = 'success';
                        document.body.appendChild(toast);
                        toast.present();

                        setTimeout(() => {
                            window.location.href = '{% url "core:dashboard" %}';
                        }, 1000);
                    } else {
                        // Error
                        this.pinError = true;
                        this.pinInput = '';

                        // Vibrate if available
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                    }
                } catch (error) {
                    console.error('Error verifying PIN:', error);
                    this.pinError = true;
                    this.pinInput = '';
                }
            },

            // Cloud Login Methods
            async cloudLogin() {
                if (!this.cloudCredentials.email || !this.cloudCredentials.password) {
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "Please complete all fields" %}';
                    toast.duration = 2000;
                    toast.color = 'warning';
                    document.body.appendChild(toast);
                    toast.present();
                    return;
                }

                this.cloudLoading = true;

                try {
                    const response = await fetch('{% url "core:cloud_login" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            email: this.cloudCredentials.email,
                            password: this.cloudCredentials.password
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        if (data.first_time) {
                            // First time - setup PIN
                            this.newUser = data.user;
                            this.showPinSetup = true;
                        } else {
                            // Already has PIN - login directly
                            const toast = document.createElement('ion-toast');
                            toast.message = `{% trans "Welcome" %}, ${data.user.name}!`;
                            toast.duration = 2000;
                            toast.color = 'success';
                            document.body.appendChild(toast);
                            toast.present();

                            setTimeout(() => {
                                window.location.href = '{% url "core:dashboard" %}';
                            }, 1000);
                        }
                    } else {
                        const toast = document.createElement('ion-toast');
                        toast.message = data.error || '{% trans "Login failed" %}';
                        toast.duration = 3000;
                        toast.color = 'danger';
                        document.body.appendChild(toast);
                        toast.present();
                    }
                } catch (error) {
                    console.error('Error during cloud login:', error);
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "Connection error. Please check your internet." %}';
                    toast.duration = 3000;
                    toast.color = 'danger';
                    document.body.appendChild(toast);
                    toast.present();
                } finally {
                    this.cloudLoading = false;
                }
            },

            // PIN Setup Methods
            addSetupPinDigit(digit) {
                if (this.setupPinInput.length < 4) {
                    this.setupPinInput += digit;

                    // Auto move to confirm when 4 digits entered
                    if (this.setupPinInput.length === 4) {
                        this.$nextTick(() => {
                            setTimeout(() => {
                                if (!this.setupPinConfirm) {
                                    this.setupPinFirst = this.setupPinInput;
                                    this.setupPinInput = '';
                                    this.setupPinConfirm = true;
                                } else {
                                    this.confirmSetupPin();
                                }
                            }, 200);
                        });
                    }
                }
            },

            clearSetupPinDigit() {
                this.setupPinInput = this.setupPinInput.slice(0, -1);
                this.setupPinError = false;
            },

            async confirmSetupPin() {
                if (this.setupPinInput === this.setupPinFirst) {
                    // Success - save PIN
                    try {
                        const response = await fetch('{% url "core:setup_pin" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({
                                user_id: this.newUser.id,
                                pin: this.setupPinInput
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            const toast = document.createElement('ion-toast');
                            toast.message = '{% trans "PIN configured successfully!" %}';
                            toast.duration = 2000;
                            toast.color = 'success';
                            document.body.appendChild(toast);
                            toast.present();

                            setTimeout(() => {
                                window.location.href = '{% url "core:dashboard" %}';
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Error setting up PIN:', error);
                    }
                } else {
                    // Error - PINs don't match
                    this.setupPinError = true;
                    this.setupPinInput = '';
                    this.setupPinConfirm = false;
                    this.setupPinFirst = '';

                    // Vibrate if available
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100]);
                    }

                    setTimeout(() => {
                        this.setupPinError = false;
                    }, 2000);
                }
            },

            toggleTheme() {
                this.isDark = !this.isDark;
                document.body.classList.toggle('dark');
                localStorage.setItem('theme', this.isDark ? 'dark' : 'light');
            }
        }
    }
</script>
{% endblock %}
