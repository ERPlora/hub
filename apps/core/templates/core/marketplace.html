{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ERPlora Hub - {% trans "Marketplace" %}{% endblock %}
{% block page_title %}{% trans "Marketplace" %}{% endblock %}

{% block section_tabbar %}
<ion-footer>
    <ion-tab-bar>
        <ion-tab-button href="{% url 'configuration:marketplace' %}" class="tab-selected">
            <ion-icon name="storefront-outline"></ion-icon>
            <ion-label>{% trans "Marketplace" %}</ion-label>
        </ion-tab-button>
        <ion-tab-button href="{% url 'configuration:plugins' %}">
            <ion-icon name="download-outline"></ion-icon>
            <ion-label>{% trans "Installed" %}</ion-label>
        </ion-tab-button>
    </ion-tab-bar>
</ion-footer>
{% endblock %}

{% block content %}
<div x-data="marketplaceData()" x-init="init()" style="padding: 24px;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h2 style="margin: 0;">{% trans "Marketplace" %}</h2>
            <p style="color: var(--ion-color-medium); margin-top: 4px;">
                {% trans "Discover and install plugins for your business" %}
            </p>
        </div>
    </div>

    <!-- Connection Status -->
    <template x-if="!isConnected && !loading">
        <ion-card color="warning" style="margin-bottom: 24px;">
            <ion-card-content>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <ion-icon name="cloud-offline-outline" style="font-size: 32px;"></ion-icon>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            {% trans "Not Connected to ERPlora Cloud" %}
                        </div>
                        <div style="font-size: 0.875rem; opacity: 0.9;">
                            {% trans "Connect your Hub to ERPlora Cloud to access the plugin marketplace." %}
                        </div>
                    </div>
                    <ion-button color="dark" @click="retryConnection()">
                        <ion-icon slot="start" name="refresh-outline"></ion-icon>
                        {% trans "Retry" %}
                    </ion-button>
                </div>
            </ion-card-content>
        </ion-card>
    </template>

    <!-- Loading State -->
    <template x-if="loading">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 48px;">
            <ion-spinner name="crescent" style="width: 48px; height: 48px;"></ion-spinner>
            <p style="color: var(--ion-color-medium); margin-top: 16px;">{% trans "Loading plugins from ERPlora Cloud..." %}</p>
        </div>
    </template>

    <!-- Error State -->
    <template x-if="error && !loading">
        <ion-card color="danger" style="margin-bottom: 24px;">
            <ion-card-content>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <ion-icon name="alert-circle-outline" style="font-size: 32px;"></ion-icon>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            {% trans "Error Loading Marketplace" %}
                        </div>
                        <div style="font-size: 0.875rem; opacity: 0.9;" x-text="error"></div>
                    </div>
                    <ion-button color="light" @click="retryConnection()">
                        <ion-icon slot="start" name="refresh-outline"></ion-icon>
                        {% trans "Retry" %}
                    </ion-button>
                </div>
            </ion-card-content>
        </ion-card>
    </template>

    <!-- Connected State with Plugins -->
    <template x-if="isConnected && !loading">
        <div>
            <!-- Search -->
            <ion-searchbar
                placeholder="{% trans 'Search plugins...' %}"
                x-model="searchQuery"
                @ionInput="filterPlugins()"
                debounce="300"
                style="margin-bottom: 24px;">
            </ion-searchbar>

            <!-- Categories Filter -->
            <div x-show="categories.length > 0" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 24px;">
                <ion-chip
                    :color="selectedCategory === null ? 'primary' : 'medium'"
                    @click="selectCategory(null)"
                    style="cursor: pointer;">
                    <ion-label>{% trans "All" %}</ion-label>
                </ion-chip>
                <template x-for="category in categories" :key="category.id">
                    <ion-chip
                        :color="selectedCategory === category.id ? 'primary' : 'medium'"
                        @click="selectCategory(category.id)"
                        style="cursor: pointer;">
                        <ion-label x-text="category.name"></ion-label>
                    </ion-chip>
                </template>
            </div>

            <!-- Plugins Count -->
            <div style="margin-bottom: 16px;">
                <h3 style="margin: 0;">
                    {% trans "Available Plugins" %}
                    (<span x-text="filteredPlugins.length"></span>)
                </h3>
            </div>

            <!-- Plugins Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
                <template x-for="plugin in filteredPlugins" :key="plugin.id">
                    <ion-card style="margin: 0; display: flex; flex-direction: column; height: 100%;">
                        <ion-card-content style="flex: 1; display: flex; flex-direction: column;">
                            <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                                <!-- Plugin Icon -->
                                <template x-if="plugin.icon">
                                    <img :src="plugin.icon" :alt="plugin.name" style="width: 64px; height: 64px; border-radius: 0.5rem; object-fit: cover;">
                                </template>
                                <template x-if="!plugin.icon">
                                    <div style="width: 64px; height: 64px; background: var(--ion-color-primary); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <ion-icon name="extension-puzzle-outline" style="font-size: 2rem; color: white;"></ion-icon>
                                    </div>
                                </template>

                                <!-- Plugin Info -->
                                <div style="flex: 1; min-width: 0;">
                                    <h4 style="font-weight: 600; margin-bottom: 4px;" x-text="plugin.name"></h4>
                                    <p style="font-size: 0.875rem; color: var(--ion-color-medium); margin-bottom: 8px;" x-text="plugin.author"></p>
                                    <div style="display: flex; align-items: center; gap: 12px; font-size: 0.875rem; color: var(--ion-color-medium);">
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <ion-icon name="star" style="color: #eab308;"></ion-icon>
                                            <span x-text="plugin.rating ? plugin.rating.toFixed(1) : '—'"></span>
                                        </div>
                                        <span x-text="plugin.downloads + ' {% trans "downloads" %}'"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <p style="font-size: 0.875rem; color: var(--ion-color-medium); margin-bottom: 16px; flex: 1;" x-text="truncateText(plugin.description, 80)"></p>

                            <!-- Price and Actions -->
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                                <div style="font-size: 1.25rem; font-weight: 600;">
                                    <template x-if="plugin.plugin_type === 'free'">
                                        <span style="color: var(--ion-color-success);">{% trans "Free" %}</span>
                                    </template>
                                    <template x-if="plugin.plugin_type !== 'free'">
                                        <span>
                                            $<span x-text="plugin.price"></span>
                                            <template x-if="plugin.plugin_type === 'subscription'">
                                                <span style="font-size: 0.75rem; font-weight: normal;">/{% trans "month" %}</span>
                                            </template>
                                        </span>
                                    </template>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <ion-button size="small" fill="outline" @click="viewDetails(plugin)">
                                        <ion-icon slot="start" name="information-circle-outline"></ion-icon>
                                        {% trans "Details" %}
                                    </ion-button>
                                    <ion-button size="small" @click="installPlugin(plugin)" :disabled="isInstalled(plugin.slug)">
                                        <ion-icon slot="start" :name="isInstalled(plugin.slug) ? 'checkmark-circle' : 'download-outline'"></ion-icon>
                                        <span x-text="isInstalled(plugin.slug) ? '{% trans "Installed" %}' : '{% trans "Install" %}'"></span>
                                    </ion-button>
                                </div>
                            </div>
                        </ion-card-content>
                    </ion-card>
                </template>

                <!-- Empty State -->
                <template x-if="filteredPlugins.length === 0 && !loading">
                    <div style="grid-column: 1 / -1;">
                        <ion-card>
                            <ion-card-content style="text-align: center; padding: 48px;">
                                <ion-icon name="cube-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
                                <p style="color: var(--ion-color-medium); margin-top: 16px;">
                                    {% trans "No plugins found" %}
                                </p>
                                <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 8px;">
                                    {% trans "Try with different search filters" %}
                                </p>
                            </ion-card-content>
                        </ion-card>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <!-- Plugin Details Modal -->
    <ion-modal x-ref="detailsModal">
        <ion-header>
            <ion-toolbar>
                <ion-title x-text="selectedPlugin?.name || '{% trans "Plugin Details" %}'"></ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="closeDetailsModal()">
                        <ion-icon slot="icon-only" name="close"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <template x-if="selectedPlugin">
                <div>
                    <!-- Plugin Header -->
                    <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                        <template x-if="selectedPlugin.icon">
                            <img :src="selectedPlugin.icon" :alt="selectedPlugin.name" style="width: 80px; height: 80px; border-radius: 0.75rem; object-fit: cover;">
                        </template>
                        <template x-if="!selectedPlugin.icon">
                            <div style="width: 80px; height: 80px; background: var(--ion-color-primary); border-radius: 0.75rem; display: flex; align-items: center; justify-content: center;">
                                <ion-icon name="extension-puzzle-outline" style="font-size: 2.5rem; color: white;"></ion-icon>
                            </div>
                        </template>
                        <div style="flex: 1;">
                            <h2 style="margin: 0 0 4px 0;" x-text="selectedPlugin.name"></h2>
                            <p style="color: var(--ion-color-medium); margin: 0;" x-text="selectedPlugin.author"></p>
                            <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                <ion-badge :color="selectedPlugin.plugin_type === 'free' ? 'success' : 'primary'">
                                    <span x-text="selectedPlugin.plugin_type === 'free' ? '{% trans "Free" %}' : '$' + selectedPlugin.price"></span>
                                </ion-badge>
                                <span style="font-size: 0.875rem; color: var(--ion-color-medium);">
                                    v<span x-text="selectedPlugin.version"></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="text-align: center; padding: 16px; background: var(--ion-color-light); border-radius: 8px;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 4px; margin-bottom: 4px;">
                                <ion-icon name="star" style="color: #eab308;"></ion-icon>
                                <span style="font-size: 1.25rem; font-weight: 600;" x-text="selectedPlugin.rating ? selectedPlugin.rating.toFixed(1) : '—'"></span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--ion-color-medium);">{% trans "Rating" %}</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--ion-color-light); border-radius: 8px;">
                            <div style="font-size: 1.25rem; font-weight: 600;" x-text="selectedPlugin.downloads"></div>
                            <div style="font-size: 0.75rem; color: var(--ion-color-medium);">{% trans "Downloads" %}</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: var(--ion-color-light); border-radius: 8px;">
                            <div style="font-size: 1.25rem; font-weight: 600;" x-text="selectedPlugin.version"></div>
                            <div style="font-size: 0.75rem; color: var(--ion-color-medium);">{% trans "Version" %}</div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 8px 0;">{% trans "Description" %}</h4>
                        <p style="color: var(--ion-color-medium); line-height: 1.6;" x-text="selectedPlugin.description"></p>
                    </div>

                    <!-- Install Button -->
                    <ion-button expand="block" @click="installPlugin(selectedPlugin)" :disabled="isInstalled(selectedPlugin.slug)">
                        <ion-icon slot="start" :name="isInstalled(selectedPlugin.slug) ? 'checkmark-circle' : 'download-outline'"></ion-icon>
                        <span x-text="isInstalled(selectedPlugin.slug) ? '{% trans "Already Installed" %}' : '{% trans "Install Plugin" %}'"></span>
                    </ion-button>
                </div>
            </template>
        </ion-content>
    </ion-modal>

    <!-- Install Progress Modal -->
    <ion-modal x-ref="installModal" :can-dismiss="!installing">
        <ion-header>
            <ion-toolbar>
                <ion-title>{% trans "Installing Plugin" %}</ion-title>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <div style="text-align: center; padding: 24px;">
                <template x-if="installing">
                    <div>
                        <ion-spinner name="crescent" style="width: 64px; height: 64px;"></ion-spinner>
                        <h3 style="margin-top: 24px;" x-text="installStatus"></h3>
                        <p style="color: var(--ion-color-medium);">{% trans "Please wait..." %}</p>
                    </div>
                </template>
                <template x-if="!installing && installSuccess">
                    <div>
                        <ion-icon name="checkmark-circle" style="font-size: 64px; color: var(--ion-color-success);"></ion-icon>
                        <h3 style="margin-top: 24px;">{% trans "Plugin Installed Successfully" %}</h3>
                        <p style="color: var(--ion-color-medium);">{% trans "The plugin has been installed. You may need to restart the server to apply migrations." %}</p>
                        <ion-button expand="block" style="margin-top: 24px;" @click="closeInstallModal()">
                            {% trans "Done" %}
                        </ion-button>
                    </div>
                </template>
                <template x-if="!installing && installError">
                    <div>
                        <ion-icon name="close-circle" style="font-size: 64px; color: var(--ion-color-danger);"></ion-icon>
                        <h3 style="margin-top: 24px;">{% trans "Installation Failed" %}</h3>
                        <p style="color: var(--ion-color-danger);" x-text="installError"></p>
                        <ion-button expand="block" style="margin-top: 24px;" @click="closeInstallModal()">
                            {% trans "Close" %}
                        </ion-button>
                    </div>
                </template>
            </div>
        </ion-content>
    </ion-modal>
</div>

<script>
function marketplaceData() {
    return {
        // State
        loading: true,
        isConnected: false,
        error: null,
        plugins: [],
        filteredPlugins: [],
        categories: [],
        installedPlugins: {{ installed_plugin_ids|safe }},

        // Filters
        searchQuery: '',
        selectedCategory: null,

        // Selected plugin for details
        selectedPlugin: null,

        // Install state
        installing: false,
        installStatus: '',
        installSuccess: false,
        installError: null,

        // API URL
        apiUrl: '{{ cloud_api_url }}',

        async init() {
            await this.loadPlugins();
        },

        async loadPlugins() {
            this.loading = true;
            this.error = null;

            try {
                const response = await fetch(`${this.apiUrl}/api/plugins/marketplace/`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                this.plugins = data.plugins || [];
                this.categories = data.categories || [];
                this.filteredPlugins = [...this.plugins];
                this.isConnected = true;

            } catch (err) {
                console.error('Failed to load plugins:', err);
                this.error = err.message || '{% trans "Failed to connect to ERPlora Cloud" %}';
                this.isConnected = false;
            } finally {
                this.loading = false;
            }
        },

        async retryConnection() {
            await this.loadPlugins();
        },

        filterPlugins() {
            let filtered = [...this.plugins];

            // Filter by search query
            if (this.searchQuery) {
                const query = this.searchQuery.toLowerCase();
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(query) ||
                    p.description.toLowerCase().includes(query) ||
                    (p.author && p.author.toLowerCase().includes(query))
                );
            }

            // Filter by category
            if (this.selectedCategory) {
                filtered = filtered.filter(p =>
                    p.categories && p.categories.includes(this.selectedCategory)
                );
            }

            this.filteredPlugins = filtered;
        },

        selectCategory(categoryId) {
            this.selectedCategory = categoryId;
            this.filterPlugins();
        },

        truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        },

        isInstalled(slug) {
            return this.installedPlugins.includes(slug);
        },

        viewDetails(plugin) {
            this.selectedPlugin = plugin;
            this.$refs.detailsModal.present();
        },

        closeDetailsModal() {
            this.$refs.detailsModal.dismiss();
            this.selectedPlugin = null;
        },

        async installPlugin(plugin) {
            if (this.isInstalled(plugin.slug)) {
                return;
            }

            this.installing = true;
            this.installStatus = '{% trans "Downloading plugin..." %}';
            this.installSuccess = false;
            this.installError = null;

            // Close details modal if open
            if (this.selectedPlugin) {
                this.$refs.detailsModal.dismiss();
            }

            // Show install modal
            this.$refs.installModal.present();

            try {
                // Call local API to download and install the plugin
                const response = await fetch('/plugins/install-from-marketplace/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        plugin_id: plugin.id,
                        plugin_slug: plugin.slug,
                        download_url: plugin.download_url
                    })
                });

                const result = await response.json();

                if (result.success) {
                    this.installSuccess = true;
                    this.installedPlugins.push(plugin.slug);
                } else {
                    this.installError = result.error || '{% trans "Installation failed" %}';
                }

            } catch (err) {
                console.error('Install error:', err);
                this.installError = err.message || '{% trans "Installation failed" %}';
            } finally {
                this.installing = false;
            }
        },

        closeInstallModal() {
            this.$refs.installModal.dismiss();
            this.installSuccess = false;
            this.installError = null;
        }
    }
}
</script>
{% endblock %}
