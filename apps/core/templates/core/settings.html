{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}CPOS Hub - {% trans "Settings" %}{% endblock %}
{% block page_title %}{% trans "Settings" %}{% endblock %}

{% block content %}
<div style="padding: 24px;" x-data="settingsApp()">
    {% if settings_message %}
    <ion-toast-controller></ion-toast-controller>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const toast = document.createElement('ion-toast');
            toast.message = '{{ settings_message }}';
            toast.duration = 3000;
            toast.color = 'success';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        });
    </script>
    {% endif %}
    <!-- Hub Configuration -->
    <ion-card>
        <ion-card-header>
            <ion-card-title>{% trans "Hub Configuration" %}</ion-card-title>
            <ion-card-subtitle>{% trans "General hub settings and information" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <div style="display: grid; gap: 16px;">
                <div>
                    <ion-label position="stacked">{% trans "Hub ID" %}</ion-label>
                    <ion-input
                        readonly
                        value="{{ hub_config.hub_id|default:'Not configured' }}"
                        style="margin-top: 8px;">
                    </ion-input>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "System Language" %}</ion-label>
                    <ion-select
                        value="{{ hub_config.os_language }}"
                        style="margin-top: 8px;"
                        x-model="language">
                        <ion-select-option value="en">English</ion-select-option>
                        <ion-select-option value="es">Espa√±ol</ion-select-option>
                    </ion-select>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "Hub Status" %}</ion-label>
                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                        <ion-badge color="{% if hub_config.is_configured %}success{% else %}warning{% endif %}">
                            {% if hub_config.is_configured %}
                                {% trans "Configured" %}
                            {% else %}
                                {% trans "Not Configured" %}
                            {% endif %}
                        </ion-badge>
                    </div>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "Tunnel Port" %}</ion-label>
                    <ion-input
                        readonly
                        value="{{ hub_config.tunnel_port|default:'Not assigned' }}"
                        style="margin-top: 8px;">
                    </ion-input>
                </div>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Store Configuration -->
    <ion-card style="margin-top: 16px;">
        <ion-card-header>
            <ion-card-title>{% trans "Store Configuration" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Business information for receipts and invoices" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_store">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <ion-label position="stacked">{% trans "Business Name" %} *</ion-label>
                        <ion-input
                            name="business_name"
                            value="{{ store_config.business_name }}"
                            placeholder="{% trans 'Enter business name' %}"
                            required
                            style="margin-top: 8px;">
                        </ion-input>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Business Address" %} *</ion-label>
                        <ion-textarea
                            name="business_address"
                            placeholder="{% trans 'Enter complete address' %}"
                            rows="3"
                            required
                            style="margin-top: 8px;">{{ store_config.business_address }}</ion-textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <ion-label position="stacked">{% trans "VAT/Tax ID" %} *</ion-label>
                            <ion-input
                                name="vat_number"
                                value="{{ store_config.vat_number }}"
                                placeholder="{% trans 'VAT or Tax ID' %}"
                                required
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>

                        <div>
                            <ion-label position="stacked">{% trans "Phone" %}</ion-label>
                            <ion-input
                                name="phone"
                                type="tel"
                                value="{{ store_config.phone }}"
                                placeholder="{% trans 'Phone number' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <ion-label position="stacked">{% trans "Email" %}</ion-label>
                            <ion-input
                                name="email"
                                type="email"
                                value="{{ store_config.email }}"
                                placeholder="{% trans 'Business email' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>

                        <div>
                            <ion-label position="stacked">{% trans "Website" %}</ion-label>
                            <ion-input
                                name="website"
                                type="url"
                                value="{{ store_config.website }}"
                                placeholder="{% trans 'Website URL' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Tax Rate" %} (%)</ion-label>
                        <ion-input
                            name="tax_rate"
                            type="number"
                            step="0.01"
                            value="{{ store_config.tax_rate }}"
                            placeholder="21.00"
                            style="margin-top: 8px;">
                        </ion-input>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Tax rate in percentage (e.g., 21.00 for 21%)" %}
                        </p>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <ion-label>{% trans "Tax Included in Prices" %}</ion-label>
                            <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                                {% trans "Prices include tax" %}
                            </p>
                        </div>
                        <ion-toggle name="tax_included" {% if store_config.tax_included %}checked{% endif %}></ion-toggle>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Business Logo" %}</ion-label>
                        {% if store_config.logo %}
                        <div style="margin-top: 8px; margin-bottom: 8px;">
                            <img src="{{ store_config.logo.url }}" alt="Logo" style="max-width: 200px; max-height: 100px; object-fit: contain;">
                        </div>
                        {% endif %}
                        <input type="file" name="logo" accept="image/*" style="margin-top: 8px;">
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Logo will be displayed on receipts (optional)" %}
                        </p>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Receipt Header" %}</ion-label>
                        <ion-textarea
                            name="receipt_header"
                            placeholder="{% trans 'Additional text for receipt header (optional)' %}"
                            rows="2"
                            style="margin-top: 8px;">{{ store_config.receipt_header }}</ion-textarea>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Text displayed at the top of receipts" %}
                        </p>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Receipt Footer" %}</ion-label>
                        <ion-textarea
                            name="receipt_footer"
                            placeholder="{% trans 'Additional text for receipt footer (optional)' %}"
                            rows="2"
                            style="margin-top: 8px;">{{ store_config.receipt_footer }}</ion-textarea>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Text displayed at the bottom of receipts (e.g., thank you message)" %}
                        </p>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                        <ion-button type="submit" color="primary">
                            <ion-icon slot="start" name="save-outline"></ion-icon>
                            {% trans "Save Store Config" %}
                        </ion-button>
                    </div>
                </div>
            </form>
        </ion-card-content>
    </ion-card>

    <!-- Display Settings -->
    <ion-card style="margin-top: 16px;">
        <ion-card-header>
            <ion-card-title>{% trans "Display Settings" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Customize the appearance and printing" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <div style="display: grid; gap: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <ion-label>{% trans "Dark Mode" %}</ion-label>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Enable dark theme" %}
                        </p>
                    </div>
                    <ion-toggle
                        x-model="darkMode"
                        @ionChange="toggleDarkMode()">
                    </ion-toggle>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <ion-label>{% trans "Auto-print Receipts" %}</ion-label>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Automatically print after each sale" %}
                        </p>
                    </div>
                    <ion-toggle
                        :color="autoPrint ? 'success' : ''"
                        x-model="autoPrint"
                        @ionChange="toggleAutoPrint()">
                    </ion-toggle>
                </div>
            </div>
        </ion-card-content>
    </ion-card>
</div>

<script>
function settingsApp() {
    return {
        language: '{{ hub_config.os_language }}',
        darkMode: false,
        autoPrint: false,

        init() {
            // Check if dark mode is enabled
            this.darkMode = document.body.classList.contains('dark');
            // Load auto-print setting from localStorage
            const autoPrintSaved = localStorage.getItem('autoPrint');
            this.autoPrint = autoPrintSaved === 'true';
        },

        toggleDarkMode() {
            document.body.classList.toggle('dark', this.darkMode);
            localStorage.setItem('darkMode', this.darkMode);
        },

        async toggleAutoPrint() {
            // Save to localStorage automatically
            localStorage.setItem('autoPrint', this.autoPrint);

            // Show success toast
            const toast = document.createElement('ion-toast');
            toast.message = this.autoPrint
                ? '{% trans "Auto-print enabled" %}'
                : '{% trans "Auto-print disabled" %}';
            toast.duration = 2000;
            toast.color = 'success';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    }
}
</script>
{% endblock %}
