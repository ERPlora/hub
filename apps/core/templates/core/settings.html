{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}ERPlora Hub - {% trans "Settings" %}{% endblock %}
{% block page_title %}{% trans "Settings" %}{% endblock %}

{% block content %}
<div style="padding: 24px;" x-data="settingsApp()">
    {% if settings_message %}
    <ion-toast-controller></ion-toast-controller>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const toast = document.createElement('ion-toast');
            toast.message = '{{ settings_message }}';
            toast.duration = 3000;
            toast.color = 'success';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        });
    </script>
    {% endif %}
    <!-- Hub Configuration -->
    <ion-card>
        <ion-card-header>
            <ion-card-title>{% trans "Hub Configuration" %}</ion-card-title>
            <ion-card-subtitle>{% trans "General hub settings and information" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <div style="display: grid; gap: 16px;">
                <div>
                    <ion-label position="stacked">{% trans "Hub ID" %}</ion-label>
                    <ion-input
                        readonly
                        value="{{ hub_config.hub_id|default:'Not configured' }}"
                        style="margin-top: 8px;">
                    </ion-input>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "System Language" %}</ion-label>
                    <ion-select
                        value="{{ hub_config.os_language }}"
                        style="margin-top: 8px;"
                        x-model="language">
                        <ion-select-option value="en">English</ion-select-option>
                        <ion-select-option value="es">Español</ion-select-option>
                    </ion-select>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "Currency" %}</ion-label>
                    <ion-select
                        id="currencySelect"
                        value="{{ hub_config.currency }}"
                        style="margin-top: 8px;"
                        x-model="currency">
                        <ion-select-option value="USD">US Dollar ($)</ion-select-option>
                        <ion-select-option value="EUR">Euro (€)</ion-select-option>
                        <ion-select-option value="GBP">British Pound (£)</ion-select-option>
                        <ion-select-option value="JPY">Japanese Yen (¥)</ion-select-option>
                        <ion-select-option value="CNY">Chinese Yuan (¥)</ion-select-option>
                        <ion-select-option value="MXN">Mexican Peso ($)</ion-select-option>
                        <ion-select-option value="CAD">Canadian Dollar ($)</ion-select-option>
                        <ion-select-option value="AUD">Australian Dollar ($)</ion-select-option>
                        <ion-select-option value="BRL">Brazilian Real (R$)</ion-select-option>
                        <ion-select-option value="ARS">Argentine Peso ($)</ion-select-option>
                        <ion-select-option value="COP">Colombian Peso ($)</ion-select-option>
                        <ion-select-option value="CLP">Chilean Peso ($)</ion-select-option>
                        <ion-select-option value="PEN">Peruvian Sol (S/)</ion-select-option>
                        <ion-select-option value="CRC">Costa Rican Colón (₡)</ion-select-option>
                    </ion-select>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "Hub Status" %}</ion-label>
                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                        <ion-badge color="{% if hub_config.is_configured %}success{% else %}warning{% endif %}">
                            {% if hub_config.is_configured %}
                                {% trans "Configured" %}
                            {% else %}
                                {% trans "Not Configured" %}
                            {% endif %}
                        </ion-badge>
                    </div>
                </div>

                <div>
                    <ion-label position="stacked">{% trans "Tunnel Port" %}</ion-label>
                    <ion-input
                        readonly
                        value="{{ hub_config.tunnel_port|default:'Not assigned' }}"
                        style="margin-top: 8px;">
                    </ion-input>
                </div>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Store Configuration -->
    <ion-card style="margin-top: 16px;">
        <ion-card-header>
            <ion-card-title>{% trans "Store Configuration" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Business information for receipts and invoices" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_store">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <ion-label position="stacked">{% trans "Business Name" %} *</ion-label>
                        <ion-input
                            name="business_name"
                            value="{{ store_config.business_name }}"
                            placeholder="{% trans 'Enter business name' %}"
                            required
                            style="margin-top: 8px;">
                        </ion-input>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Business Address" %} *</ion-label>
                        <ion-textarea
                            name="business_address"
                            placeholder="{% trans 'Enter complete address' %}"
                            rows="3"
                            required
                            style="margin-top: 8px;">{{ store_config.business_address }}</ion-textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <ion-label position="stacked">{% trans "VAT/Tax ID" %} *</ion-label>
                            <ion-input
                                name="vat_number"
                                value="{{ store_config.vat_number }}"
                                placeholder="{% trans 'VAT or Tax ID' %}"
                                required
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>

                        <div>
                            <ion-label position="stacked">{% trans "Phone" %}</ion-label>
                            <ion-input
                                name="phone"
                                type="tel"
                                value="{{ store_config.phone }}"
                                placeholder="{% trans 'Phone number' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <ion-label position="stacked">{% trans "Email" %}</ion-label>
                            <ion-input
                                name="email"
                                type="email"
                                value="{{ store_config.email }}"
                                placeholder="{% trans 'Business email' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>

                        <div>
                            <ion-label position="stacked">{% trans "Website" %}</ion-label>
                            <ion-input
                                name="website"
                                type="url"
                                value="{{ store_config.website }}"
                                placeholder="{% trans 'Website URL' %}"
                                style="margin-top: 8px;">
                            </ion-input>
                        </div>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Tax Rate" %} (%)</ion-label>
                        <ion-input
                            name="tax_rate"
                            type="number"
                            step="0.01"
                            value="{{ store_config.tax_rate }}"
                            placeholder="21.00"
                            style="margin-top: 8px;">
                        </ion-input>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Tax rate in percentage (e.g., 21.00 for 21%)" %}
                        </p>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <ion-label>{% trans "Tax Included in Prices" %}</ion-label>
                            <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                                {% trans "Prices include tax" %}
                            </p>
                        </div>
                        <ion-toggle name="tax_included" {% if store_config.tax_included %}checked{% endif %} color="success"></ion-toggle>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Business Logo" %}</ion-label>
                        {% if store_config.logo %}
                        <div style="margin-top: 8px; margin-bottom: 8px;">
                            <img src="{{ store_config.logo.url }}" alt="Logo" style="max-width: 200px; max-height: 100px; object-fit: contain;">
                        </div>
                        {% endif %}
                        <input type="file" name="logo" accept="image/*" style="margin-top: 8px;">
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Logo will be displayed on receipts (optional)" %}
                        </p>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Receipt Header" %}</ion-label>
                        <ion-textarea
                            name="receipt_header"
                            placeholder="{% trans 'Additional text for receipt header (optional)' %}"
                            rows="2"
                            style="margin-top: 8px;">{{ store_config.receipt_header }}</ion-textarea>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Text displayed at the top of receipts" %}
                        </p>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Receipt Footer" %}</ion-label>
                        <ion-textarea
                            name="receipt_footer"
                            placeholder="{% trans 'Additional text for receipt footer (optional)' %}"
                            rows="2"
                            style="margin-top: 8px;">{{ store_config.receipt_footer }}</ion-textarea>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Text displayed at the bottom of receipts (e.g., thank you message)" %}
                        </p>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                        <ion-button type="submit" color="primary">
                            <ion-icon slot="start" name="save-outline"></ion-icon>
                            {% trans "Save Store Config" %}
                        </ion-button>
                    </div>
                </div>
            </form>
        </ion-card-content>
    </ion-card>

    <!-- Display Settings -->
    <ion-card style="margin-top: 16px;">
        <ion-card-header>
            <ion-card-title>{% trans "Display Settings" %}</ion-card-title>
            <ion-card-subtitle>{% trans "Customize the appearance and printing" %}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
            <div style="display: grid; gap: 16px;">
                <!-- Color Theme Selector -->
                <div>
                    <ion-label position="stacked">{% trans "Color Palette" %}</ion-label>
                    <ion-select
                        id="colorThemeSelect"
                        :value="colorTheme"
                        style="margin-top: 8px;">
                        <ion-select-option value="default">{% trans "Default (Gray)" %}</ion-select-option>
                        <ion-select-option value="blue">{% trans "Blue" %}</ion-select-option>
                    </ion-select>
                    <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                        {% trans "Choose your preferred color palette. Works with both light and dark modes." %}
                    </p>
                </div>

                <!-- Dark Mode Info -->
                <div style="padding: 12px; background: var(--ion-color-light); border-radius: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <ion-icon :name="parentIsDark ? 'moon' : 'sunny'" style="color: var(--ion-color-primary);"></ion-icon>
                        <ion-label style="font-weight: 600;">
                            {% trans "Current Mode" %}: <span x-text="parentIsDark ? '{% trans "Dark" %}' : '{% trans "Light" %}'"></span>
                        </ion-label>
                    </div>
                    <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin: 0;">
                        {% trans "Toggle between light and dark modes using the" %}
                        <ion-icon :name="parentIsDark ? 'sunny-outline' : 'moon-outline'" style="vertical-align: middle;"></ion-icon>
                        {% trans "icon in the header" %}
                    </p>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <ion-label>{% trans "Auto-print Receipts" %}</ion-label>
                        <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                            {% trans "Automatically print after each sale" %}
                        </p>
                    </div>
                    <ion-toggle
                        color="success"
                        :checked="autoPrint"
                        @ionChange="autoPrint = $event.target.checked; toggleAutoPrint()">
                    </ion-toggle>
                </div>
            </div>
        </ion-card-content>
    </ion-card>
</div>

<script>
function settingsApp() {
    return {
        language: '{{ hub_config.os_language }}',
        currency: '{{ hub_config.currency }}',
        autoPrint: {{ hub_config.auto_print|yesno:"true,false" }},
        colorTheme: '{{ hub_config.color_theme }}',
        parentIsDark: {{ hub_config.dark_mode|yesno:"true,false" }},

        init() {
            // Alpine.js with :value binding handles initialization automatically
            // Listen for dark mode changes from parent hubApp
            document.addEventListener('theme-changed', (e) => {
                this.parentIsDark = e.detail.isDark;
            });

            // Add native event listener for color theme select (Ionic Web Component)
            const themeSelect = document.getElementById('colorThemeSelect');
            if (themeSelect) {
                console.log('[INIT] Attaching event listener to colorThemeSelect');
                themeSelect.addEventListener('ionChange', (e) => {
                    console.log('[SELECT EVENT] ionChange triggered, value:', e.detail.value);
                    this.changeColorTheme(e.detail.value);
                });
            } else {
                console.error('[INIT] colorThemeSelect element not found');
            }

            // Add event listener for currency select
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) {
                currencySelect.addEventListener('ionChange', (e) => {
                    this.currency = e.detail.value;
                    this.saveCurrency();
                });
            }
        },

        async saveCurrency() {
            try {
                const formData = new FormData();
                formData.append('action', 'update_currency');
                formData.append('currency', this.currency);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('{% url "configuration:settings" %}', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success toast
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "Currency updated" %}';
                    toast.duration = 2000;
                    toast.color = 'success';
                    toast.position = 'top';
                    document.body.appendChild(toast);
                    await toast.present();
                } else {
                    throw new Error('Failed to save currency');
                }
            } catch (error) {
                console.error('[SAVE CURRENCY ERROR]', error);

                // Show error toast
                const toast = document.createElement('ion-toast');
                toast.message = '{% trans "Failed to update currency" %}';
                toast.duration = 3000;
                toast.color = 'danger';
                toast.position = 'top';
                document.body.appendChild(toast);
                await toast.present();
            }
        },

        async changeColorTheme(newTheme) {
            console.log('[CHANGE THEME] New theme selected:', newTheme);
            console.log('[CHANGE THEME] Current colorTheme before update:', this.colorTheme);

            // Update the colorTheme value
            this.colorTheme = newTheme;
            console.log('[CHANGE THEME] Updated colorTheme to:', this.colorTheme);

            // Save theme preference to database
            console.log('[CHANGE THEME] Calling saveThemePreferences...');
            await this.saveThemePreferences();
            console.log('[CHANGE THEME] saveThemePreferences completed');

            // Reload page to apply new theme
            console.log('[CHANGE THEME] Reloading page...');
            window.location.reload();
        },

        async saveThemePreferences() {
            try {
                console.log('[SAVE PREFS] Building FormData with:', {
                    action: 'update_theme',
                    color_theme: this.colorTheme,
                    auto_print: this.autoPrint
                });

                const formData = new FormData();
                formData.append('action', 'update_theme');
                formData.append('color_theme', this.colorTheme);
                formData.append('auto_print', this.autoPrint);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                console.log('[SAVE PREFS] Sending POST request...');
                const response = await fetch('{% url "configuration:settings" %}', {
                    method: 'POST',
                    body: formData
                });

                console.log('[SAVE PREFS] Response status:', response.status);
                const result = await response.json();
                console.log('[SAVE PREFS] Response data:', result);

                if (!response.ok) {
                    throw new Error('Failed to save preferences');
                }
            } catch (error) {
                console.error('[SAVE PREFS ERROR]', error);
            }
        },

        async toggleAutoPrint() {
            // Save to database
            await this.saveThemePreferences();

            // Show success toast
            const toast = document.createElement('ion-toast');
            toast.message = this.autoPrint
                ? '{% trans "Auto-print enabled" %}'
                : '{% trans "Auto-print disabled" %}';
            toast.duration = 2000;
            toast.color = 'success';
            toast.position = 'top';
            document.body.appendChild(toast);
            await toast.present();
        }
    }
}
</script>
{% endblock %}
