{% extends "core/app_base.html" %}
{% load static %}
{% load i18n %}

{% block title %}CPOS Hub - {% trans "Employees" %}{% endblock %}
{% block page_title %}{% trans "Employees" %}{% endblock %}

{% block content %}
<div style="padding: 24px;" x-data="employeesApp()">
    <!-- Header with Add Button -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2 style="margin: 0;">{% trans "Employee Management" %}</h2>
            <p style="color: var(--ion-color-medium); margin-top: 4px;">
                {% trans "Manage employee accounts and roles" %}
            </p>
        </div>
        <ion-button @click="openAddModal()">
            <ion-icon slot="start" name="person-add-outline"></ion-icon>
            {% trans "Add Employee" %}
        </ion-button>
    </div>

    <!-- Employees Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
        {% for user in local_users %}
        <ion-card>
            <ion-card-content>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <!-- Avatar -->
                    <div style="width: 60px; height: 60px; border-radius: 50%; background: var(--ion-color-primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 600; flex-shrink: 0;">
                        {{ user.name|first|upper }}
                    </div>

                    <!-- Info -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 4px;">
                            {{ user.name }}
                        </div>
                        <div style="color: var(--ion-color-medium); font-size: 0.875rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            {{ user.email }}
                        </div>
                        <ion-badge color="{% if user.role == 'admin' %}primary{% elif user.role == 'manager' %}success{% else %}secondary{% endif %}">
                            {{ user.role|title }}
                        </ion-badge>
                    </div>
                </div>

                <!-- Actions -->
                <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--ion-color-light-shade);">
                    <ion-button size="small" fill="outline" @click="editEmployee({{ user.id }}, '{{ user.name }}', '{{ user.email }}', '{{ user.role }}')">
                        <ion-icon slot="start" name="create-outline"></ion-icon>
                        {% trans "Edit" %}
                    </ion-button>
                    <ion-button size="small" fill="outline" color="medium" @click="resetPin({{ user.id }}, '{{ user.name }}')">
                        <ion-icon slot="start" name="key-outline"></ion-icon>
                        {% trans "Reset PIN" %}
                    </ion-button>
                    {% if user.role != 'admin' %}
                    <ion-button size="small" fill="outline" color="danger" @click="deleteEmployee({{ user.id }}, '{{ user.name }}')">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                    </ion-button>
                    {% endif %}
                </div>
            </ion-card-content>
        </ion-card>
        {% empty %}
        <ion-card>
            <ion-card-content style="text-align: center; padding: 40px;">
                <ion-icon name="people-outline" style="font-size: 64px; color: var(--ion-color-medium);"></ion-icon>
                <p style="color: var(--ion-color-medium); margin-top: 16px;">
                    {% trans "No employees found" %}
                </p>
            </ion-card-content>
        </ion-card>
        {% endfor %}
    </div>

    <!-- Add/Edit Employee Modal -->
    <ion-modal :is-open="showModal" @didDismiss="closeModal()">
        <ion-header>
            <ion-toolbar>
                <ion-title x-text="modalTitle"></ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="closeModal()">
                        <ion-icon name="close"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <form @submit.prevent="saveEmployee()">
                <div style="display: grid; gap: 16px;">
                    <div>
                        <ion-label position="stacked">{% trans "Name" %} *</ion-label>
                        <ion-input
                            x-model="form.name"
                            placeholder="{% trans 'Enter employee name' %}"
                            required
                            style="margin-top: 8px;">
                        </ion-input>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Email" %} *</ion-label>
                        <ion-input
                            type="email"
                            x-model="form.email"
                            placeholder="{% trans 'Enter email address' %}"
                            required
                            style="margin-top: 8px;">
                        </ion-input>
                    </div>

                    <div>
                        <ion-label position="stacked">{% trans "Role" %} *</ion-label>
                        <ion-select
                            x-model="form.role"
                            placeholder="{% trans 'Select role' %}"
                            style="margin-top: 8px;">
                            <ion-select-option value="cashier">{% trans "Cashier" %}</ion-select-option>
                            <ion-select-option value="manager">{% trans "Manager" %}</ion-select-option>
                            <ion-select-option value="admin">{% trans "Admin" %}</ion-select-option>
                        </ion-select>
                    </div>

                    <template x-if="!form.id">
                        <div>
                            <ion-label position="stacked">{% trans "PIN" %} *</ion-label>
                            <ion-input
                                type="number"
                                x-model="form.pin"
                                placeholder="{% trans '4-digit PIN' %}"
                                minlength="4"
                                maxlength="4"
                                required
                                style="margin-top: 8px;">
                            </ion-input>
                            <p style="color: var(--ion-color-medium); font-size: 0.875rem; margin-top: 4px;">
                                {% trans "This will be the employee's login PIN" %}
                            </p>
                        </div>
                    </template>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                    <ion-button color="medium" @click="closeModal()" type="button">
                        {% trans "Cancel" %}
                    </ion-button>
                    <ion-button type="submit">
                        <ion-icon slot="start" name="save-outline"></ion-icon>
                        {% trans "Save" %}
                    </ion-button>
                </div>
            </form>
        </ion-content>
    </ion-modal>

    <!-- Reset PIN Modal -->
    <ion-modal :is-open="showResetPinModal" @didDismiss="closeResetPinModal()">
        <ion-header>
            <ion-toolbar>
                <ion-title>{% trans "Reset PIN" %}</ion-title>
                <ion-buttons slot="end">
                    <ion-button @click="closeResetPinModal()">
                        <ion-icon name="close"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
            <p x-text="'{% trans "Reset PIN for" %} ' + resetPinName"></p>
            <form @submit.prevent="saveResetPin()">
                <div>
                    <ion-label position="stacked">{% trans "New PIN" %} *</ion-label>
                    <ion-input
                        type="number"
                        x-model="resetPinValue"
                        placeholder="{% trans '4-digit PIN' %}"
                        minlength="4"
                        maxlength="4"
                        required
                        style="margin-top: 8px;">
                    </ion-input>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end;">
                    <ion-button color="medium" @click="closeResetPinModal()" type="button">
                        {% trans "Cancel" %}
                    </ion-button>
                    <ion-button type="submit" color="primary">
                        <ion-icon slot="start" name="key-outline"></ion-icon>
                        {% trans "Reset PIN" %}
                    </ion-button>
                </div>
            </form>
        </ion-content>
    </ion-modal>
</div>

<script>
function employeesApp() {
    return {
        showModal: false,
        showResetPinModal: false,
        modalTitle: '',
        resetPinId: null,
        resetPinName: '',
        resetPinValue: '',
        form: {
            id: null,
            name: '',
            email: '',
            role: 'cashier',
            pin: ''
        },

        openAddModal() {
            this.modalTitle = '{% trans "Add Employee" %}';
            this.form = {
                id: null,
                name: '',
                email: '',
                role: 'cashier',
                pin: ''
            };
            this.showModal = true;
        },

        editEmployee(id, name, email, role) {
            this.modalTitle = '{% trans "Edit Employee" %}';
            this.form = {
                id: id,
                name: name,
                email: email,
                role: role,
                pin: ''
            };
            this.showModal = true;
        },

        closeModal() {
            this.showModal = false;
        },

        async saveEmployee() {
            try {
                const url = this.form.id ? '/api/employees/update/' : '/api/employees/create/';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.form)
                });

                if (response.ok) {
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "Employee saved successfully" %}';
                    toast.duration = 2000;
                    toast.color = 'success';
                    document.body.appendChild(toast);
                    await toast.present();

                    // Reload page
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || '{% trans "Failed to save employee" %}');
                }
            } catch (error) {
                const toast = document.createElement('ion-toast');
                toast.message = error.message;
                toast.duration = 3000;
                toast.color = 'danger';
                document.body.appendChild(toast);
                toast.present();
            }
        },

        resetPin(id, name) {
            this.resetPinId = id;
            this.resetPinName = name;
            this.resetPinValue = '';
            this.showResetPinModal = true;
        },

        closeResetPinModal() {
            this.showResetPinModal = false;
        },

        async saveResetPin() {
            try {
                const response = await fetch('/api/employees/reset-pin/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: this.resetPinId,
                        pin: this.resetPinValue
                    })
                });

                if (response.ok) {
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "PIN reset successfully" %}';
                    toast.duration = 2000;
                    toast.color = 'success';
                    document.body.appendChild(toast);
                    await toast.present();

                    this.closeResetPinModal();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || '{% trans "Failed to reset PIN" %}');
                }
            } catch (error) {
                const toast = document.createElement('ion-toast');
                toast.message = error.message;
                toast.duration = 3000;
                toast.color = 'danger';
                document.body.appendChild(toast);
                toast.present();
            }
        },

        async deleteEmployee(id, name) {
            if (!confirm(`{% trans "Are you sure you want to delete" %} ${name}?`)) {
                return;
            }

            try {
                const response = await fetch('/api/employees/delete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: id })
                });

                if (response.ok) {
                    const toast = document.createElement('ion-toast');
                    toast.message = '{% trans "Employee deleted successfully" %}';
                    toast.duration = 2000;
                    toast.color = 'success';
                    document.body.appendChild(toast);
                    await toast.present();

                    // Reload page
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    const error = await response.json();
                    throw new Error(error.error || '{% trans "Failed to delete employee" %}');
                }
            } catch (error) {
                const toast = document.createElement('ion-toast');
                toast.message = error.message;
                toast.duration = 3000;
                toast.color = 'danger';
                document.body.appendChild(toast);
                toast.present();
            }
        }
    }
}
</script>
{% endblock %}
