# ==============================================================================
# ERPlora Hub - Docker Compose for Dokploy
# ==============================================================================
# Dokploy usa este archivo para desplegar el Hub como Docker Compose.
# Los volúmenes persisten entre deploys usando bind mounts al NVMe local.
#
# Variables de entorno (inyectadas por Dokploy via .env):
#   - HUB_ID: UUID del Hub
#   - HUB_NAME: Nombre/subdomain del Hub
#   - VOLUME_PATH: Ruta local NVMe en el host (ej: /data)
#   - AWS_*: Credenciales S3
#   - Todas las demás env vars configuradas en Dokploy
#
# Volumen persistente (NVMe local del servidor):
#   Host: ${VOLUME_PATH}/hubs/${HUB_ID}/  →  Container: /app/data/
#   - /app/data/db/db.sqlite3  - SQLite database (PERSISTENT)
#   - /app/data/modules/       - Installed modules
#   - Cada DB SQLite tiene un límite recomendado de 2 GB
#
# Red:
#   - dokploy-network: Red de Dokploy para Traefik
# ==============================================================================

services:
  hub:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    restart: unless-stopped
    # Command: create data dirs, run migrations, start gunicorn
    command: ["sh", "-c", "echo '=== ERPlora Hub Starting ===' && mkdir -p /app/data/db && python manage.py migrate --noinput && echo 'Starting Gunicorn server...' && exec gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 4 --worker-class gthread --timeout 120 --access-logfile - --error-logfile - --capture-output --enable-stdio-inheritance"]
    volumes:
      # Bind mount: host NVMe → fixed /app/data inside container
      # Host path uses VOLUME_PATH + HUB_ID for per-hub isolation
      # Container path is always /app/data (deterministic)
      - ${VOLUME_PATH:-/data}/hubs/${HUB_ID}:/app/data
    environment:
      # Estas variables son inyectadas por Dokploy via .env
      - HUB_ID=${HUB_ID}
      - HUB_NAME=${HUB_NAME}
      - DEPLOYMENT_MODE=web
      - CLOUD_BASE_URL=${CLOUD_BASE_URL}
      - HUB_JWT=${HUB_JWT}
      - PARENT_DOMAIN=${PARENT_DOMAIN}
      - SERVER_DOMAIN=${SERVER_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      # Database configuration (SQLite for Starter, PostgreSQL for Business)
      - DATABASE_URL=${DATABASE_URL:-}
      # S3 configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_STORAGE_BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_S3_REGION_NAME=${AWS_S3_REGION_NAME}
      - AWS_LOCATION=${AWS_LOCATION}
    dns:
      - 8.8.8.8
      - 1.1.1.1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health/')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true
