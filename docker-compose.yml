# ==============================================================================
# ERPlora Hub - Docker Compose for Dokploy
# ==============================================================================
# Dokploy usa este archivo para desplegar el Hub como Docker Compose.
# Los volúmenes persisten entre deploys automáticamente.
#
# Variables de entorno (inyectadas por Dokploy via .env):
#   - HUB_ID: UUID del Hub
#   - HUB_NAME: Nombre/subdomain del Hub
#   - AWS_*: Credenciales S3
#   - Todas las demás env vars configuradas en Dokploy
#
# Volumen persistente:
#   - hub-data:/app/data → SQLite en /app/data/{HUB_ID}/db/db.sqlite3
#
# Red:
#   - dokploy-network: Red de Dokploy para Traefik
# ==============================================================================

services:
  hub:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    volumes:
      # Volumen persistente para SQLite
      # Cada Hub tiene su carpeta: /app/data/{HUB_ID}/db/db.sqlite3
      - hub-data:/app/data
    environment:
      # Estas variables son inyectadas por Dokploy via .env
      - HUB_ID=${HUB_ID}
      - HUB_NAME=${HUB_NAME}
      - DJANGO_SETTINGS_MODULE=${DJANGO_SETTINGS_MODULE:-config.settings.web}
      - DEPLOYMENT_MODE=${DEPLOYMENT_MODE:-web}
      - CLOUD_API_URL=${CLOUD_API_URL}
      - HUB_JWT=${HUB_JWT}
      - PARENT_DOMAIN=${PARENT_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      # S3 configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_STORAGE_BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_S3_REGION_NAME=${AWS_S3_REGION_NAME}
      - AWS_LOCATION=${AWS_LOCATION}
    labels:
      # Traefik routing - Dokploy gestiona las labels automáticamente
      # pero las definimos explícitamente para asegurar el dominio correcto
      - "traefik.enable=true"
      - "traefik.http.routers.hub-${HUB_NAME}.rule=Host(`${HUB_NAME}.${PARENT_DOMAIN}`)"
      - "traefik.http.routers.hub-${HUB_NAME}.entrypoints=websecure"
      - "traefik.http.routers.hub-${HUB_NAME}.tls=true"
      - "traefik.http.routers.hub-${HUB_NAME}.tls.certresolver=letsencrypt"
      - "traefik.http.services.hub-${HUB_NAME}.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

volumes:
  hub-data:
    # Volumen Docker nombrado - persiste entre deploys
    # Dokploy mantiene los volúmenes automáticamente
    name: hub-data-${HUB_ID:-default}
