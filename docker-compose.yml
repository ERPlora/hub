# ==============================================================================
# ERPlora Hub - Docker Compose for Dokploy
# ==============================================================================
# Dokploy usa este archivo para desplegar el Hub como Docker Compose.
# Los volúmenes persisten entre deploys usando bind mounts al NVMe local.
#
# Variables de entorno (inyectadas por Dokploy via .env):
#   - HUB_ID: UUID del Hub
#   - HUB_NAME: Nombre/subdomain del Hub
#   - VOLUME_PATH: Ruta local NVMe en el host (ej: /data)
#   - AWS_*: Credenciales S3
#   - Todas las demás env vars configuradas en Dokploy
#
# Volumen persistente (NVMe local del servidor):
#   - ${VOLUME_PATH}/hubs/${HUB_ID}/ montado en el mismo path dentro del contenedor
#   - DATABASE_PATH apunta directamente: /data/hubs/{hub_id}/db/db.sqlite3
#   - Cada DB SQLite tiene un límite recomendado de 2 GB
#
# Red:
#   - dokploy-network: Red de Dokploy para Traefik
# ==============================================================================

services:
  hub:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
    restart: unless-stopped
    # Command inline - runs migrations and starts gunicorn
    command: ["sh", "-c", "echo '=== ERPlora Hub Starting ===' && mkdir -p $(dirname $DATABASE_PATH) && python manage.py migrate --noinput && echo 'Starting Gunicorn server...' && exec gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 4 --worker-class gthread --timeout 120 --access-logfile - --error-logfile - --capture-output --enable-stdio-inheritance"]
    volumes:
      # Bind mount al NVMe local del servidor
      # Monta la carpeta del Hub en el mismo path host=contenedor
      # para que DATABASE_PATH funcione directamente
      - ${VOLUME_PATH}/hubs/${HUB_ID}:${VOLUME_PATH}/hubs/${HUB_ID}
    environment:
      # Estas variables son inyectadas por Dokploy via .env
      - HUB_ID=${HUB_ID}
      - HUB_NAME=${HUB_NAME}
      - DEPLOYMENT_MODE=web
      - VOLUME_PATH=${VOLUME_PATH:-/data}
      - CLOUD_BASE_URL=${CLOUD_BASE_URL}
      - HUB_JWT=${HUB_JWT}
      - PARENT_DOMAIN=${PARENT_DOMAIN}
      - SERVER_DOMAIN=${SERVER_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      # Database configuration (SQLite for Starter, PostgreSQL for Business)
      - DATABASE_PATH=${DATABASE_PATH}
      - DATABASE_URL=${DATABASE_URL:-}
      # S3 configuration
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_STORAGE_BUCKET_NAME=${AWS_STORAGE_BUCKET_NAME}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_S3_REGION_NAME=${AWS_S3_REGION_NAME}
      - AWS_LOCATION=${AWS_LOCATION}
    # Labels de Traefik comentados - Dokploy gestiona dominios via API domain.create
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.hub-${HUB_NAME}.rule=Host(`${HUB_NAME}.${SERVER_DOMAIN}`)"
    #   - "traefik.http.routers.hub-${HUB_NAME}.entrypoints=websecure"
    #   - "traefik.http.routers.hub-${HUB_NAME}.tls=true"
    #   - "traefik.http.routers.hub-${HUB_NAME}.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.hub-${HUB_NAME}.loadbalancer.server.port=8000"
    dns:
      - 8.8.8.8
      - 1.1.1.1
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health/')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

# No usamos volúmenes Docker nombrados - usamos bind mounts al NVMe local
# El path viene de VOLUME_PATH (configurado en el Server model, ej: /data)
